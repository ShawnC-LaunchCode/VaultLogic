npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

 DEV  v4.0.16 C:/Users/scoot/poll/VaultLogic

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674843945,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768674847234,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674847301,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768674849472,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674849491,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768674849481,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674849481,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674849486,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674849486,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674849490,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674849491,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674849491,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674849491,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674849714,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768674849724,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768674849724,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2493ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:33:55
   Duration  19.43s (transform 6.01s, setup 2.19s, import 8.70s, tests 2.49s, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x1 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674897655,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674901327,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768674901376,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768674903579,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674903598,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768674903588,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674903588,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674903593,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674903593,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674903597,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674903597,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674903598,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674903598,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674903795,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768674903807,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768674903808,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2483ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:34:50
   Duration  13.02s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x2 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675043646,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675046803,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675046848,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w0_v3", public;\n' +
    '\n' +
    `CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> st'... 111275 more characters,
  params: [],
  cause: error: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 264,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key (typname, typnamespace)=(anonymous_access_type, 2456483) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'pg_catalog',
    table: 'pg_type',
    column: undefined,
    dataType: undefined,
    constraint: 'pg_type_typname_nsp_index',
    file: 'nbtinsert.c',
    line: '667',
    routine: '_bt_check_unique'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675050108,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675050126,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675050116,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675050117,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675050121,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675050121,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675050125,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675050125,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675050126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675050126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768675050455,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675050466,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675050467,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4626ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:37:13
   Duration  16.19s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x3 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675167824,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675171367,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675171418,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675173260,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675173279,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675173269,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675173269,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675173273,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675173274,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675173278,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675173278,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675173279,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675173279,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675173861,"env":"test","module":"user-credentials-repository","userId":"ef8f1867-2865-4045-9dee-e857704e6222","msg":"User credentials created"}
{"level":30,"time":1768675173993,"env":"test","module":"email-queue","jobId":"b1e2378c-342f-478c-b178-00807a356b0f","to":"test-oaZUQtuONNPrcrH4k2Lwj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675173997,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675174007,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675174007,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: JWT_SECRET is not defined
    at AuthService.createToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:72:9)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:248:33
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3571ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:39:17
   Duration  16.40s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x4 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675269861,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768675281555,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675286885,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768675288520,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675288532,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675288525,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675288526,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675288528,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675288528,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675288532,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675288532,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675288532,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675288532,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675289021,"env":"test","module":"user-credentials-repository","userId":"4086cac3-e61a-4365-9a01-7811d93d62da","msg":"User credentials created"}
{"level":30,"time":1768675289138,"env":"test","module":"email-queue","jobId":"df42ccfa-4b19-4cc7-bd9d-67ac7b0d30cc","to":"test-ndLoYs7gWddFLWrGF8D9X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675289195,"env":"test","module":"auth-routes","userId":"4086cac3-e61a-4365-9a01-7811d93d62da","email":"test-ndLoYs7gWddFLWrGF8D9X@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675289900,"env":"test","module":"user-credentials-repository","userId":"2e07f82d-f879-4142-857f-ca877981f21c","msg":"User credentials created"}
{"level":30,"time":1768675290044,"env":"test","module":"email-queue","jobId":"1b9262c5-00a3-42d0-ba43-1476417fbc5b","to":"protected-test-QtayIvv0ha4PY0ZKCtU1G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675290100,"env":"test","module":"auth-routes","userId":"2e07f82d-f879-4142-857f-ca877981f21c","email":"protected-test-QtayIvv0ha4PY0ZKCtU1G@example.com","msg":"User registered"}
{"level":30,"time":1768675290791,"env":"test","module":"auth-routes","userId":"2e07f82d-f879-4142-857f-ca877981f21c","msg":"User logged in successfully"}
{"level":30,"time":1768675290856,"env":"test","module":"audit-log-service","userId":"2e07f82d-f879-4142-857f-ca877981f21c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768675291338,"env":"test","module":"user-credentials-repository","userId":"11eb8db4-e67d-4753-807a-6c3b4c83f5a4","msg":"User credentials created"}
{"level":30,"time":1768675291459,"env":"test","module":"email-queue","jobId":"a6cc0d74-f7df-4cee-9fd2-ad32e7aae904","to":"protected-test-hMJkzypATGbMmu6fGbD0Z@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675291517,"env":"test","module":"auth-routes","userId":"11eb8db4-e67d-4753-807a-6c3b4c83f5a4","email":"protected-test-hMJkzypATGbMmu6fGbD0Z@example.com","msg":"User registered"}
{"level":30,"time":1768675292239,"env":"test","module":"auth-routes","userId":"11eb8db4-e67d-4753-807a-6c3b4c83f5a4","msg":"User logged in successfully"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768675292297,"env":"test","module":"audit-log-service","userId":"11eb8db4-e67d-4753-807a-6c3b4c83f5a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675292302,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675292713,"env":"test","module":"user-credentials-repository","userId":"bfd54948-3cfe-40cf-8156-270312d104e6","msg":"User credentials created"}
{"level":30,"time":1768675292826,"env":"test","module":"email-queue","jobId":"617a1b30-21f4-4b4d-a57e-1d8a8d693b03","to":"protected-test-X_WOqIwxgF7fIQmQkLYKN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675292887,"env":"test","module":"auth-routes","userId":"bfd54948-3cfe-40cf-8156-270312d104e6","email":"protected-test-X_WOqIwxgF7fIQmQkLYKN@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675293614,"env":"test","module":"auth-routes","userId":"bfd54948-3cfe-40cf-8156-270312d104e6","msg":"User logged in successfully"}
{"level":30,"time":1768675293673,"env":"test","module":"audit-log-service","userId":"bfd54948-3cfe-40cf-8156-270312d104e6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675293677,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675294084,"env":"test","module":"user-credentials-repository","userId":"b11f4596-c914-4d27-8d02-af95a24ec885","msg":"User credentials created"}
{"level":30,"time":1768675294203,"env":"test","module":"email-queue","jobId":"aa06f16f-ea14-4711-bef2-c827f8d86f1c","to":"protected-test-QpUTA5VPpp-Y3SmssDSwf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675294258,"env":"test","module":"auth-routes","userId":"b11f4596-c914-4d27-8d02-af95a24ec885","email":"protected-test-QpUTA5VPpp-Y3SmssDSwf@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675294946,"env":"test","module":"auth-routes","userId":"b11f4596-c914-4d27-8d02-af95a24ec885","msg":"User logged in successfully"}
{"level":30,"time":1768675295004,"env":"test","module":"audit-log-service","userId":"b11f4596-c914-4d27-8d02-af95a24ec885","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675295009,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675295432,"env":"test","module":"user-credentials-repository","userId":"4b3df8de-f036-4a34-aaaf-6267d72dc0b1","msg":"User credentials created"}
{"level":30,"time":1768675295543,"env":"test","module":"email-queue","jobId":"c4c86b7b-7f1b-4a94-b200-640c7a910b22","to":"protected-test-02lqoR2cuAuVmyXtv-bdr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675295601,"env":"test","module":"auth-routes","userId":"4b3df8de-f036-4a34-aaaf-6267d72dc0b1","email":"protected-test-02lqoR2cuAuVmyXtv-bdr@example.com","msg":"User registered"}
{"level":30,"time":1768675296297,"env":"test","module":"auth-routes","userId":"4b3df8de-f036-4a34-aaaf-6267d72dc0b1","msg":"User logged in successfully"}
{"level":30,"time":1768675296352,"env":"test","module":"audit-log-service","userId":"4b3df8de-f036-4a34-aaaf-6267d72dc0b1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675296356,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675296356,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675296759,"env":"test","module":"user-credentials-repository","userId":"18b8dd9c-311f-4d89-8a4f-06d53ac6ae57","msg":"User credentials created"}
{"level":30,"time":1768675296872,"env":"test","module":"email-queue","jobId":"4b8b162d-913e-4345-b15a-532a5dd73f7a","to":"protected-test-uRSJaBDvO0D_rDfBtg9PI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675296935,"env":"test","module":"auth-routes","userId":"18b8dd9c-311f-4d89-8a4f-06d53ac6ae57","email":"protected-test-uRSJaBDvO0D_rDfBtg9PI@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675297600,"env":"test","module":"auth-routes","userId":"18b8dd9c-311f-4d89-8a4f-06d53ac6ae57","msg":"User logged in successfully"}
{"level":30,"time":1768675297662,"env":"test","module":"audit-log-service","userId":"18b8dd9c-311f-4d89-8a4f-06d53ac6ae57","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675298159,"env":"test","module":"user-credentials-repository","userId":"448dfc78-9af1-455e-a730-11a8454af5dc","msg":"User credentials created"}
{"level":30,"time":1768675298281,"env":"test","module":"email-queue","jobId":"730d4289-573d-41c3-b226-60cee09f62ea","to":"protected-test-eJOhfSWbpiKRM6A4HM51j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675298342,"env":"test","module":"auth-routes","userId":"448dfc78-9af1-455e-a730-11a8454af5dc","email":"protected-test-eJOhfSWbpiKRM6A4HM51j@example.com","msg":"User registered"}
{"level":30,"time":1768675299030,"env":"test","module":"auth-routes","userId":"448dfc78-9af1-455e-a730-11a8454af5dc","msg":"User logged in successfully"}
{"level":30,"time":1768675299092,"env":"test","module":"audit-log-service","userId":"448dfc78-9af1-455e-a730-11a8454af5dc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675299096,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675299499,"env":"test","module":"user-credentials-repository","userId":"8796b551-8d4c-43e1-8070-6c84da1b3d55","msg":"User credentials created"}
{"level":30,"time":1768675299616,"env":"test","module":"email-queue","jobId":"2bdef026-d740-4f2a-bf0e-c1e7f8c7f90c","to":"protected-test-TeJU7VUwxlxw0FiriglN2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675299676,"env":"test","module":"auth-routes","userId":"8796b551-8d4c-43e1-8070-6c84da1b3d55","email":"protected-test-TeJU7VUwxlxw0FiriglN2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675300387,"env":"test","module":"auth-routes","userId":"8796b551-8d4c-43e1-8070-6c84da1b3d55","msg":"User logged in successfully"}
{"level":30,"time":1768675300443,"env":"test","module":"audit-log-service","userId":"8796b551-8d4c-43e1-8070-6c84da1b3d55","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675300447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675300849,"env":"test","module":"user-credentials-repository","userId":"ccc1e044-185b-481d-b403-8d54e98356d2","msg":"User credentials created"}
{"level":30,"time":1768675300961,"env":"test","module":"email-queue","jobId":"b48b9596-1ee1-4e4b-963a-8cb9d7c27416","to":"protected-test-TRlfl9AsUqwKualH_oPo3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675301016,"env":"test","module":"auth-routes","userId":"ccc1e044-185b-481d-b403-8d54e98356d2","email":"protected-test-TRlfl9AsUqwKualH_oPo3@example.com","msg":"User registered"}
{"level":30,"time":1768675301678,"env":"test","module":"auth-routes","userId":"ccc1e044-185b-481d-b403-8d54e98356d2","msg":"User logged in successfully"}
{"level":30,"time":1768675301733,"env":"test","module":"audit-log-service","userId":"ccc1e044-185b-481d-b403-8d54e98356d2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=ccc1e044-185b-481d-b403-8d54e98356d2, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T18:41:41.852Z"}
{"level":30,"time":1768675302297,"env":"test","module":"user-credentials-repository","userId":"340a594d-3d2c-426d-bdbf-a80c8829e9c4","msg":"User credentials created"}
{"level":30,"time":1768675302410,"env":"test","module":"email-queue","jobId":"521b0d89-2804-4b20-8fa6-f9aa157f42a6","to":"protected-test-onYQSZeR7hKf0KhPoqhcl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675302466,"env":"test","module":"auth-routes","userId":"340a594d-3d2c-426d-bdbf-a80c8829e9c4","email":"protected-test-onYQSZeR7hKf0KhPoqhcl@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675303202,"env":"test","module":"auth-routes","userId":"340a594d-3d2c-426d-bdbf-a80c8829e9c4","msg":"User logged in successfully"}
{"level":30,"time":1768675303261,"env":"test","module":"audit-log-service","userId":"340a594d-3d2c-426d-bdbf-a80c8829e9c4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675303266,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675303666,"env":"test","module":"user-credentials-repository","userId":"e183a9b4-1a59-49ed-9f51-f83bd16b0c2a","msg":"User credentials created"}
{"level":30,"time":1768675303793,"env":"test","module":"email-queue","jobId":"75d5c242-426b-4eb5-b0cf-114b58b4c29e","to":"protected-test-qGgkzGvPD20dCsPoaicqJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675303855,"env":"test","module":"auth-routes","userId":"e183a9b4-1a59-49ed-9f51-f83bd16b0c2a","email":"protected-test-qGgkzGvPD20dCsPoaicqJ@example.com","msg":"User registered"}
{"level":30,"time":1768675304533,"env":"test","module":"auth-routes","userId":"e183a9b4-1a59-49ed-9f51-f83bd16b0c2a","msg":"User logged in successfully"}
{"level":30,"time":1768675304589,"env":"test","module":"audit-log-service","userId":"e183a9b4-1a59-49ed-9f51-f83bd16b0c2a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675305205,"env":"test","module":"user-credentials-repository","userId":"115e1a57-9481-4730-bf1f-07d6a3ad355b","msg":"User credentials created"}
{"level":30,"time":1768675305324,"env":"test","module":"email-queue","jobId":"829a2018-822c-444f-a6fd-07ff891da97c","to":"protected-test-2pBVwUdVsqPDnG1GF0Y5n@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675305385,"env":"test","module":"auth-routes","userId":"115e1a57-9481-4730-bf1f-07d6a3ad355b","email":"protected-test-2pBVwUdVsqPDnG1GF0Y5n@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675306090,"env":"test","module":"auth-routes","userId":"115e1a57-9481-4730-bf1f-07d6a3ad355b","msg":"User logged in successfully"}
{"level":30,"time":1768675306148,"env":"test","module":"audit-log-service","userId":"115e1a57-9481-4730-bf1f-07d6a3ad355b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675306154,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675306564,"env":"test","module":"user-credentials-repository","userId":"19ff3e61-149d-4cbe-8bb6-c0792924b2af","msg":"User credentials created"}
{"level":30,"time":1768675306677,"env":"test","module":"email-queue","jobId":"43f63514-65ce-4f4c-8cce-9d253dcef1f5","to":"protected-test-Y6EYwT4AfVWWZ4v5lPsgn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675306735,"env":"test","module":"auth-routes","userId":"19ff3e61-149d-4cbe-8bb6-c0792924b2af","email":"protected-test-Y6EYwT4AfVWWZ4v5lPsgn@example.com","msg":"User registered"}
{"level":30,"time":1768675307419,"env":"test","module":"auth-routes","userId":"19ff3e61-149d-4cbe-8bb6-c0792924b2af","msg":"User logged in successfully"}
{"level":30,"time":1768675307478,"env":"test","module":"audit-log-service","userId":"19ff3e61-149d-4cbe-8bb6-c0792924b2af","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675308682,"env":"test","module":"user-credentials-repository","userId":"f8bdb174-3b19-4826-b763-25b5002bfab4","msg":"User credentials created"}
{"level":30,"time":1768675308799,"env":"test","module":"email-queue","jobId":"e6b0bd42-a696-4274-b309-d88b2b8d9856","to":"protected-test-N-6YZ6L4aiKVrinWSD2Ge@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675308859,"env":"test","module":"auth-routes","userId":"f8bdb174-3b19-4826-b763-25b5002bfab4","email":"protected-test-N-6YZ6L4aiKVrinWSD2Ge@example.com","msg":"User registered"}
{"level":30,"time":1768675309567,"env":"test","module":"auth-routes","userId":"f8bdb174-3b19-4826-b763-25b5002bfab4","msg":"User logged in successfully"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675309629,"env":"test","module":"audit-log-service","userId":"f8bdb174-3b19-4826-b763-25b5002bfab4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675309633,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675310046,"env":"test","module":"user-credentials-repository","userId":"f7b3e7f9-f10b-4ef0-af92-0a3283af2a5e","msg":"User credentials created"}
{"level":30,"time":1768675310164,"env":"test","module":"email-queue","jobId":"30eea6d6-08eb-48a6-a0f0-1f77db7e9cde","to":"protected-test-92vzY_LfQa-YbOBp7QJ-2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675310226,"env":"test","module":"auth-routes","userId":"f7b3e7f9-f10b-4ef0-af92-0a3283af2a5e","email":"protected-test-92vzY_LfQa-YbOBp7QJ-2@example.com","msg":"User registered"}
{"level":30,"time":1768675310914,"env":"test","module":"auth-routes","userId":"f7b3e7f9-f10b-4ef0-af92-0a3283af2a5e","msg":"User logged in successfully"}
{"level":30,"time":1768675310971,"env":"test","module":"audit-log-service","userId":"f7b3e7f9-f10b-4ef0-af92-0a3283af2a5e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675310975,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675310975,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675311449,"env":"test","module":"user-credentials-repository","userId":"ecdf9a54-6d91-411c-9c08-759757c70f8a","msg":"User credentials created"}
{"level":30,"time":1768675311563,"env":"test","module":"email-queue","jobId":"e28421ad-e9c7-42ea-9a18-2b335cf23e7d","to":"protected-test-ztRxJcsOqMH6gvZcr5kn3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675311620,"env":"test","module":"auth-routes","userId":"ecdf9a54-6d91-411c-9c08-759757c70f8a","email":"protected-test-ztRxJcsOqMH6gvZcr5kn3@example.com","msg":"User registered"}
{"level":30,"time":1768675312355,"env":"test","module":"auth-routes","userId":"ecdf9a54-6d91-411c-9c08-759757c70f8a","msg":"User logged in successfully"}
{"level":30,"time":1768675312412,"env":"test","module":"audit-log-service","userId":"ecdf9a54-6d91-411c-9c08-759757c70f8a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675312416,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675312840,"env":"test","module":"user-credentials-repository","userId":"cb80af11-9231-4c41-9449-803b0cd9da8a","msg":"User credentials created"}
{"level":30,"time":1768675312962,"env":"test","module":"email-queue","jobId":"22ff7b84-6e3e-4715-ae5c-cfc92ad29a9a","to":"protected-test-q-85G2UULIPvw_TYwSVxV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675313023,"env":"test","module":"auth-routes","userId":"cb80af11-9231-4c41-9449-803b0cd9da8a","email":"protected-test-q-85G2UULIPvw_TYwSVxV@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675313722,"env":"test","module":"auth-routes","userId":"cb80af11-9231-4c41-9449-803b0cd9da8a","msg":"User logged in successfully"}
{"level":30,"time":1768675313779,"env":"test","module":"audit-log-service","userId":"cb80af11-9231-4c41-9449-803b0cd9da8a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675313782,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675314203,"env":"test","module":"user-credentials-repository","userId":"6a50cdb1-0424-4780-8ec2-8ee2a0d4f1e0","msg":"User credentials created"}
{"level":30,"time":1768675314318,"env":"test","module":"email-queue","jobId":"fb8c6dcb-7017-49b1-9b09-574252e65f21","to":"protected-test-G-xvHy0RlUP8KGa_UK_Rm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675314376,"env":"test","module":"auth-routes","userId":"6a50cdb1-0424-4780-8ec2-8ee2a0d4f1e0","email":"protected-test-G-xvHy0RlUP8KGa_UK_Rm@example.com","msg":"User registered"}
{"level":30,"time":1768675315067,"env":"test","module":"auth-routes","userId":"6a50cdb1-0424-4780-8ec2-8ee2a0d4f1e0","msg":"User logged in successfully"}
{"level":30,"time":1768675315128,"env":"test","module":"audit-log-service","userId":"6a50cdb1-0424-4780-8ec2-8ee2a0d4f1e0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675315131,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675315528,"env":"test","module":"user-credentials-repository","userId":"44d54fc8-8c5b-4c7d-944e-2bd808bc7e66","msg":"User credentials created"}
{"level":30,"time":1768675315649,"env":"test","module":"email-queue","jobId":"9bb6a7a0-4d63-4ad7-9971-5404be0847fa","to":"protected-test-d3DvgXZhrizX2DfxKdiCi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675315711,"env":"test","module":"auth-routes","userId":"44d54fc8-8c5b-4c7d-944e-2bd808bc7e66","email":"protected-test-d3DvgXZhrizX2DfxKdiCi@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675316372,"env":"test","module":"auth-routes","userId":"44d54fc8-8c5b-4c7d-944e-2bd808bc7e66","msg":"User logged in successfully"}
{"level":30,"time":1768675316428,"env":"test","module":"audit-log-service","userId":"44d54fc8-8c5b-4c7d-944e-2bd808bc7e66","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675316431,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675316842,"env":"test","module":"user-credentials-repository","userId":"24a26df9-b4b7-4c5f-8f9b-ad3fad20d9b4","msg":"User credentials created"}
{"level":30,"time":1768675316957,"env":"test","module":"email-queue","jobId":"547b6391-0393-474d-91b9-eee1a432e56a","to":"protected-test-BrZg6usO3UwvJbT7SexJh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675317014,"env":"test","module":"auth-routes","userId":"24a26df9-b4b7-4c5f-8f9b-ad3fad20d9b4","email":"protected-test-BrZg6usO3UwvJbT7SexJh@example.com","msg":"User registered"}
{"level":30,"time":1768675317705,"env":"test","module":"auth-routes","userId":"24a26df9-b4b7-4c5f-8f9b-ad3fad20d9b4","msg":"User logged in successfully"}
{"level":30,"time":1768675317760,"env":"test","module":"audit-log-service","userId":"24a26df9-b4b7-4c5f-8f9b-ad3fad20d9b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675317763,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675318166,"env":"test","module":"user-credentials-repository","userId":"e2f85654-09f9-4b8a-949e-b1a30a38db6a","msg":"User credentials created"}
{"level":30,"time":1768675318285,"env":"test","module":"email-queue","jobId":"d38358c7-7318-4614-8798-c924e68e3458","to":"protected-test-0ZMug0DJY9kxwu8S7R-Gz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675318372,"env":"test","module":"auth-routes","userId":"e2f85654-09f9-4b8a-949e-b1a30a38db6a","email":"protected-test-0ZMug0DJY9kxwu8S7R-Gz@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675319063,"env":"test","module":"auth-routes","userId":"e2f85654-09f9-4b8a-949e-b1a30a38db6a","msg":"User logged in successfully"}
{"level":30,"time":1768675319124,"env":"test","module":"audit-log-service","userId":"e2f85654-09f9-4b8a-949e-b1a30a38db6a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675319127,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675319536,"env":"test","module":"user-credentials-repository","userId":"3fcf121d-02f9-4e72-adad-1e3a08092419","msg":"User credentials created"}
{"level":30,"time":1768675319651,"env":"test","module":"email-queue","jobId":"c600312d-5fa1-464e-ba5f-d14565a80abc","to":"protected-test-mtUX_0snU1IhjrbSTAEhj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675319707,"env":"test","module":"auth-routes","userId":"3fcf121d-02f9-4e72-adad-1e3a08092419","email":"protected-test-mtUX_0snU1IhjrbSTAEhj@example.com","msg":"User registered"}
{"level":30,"time":1768675320441,"env":"test","module":"auth-routes","userId":"3fcf121d-02f9-4e72-adad-1e3a08092419","msg":"User logged in successfully"}
{"level":30,"time":1768675320508,"env":"test","module":"audit-log-service","userId":"3fcf121d-02f9-4e72-adad-1e3a08092419","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675320924,"env":"test","module":"user-credentials-repository","userId":"3695b145-dcba-408e-b772-c9c6f8ced891","msg":"User credentials created"}
{"level":30,"time":1768675321038,"env":"test","module":"email-queue","jobId":"5e70a1e0-52ce-4a3b-bb5c-40b7b1bb2e08","to":"protected-test-g0kZia2WMDL-_29aiugI_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675321092,"env":"test","module":"auth-routes","userId":"3695b145-dcba-408e-b772-c9c6f8ced891","email":"protected-test-g0kZia2WMDL-_29aiugI_@example.com","msg":"User registered"}
{"level":30,"time":1768675321787,"env":"test","module":"auth-routes","userId":"3695b145-dcba-408e-b772-c9c6f8ced891","msg":"User logged in successfully"}
{"level":30,"time":1768675321850,"env":"test","module":"audit-log-service","userId":"3695b145-dcba-408e-b772-c9c6f8ced891","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675322393,"env":"test","module":"user-credentials-repository","userId":"47b22490-d3b6-4637-84e0-c6c9293b08c9","msg":"User credentials created"}
{"level":30,"time":1768675322517,"env":"test","module":"email-queue","jobId":"fab8b817-1f0c-4ef5-986d-72d80ec70d5a","to":"protected-test-lBZPq36EioPTVhRgN6Q_g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675322578,"env":"test","module":"auth-routes","userId":"47b22490-d3b6-4637-84e0-c6c9293b08c9","email":"protected-test-lBZPq36EioPTVhRgN6Q_g@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675323274,"env":"test","module":"auth-routes","userId":"47b22490-d3b6-4637-84e0-c6c9293b08c9","msg":"User logged in successfully"}
{"level":30,"time":1768675323336,"env":"test","module":"audit-log-service","userId":"47b22490-d3b6-4637-84e0-c6c9293b08c9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675323740,"env":"test","module":"user-credentials-repository","userId":"911528f2-db73-4a89-8d2e-ba2f910506a1","msg":"User credentials created"}
{"level":30,"time":1768675323861,"env":"test","module":"email-queue","jobId":"9d945b82-cb7f-4b35-882a-b14021684b14","to":"user2-j_FSZx5XBhiV0SHPpmOb-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675323918,"env":"test","module":"auth-routes","userId":"911528f2-db73-4a89-8d2e-ba2f910506a1","email":"user2-j_FSZx5XBhiV0SHPpmOb-@example.com","msg":"User registered"}
{"level":30,"time":1768675324533,"env":"test","module":"auth-routes","userId":"911528f2-db73-4a89-8d2e-ba2f910506a1","msg":"User logged in successfully"}
{"level":30,"time":1768675324601,"env":"test","module":"audit-log-service","userId":"911528f2-db73-4a89-8d2e-ba2f910506a1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675324677,"env":"test","module":"rbac-middleware","userId":"911528f2-db73-4a89-8d2e-ba2f910506a1","userRole":"viewer","permission":"project:delete","path":"/dada64d6-e097-428f-a2ea-996b44e084b4","msg":"Permission denied"}
{"level":30,"time":1768675325074,"env":"test","module":"user-credentials-repository","userId":"608844a7-0963-4e45-bb2a-bd3fc67d31d9","msg":"User credentials created"}
{"level":30,"time":1768675325199,"env":"test","module":"email-queue","jobId":"50173a7e-c8b8-4e08-950c-e11993c77580","to":"protected-test-WKeAAhsSguGBy0g6ytYxf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675325261,"env":"test","module":"auth-routes","userId":"608844a7-0963-4e45-bb2a-bd3fc67d31d9","email":"protected-test-WKeAAhsSguGBy0g6ytYxf@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675325962,"env":"test","module":"auth-routes","userId":"608844a7-0963-4e45-bb2a-bd3fc67d31d9","msg":"User logged in successfully"}
{"level":30,"time":1768675326019,"env":"test","module":"audit-log-service","userId":"608844a7-0963-4e45-bb2a-bd3fc67d31d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675326491,"env":"test","module":"user-credentials-repository","userId":"85aba9e7-6aff-49d7-9a5e-657d56c8c2b0","msg":"User credentials created"}
{"level":30,"time":1768675326612,"env":"test","module":"email-queue","jobId":"7fe0e8e9-ea7f-4cd2-ad0b-419c9f4adecc","to":"protected-test-FMoU1RXuuXiTxEjcfJEz7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675326673,"env":"test","module":"auth-routes","userId":"85aba9e7-6aff-49d7-9a5e-657d56c8c2b0","email":"protected-test-FMoU1RXuuXiTxEjcfJEz7@example.com","msg":"User registered"}
{"level":30,"time":1768675327357,"env":"test","module":"auth-routes","userId":"85aba9e7-6aff-49d7-9a5e-657d56c8c2b0","msg":"User logged in successfully"}
{"level":30,"time":1768675327412,"env":"test","module":"audit-log-service","userId":"85aba9e7-6aff-49d7-9a5e-657d56c8c2b0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675327864,"env":"test","module":"user-credentials-repository","userId":"be3995cd-84a7-4940-a845-af8ceac53f77","msg":"User credentials created"}
{"level":30,"time":1768675327982,"env":"test","module":"email-queue","jobId":"a2e5af47-1b68-44ed-9861-482abd88938f","to":"protected-test-79Xehnu5FZvyt22enJzla@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675328038,"env":"test","module":"auth-routes","userId":"be3995cd-84a7-4940-a845-af8ceac53f77","email":"protected-test-79Xehnu5FZvyt22enJzla@example.com","msg":"User registered"}
{"level":30,"time":1768675328715,"env":"test","module":"auth-routes","userId":"be3995cd-84a7-4940-a845-af8ceac53f77","msg":"User logged in successfully"}
{"level":30,"time":1768675328769,"env":"test","module":"audit-log-service","userId":"be3995cd-84a7-4940-a845-af8ceac53f77","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675329227,"env":"test","module":"user-credentials-repository","userId":"cfdaaac0-bb06-4775-ad10-c1a35c793d53","msg":"User credentials created"}
{"level":30,"time":1768675329339,"env":"test","module":"email-queue","jobId":"247773d2-a508-4e10-a3ae-a9d4e7af6bd6","to":"protected-test-lP6pzltGkFZtDI0kVCwYa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675329396,"env":"test","module":"auth-routes","userId":"cfdaaac0-bb06-4775-ad10-c1a35c793d53","email":"protected-test-lP6pzltGkFZtDI0kVCwYa@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675330080,"env":"test","module":"auth-routes","userId":"cfdaaac0-bb06-4775-ad10-c1a35c793d53","msg":"User logged in successfully"}
{"level":30,"time":1768675330137,"env":"test","module":"audit-log-service","userId":"cfdaaac0-bb06-4775-ad10-c1a35c793d53","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675330989,"env":"test","module":"user-credentials-repository","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","msg":"User credentials created"}
{"level":30,"time":1768675331102,"env":"test","module":"email-queue","jobId":"a45f6a45-5ac6-4b3f-ac01-b2397b233338","to":"protected-test-q_L4lDbg1PEwp2db7mQ4y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675331162,"env":"test","module":"auth-routes","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","email":"protected-test-q_L4lDbg1PEwp2db7mQ4y@example.com","msg":"User registered"}
{"level":30,"time":1768675331873,"env":"test","module":"auth-routes","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","msg":"User logged in successfully"}
{"level":30,"time":1768675331931,"env":"test","module":"audit-log-service","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675332525,"env":"test","module":"auth-routes","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","msg":"User logged in successfully"}
{"level":30,"time":1768675332586,"env":"test","module":"audit-log-service","userId":"1a98de4e-fb95-4d50-bf28-c2bbe850cdf5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675333071,"env":"test","module":"user-credentials-repository","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","msg":"User credentials created"}
{"level":30,"time":1768675333185,"env":"test","module":"email-queue","jobId":"cacebb84-4155-4790-af12-3cdd4e8f7eb3","to":"protected-test-d3i2qsMuXjud2tBTf-Hl9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675333251,"env":"test","module":"auth-routes","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","email":"protected-test-d3i2qsMuXjud2tBTf-Hl9@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675333970,"env":"test","module":"auth-routes","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","msg":"User logged in successfully"}
{"level":30,"time":1768675334025,"env":"test","module":"audit-log-service","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675334590,"env":"test","module":"auth-routes","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","msg":"User logged in successfully"}
{"level":30,"time":1768675334650,"env":"test","module":"audit-log-service","userId":"8569b91b-0664-48a6-af3f-62d1cca76ffc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675335066,"env":"test","module":"user-credentials-repository","userId":"cba225a3-1cef-41de-a4fe-c8034cb1aeb4","msg":"User credentials created"}
{"level":30,"time":1768675335183,"env":"test","module":"email-queue","jobId":"652009c9-dcc9-4310-bbb7-ba16308c07ae","to":"user2-vJOEZQx8VBo41CZPDo64m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675335238,"env":"test","module":"auth-routes","userId":"cba225a3-1cef-41de-a4fe-c8034cb1aeb4","email":"user2-vJOEZQx8VBo41CZPDo64m@example.com","msg":"User registered"}
{"level":30,"time":1768675335807,"env":"test","module":"auth-routes","userId":"cba225a3-1cef-41de-a4fe-c8034cb1aeb4","msg":"User logged in successfully"}
{"level":30,"time":1768675335864,"env":"test","module":"audit-log-service","userId":"cba225a3-1cef-41de-a4fe-c8034cb1aeb4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675336421,"env":"test","module":"user-credentials-repository","userId":"2608cc6a-1259-498e-ad13-d129484b347d","msg":"User credentials created"}
{"level":30,"time":1768675336536,"env":"test","module":"email-queue","jobId":"130961f5-b5f0-4a3c-921a-e59873ae03d2","to":"protected-test-fv6i-981DeyuIMaEDZGvK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675336594,"env":"test","module":"auth-routes","userId":"2608cc6a-1259-498e-ad13-d129484b347d","email":"protected-test-fv6i-981DeyuIMaEDZGvK@example.com","msg":"User registered"}
{"level":30,"time":1768675337285,"env":"test","module":"auth-routes","userId":"2608cc6a-1259-498e-ad13-d129484b347d","msg":"User logged in successfully"}
{"level":30,"time":1768675337343,"env":"test","module":"audit-log-service","userId":"2608cc6a-1259-498e-ad13-d129484b347d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675337928,"env":"test","module":"intake-service","runId":"4fac44f4-9c7c-4425-94ff-2768122f9a7b","slug":"public-jaA6OYR10tABIIh6PllnZ","msg":"Created intake run"}
{"level":30,"time":1768675338375,"env":"test","module":"user-credentials-repository","userId":"1e798cb7-1edb-4b5d-a78d-141470106cf2","msg":"User credentials created"}
{"level":30,"time":1768675338507,"env":"test","module":"email-queue","jobId":"ba292177-1d38-4fb3-b57c-a999b0c7fe3c","to":"protected-test-SUbhwDwUA-Yte7-ZuJCn7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675338565,"env":"test","module":"auth-routes","userId":"1e798cb7-1edb-4b5d-a78d-141470106cf2","email":"protected-test-SUbhwDwUA-Yte7-ZuJCn7@example.com","msg":"User registered"}
{"level":30,"time":1768675339245,"env":"test","module":"auth-routes","userId":"1e798cb7-1edb-4b5d-a78d-141470106cf2","msg":"User logged in successfully"}
{"level":30,"time":1768675339305,"env":"test","module":"audit-log-service","userId":"1e798cb7-1edb-4b5d-a78d-141470106cf2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675339892,"env":"test","module":"intake-service","runId":"ba364439-b4b8-4928-9916-eea6c050fd95","slug":"optional-qvp6FSM1XSlE4VXG042vl","userId":"1e798cb7-1edb-4b5d-a78d-141470106cf2","msg":"Created intake run"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675340324,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675340325,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ£ô tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 59672ms
       Γ£ô should allow access with valid Bearer token  1418ms
       Γ£ô should reject access without Authorization header  1382ms
       Γ£ô should reject access with empty Bearer token  1374ms
       Γ£ô should reject access with malformed Authorization header  1332ms
       Γ£ô should reject access with wrong token type  1347ms
       Γ£ô should allow POST with valid Bearer token  1363ms
       Γ£ô should reject POST without Bearer token  1376ms
       Γ£ô should reject POST with invalid token  1352ms
       Γ£ô should allow PUT with valid Bearer token  1462ms
       Γ£ô should reject PUT without Bearer token  1357ms
       Γ£ô should allow DELETE with valid Bearer token  1503ms
       Γ£ô should reject DELETE without Bearer token  1385ms
       Γ£ô should allow PATCH with valid Bearer token  2106ms
       Γ£ô should reject PATCH without Bearer token  1372ms
       Γ£ô should handle Bearer token with extra spaces  1342ms
       Γ£ô should handle very long invalid token  1442ms
       Γ£ô should handle empty Authorization header  1366ms
       Γ£ô should handle Authorization header with only Bearer  1349ms
       Γ£ô should handle multiple Authorization headers  1301ms
       Γ£ô should reject token with SQL injection attempt  1331ms
       Γ£ô should reject token with XSS attempt  1363ms
       Γ£ô should reject token with missing userId  1387ms
       Γ£ô should reject token with non-existent userId  1465ms
       Γ£ô should not allow user to access another user's resources  2698ms
       Γ£ô should inject userId into request context  1402ms
       Γ£ô should inject tenantId into request context  1392ms
       Γ£ô should inject role into request context  1359ms
       Γ£ô should not apply general rate limiting to authenticated requests  1732ms
       Γ£ô should handle request with both Bearer token and cookies  2081ms
       Γ£ô should prioritize Bearer token over cookie when both present  3334ms
       Γ£ô should allow unauthenticated access to optional auth routes  2009ms
       Γ£ô should enhance optional auth routes with user context when authenticated  2022ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  12:40:53
   Duration  83.89s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x5 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675488456,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675493546,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675493600,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675495379,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675495394,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675495386,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675495387,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675495390,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675495390,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675495394,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675495394,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675495394,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675495394,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675495909,"env":"test","module":"user-credentials-repository","userId":"0452169e-0028-493a-b1d1-c57edebea620","msg":"User credentials created"}
{"level":30,"time":1768675496042,"env":"test","module":"email-queue","jobId":"f82ecbe1-3d30-4e13-86a9-2143346524e6","to":"test-PjZL4EJVIF6h9WqLQ0TqL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675496112,"env":"test","module":"auth-routes","userId":"0452169e-0028-493a-b1d1-c57edebea620","email":"test-PjZL4EJVIF6h9WqLQ0TqL@example.com","msg":"User registered"}
{"level":30,"time":1768675496857,"env":"test","module":"user-credentials-repository","userId":"1f870e97-78c3-47c0-909d-2d10a80e244e","msg":"User credentials created"}
{"level":30,"time":1768675496977,"env":"test","module":"email-queue","jobId":"521406e9-990b-4b75-84fc-353d258ccdc6","to":"protected-test-cFlSjWcBAagkm8xwf0m0d@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675497038,"env":"test","module":"auth-routes","userId":"1f870e97-78c3-47c0-909d-2d10a80e244e","email":"protected-test-cFlSjWcBAagkm8xwf0m0d@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675497739,"env":"test","module":"auth-routes","userId":"1f870e97-78c3-47c0-909d-2d10a80e244e","msg":"User logged in successfully"}
{"level":30,"time":1768675497800,"env":"test","module":"audit-log-service","userId":"1f870e97-78c3-47c0-909d-2d10a80e244e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675498297,"env":"test","module":"user-credentials-repository","userId":"7ebc12d7-cef0-4f6b-9846-0ac1c3b89a97","msg":"User credentials created"}
{"level":30,"time":1768675498421,"env":"test","module":"email-queue","jobId":"9de04f3d-9d62-483d-a476-5afd8f9e40cf","to":"protected-test-pMaGrXI6BGDuQoRZ-V8gV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675498482,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["7ebc12d7-cef0-4f6b-9846-0ac1c3b89a97","7036877cf72cf7f0b9d262b217577e399b190818509343aed9227595221467c2","2026-02-16T18:44:58.422Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:44:58.422Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7ebc12d7-cef0-4f6b-9846-0ac1c3b89a97) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675499157,"env":"test","module":"user-credentials-repository","userId":"884a9aaa-9a5a-48aa-82b4-d88dce295ac0","msg":"User credentials created"}
{"level":30,"time":1768675499256,"env":"test","module":"email-queue","jobId":"86c40da4-d685-45be-8ac7-a3c7f3989382","to":"protected-test-Gwj8hCC5md8cHhiUxCdWg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675499313,"env":"test","module":"auth-routes","userId":"884a9aaa-9a5a-48aa-82b4-d88dce295ac0","email":"protected-test-Gwj8hCC5md8cHhiUxCdWg@example.com","msg":"User registered"}
{"level":30,"time":1768675500177,"env":"test","module":"user-credentials-repository","userId":"a13575b8-1b01-4e96-84e5-4630b210b334","msg":"User credentials created"}
{"level":30,"time":1768675500299,"env":"test","module":"email-queue","jobId":"2c5ec03f-ab17-49db-8b41-170ebaa368fc","to":"protected-test-5HwjLcUR47hNubNj3YZlU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675500361,"env":"test","module":"auth-routes","userId":"a13575b8-1b01-4e96-84e5-4630b210b334","email":"protected-test-5HwjLcUR47hNubNj3YZlU@example.com","msg":"User registered"}
{"level":30,"time":1768675501060,"env":"test","module":"user-credentials-repository","userId":"a2fa7db7-f694-4453-80bd-d4c5ed5dc3a8","msg":"User credentials created"}
{"level":30,"time":1768675501147,"env":"test","module":"email-queue","jobId":"613521ef-cdcb-4f72-bcb4-667534cb14ae","to":"protected-test-Pe0ILJnasyKb8AjvG5HlR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675501199,"env":"test","module":"auth-routes","userId":"a2fa7db7-f694-4453-80bd-d4c5ed5dc3a8","email":"protected-test-Pe0ILJnasyKb8AjvG5HlR@example.com","msg":"User registered"}
{"level":50,"time":1768675502003,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0c52bc96-f3c2-43be-a301-b51bc070f893","$2b$12$4/0Ei4vIAf1UF2UydmqncOwrYFXrK6UzmRq5AAhdZ2iRQXCc3UySu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0c52bc96-f3c2-43be-a301-b51bc070f893) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0c52bc96-f3c2-43be-a301-b51bc070f893","msg":"Failed to create user credentials"}
{"level":50,"time":1768675502003,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0c52bc96-f3c2-43be-a301-b51bc070f893","$2b$12$4/0Ei4vIAf1UF2UydmqncOwrYFXrK6UzmRq5AAhdZ2iRQXCc3UySu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0c52bc96-f3c2-43be-a301-b51bc070f893) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675502650,"env":"test","module":"user-credentials-repository","userId":"e9704f0f-6578-4328-bf2d-e6904e090456","msg":"User credentials created"}
{"level":30,"time":1768675502747,"env":"test","module":"email-queue","jobId":"ebaf24b6-0b28-4de9-ba96-88e60f9f7773","to":"protected-test-lEKdGV6XTz7kUG1Kwoh6H@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502792,"env":"test","module":"auth-routes","userId":"e9704f0f-6578-4328-bf2d-e6904e090456","email":"protected-test-lEKdGV6XTz7kUG1Kwoh6H@example.com","msg":"User registered"}
{"level":30,"time":1768675503498,"env":"test","module":"user-credentials-repository","userId":"f2442a82-1807-472e-8847-82e1095438a5","msg":"User credentials created"}
{"level":30,"time":1768675503585,"env":"test","module":"email-queue","jobId":"07830367-657e-45bc-81a9-0bfc09f58226","to":"protected-test-F7jdtdylzG6-03w2mF_Sk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675503635,"env":"test","module":"auth-routes","userId":"f2442a82-1807-472e-8847-82e1095438a5","email":"protected-test-F7jdtdylzG6-03w2mF_Sk@example.com","msg":"User registered"}
{"level":30,"time":1768675504333,"env":"test","module":"user-credentials-repository","userId":"1b852d9e-d8e2-44fd-b27b-824d1a68dc5b","msg":"User credentials created"}
{"level":30,"time":1768675504429,"env":"test","module":"email-queue","jobId":"b288c317-8de4-4986-b7a0-d3b5c4f7351c","to":"protected-test-tAV7YKct-Xl6Nx5B3Omb9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675504478,"env":"test","module":"auth-routes","userId":"1b852d9e-d8e2-44fd-b27b-824d1a68dc5b","email":"protected-test-tAV7YKct-Xl6Nx5B3Omb9@example.com","msg":"User registered"}
{"level":30,"time":1768675505196,"env":"test","module":"user-credentials-repository","userId":"81d0996a-b508-4f56-b449-b177f0425d3f","msg":"User credentials created"}
{"level":30,"time":1768675505288,"env":"test","module":"email-queue","jobId":"ae33109d-5e76-4f69-803c-d5212a94f7ae","to":"protected-test-O-hBC-GKhFuib-qeJezXT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675505339,"env":"test","module":"auth-routes","userId":"81d0996a-b508-4f56-b449-b177f0425d3f","email":"protected-test-O-hBC-GKhFuib-qeJezXT@example.com","msg":"User registered"}
{"level":30,"time":1768675506129,"env":"test","module":"user-credentials-repository","userId":"c9f4b332-8043-4778-9f4d-c888763135d7","msg":"User credentials created"}
{"level":30,"time":1768675506246,"env":"test","module":"email-queue","jobId":"24f15c72-3a5e-4bd3-b3f9-cfe824aa9c54","to":"protected-test-r40cTtcrFmsNG_8rSGFf_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675506307,"env":"test","module":"auth-routes","userId":"c9f4b332-8043-4778-9f4d-c888763135d7","email":"protected-test-r40cTtcrFmsNG_8rSGFf_@example.com","msg":"User registered"}
{"level":30,"time":1768675507007,"env":"test","module":"user-credentials-repository","userId":"81ad2846-51a2-49b1-bf4b-85b44bd8ffa8","msg":"User credentials created"}
{"level":30,"time":1768675507100,"env":"test","module":"email-queue","jobId":"05c358ef-1032-456c-888f-1b78f36e788f","to":"protected-test-r9_wcdEtYxZtRn2sgfKdM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675507153,"env":"test","module":"auth-routes","userId":"81ad2846-51a2-49b1-bf4b-85b44bd8ffa8","email":"protected-test-r9_wcdEtYxZtRn2sgfKdM@example.com","msg":"User registered"}
{"level":30,"time":1768675507861,"env":"test","module":"user-credentials-repository","userId":"6df3b37e-c893-40d4-b5c3-2eae4e423e31","msg":"User credentials created"}
{"level":30,"time":1768675507954,"env":"test","module":"email-queue","jobId":"8bcddcbc-ac9e-4beb-81af-e27bc31c6dc5","to":"protected-test-qCDWS7nzvm6Ar2_BEJQf6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675508007,"env":"test","module":"auth-routes","userId":"6df3b37e-c893-40d4-b5c3-2eae4e423e31","email":"protected-test-qCDWS7nzvm6Ar2_BEJQf6@example.com","msg":"User registered"}
{"level":30,"time":1768675508865,"env":"test","module":"user-credentials-repository","userId":"07e12b7a-1eb9-4f79-9e7a-f18bd65d4674","msg":"User credentials created"}
{"level":30,"time":1768675508987,"env":"test","module":"email-queue","jobId":"bba40c72-e8ea-4b8a-82d5-80e128e24a3e","to":"protected-test-xBAi3-aJL6qvxsN4nlp8l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675509046,"env":"test","module":"auth-routes","userId":"07e12b7a-1eb9-4f79-9e7a-f18bd65d4674","email":"protected-test-xBAi3-aJL6qvxsN4nlp8l@example.com","msg":"User registered"}
{"level":30,"time":1768675509738,"env":"test","module":"user-credentials-repository","userId":"dd654dd5-c8ed-4fd9-852b-399534abcef4","msg":"User credentials created"}
{"level":30,"time":1768675509830,"env":"test","module":"email-queue","jobId":"58df633c-515e-4186-aaf2-5689447077f3","to":"protected-test-gpD915vmSJx8Dtqu_bWZI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675509874,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["dd654dd5-c8ed-4fd9-852b-399534abcef4","c32bfed98c9becdf388865558f38b5096096afebe836054db64d25a95bbf9e9a","2026-02-16T18:45:09.830Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:09.830Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(dd654dd5-c8ed-4fd9-852b-399534abcef4) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675510622,"env":"test","module":"user-credentials-repository","userId":"8967c244-0f81-4c09-a29b-2dd7043396d9","msg":"User credentials created"}
{"level":30,"time":1768675510744,"env":"test","module":"email-queue","jobId":"99d668e3-791c-43b2-90a9-48caef0c05e9","to":"protected-test-kaRG9GaDKdfLNwgVqeyRS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675510803,"env":"test","module":"auth-routes","userId":"8967c244-0f81-4c09-a29b-2dd7043396d9","email":"protected-test-kaRG9GaDKdfLNwgVqeyRS@example.com","msg":"User registered"}
{"level":50,"time":1768675511505,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["79483897-58da-46f0-844d-17fec8ca8bdc","$2b$12$T8ID3Wz5YuieEUg3vn74fu3x3UzKW98cPAC/PfBmEps7LQA9S6ySe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(79483897-58da-46f0-844d-17fec8ca8bdc) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"79483897-58da-46f0-844d-17fec8ca8bdc","msg":"Failed to create user credentials"}
{"level":50,"time":1768675511505,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["79483897-58da-46f0-844d-17fec8ca8bdc","$2b$12$T8ID3Wz5YuieEUg3vn74fu3x3UzKW98cPAC/PfBmEps7LQA9S6ySe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(79483897-58da-46f0-844d-17fec8ca8bdc) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512271,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1176a056-efa8-4834-91f9-11c687fd868b","$2b$12$4wxsdDiRnt4M2fkdr78EFuUaf/LzYRUi5UEQgRF4cboMsPaR6wiLu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1176a056-efa8-4834-91f9-11c687fd868b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1176a056-efa8-4834-91f9-11c687fd868b","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512271,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1176a056-efa8-4834-91f9-11c687fd868b","$2b$12$4wxsdDiRnt4M2fkdr78EFuUaf/LzYRUi5UEQgRF4cboMsPaR6wiLu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1176a056-efa8-4834-91f9-11c687fd868b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675513043,"env":"test","module":"user-credentials-repository","userId":"c1b5f421-73d3-4796-bd91-f9ed47281159","msg":"User credentials created"}
{"level":30,"time":1768675513164,"env":"test","module":"email-queue","jobId":"70325b59-647d-4354-8ce5-2733e50d417a","to":"protected-test-LVcdBSb8nan7UjY-4WWv9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675513227,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["c1b5f421-73d3-4796-bd91-f9ed47281159","5834c894d023e8008d05ef56c30bf3ec940dd9e7e8929a81a315ea139be3eba4","2026-02-16T18:45:13.164Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:13.165Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c1b5f421-73d3-4796-bd91-f9ed47281159) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675513994,"env":"test","module":"user-credentials-repository","userId":"077ba770-98a8-4ba4-867e-73cb0d09b078","msg":"User credentials created"}
{"level":30,"time":1768675514113,"env":"test","module":"email-queue","jobId":"ee58cb82-24f2-43e6-a20f-45aae87f2c34","to":"protected-test-ye08h1X7M-8IkGdA8eB5g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675514169,"env":"test","module":"auth-routes","userId":"077ba770-98a8-4ba4-867e-73cb0d09b078","email":"protected-test-ye08h1X7M-8IkGdA8eB5g@example.com","msg":"User registered"}
{"level":30,"time":1768675514884,"env":"test","module":"user-credentials-repository","userId":"b42ebd51-5528-4e23-886a-be120a351b50","msg":"User credentials created"}
{"level":30,"time":1768675514979,"env":"test","module":"email-queue","jobId":"28829d82-cab0-49f9-a580-352d4e05d860","to":"protected-test-Id-2l1X1Qt72N5x3qT0f7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675515022,"env":"test","module":"auth-routes","userId":"b42ebd51-5528-4e23-886a-be120a351b50","email":"protected-test-Id-2l1X1Qt72N5x3qT0f7@example.com","msg":"User registered"}
{"level":30,"time":1768675515831,"env":"test","module":"user-credentials-repository","userId":"d4617ffb-e46e-4ae3-9be5-9a86cd4e2ee9","msg":"User credentials created"}
{"level":50,"time":1768675515893,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["d4617ffb-e46e-4ae3-9be5-9a86cd4e2ee9","fc670b7f69a63ec1d168af3254398e8b4d7d2452a41f9a0d368007672b1e0dc3","2026-01-18T18:45:15.831Z"],"cause":{"length":371,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d4617ffb-e46e-4ae3-9be5-9a86cd4e2ee9) is not present in table \"users\".","schema":"public","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675516651,"env":"test","module":"user-credentials-repository","userId":"3b314983-f038-4b9c-b4c2-4874d73e6d7d","msg":"User credentials created"}
{"level":30,"time":1768675516771,"env":"test","module":"email-queue","jobId":"db0d67d5-d7ad-4362-8921-7b0c6059a097","to":"protected-test--VuQgkXBeaQUpKeqzc4yl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675516831,"env":"test","module":"auth-routes","userId":"3b314983-f038-4b9c-b4c2-4874d73e6d7d","email":"protected-test--VuQgkXBeaQUpKeqzc4yl@example.com","msg":"User registered"}
{"level":30,"time":1768675517537,"env":"test","module":"user-credentials-repository","userId":"e7eda0ee-96ee-423c-9298-c5d49c9f952c","msg":"User credentials created"}
{"level":30,"time":1768675517628,"env":"test","module":"email-queue","jobId":"a583de2a-1d01-446c-9b65-0a06b6f1e9d5","to":"protected-test-9vyRrv2rCKP58td5r5QYc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675517672,"env":"test","module":"auth-routes","userId":"e7eda0ee-96ee-423c-9298-c5d49c9f952c","email":"protected-test-9vyRrv2rCKP58td5r5QYc@example.com","msg":"User registered"}
{"level":30,"time":1768675518525,"env":"test","module":"user-credentials-repository","userId":"c3b6ab87-22d8-4c77-93a0-a346837a61c0","msg":"User credentials created"}
{"level":30,"time":1768675518644,"env":"test","module":"email-queue","jobId":"6fac9368-643d-4161-8c7a-bf736a446ee1","to":"protected-test-YVpYOVGWsAIyqnpEii-Ra@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675518700,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["c3b6ab87-22d8-4c77-93a0-a346837a61c0","6cb160e441d97a34536119e816c2c152a3c29c97cd1d88ba2c781a89b5ef2614","2026-02-16T18:45:18.644Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:18.644Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c3b6ab87-22d8-4c77-93a0-a346837a61c0) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675519464,"env":"test","module":"user-credentials-repository","userId":"18a39f5e-aeff-410b-b9ee-49eb2b6385b4","msg":"User credentials created"}
{"level":30,"time":1768675519579,"env":"test","module":"email-queue","jobId":"fb4b67fe-2762-49dd-b91f-193e75227bc4","to":"protected-test-YADUT53-o02Plgy7DYGer@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675519636,"env":"test","module":"auth-routes","userId":"18a39f5e-aeff-410b-b9ee-49eb2b6385b4","email":"protected-test-YADUT53-o02Plgy7DYGer@example.com","msg":"User registered"}
{"level":30,"time":1768675520454,"env":"test","module":"user-credentials-repository","userId":"1f1ef685-16c1-4857-b5ab-75a3bc5a4e8b","msg":"User credentials created"}
{"level":50,"time":1768675520514,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["1f1ef685-16c1-4857-b5ab-75a3bc5a4e8b","eef10f0f23f6c867e2ce7239ae043a01872adcf09f19bcc3ff83bde1e087ceb3","2026-01-18T18:45:20.454Z"],"cause":{"length":371,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1f1ef685-16c1-4857-b5ab-75a3bc5a4e8b) is not present in table \"users\".","schema":"public","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675521174,"env":"test","module":"user-credentials-repository","userId":"bcb6cdd6-f662-4271-a46b-32284cda9ef6","msg":"User credentials created"}
{"level":50,"time":1768675521222,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["bcb6cdd6-f662-4271-a46b-32284cda9ef6","b9fbafc37030f99ed832fb228fc78d16d991acae3d65f3253f23325a06464f4f","2026-01-18T18:45:21.175Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bcb6cdd6-f662-4271-a46b-32284cda9ef6) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675521856,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c9bc49e9-b621-4fe2-864f-8d73bd8ae3a7","$2b$12$VHFcuRtbCvC1jsGFNbhKFuprnRaZPAqE3feI.LP2gyvHd6S6AyM.G"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c9bc49e9-b621-4fe2-864f-8d73bd8ae3a7) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c9bc49e9-b621-4fe2-864f-8d73bd8ae3a7","msg":"Failed to create user credentials"}
{"level":50,"time":1768675521856,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c9bc49e9-b621-4fe2-864f-8d73bd8ae3a7","$2b$12$VHFcuRtbCvC1jsGFNbhKFuprnRaZPAqE3feI.LP2gyvHd6S6AyM.G"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c9bc49e9-b621-4fe2-864f-8d73bd8ae3a7) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675522481,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bdccdf5c-9c56-495e-948e-9be0967cb3b8","$2b$12$3nBVdCyOsbp4ksQGQPbuIumsj5N2XrlvUSnX8FypkYFzdbvOoD/li"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bdccdf5c-9c56-495e-948e-9be0967cb3b8) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bdccdf5c-9c56-495e-948e-9be0967cb3b8","msg":"Failed to create user credentials"}
{"level":50,"time":1768675522481,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bdccdf5c-9c56-495e-948e-9be0967cb3b8","$2b$12$3nBVdCyOsbp4ksQGQPbuIumsj5N2XrlvUSnX8FypkYFzdbvOoD/li"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bdccdf5c-9c56-495e-948e-9be0967cb3b8) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675523222,"env":"test","module":"user-credentials-repository","userId":"1e837545-e310-4923-9a60-8a099fee1bbb","msg":"User credentials created"}
{"level":30,"time":1768675523338,"env":"test","module":"email-queue","jobId":"14443b9c-cf83-47b8-877c-275ead4dc9e3","to":"protected-test-dBF6YDgApiFn9I1S7d6qB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675523395,"env":"test","module":"auth-routes","userId":"1e837545-e310-4923-9a60-8a099fee1bbb","email":"protected-test-dBF6YDgApiFn9I1S7d6qB@example.com","msg":"User registered"}
{"level":50,"time":1768675524231,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1e7f01a0-f9a9-4940-86f1-ae116f4b25cc","$2b$12$5DbREyj0dVQqTkEbV5yP1.7LmIEpgYvE7txSxeQNp6onx.7IkZw6S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1e7f01a0-f9a9-4940-86f1-ae116f4b25cc) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1e7f01a0-f9a9-4940-86f1-ae116f4b25cc","msg":"Failed to create user credentials"}
{"level":50,"time":1768675524231,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1e7f01a0-f9a9-4940-86f1-ae116f4b25cc","$2b$12$5DbREyj0dVQqTkEbV5yP1.7LmIEpgYvE7txSxeQNp6onx.7IkZw6S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1e7f01a0-f9a9-4940-86f1-ae116f4b25cc) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675524696,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675524696,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 31 failed | 1 skipped) 32203ms
       Γ£ô should allow access with valid Bearer token  1441ms
       ├ù should reject access without Authorization header 615ms
       ├ù should reject access with empty Bearer token 886ms
       ├ù should reject access with malformed Authorization header 1051ms
       ├ù should reject access with wrong token type 824ms
       ├ù should allow POST with valid Bearer token 758ms
       ├ù should reject POST without Bearer token 835ms
       ├ù should reject POST with invalid token 842ms
       ├ù should allow PUT with valid Bearer token 842ms
       ├ù should reject PUT without Bearer token 857ms
       ├ù should allow DELETE with valid Bearer token 982ms
       ├ù should reject DELETE without Bearer token 841ms
       ├ù should allow PATCH with valid Bearer token 897ms
       ├ù should reject PATCH without Bearer token 1003ms
       ├ù should handle Bearer token with extra spaces 770ms
       Γåô should handle token with newlines
       ├ù should handle very long invalid token 983ms
       ├ù should handle empty Authorization header 649ms
       ├ù should handle Authorization header with only Bearer 765ms
       ├ù should handle multiple Authorization headers 957ms
       ├ù should reject token with SQL injection attempt 1000ms
       ├ù should reject token with XSS attempt 839ms
       ├ù should reject token with missing userId 826ms
       ├ù should reject token with non-existent userId 996ms
       ├ù should not allow user to access another user's resources 871ms
       ├ù should inject userId into request context 939ms
       ├ù should inject tenantId into request context 995ms
       ├ù should inject role into request context 820ms
       ├ù should not apply general rate limiting to authenticated requests 707ms
       ├ù should handle request with both Bearer token and cookies 636ms
       ├ù should prioritize Bearer token over cookie when both present 624ms
       ├ù should allow unauthenticated access to optional auth routes 970ms
       ├ù should enhance optional auth routes with user context when authenticated 780ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 31 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,884a9aaa-9a5a-48aa-82b4-d88dce295ac0
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,a13575b8-1b01-4e96-84e5-4630b210b334
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,a2fa7db7-f694-4453-80bd-d4c5ed5dc3a8
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,e9704f0f-6578-4328-bf2d-e6904e090456
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[5/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,f2442a82-1807-472e-8847-82e1095438a5
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[6/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,1b852d9e-d8e2-44fd-b27b-824d1a68dc5b
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[7/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,81d0996a-b508-4f56-b449-b177f0425d3f
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[8/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,c9f4b332-8043-4778-9f4d-c888763135d7
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[9/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,81ad2846-51a2-49b1-bf4b-85b44bd8ffa8
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[10/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 7c13f7ee-1bc6-422e-b758-75707841bb8e,6df3b37e-c893-40d4-b5c3-2eae4e423e31,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6df3b37e-c893-40d4-b5c3-2eae4e423e31) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[11/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,07e12b7a-1eb9-4f79-9e7a-f18bd65d4674
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[12/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,8967c244-0f81-4c09-a29b-2dd7043396d9
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[13/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,077ba770-98a8-4ba4-867e-73cb0d09b078
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[14/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,b42ebd51-5528-4e23-886a-be120a351b50
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[15/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,3b314983-f038-4b9c-b4c2-4874d73e6d7d
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[16/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 7c13f7ee-1bc6-422e-b758-75707841bb8e,e7eda0ee-96ee-423c-9298-c5d49c9f952c,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e7eda0ee-96ee-423c-9298-c5d49c9f952c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[17/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,18a39f5e-aeff-410b-b9ee-49eb2b6385b4
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[18/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: be4546b3-4f72-42cd-b9fb-fc8c6190c40e,owner,true,1e837545-e310-4923-9a60-8a099fee1bbb
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(be4546b3-4f72-42cd-b9fb-fc8c6190c40e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[19/31]ΓÄ»


 Test Files  1 failed (1)
      Tests  31 failed | 1 passed | 1 skipped (33)
   Start at  12:44:04
   Duration  75.27s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x6 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678738869,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678746906,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678746954,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678748498,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678748513,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678748505,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678748506,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678748509,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678748509,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678748513,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678748513,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678748513,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678748513,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768678749011,"env":"test","module":"user-credentials-repository","userId":"cc73e955-6e77-432f-985d-020390200cfe","msg":"User credentials created"}
{"level":50,"time":1768678749069,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["cc73e955-6e77-432f-985d-020390200cfe","bc277dd20db4528a2139635a675ec4252add9f070670f8815bc6c1b9039623f1","2026-01-18T19:39:09.012Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cc73e955-6e77-432f-985d-020390200cfe) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768678749077,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768678749077,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2994ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:38:49
   Duration  17.11s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x7 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678770778,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678777013,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678777053,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678777357,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678777374,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678777365,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678777366,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678777370,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678777370,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678777374,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678777374,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678777374,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678777374,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant n32XlVSleuPtqF5lF86ch,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant n32XlVSleuPtqF5lF86ch', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678777686,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768678777687,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1513ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant n32XlVSleuPtqF5lF86ch,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:17
   Duration  17.14s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x8 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678786087,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768678790316,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678799172,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768678799527,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678799550,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768678799537,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678799538,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678799544,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678799544,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678799549,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678799549,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678799550,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678799550,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768678799861,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678799861,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XThhFGTu0XvSw2VoINA8a,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant XThhFGTu0XvSw2VoINA8a', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 10411ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XThhFGTu0XvSw2VoINA8a,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:37
   Duration  21.78s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x9 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679038296,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679048903,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679054194,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679055884,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679055902,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679055892,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679055892,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679055897,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679055897,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679055902,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679055902,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679055902,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679055902,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":50,"time":1768679056612,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8759b59b-eb99-4704-9399-96ce4e73f8d3","$2b$12$YHnpWk34eMLbHJuVBl77kOsTJTJB.Fbfv2UmxLzhGtnfE86q2QJBS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8759b59b-eb99-4704-9399-96ce4e73f8d3) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8759b59b-eb99-4704-9399-96ce4e73f8d3","msg":"Failed to create user credentials"}
{"level":50,"time":1768679056622,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8759b59b-eb99-4704-9399-96ce4e73f8d3","$2b$12$YHnpWk34eMLbHJuVBl77kOsTJTJB.Fbfv2UmxLzhGtnfE86q2QJBS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8759b59b-eb99-4704-9399-96ce4e73f8d3) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679056669,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679056670,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 8819ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:43:48
   Duration  27.27s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x10 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679218952,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679223732,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679224202,"env":"test","msg":"DB: Set search_path on initial connection: \"test_schema_w0_v3\",public"}
{"level":30,"time":1768679224202,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768679226626,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679228077,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679228095,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679228085,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679228086,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679228090,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679228090,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679228094,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679228094,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679228095,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679228095,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768679228692,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["75dabb32-d1b3-43fb-8c59-98fd56636caf","$2b$12$VK2HLYzZF8dIiALs9mKxfOqOCrULMHNQMo4M77EVcJ2OxTwrdtzUG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(75dabb32-d1b3-43fb-8c59-98fd56636caf) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"75dabb32-d1b3-43fb-8c59-98fd56636caf","msg":"Failed to create user credentials"}
{"level":50,"time":1768679228692,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["75dabb32-d1b3-43fb-8c59-98fd56636caf","$2b$12$VK2HLYzZF8dIiALs9mKxfOqOCrULMHNQMo4M77EVcJ2OxTwrdtzUG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(75dabb32-d1b3-43fb-8c59-98fd56636caf) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679228705,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679228705,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5912ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:46:49
   Duration  18.29s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x11 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679344206,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679378524,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679378525,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (from connection string options)"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679378618,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768679380158,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679380178,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679380167,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679380168,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679380173,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679380173,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679380178,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679380178,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679380178,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679380178,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679380631,"env":"test","module":"user-credentials-repository","userId":"1e810f33-c6c8-44dc-991c-183f7e079dae","msg":"User credentials created"}
{"level":30,"time":1768679380721,"env":"test","module":"email-queue","jobId":"ab29358a-b5e9-4cdc-91d2-735a19a93367","to":"test-Pj7XjMccmKP8ZHlMJ4m9u@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679380768,"env":"test","module":"auth-routes","userId":"1e810f33-c6c8-44dc-991c-183f7e079dae","email":"test-Pj7XjMccmKP8ZHlMJ4m9u@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768679381394,"env":"test","module":"user-credentials-repository","userId":"d8ce77dc-5e6c-4926-8c25-86f6836a9af0","msg":"User credentials created"}
{"level":30,"time":1768679381480,"env":"test","module":"email-queue","jobId":"02cbec06-01c0-4a5c-86cb-7a4ef925cf36","to":"protected-test-4AjdgIC0-MMcFbTlu9xTx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679381529,"env":"test","module":"auth-routes","userId":"d8ce77dc-5e6c-4926-8c25-86f6836a9af0","email":"protected-test-4AjdgIC0-MMcFbTlu9xTx@example.com","msg":"User registered"}
{"level":30,"time":1768679382141,"env":"test","module":"auth-routes","userId":"d8ce77dc-5e6c-4926-8c25-86f6836a9af0","msg":"User logged in successfully"}
{"level":30,"time":1768679382186,"env":"test","module":"audit-log-service","userId":"d8ce77dc-5e6c-4926-8c25-86f6836a9af0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679382622,"env":"test","module":"user-credentials-repository","userId":"07ec9c9f-d8b6-46b0-aa1c-c12566e9d1cf","msg":"User credentials created"}
{"level":30,"time":1768679382710,"env":"test","module":"email-queue","jobId":"5c80054d-f782-49d4-8549-a292483a2409","to":"protected-test-FK0p_xJuusXD1uBTjCDdJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679382755,"env":"test","module":"auth-routes","userId":"07ec9c9f-d8b6-46b0-aa1c-c12566e9d1cf","email":"protected-test-FK0p_xJuusXD1uBTjCDdJ@example.com","msg":"User registered"}
{"level":30,"time":1768679383336,"env":"test","module":"auth-routes","userId":"07ec9c9f-d8b6-46b0-aa1c-c12566e9d1cf","msg":"User logged in successfully"}
{"level":30,"time":1768679383379,"env":"test","module":"audit-log-service","userId":"07ec9c9f-d8b6-46b0-aa1c-c12566e9d1cf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679383386,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768679383756,"env":"test","module":"user-credentials-repository","userId":"b1f17ebb-c18e-4a5c-9c05-65902ebf8984","msg":"User credentials created"}
{"level":30,"time":1768679383842,"env":"test","module":"email-queue","jobId":"d130fbd4-b8c5-40ef-91d4-edd90ae5cf0d","to":"protected-test-kXts6PP-FA3vhmrfJaGR-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679383885,"env":"test","module":"auth-routes","userId":"b1f17ebb-c18e-4a5c-9c05-65902ebf8984","email":"protected-test-kXts6PP-FA3vhmrfJaGR-@example.com","msg":"User registered"}
{"level":30,"time":1768679384499,"env":"test","module":"auth-routes","userId":"b1f17ebb-c18e-4a5c-9c05-65902ebf8984","msg":"User logged in successfully"}
{"level":30,"time":1768679384542,"env":"test","module":"audit-log-service","userId":"b1f17ebb-c18e-4a5c-9c05-65902ebf8984","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679384545,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679384906,"env":"test","module":"user-credentials-repository","userId":"5157d37c-ce15-4560-a5aa-0bf571d775d5","msg":"User credentials created"}
{"level":30,"time":1768679385006,"env":"test","module":"email-queue","jobId":"f442cc2a-4aa1-43bf-88d7-1b9420e5b295","to":"protected-test-CgwvOHE9iN1frCtMyYwc7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679385051,"env":"test","module":"auth-routes","userId":"5157d37c-ce15-4560-a5aa-0bf571d775d5","email":"protected-test-CgwvOHE9iN1frCtMyYwc7@example.com","msg":"User registered"}
{"level":30,"time":1768679385656,"env":"test","module":"auth-routes","userId":"5157d37c-ce15-4560-a5aa-0bf571d775d5","msg":"User logged in successfully"}
{"level":30,"time":1768679385703,"env":"test","module":"audit-log-service","userId":"5157d37c-ce15-4560-a5aa-0bf571d775d5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679385707,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768679386077,"env":"test","module":"user-credentials-repository","userId":"21f0a2c9-6c37-4ded-92ab-450bd79fec9a","msg":"User credentials created"}
{"level":30,"time":1768679386164,"env":"test","module":"email-queue","jobId":"6800863d-2aa0-4da2-bf49-7249ce5ba7ae","to":"protected-test-yqWkjr1cvZKn-nfl99twr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679386209,"env":"test","module":"auth-routes","userId":"21f0a2c9-6c37-4ded-92ab-450bd79fec9a","email":"protected-test-yqWkjr1cvZKn-nfl99twr@example.com","msg":"User registered"}
{"level":30,"time":1768679386799,"env":"test","module":"auth-routes","userId":"21f0a2c9-6c37-4ded-92ab-450bd79fec9a","msg":"User logged in successfully"}
{"level":30,"time":1768679386843,"env":"test","module":"audit-log-service","userId":"21f0a2c9-6c37-4ded-92ab-450bd79fec9a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679386847,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679386847,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679387213,"env":"test","module":"user-credentials-repository","userId":"63b8e473-dd3b-4524-b12e-204e5d2b00e2","msg":"User credentials created"}
{"level":30,"time":1768679387302,"env":"test","module":"email-queue","jobId":"79d513f9-b74d-48ea-835b-a42ceaad026f","to":"protected-test-Q9Rmqbd6b27sAT_dizNk7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679387352,"env":"test","module":"auth-routes","userId":"63b8e473-dd3b-4524-b12e-204e5d2b00e2","email":"protected-test-Q9Rmqbd6b27sAT_dizNk7@example.com","msg":"User registered"}
{"level":30,"time":1768679387952,"env":"test","module":"auth-routes","userId":"63b8e473-dd3b-4524-b12e-204e5d2b00e2","msg":"User logged in successfully"}
{"level":30,"time":1768679387996,"env":"test","module":"audit-log-service","userId":"63b8e473-dd3b-4524-b12e-204e5d2b00e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679388427,"env":"test","module":"user-credentials-repository","userId":"9b212191-e40e-4064-a7ac-dfa31a54cda6","msg":"User credentials created"}
{"level":30,"time":1768679388512,"env":"test","module":"email-queue","jobId":"00a07667-fa81-4b20-b918-089a30a14e91","to":"protected-test-MVXM-lXfV90mJFEY7r8CA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679388555,"env":"test","module":"auth-routes","userId":"9b212191-e40e-4064-a7ac-dfa31a54cda6","email":"protected-test-MVXM-lXfV90mJFEY7r8CA@example.com","msg":"User registered"}
{"level":30,"time":1768679389138,"env":"test","module":"auth-routes","userId":"9b212191-e40e-4064-a7ac-dfa31a54cda6","msg":"User logged in successfully"}
{"level":30,"time":1768679389186,"env":"test","module":"audit-log-service","userId":"9b212191-e40e-4064-a7ac-dfa31a54cda6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679389190,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679389550,"env":"test","module":"user-credentials-repository","userId":"e6181121-b68e-4a7d-b8bf-78cee460ab64","msg":"User credentials created"}
{"level":30,"time":1768679389641,"env":"test","module":"email-queue","jobId":"4c6b5961-d11d-44eb-908d-cc5bf8f20f7d","to":"protected-test-W2lQhy2kTpPltd8vKHwOX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679389691,"env":"test","module":"auth-routes","userId":"e6181121-b68e-4a7d-b8bf-78cee460ab64","email":"protected-test-W2lQhy2kTpPltd8vKHwOX@example.com","msg":"User registered"}
{"level":30,"time":1768679390259,"env":"test","module":"auth-routes","userId":"e6181121-b68e-4a7d-b8bf-78cee460ab64","msg":"User logged in successfully"}
{"level":30,"time":1768679390302,"env":"test","module":"audit-log-service","userId":"e6181121-b68e-4a7d-b8bf-78cee460ab64","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679390306,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679390669,"env":"test","module":"user-credentials-repository","userId":"979acd78-71c8-4a17-8423-0ba0a1e78a4b","msg":"User credentials created"}
{"level":30,"time":1768679390756,"env":"test","module":"email-queue","jobId":"57ee719b-0dc7-4e86-bf6e-f01a3ddc8235","to":"protected-test-99lD97lW__ZGDkC0afmXe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679390822,"env":"test","module":"auth-routes","userId":"979acd78-71c8-4a17-8423-0ba0a1e78a4b","email":"protected-test-99lD97lW__ZGDkC0afmXe@example.com","msg":"User registered"}
{"level":30,"time":1768679391408,"env":"test","module":"auth-routes","userId":"979acd78-71c8-4a17-8423-0ba0a1e78a4b","msg":"User logged in successfully"}
{"level":30,"time":1768679391456,"env":"test","module":"audit-log-service","userId":"979acd78-71c8-4a17-8423-0ba0a1e78a4b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=979acd78-71c8-4a17-8423-0ba0a1e78a4b, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T19:49:51.553Z"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679391977,"env":"test","module":"user-credentials-repository","userId":"63a516e4-7e77-4ec5-aff9-fe5b76532af5","msg":"User credentials created"}
{"level":30,"time":1768679392098,"env":"test","module":"email-queue","jobId":"4d9cbf6c-a350-48e1-833e-2b8fea0fb5b7","to":"protected-test-Y0tg5RF6ltJs3kghXWsa7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679392142,"env":"test","module":"auth-routes","userId":"63a516e4-7e77-4ec5-aff9-fe5b76532af5","email":"protected-test-Y0tg5RF6ltJs3kghXWsa7@example.com","msg":"User registered"}
{"level":30,"time":1768679392755,"env":"test","module":"auth-routes","userId":"63a516e4-7e77-4ec5-aff9-fe5b76532af5","msg":"User logged in successfully"}
{"level":30,"time":1768679392799,"env":"test","module":"audit-log-service","userId":"63a516e4-7e77-4ec5-aff9-fe5b76532af5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679392803,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679393164,"env":"test","module":"user-credentials-repository","userId":"5afd59d3-7196-4733-96e8-434319e0401b","msg":"User credentials created"}
{"level":30,"time":1768679393253,"env":"test","module":"email-queue","jobId":"02eb5079-84ec-4178-bd23-1725097b446d","to":"protected-test-cV4-Wna-HaNhWHg6vI82H@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679393300,"env":"test","module":"auth-routes","userId":"5afd59d3-7196-4733-96e8-434319e0401b","email":"protected-test-cV4-Wna-HaNhWHg6vI82H@example.com","msg":"User registered"}
{"level":30,"time":1768679393906,"env":"test","module":"auth-routes","userId":"5afd59d3-7196-4733-96e8-434319e0401b","msg":"User logged in successfully"}
{"level":30,"time":1768679393949,"env":"test","module":"audit-log-service","userId":"5afd59d3-7196-4733-96e8-434319e0401b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679394466,"env":"test","module":"user-credentials-repository","userId":"be7daf45-f18e-456e-9674-1f3ffcc21d6d","msg":"User credentials created"}
{"level":30,"time":1768679394560,"env":"test","module":"email-queue","jobId":"e3cbaaf2-1635-41c8-bdbf-31ee3fbb7051","to":"protected-test-GNAOHyUjWdABXDK1sQ91t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679394605,"env":"test","module":"auth-routes","userId":"be7daf45-f18e-456e-9674-1f3ffcc21d6d","email":"protected-test-GNAOHyUjWdABXDK1sQ91t@example.com","msg":"User registered"}
{"level":30,"time":1768679395221,"env":"test","module":"auth-routes","userId":"be7daf45-f18e-456e-9674-1f3ffcc21d6d","msg":"User logged in successfully"}
{"level":30,"time":1768679395266,"env":"test","module":"audit-log-service","userId":"be7daf45-f18e-456e-9674-1f3ffcc21d6d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679395272,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679395631,"env":"test","module":"user-credentials-repository","userId":"3c922e22-c365-4964-b02e-03d6710d55c8","msg":"User credentials created"}
{"level":30,"time":1768679395722,"env":"test","module":"email-queue","jobId":"ff785ade-2abe-4506-99d1-ffb0b2c4a504","to":"protected-test-KPBvC1DtAdQJMJEKyJgBt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679395767,"env":"test","module":"auth-routes","userId":"3c922e22-c365-4964-b02e-03d6710d55c8","email":"protected-test-KPBvC1DtAdQJMJEKyJgBt@example.com","msg":"User registered"}
{"level":30,"time":1768679396409,"env":"test","module":"auth-routes","userId":"3c922e22-c365-4964-b02e-03d6710d55c8","msg":"User logged in successfully"}
{"level":30,"time":1768679396457,"env":"test","module":"audit-log-service","userId":"3c922e22-c365-4964-b02e-03d6710d55c8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679397537,"env":"test","module":"user-credentials-repository","userId":"293e132e-6794-4f54-87e8-8be4ecfa6b54","msg":"User credentials created"}
{"level":30,"time":1768679397631,"env":"test","module":"email-queue","jobId":"d5181c96-00b8-4c02-b2d7-5ed1162e2015","to":"protected-test-UyuRZzspoY9gJ8oWiTMbW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679397678,"env":"test","module":"auth-routes","userId":"293e132e-6794-4f54-87e8-8be4ecfa6b54","email":"protected-test-UyuRZzspoY9gJ8oWiTMbW@example.com","msg":"User registered"}
{"level":30,"time":1768679398374,"env":"test","module":"auth-routes","userId":"293e132e-6794-4f54-87e8-8be4ecfa6b54","msg":"User logged in successfully"}
{"level":30,"time":1768679398421,"env":"test","module":"audit-log-service","userId":"293e132e-6794-4f54-87e8-8be4ecfa6b54","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679398427,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679398845,"env":"test","module":"user-credentials-repository","userId":"3f5fc803-8e9d-477a-b953-416cfb4f17a4","msg":"User credentials created"}
{"level":30,"time":1768679398936,"env":"test","module":"email-queue","jobId":"6adda65f-d3ea-4978-8f40-c70a1962c577","to":"protected-test-FGWOscy1IKge_IsCMESxq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679398986,"env":"test","module":"auth-routes","userId":"3f5fc803-8e9d-477a-b953-416cfb4f17a4","email":"protected-test-FGWOscy1IKge_IsCMESxq@example.com","msg":"User registered"}
{"level":30,"time":1768679399610,"env":"test","module":"auth-routes","userId":"3f5fc803-8e9d-477a-b953-416cfb4f17a4","msg":"User logged in successfully"}
{"level":30,"time":1768679399657,"env":"test","module":"audit-log-service","userId":"3f5fc803-8e9d-477a-b953-416cfb4f17a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679399663,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679399663,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679400096,"env":"test","module":"user-credentials-repository","userId":"1e0717b1-ac15-40dc-8b86-56c445f5a457","msg":"User credentials created"}
{"level":30,"time":1768679400194,"env":"test","module":"email-queue","jobId":"22643e00-bdec-4a1f-8225-0bc82788670f","to":"protected-test-nRniCxxK9LlYiAfO4_jmf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679400241,"env":"test","module":"auth-routes","userId":"1e0717b1-ac15-40dc-8b86-56c445f5a457","email":"protected-test-nRniCxxK9LlYiAfO4_jmf@example.com","msg":"User registered"}
{"level":50,"time":1768679400529,"env":"test","module":"auth-routes","userId":"1e0717b1-ac15-40dc-8b86-56c445f5a457","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768679400740,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768679401262,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1fae770a-2383-483f-a672-a2df79d4ef52","$2b$12$uZ4nwh.WuvGrClbO98mfguSbkSZG0QoCJkpPudt7eoAtbAdZWBzSG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1fae770a-2383-483f-a672-a2df79d4ef52) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1fae770a-2383-483f-a672-a2df79d4ef52","msg":"Failed to create user credentials"}
{"level":50,"time":1768679401262,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1fae770a-2383-483f-a672-a2df79d4ef52","$2b$12$uZ4nwh.WuvGrClbO98mfguSbkSZG0QoCJkpPudt7eoAtbAdZWBzSG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1fae770a-2383-483f-a672-a2df79d4ef52) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768679402126,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["73699a38-2438-42fa-b305-152556023503","$2b$12$XPeEF7Bfg1DR7zDDCwaPXONS02GNi9sq6Pwrst7qS8JC94EMmyqTq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(73699a38-2438-42fa-b305-152556023503) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"73699a38-2438-42fa-b305-152556023503","msg":"Failed to create user credentials"}
{"level":50,"time":1768679402126,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["73699a38-2438-42fa-b305-152556023503","$2b$12$XPeEF7Bfg1DR7zDDCwaPXONS02GNi9sq6Pwrst7qS8JC94EMmyqTq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(73699a38-2438-42fa-b305-152556023503) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679402779,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f97594f-2c04-4c0c-979f-5ce806320616","$2b$12$bA6ZSKTjjxSiCl3vNdZ6quCxplU2QSoPTistu4F2IoFX.U2YVPsRa"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f97594f-2c04-4c0c-979f-5ce806320616) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3f97594f-2c04-4c0c-979f-5ce806320616","msg":"Failed to create user credentials"}
{"level":50,"time":1768679402779,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f97594f-2c04-4c0c-979f-5ce806320616","$2b$12$bA6ZSKTjjxSiCl3vNdZ6quCxplU2QSoPTistu4F2IoFX.U2YVPsRa"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f97594f-2c04-4c0c-979f-5ce806320616) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679403488,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bd3d3aa7-198a-4118-977c-ee3794e1cb24","$2b$12$ub7IBZrH.VBf1SbM2V1BvOnnBGUccsOn21Bnza5pMTihCzABbpqBa"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bd3d3aa7-198a-4118-977c-ee3794e1cb24) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bd3d3aa7-198a-4118-977c-ee3794e1cb24","msg":"Failed to create user credentials"}
{"level":50,"time":1768679403488,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bd3d3aa7-198a-4118-977c-ee3794e1cb24","$2b$12$ub7IBZrH.VBf1SbM2V1BvOnnBGUccsOn21Bnza5pMTihCzABbpqBa"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bd3d3aa7-198a-4118-977c-ee3794e1cb24) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679404288,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d7a43223-f689-4c27-b0ac-b8ba9e23e13a","$2b$12$E54HoPVDMtOPLSjZR/9hK.Su6VzK/fGp20KKnsbYP2KKftUZUsETe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d7a43223-f689-4c27-b0ac-b8ba9e23e13a) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d7a43223-f689-4c27-b0ac-b8ba9e23e13a","msg":"Failed to create user credentials"}
{"level":50,"time":1768679404288,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d7a43223-f689-4c27-b0ac-b8ba9e23e13a","$2b$12$E54HoPVDMtOPLSjZR/9hK.Su6VzK/fGp20KKnsbYP2KKftUZUsETe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d7a43223-f689-4c27-b0ac-b8ba9e23e13a) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679405080,"env":"test","module":"user-credentials-repository","userId":"f1d26b97-5806-4599-bc79-6c5e318d2dca","msg":"User credentials created"}
{"level":50,"time":1768679405140,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["f1d26b97-5806-4599-bc79-6c5e318d2dca","b153c500e7f7b688037a280faa4c9665b34cf805d3e96ed2ce2528f84c124a0a","2026-01-18T19:50:05.080Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f1d26b97-5806-4599-bc79-6c5e318d2dca) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679405812,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ce90e199-9fb1-4cce-ab2a-4fc5ce466e17","$2b$12$dOLdJ4.v7HZT7QvJ0BsM.e/QY9vjUi4DA2LWzvSCa9fAw4gpLt4Om"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ce90e199-9fb1-4cce-ab2a-4fc5ce466e17) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ce90e199-9fb1-4cce-ab2a-4fc5ce466e17","msg":"Failed to create user credentials"}
{"level":50,"time":1768679405812,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ce90e199-9fb1-4cce-ab2a-4fc5ce466e17","$2b$12$dOLdJ4.v7HZT7QvJ0BsM.e/QY9vjUi4DA2LWzvSCa9fAw4gpLt4Om"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ce90e199-9fb1-4cce-ab2a-4fc5ce466e17) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679406482,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b1359979-711d-4123-a3c5-b37d655e0815","$2b$12$oOJCmDy6x90d1lKry0Xhqeiy.0MMupir2fmpIQ8dHuh7kv2/pELJW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b1359979-711d-4123-a3c5-b37d655e0815) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b1359979-711d-4123-a3c5-b37d655e0815","msg":"Failed to create user credentials"}
{"level":50,"time":1768679406482,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b1359979-711d-4123-a3c5-b37d655e0815","$2b$12$oOJCmDy6x90d1lKry0Xhqeiy.0MMupir2fmpIQ8dHuh7kv2/pELJW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b1359979-711d-4123-a3c5-b37d655e0815) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679407145,"env":"test","module":"user-credentials-repository","userId":"03149978-d32b-41ed-820a-d9c3cbc38dcc","msg":"User credentials created"}
{"level":50,"time":1768679407192,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["03149978-d32b-41ed-820a-d9c3cbc38dcc","72bcc12ba29659cab0e741953b5d86d9e81903a1a28c5dda673f0d8daa7a2d4a","2026-01-18T19:50:07.145Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(03149978-d32b-41ed-820a-d9c3cbc38dcc) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768679407870,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a067828a-4bf6-4e83-8c8a-6f7bf8e87bdf","$2b$12$ie6uAH4oqRfnCMOamj88XOg5ZctByN3AodO/BBsyW6.ZZ1vfZVY7S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a067828a-4bf6-4e83-8c8a-6f7bf8e87bdf) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"a067828a-4bf6-4e83-8c8a-6f7bf8e87bdf","msg":"Failed to create user credentials"}
{"level":50,"time":1768679407870,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a067828a-4bf6-4e83-8c8a-6f7bf8e87bdf","$2b$12$ie6uAH4oqRfnCMOamj88XOg5ZctByN3AodO/BBsyW6.ZZ1vfZVY7S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a067828a-4bf6-4e83-8c8a-6f7bf8e87bdf) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679408522,"env":"test","module":"user-credentials-repository","userId":"a13dacc8-3c53-4f31-a353-6e0e4975303b","msg":"User credentials created"}
{"level":50,"time":1768679408569,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["a13dacc8-3c53-4f31-a353-6e0e4975303b","6f5ad69806ef14eb398e46fbe024954055680a4818b3e8feef62613df8193c16","2026-01-18T19:50:08.522Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a13dacc8-3c53-4f31-a353-6e0e4975303b) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679409346,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7451a8e3-1cd9-4828-8c95-0cad50e1eadc","$2b$12$d1hOR2TGYsDPWmgzsJ6WEehaDXnaYrOdFxtSMAK8xeA/m0jZRYfTC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7451a8e3-1cd9-4828-8c95-0cad50e1eadc) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7451a8e3-1cd9-4828-8c95-0cad50e1eadc","msg":"Failed to create user credentials"}
{"level":50,"time":1768679409346,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7451a8e3-1cd9-4828-8c95-0cad50e1eadc","$2b$12$d1hOR2TGYsDPWmgzsJ6WEehaDXnaYrOdFxtSMAK8xeA/m0jZRYfTC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7451a8e3-1cd9-4828-8c95-0cad50e1eadc) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679410013,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["68df8792-d2f7-43df-8b79-fb20c3ec64b8","$2b$12$tItWoCPKnQ/J.UqQF4Wln.pfTwxqSqtaM75FPb/yj4ZaJ37NF7yw."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(68df8792-d2f7-43df-8b79-fb20c3ec64b8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"68df8792-d2f7-43df-8b79-fb20c3ec64b8","msg":"Failed to create user credentials"}
{"level":50,"time":1768679410013,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["68df8792-d2f7-43df-8b79-fb20c3ec64b8","$2b$12$tItWoCPKnQ/J.UqQF4Wln.pfTwxqSqtaM75FPb/yj4ZaJ37NF7yw."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(68df8792-d2f7-43df-8b79-fb20c3ec64b8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679410940,"env":"test","module":"user-credentials-repository","userId":"bcc37ce6-3234-4329-bbf2-c146af0ca7e3","msg":"User credentials created"}
{"level":50,"time":1768679410990,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["bcc37ce6-3234-4329-bbf2-c146af0ca7e3","c1dcf82244d2348d8839588cdcd11ae3c5a3cf7fc605090c6ca1d76c027c8532","2026-01-18T19:50:10.940Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bcc37ce6-3234-4329-bbf2-c146af0ca7e3) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679411657,"env":"test","module":"user-credentials-repository","userId":"22611e03-43b6-4f2e-b7fc-805b7eb3c0df","msg":"User credentials created"}
{"level":50,"time":1768679411706,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["22611e03-43b6-4f2e-b7fc-805b7eb3c0df","6ffceeb710d31b4517686196290eec8bc5e8513352d92bcb68c56aa3985205ce","2026-01-18T19:50:11.657Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(22611e03-43b6-4f2e-b7fc-805b7eb3c0df) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768679412434,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8912655d-412f-4475-9aae-5d3e0ec9f1ec","$2b$12$wdnzjGuo9LoTWDOpKw2Fp./HJIpnbKmmJRAip.8QixDo4cyWlGNEa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8912655d-412f-4475-9aae-5d3e0ec9f1ec) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8912655d-412f-4475-9aae-5d3e0ec9f1ec","msg":"Failed to create user credentials"}
{"level":50,"time":1768679412434,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8912655d-412f-4475-9aae-5d3e0ec9f1ec","$2b$12$wdnzjGuo9LoTWDOpKw2Fp./HJIpnbKmmJRAip.8QixDo4cyWlGNEa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8912655d-412f-4475-9aae-5d3e0ec9f1ec) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679412914,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679412915,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: 91885c78-7cfb-4a71-a33e-3f710c5eaaba
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ '91885c78-7cfb-4a71-a33e-3f710c5eaaba' ],
  cause: error: update or delete on table "users" violates foreign key constraint "workflow_versions_created_by_users_id_fk" on table "workflow_versions"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 387,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(1e810f33-c6c8-44dc-991c-183f7e079dae) is still referenced from table "workflow_versions".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'workflow_versions',
    column: undefined,
    dataType: undefined,
    constraint: 'workflow_versions_created_by_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 17 failed | 1 skipped) 35310ms
       Γ£ô should allow access with valid Bearer token  1222ms
       Γ£ô should reject access without Authorization header  1147ms
       Γ£ô should reject access with empty Bearer token  1159ms
       Γ£ô should reject access with malformed Authorization header  1161ms
       Γ£ô should reject access with wrong token type  1140ms
       Γ£ô should allow POST with valid Bearer token  1206ms
       Γ£ô should reject POST without Bearer token  1136ms
       Γ£ô should reject POST with invalid token  1116ms
       Γ£ô should allow PUT with valid Bearer token  1296ms
       Γ£ô should reject PUT without Bearer token  1202ms
       Γ£ô should allow DELETE with valid Bearer token  1289ms
       Γ£ô should reject DELETE without Bearer token  1180ms
       Γ£ô should allow PATCH with valid Bearer token  1808ms
       Γ£ô should reject PATCH without Bearer token  1346ms
       Γ£ô should handle Bearer token with extra spaces  1237ms
       Γåô should handle token with newlines
       ├ù should handle very long invalid token 1086ms
       ├ù should handle empty Authorization header 514ms
       ├ù should handle Authorization header with only Bearer 863ms
       ├ù should handle multiple Authorization headers 653ms
       ├ù should reject token with SQL injection attempt 709ms
       ├ù should reject token with XSS attempt 800ms
       ├ù should reject token with missing userId 852ms
       ├ù should reject token with non-existent userId 672ms
       ├ù should not allow user to access another user's resources 670ms
       ├ù should inject userId into request context 711ms
       ├ù should inject tenantId into request context 677ms
       ├ù should inject role into request context 700ms
       ├ù should not apply general rate limiting to authenticated requests 777ms
       ├ù should handle request with both Bearer token and cookies 667ms
       ├ù should prioritize Bearer token over cookie when both present 977ms
       ├ù should allow unauthenticated access to optional auth routes 717ms
       ├ù should enhance optional auth routes with user context when authenticated 728ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 17 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
Error: expected 200 "OK", got 401 "Unauthorized"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/17]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/17]ΓÄ»


 Test Files  1 failed (1)
      Tests  17 failed | 15 passed | 1 skipped (33)
   Start at  13:47:44
   Duration  142.83s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x12 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679566939,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679585511,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679585512,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679585958,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679884591,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600011ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:52:34
   Duration  626.70s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x13 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768680389733,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768680394090,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768680394091,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768680394151,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768680693126,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600019ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:06:21
   Duration  611.35s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x14 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681265464,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681272542,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681272542,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681272601,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681274309,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681274327,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681274319,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681274319,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681274323,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681274323,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681274327,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681274327,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681274327,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681274327,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":50,"time":1768681274883,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b7c5f24-adcb-4e1a-8e8c-e402543d1f25","$2b$12$dq1Lp8a/JkMr8vBvHMeQCOMzGBDYMgsjnvQVn077D9H5yKA0lyBRu"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b7c5f24-adcb-4e1a-8e8c-e402543d1f25) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8b7c5f24-adcb-4e1a-8e8c-e402543d1f25","msg":"Failed to create user credentials"}
{"level":50,"time":1768681274883,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b7c5f24-adcb-4e1a-8e8c-e402543d1f25","$2b$12$dq1Lp8a/JkMr8vBvHMeQCOMzGBDYMgsjnvQVn077D9H5yKA0lyBRu"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b7c5f24-adcb-4e1a-8e8c-e402543d1f25) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681274896,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681274896,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3373ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:20:48
   Duration  21.01s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x15 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681468328,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681472697,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681472697,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681472750,"env":"test","msg":"DB: Wrapped execute() to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768681472750,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681475687,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681475704,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681475694,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681475695,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681475699,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681475699,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681475703,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681475703,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681475704,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681475704,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681476203,"env":"test","module":"user-credentials-repository","userId":"386167ed-7c12-4888-8126-075069e8410c","msg":"User credentials created"}
{"level":30,"time":1768681476326,"env":"test","module":"email-queue","jobId":"212dbf9f-80dc-4e37-9d45-63a0bfa9b143","to":"test-xNI9rmxdyRU6n1iujcZmT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681476389,"env":"test","module":"auth-routes","userId":"386167ed-7c12-4888-8126-075069e8410c","email":"test-xNI9rmxdyRU6n1iujcZmT@example.com","msg":"User registered"}
{"level":30,"time":1768681477091,"env":"test","module":"user-credentials-repository","userId":"beaaffc7-9ac6-4678-906b-0420ea177fd1","msg":"User credentials created"}
{"level":30,"time":1768681477232,"env":"test","module":"email-queue","jobId":"fb1ee45a-3b03-49fe-943c-2e30aa31c926","to":"protected-test-u4LRN7jIxVxHd6PwG08Ah@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681477289,"env":"test","module":"auth-routes","userId":"beaaffc7-9ac6-4678-906b-0420ea177fd1","email":"protected-test-u4LRN7jIxVxHd6PwG08Ah@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681478006,"env":"test","module":"auth-routes","userId":"beaaffc7-9ac6-4678-906b-0420ea177fd1","msg":"User logged in successfully"}
{"level":30,"time":1768681478065,"env":"test","module":"audit-log-service","userId":"beaaffc7-9ac6-4678-906b-0420ea177fd1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681478537,"env":"test","module":"user-credentials-repository","userId":"33d1cbbb-1396-40d0-92b8-00414e59acd8","msg":"User credentials created"}
{"level":30,"time":1768681478653,"env":"test","module":"email-queue","jobId":"d227624a-d944-49e8-8fef-39dbbfe77a5e","to":"protected-test-Veb-jKZ98hlU3y1efgbnb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681478716,"env":"test","module":"auth-routes","userId":"33d1cbbb-1396-40d0-92b8-00414e59acd8","email":"protected-test-Veb-jKZ98hlU3y1efgbnb@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681479413,"env":"test","module":"auth-routes","userId":"33d1cbbb-1396-40d0-92b8-00414e59acd8","msg":"User logged in successfully"}
{"level":30,"time":1768681479469,"env":"test","module":"audit-log-service","userId":"33d1cbbb-1396-40d0-92b8-00414e59acd8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681479474,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681479877,"env":"test","module":"user-credentials-repository","userId":"e16967b3-db07-4276-9f59-d724fa927957","msg":"User credentials created"}
{"level":30,"time":1768681479993,"env":"test","module":"email-queue","jobId":"057a8c05-279e-4659-89d3-123c8f2c637e","to":"protected-test-m1e8nNVgTNRPKoKKSbh5x@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681480084,"env":"test","module":"auth-routes","userId":"e16967b3-db07-4276-9f59-d724fa927957","email":"protected-test-m1e8nNVgTNRPKoKKSbh5x@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681480770,"env":"test","module":"auth-routes","userId":"e16967b3-db07-4276-9f59-d724fa927957","msg":"User logged in successfully"}
{"level":30,"time":1768681480827,"env":"test","module":"audit-log-service","userId":"e16967b3-db07-4276-9f59-d724fa927957","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681480832,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681481233,"env":"test","module":"user-credentials-repository","userId":"f4ca3e11-742e-4d12-add5-79ab0a8fcc87","msg":"User credentials created"}
{"level":30,"time":1768681481352,"env":"test","module":"email-queue","jobId":"64e8a7ee-f53f-42da-9674-9921c524566b","to":"protected-test-Bk8v_GTeQ82ZkclA6iJnS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681481409,"env":"test","module":"auth-routes","userId":"f4ca3e11-742e-4d12-add5-79ab0a8fcc87","email":"protected-test-Bk8v_GTeQ82ZkclA6iJnS@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681482103,"env":"test","module":"auth-routes","userId":"f4ca3e11-742e-4d12-add5-79ab0a8fcc87","msg":"User logged in successfully"}
{"level":30,"time":1768681482158,"env":"test","module":"audit-log-service","userId":"f4ca3e11-742e-4d12-add5-79ab0a8fcc87","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681482162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681482561,"env":"test","module":"user-credentials-repository","userId":"b1636aeb-3d93-4b66-9dd4-1264fc06ef1d","msg":"User credentials created"}
{"level":30,"time":1768681482675,"env":"test","module":"email-queue","jobId":"2e628563-8e0c-4100-8dd4-61d55de32972","to":"protected-test-9w2tKVJIPg-Zn6hmQCiJi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681482739,"env":"test","module":"auth-routes","userId":"b1636aeb-3d93-4b66-9dd4-1264fc06ef1d","email":"protected-test-9w2tKVJIPg-Zn6hmQCiJi@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681483427,"env":"test","module":"auth-routes","userId":"b1636aeb-3d93-4b66-9dd4-1264fc06ef1d","msg":"User logged in successfully"}
{"level":30,"time":1768681483487,"env":"test","module":"audit-log-service","userId":"b1636aeb-3d93-4b66-9dd4-1264fc06ef1d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681483491,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681483492,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681483903,"env":"test","module":"user-credentials-repository","userId":"719f3bee-c870-4a46-963a-5b5646de3d38","msg":"User credentials created"}
{"level":30,"time":1768681484018,"env":"test","module":"email-queue","jobId":"c69fbbf8-ba33-4e0f-aa88-20f7f90daefd","to":"protected-test-GaRZPt4swdHvJUk_O6RoP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681484075,"env":"test","module":"auth-routes","userId":"719f3bee-c870-4a46-963a-5b5646de3d38","email":"protected-test-GaRZPt4swdHvJUk_O6RoP@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681484793,"env":"test","module":"auth-routes","userId":"719f3bee-c870-4a46-963a-5b5646de3d38","msg":"User logged in successfully"}
{"level":30,"time":1768681484854,"env":"test","module":"audit-log-service","userId":"719f3bee-c870-4a46-963a-5b5646de3d38","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681485332,"env":"test","module":"user-credentials-repository","userId":"3739aeff-7cb9-4f65-acdf-609b2730cc79","msg":"User credentials created"}
{"level":30,"time":1768681485449,"env":"test","module":"email-queue","jobId":"00b68690-ee57-4424-8f1d-b0af4f0b409c","to":"protected-test-ZK_OqNQ9ikIhhLyyurM8K@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681485506,"env":"test","module":"auth-routes","userId":"3739aeff-7cb9-4f65-acdf-609b2730cc79","email":"protected-test-ZK_OqNQ9ikIhhLyyurM8K@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681486200,"env":"test","module":"auth-routes","userId":"3739aeff-7cb9-4f65-acdf-609b2730cc79","msg":"User logged in successfully"}
{"level":30,"time":1768681486261,"env":"test","module":"audit-log-service","userId":"3739aeff-7cb9-4f65-acdf-609b2730cc79","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681486265,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681486659,"env":"test","module":"user-credentials-repository","userId":"c53b02ef-3701-44bf-9910-948ef7cc69cb","msg":"User credentials created"}
{"level":30,"time":1768681486773,"env":"test","module":"email-queue","jobId":"9eb43b5a-8778-44d9-a6d2-fd0cc02ec173","to":"protected-test-TuQ6h5aM1TIKShUmF_y9s@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681486828,"env":"test","module":"auth-routes","userId":"c53b02ef-3701-44bf-9910-948ef7cc69cb","email":"protected-test-TuQ6h5aM1TIKShUmF_y9s@example.com","msg":"User registered"}
{"level":30,"time":1768681487554,"env":"test","module":"auth-routes","userId":"c53b02ef-3701-44bf-9910-948ef7cc69cb","msg":"User logged in successfully"}
{"level":30,"time":1768681487614,"env":"test","module":"audit-log-service","userId":"c53b02ef-3701-44bf-9910-948ef7cc69cb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681487618,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681488032,"env":"test","module":"user-credentials-repository","userId":"d4abf4c2-89b8-4872-868b-a183a8f7d72c","msg":"User credentials created"}
{"level":30,"time":1768681488154,"env":"test","module":"email-queue","jobId":"6cd2e603-83a2-4ec5-99c0-449211d2ad02","to":"protected-test-Riu-Y6Es2-ZDhuqYlZJcD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681488215,"env":"test","module":"auth-routes","userId":"d4abf4c2-89b8-4872-868b-a183a8f7d72c","email":"protected-test-Riu-Y6Es2-ZDhuqYlZJcD@example.com","msg":"User registered"}
{"level":30,"time":1768681488918,"env":"test","module":"auth-routes","userId":"d4abf4c2-89b8-4872-868b-a183a8f7d72c","msg":"User logged in successfully"}
{"level":30,"time":1768681488977,"env":"test","module":"audit-log-service","userId":"d4abf4c2-89b8-4872-868b-a183a8f7d72c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=d4abf4c2-89b8-4872-868b-a183a8f7d72c, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:24:49.099Z"}
{"level":30,"time":1768681489562,"env":"test","module":"user-credentials-repository","userId":"3dcbb8c2-6fea-4180-bee6-a485059dc603","msg":"User credentials created"}
{"level":30,"time":1768681489678,"env":"test","module":"email-queue","jobId":"246c363d-b608-421b-902f-bf19a3b06490","to":"protected-test-aVH_WUhbBjN-6ED0L2RM0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681489739,"env":"test","module":"auth-routes","userId":"3dcbb8c2-6fea-4180-bee6-a485059dc603","email":"protected-test-aVH_WUhbBjN-6ED0L2RM0@example.com","msg":"User registered"}
{"level":30,"time":1768681490437,"env":"test","module":"auth-routes","userId":"3dcbb8c2-6fea-4180-bee6-a485059dc603","msg":"User logged in successfully"}
{"level":30,"time":1768681490493,"env":"test","module":"audit-log-service","userId":"3dcbb8c2-6fea-4180-bee6-a485059dc603","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681490497,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681490908,"env":"test","module":"user-credentials-repository","userId":"1f729c2f-eed3-4364-8280-298e664ad13f","msg":"User credentials created"}
{"level":30,"time":1768681491029,"env":"test","module":"email-queue","jobId":"0793db6e-2c6d-4765-9ab9-cecb1162ad73","to":"protected-test-H4sAUkv9hHUPBtR5LWIh_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681491090,"env":"test","module":"auth-routes","userId":"1f729c2f-eed3-4364-8280-298e664ad13f","email":"protected-test-H4sAUkv9hHUPBtR5LWIh_@example.com","msg":"User registered"}
{"level":30,"time":1768681491814,"env":"test","module":"auth-routes","userId":"1f729c2f-eed3-4364-8280-298e664ad13f","msg":"User logged in successfully"}
{"level":30,"time":1768681491871,"env":"test","module":"audit-log-service","userId":"1f729c2f-eed3-4364-8280-298e664ad13f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681492586,"env":"test","module":"user-credentials-repository","userId":"d957fe2e-1fe9-4f82-a574-47c35318e8bb","msg":"User credentials created"}
{"level":30,"time":1768681492702,"env":"test","module":"email-queue","jobId":"51fc6c0b-693b-4700-b9c1-cf9a9f3e20df","to":"protected-test-SMF4JKUgBXO5MqkO1BtXr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681492764,"env":"test","module":"auth-routes","userId":"d957fe2e-1fe9-4f82-a574-47c35318e8bb","email":"protected-test-SMF4JKUgBXO5MqkO1BtXr@example.com","msg":"User registered"}
{"level":30,"time":1768681493490,"env":"test","module":"auth-routes","userId":"d957fe2e-1fe9-4f82-a574-47c35318e8bb","msg":"User logged in successfully"}
{"level":30,"time":1768681493547,"env":"test","module":"audit-log-service","userId":"d957fe2e-1fe9-4f82-a574-47c35318e8bb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681493552,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681493982,"env":"test","module":"user-credentials-repository","userId":"b0819f4b-357f-4723-b987-83eeb8ec1d1d","msg":"User credentials created"}
{"level":30,"time":1768681494097,"env":"test","module":"email-queue","jobId":"27958cf2-eeec-40e2-b515-6e001a363009","to":"protected-test-YC9OsiJX12leNi284Pp3l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681494162,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["b0819f4b-357f-4723-b987-83eeb8ec1d1d","bac7940fd9f16d363e2fd481ea58dbfd24cb3570f921041bf8577339b1f09769","2026-02-16T20:24:54.098Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:24:54.098Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b0819f4b-357f-4723-b987-83eeb8ec1d1d) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681494998,"env":"test","module":"user-credentials-repository","userId":"9fd44ebd-fd4e-4417-a2d6-082f36541492","msg":"User credentials created"}
{"level":30,"time":1768681495111,"env":"test","module":"email-queue","jobId":"f00079de-fcfe-4ce1-b932-0bd2ebd5c1e0","to":"protected-test-N1Bptaw0LpV6x2K80UDcV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681495169,"env":"test","module":"auth-routes","userId":"9fd44ebd-fd4e-4417-a2d6-082f36541492","email":"protected-test-N1Bptaw0LpV6x2K80UDcV@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681495881,"env":"test","module":"auth-routes","userId":"9fd44ebd-fd4e-4417-a2d6-082f36541492","msg":"User logged in successfully"}
{"level":30,"time":1768681495943,"env":"test","module":"audit-log-service","userId":"9fd44ebd-fd4e-4417-a2d6-082f36541492","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681495947,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681496375,"env":"test","module":"user-credentials-repository","userId":"a4147655-c56f-4e61-aabb-a0e188e9fcb5","msg":"User credentials created"}
{"level":30,"time":1768681496489,"env":"test","module":"email-queue","jobId":"814de897-ad70-4009-878c-89eefa55f979","to":"protected-test-FwwvRqJyhClrbHdh-vJbS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681496547,"env":"test","module":"auth-routes","userId":"a4147655-c56f-4e61-aabb-a0e188e9fcb5","email":"protected-test-FwwvRqJyhClrbHdh-vJbS@example.com","msg":"User registered"}
{"level":30,"time":1768681497242,"env":"test","module":"auth-routes","userId":"a4147655-c56f-4e61-aabb-a0e188e9fcb5","msg":"User logged in successfully"}
{"level":30,"time":1768681497299,"env":"test","module":"audit-log-service","userId":"a4147655-c56f-4e61-aabb-a0e188e9fcb5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681497303,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681497304,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681497759,"env":"test","module":"user-credentials-repository","userId":"3046fcd1-3dbc-4704-9197-d34afa557652","msg":"User credentials created"}
{"level":30,"time":1768681497889,"env":"test","module":"email-queue","jobId":"7d7775bc-d4ad-41f6-b710-1557cff6563c","to":"protected-test-42XJlmTUc_jlfeNG5IS8V@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681497950,"env":"test","module":"auth-routes","userId":"3046fcd1-3dbc-4704-9197-d34afa557652","email":"protected-test-42XJlmTUc_jlfeNG5IS8V@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681498665,"env":"test","module":"auth-routes","userId":"3046fcd1-3dbc-4704-9197-d34afa557652","msg":"User logged in successfully"}
{"level":30,"time":1768681498726,"env":"test","module":"audit-log-service","userId":"3046fcd1-3dbc-4704-9197-d34afa557652","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681498730,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681499159,"env":"test","module":"user-credentials-repository","userId":"bdfb6e90-bc4a-4227-ae5c-a6bda5ad4c4b","msg":"User credentials created"}
{"level":30,"time":1768681499281,"env":"test","module":"email-queue","jobId":"29502130-6787-45db-afa3-706f432c5934","to":"protected-test-QXB7exzO6VCLa-v6BueHA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681499341,"env":"test","module":"auth-routes","userId":"bdfb6e90-bc4a-4227-ae5c-a6bda5ad4c4b","email":"protected-test-QXB7exzO6VCLa-v6BueHA@example.com","msg":"User registered"}
{"level":30,"time":1768681500179,"env":"test","module":"auth-routes","userId":"bdfb6e90-bc4a-4227-ae5c-a6bda5ad4c4b","msg":"User logged in successfully"}
{"level":30,"time":1768681500240,"env":"test","module":"audit-log-service","userId":"bdfb6e90-bc4a-4227-ae5c-a6bda5ad4c4b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681500244,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681500732,"env":"test","module":"user-credentials-repository","userId":"865b95d3-e3a3-4170-864f-6e65176f5e51","msg":"User credentials created"}
{"level":30,"time":1768681500847,"env":"test","module":"email-queue","jobId":"46a67e87-7662-41ee-a4c0-682f7f6bd099","to":"protected-test-1VThVb0zeV3pnryNbYs3M@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681500909,"env":"test","module":"auth-routes","userId":"865b95d3-e3a3-4170-864f-6e65176f5e51","email":"protected-test-1VThVb0zeV3pnryNbYs3M@example.com","msg":"User registered"}
{"level":30,"time":1768681501678,"env":"test","module":"auth-routes","userId":"865b95d3-e3a3-4170-864f-6e65176f5e51","msg":"User logged in successfully"}
{"level":30,"time":1768681501736,"env":"test","module":"audit-log-service","userId":"865b95d3-e3a3-4170-864f-6e65176f5e51","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681501740,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681502243,"env":"test","module":"user-credentials-repository","userId":"35b6fa59-2c67-4b6f-8e69-3d3b68995623","msg":"User credentials created"}
{"level":30,"time":1768681502364,"env":"test","module":"email-queue","jobId":"88d91498-4207-4f35-a094-a94f2579ebf7","to":"protected-test-lE8OBMSL4zPebdi_E_794@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681502424,"env":"test","module":"auth-routes","userId":"35b6fa59-2c67-4b6f-8e69-3d3b68995623","email":"protected-test-lE8OBMSL4zPebdi_E_794@example.com","msg":"User registered"}
{"level":30,"time":1768681503194,"env":"test","module":"auth-routes","userId":"35b6fa59-2c67-4b6f-8e69-3d3b68995623","msg":"User logged in successfully"}
{"level":30,"time":1768681503255,"env":"test","module":"audit-log-service","userId":"35b6fa59-2c67-4b6f-8e69-3d3b68995623","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681503259,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681503779,"env":"test","module":"user-credentials-repository","userId":"61135e47-5994-4e0a-b9a2-c73a3ddad08d","msg":"User credentials created"}
{"level":30,"time":1768681503892,"env":"test","module":"email-queue","jobId":"dc71b772-c6db-4b2c-ad16-b9906aeead37","to":"protected-test-ZGQC-CPvd0-nC24T84LI8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681503955,"env":"test","module":"auth-routes","userId":"61135e47-5994-4e0a-b9a2-c73a3ddad08d","email":"protected-test-ZGQC-CPvd0-nC24T84LI8@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681504706,"env":"test","module":"auth-routes","userId":"61135e47-5994-4e0a-b9a2-c73a3ddad08d","msg":"User logged in successfully"}
{"level":30,"time":1768681504763,"env":"test","module":"audit-log-service","userId":"61135e47-5994-4e0a-b9a2-c73a3ddad08d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681504767,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681505242,"env":"test","module":"user-credentials-repository","userId":"eecd7978-30a6-4e25-8e20-fcbc713dc954","msg":"User credentials created"}
{"level":30,"time":1768681505355,"env":"test","module":"email-queue","jobId":"66774449-8df6-429f-8051-c4882f2a09c5","to":"protected-test-l10A-F8K8i5KvJzGLdrFT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681505412,"env":"test","module":"auth-routes","userId":"eecd7978-30a6-4e25-8e20-fcbc713dc954","email":"protected-test-l10A-F8K8i5KvJzGLdrFT@example.com","msg":"User registered"}
{"level":30,"time":1768681506119,"env":"test","module":"auth-routes","userId":"eecd7978-30a6-4e25-8e20-fcbc713dc954","msg":"User logged in successfully"}
{"level":30,"time":1768681506177,"env":"test","module":"audit-log-service","userId":"eecd7978-30a6-4e25-8e20-fcbc713dc954","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681506182,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681506621,"env":"test","module":"user-credentials-repository","userId":"2babd481-4ec7-4c51-9670-c664024612d4","msg":"User credentials created"}
{"level":30,"time":1768681506739,"env":"test","module":"email-queue","jobId":"3a295279-0a01-487c-a155-35cad4ae26a9","to":"protected-test-2QMe71NWYwIvfPfK8fBO2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681506804,"env":"test","module":"auth-routes","userId":"2babd481-4ec7-4c51-9670-c664024612d4","email":"protected-test-2QMe71NWYwIvfPfK8fBO2@example.com","msg":"User registered"}
{"level":50,"time":1768681507550,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["2babd481-4ec7-4c51-9670-c664024612d4","a423c75dccf932278fde4c769553db52efd4d41757d64ff0107572fde1d4a0ac","2026-02-16T20:25:07.468Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:25:07.468Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2babd481-4ec7-4c51-9670-c664024612d4) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":30,"time":1768681508411,"env":"test","module":"user-credentials-repository","userId":"5a6e5e2c-72dd-46c4-a789-0a22ed5bf989","msg":"User credentials created"}
{"level":30,"time":1768681508536,"env":"test","module":"email-queue","jobId":"8b4869b3-06f5-46e9-a2da-bfc458a148ba","to":"protected-test-VmnwQWt83BPWCy2E2KXwo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681508596,"env":"test","module":"auth-routes","userId":"5a6e5e2c-72dd-46c4-a789-0a22ed5bf989","email":"protected-test-VmnwQWt83BPWCy2E2KXwo@example.com","msg":"User registered"}
{"level":30,"time":1768681509655,"env":"test","module":"user-credentials-repository","userId":"1be9f1a7-c030-4980-a201-bb22179d2043","msg":"User credentials created"}
{"level":50,"time":1768681509744,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["1be9f1a7-c030-4980-a201-bb22179d2043","76164a1cfe393cd2b5b3f4d25cdcb9312a071f52d04d825696e19a55c2ab975c","2026-01-18T20:25:09.655Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1be9f1a7-c030-4980-a201-bb22179d2043) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681510494,"env":"test","module":"user-credentials-repository","userId":"41a5da11-6124-4a64-b6ed-daa8f6b9b0d6","msg":"User credentials created"}
{"level":30,"time":1768681510596,"env":"test","module":"email-queue","jobId":"abbaedbd-8f72-4cf2-84fd-da6f0446998c","to":"protected-test-5CNrjxA9B4JARRCHTk5Vw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681510647,"env":"test","module":"auth-routes","userId":"41a5da11-6124-4a64-b6ed-daa8f6b9b0d6","email":"protected-test-5CNrjxA9B4JARRCHTk5Vw@example.com","msg":"User registered"}
{"level":40,"time":1768681511195,"env":"test","module":"auth-routes","userId":"41a5da11-6124-4a64-b6ed-daa8f6b9b0d6","email":"protected-test-5CNrjxA9B4JARRCHTk5Vw@example.com","msg":"Login blocked: email not verified"}
{"level":50,"time":1768681511195,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768681511658,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["91bf024b-cd88-4066-8c57-36493daa52d1","$2b$12$dIo9cIKWRPGDMyxZgN05T.t8Z1LRTXOwuvQDX8W5BP8IYCnXCZmZC"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(91bf024b-cd88-4066-8c57-36493daa52d1) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"91bf024b-cd88-4066-8c57-36493daa52d1","msg":"Failed to create user credentials"}
{"level":50,"time":1768681511658,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["91bf024b-cd88-4066-8c57-36493daa52d1","$2b$12$dIo9cIKWRPGDMyxZgN05T.t8Z1LRTXOwuvQDX8W5BP8IYCnXCZmZC"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(91bf024b-cd88-4066-8c57-36493daa52d1) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681512564,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["df73a12f-ad92-4640-a1b2-e631f9865684","$2b$12$cEkRX/rCvft4fUKbi/bGlOQs4/yOlsyaN8ap1ZOW7Wqtw2KzYvzpC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(df73a12f-ad92-4640-a1b2-e631f9865684) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"df73a12f-ad92-4640-a1b2-e631f9865684","msg":"Failed to create user credentials"}
{"level":50,"time":1768681512565,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["df73a12f-ad92-4640-a1b2-e631f9865684","$2b$12$cEkRX/rCvft4fUKbi/bGlOQs4/yOlsyaN8ap1ZOW7Wqtw2KzYvzpC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(df73a12f-ad92-4640-a1b2-e631f9865684) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681513367,"env":"test","module":"user-credentials-repository","userId":"1e38635a-be9d-4998-8e73-5f0f823e2a2b","msg":"User credentials created"}
{"level":50,"time":1768681513419,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["1e38635a-be9d-4998-8e73-5f0f823e2a2b","1b78a01f198e6442d08a325160cb949822ea2b014fa456232afbdb268b064f37","2026-01-18T20:25:13.368Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1e38635a-be9d-4998-8e73-5f0f823e2a2b) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681514190,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bc6323ab-e561-4988-b94c-1a818091c301","$2b$12$jifSkFoq1nGwanvU1MdKfeZlHVWhc24fE0Sk7LIMeTsytfb8iMFkO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bc6323ab-e561-4988-b94c-1a818091c301) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bc6323ab-e561-4988-b94c-1a818091c301","msg":"Failed to create user credentials"}
{"level":50,"time":1768681514191,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bc6323ab-e561-4988-b94c-1a818091c301","$2b$12$jifSkFoq1nGwanvU1MdKfeZlHVWhc24fE0Sk7LIMeTsytfb8iMFkO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bc6323ab-e561-4988-b94c-1a818091c301) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681514946,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5de64f4e-55aa-4f9d-9a59-bd3de7524d1d","$2b$12$d/PXWP7DxrkHJFr7DSWtK.HgmdNBJirsOWZHipqHmC8u1wpZj9Cq6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5de64f4e-55aa-4f9d-9a59-bd3de7524d1d) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5de64f4e-55aa-4f9d-9a59-bd3de7524d1d","msg":"Failed to create user credentials"}
{"level":50,"time":1768681514946,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5de64f4e-55aa-4f9d-9a59-bd3de7524d1d","$2b$12$d/PXWP7DxrkHJFr7DSWtK.HgmdNBJirsOWZHipqHmC8u1wpZj9Cq6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5de64f4e-55aa-4f9d-9a59-bd3de7524d1d) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681515775,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["75942b3c-a522-44d7-97a5-1637d66731dc","$2b$12$pzQaznISgaTNIC4kpjCYZOvkL4kRGebDHOYRvhoEeFyQbwSjDy.Uu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(75942b3c-a522-44d7-97a5-1637d66731dc) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"75942b3c-a522-44d7-97a5-1637d66731dc","msg":"Failed to create user credentials"}
{"level":50,"time":1768681515775,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["75942b3c-a522-44d7-97a5-1637d66731dc","$2b$12$pzQaznISgaTNIC4kpjCYZOvkL4kRGebDHOYRvhoEeFyQbwSjDy.Uu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(75942b3c-a522-44d7-97a5-1637d66731dc) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681516626,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5c3f938f-23c0-4451-860b-dacd19d3d74b","$2b$12$t2dSRI8cCbOM/uMHjXoAF.qon3m72S.j5UNtw9eJKomPDZjr8IKYi"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5c3f938f-23c0-4451-860b-dacd19d3d74b) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5c3f938f-23c0-4451-860b-dacd19d3d74b","msg":"Failed to create user credentials"}
{"level":50,"time":1768681516627,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5c3f938f-23c0-4451-860b-dacd19d3d74b","$2b$12$t2dSRI8cCbOM/uMHjXoAF.qon3m72S.j5UNtw9eJKomPDZjr8IKYi"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5c3f938f-23c0-4451-860b-dacd19d3d74b) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681517207,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681517207,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 2babd481-4ec7-4c51-9670-c664024612d4,a423c75dccf932278fde4c769553db52efd4d41757d64ff0107572fde1d4a0ac,2026-02-16T20:25:07.468Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:25:07.468Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '2babd481-4ec7-4c51-9670-c664024612d4',
    'a423c75dccf932278fde4c769553db52efd4d41757d64ff0107572fde1d4a0ac',
    '2026-02-16T20:25:07.468Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:25:07.468Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 339,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(2babd481-4ec7-4c51-9670-c664024612d4) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w14_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:91:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: de65141e-f4d1-4d58-9647-f1852632771c
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ 'de65141e-f4d1-4d58-9647-f1852632771c' ],
  cause: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 346,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(beaaffc7-9ac6-4678-906b-0420ea177fd1) is still referenced from table "audit_logs".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 12 failed | 1 skipped) 45344ms
       Γ£ô should allow access with valid Bearer token  1433ms
       Γ£ô should reject access without Authorization header  1346ms
       Γ£ô should reject access with empty Bearer token  1357ms
       Γ£ô should reject access with malformed Authorization header  1330ms
       Γ£ô should reject access with wrong token type  1329ms
       Γ£ô should allow POST with valid Bearer token  1429ms
       Γ£ô should reject POST without Bearer token  1344ms
       Γ£ô should reject POST with invalid token  1354ms
       Γ£ô should allow PUT with valid Bearer token  1541ms
       Γ£ô should reject PUT without Bearer token  1338ms
       Γ£ô should allow DELETE with valid Bearer token  1565ms
       Γ£ô should reject DELETE without Bearer token  1490ms
       ├ù should allow PATCH with valid Bearer token 612ms
       Γ£ô should reject PATCH without Bearer token  1782ms
       Γ£ô should handle Bearer token with extra spaces  1357ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1427ms
       Γ£ô should handle empty Authorization header  1513ms
       Γ£ô should handle Authorization header with only Bearer  1496ms
       Γ£ô should handle multiple Authorization headers  1520ms
       Γ£ô should reject token with SQL injection attempt  1507ms
       Γ£ô should reject token with XSS attempt  1415ms
       ├ù should reject token with missing userId 1383ms
       ├ù should reject token with non-existent userId 1148ms
       ├ù should not allow user to access another user's resources 1034ms
       ├ù should inject userId into request context 1472ms
       ├ù should inject tenantId into request context 440ms
       ├ù should inject role into request context 907ms
       ├ù should not apply general rate limiting to authenticated requests 854ms
       ├ù should handle request with both Bearer token and cookies 772ms
       ├ù should prioritize Bearer token over cookie when both present 756ms
       ├ù should allow unauthenticated access to optional auth routes 828ms
       ├ù should enhance optional auth routes with user context when authenticated 852ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 12 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Error: expected 200 "OK", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: b472f5b0-a373-4af8-a23b-d97c53a42d55,5a6e5e2c-72dd-46c4-a789-0a22ed5bf989,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 399, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(b472f5b0-a373-4af8-a23b-d97c53a42d55) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: expected 200 "OK", got 403 "Forbidden"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/12]ΓÄ»


 Test Files  1 failed (1)
      Tests  12 failed | 20 passed | 1 skipped (33)
   Start at  14:24:19
   Duration  56.96s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x16 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681686943,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stderr | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Failed to create schema test_schema_w0_v3: error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

{"level":30,"time":1768681691952,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681692032,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681692098,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681692036,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681692046,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681692047,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681692051,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681692051,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681692056,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681692097,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681692098,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681692098,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Jlgow_5-1NIyuJ7A0myR-,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Jlgow_5-1NIyuJ7A0myR-', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 851ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Jlgow_5-1NIyuJ7A0myR-,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:26:05
   Duration  125.61s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x17 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681709676,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681715886,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681715887,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (via PGOPTIONS)"}
{"level":30,"time":1768681715963,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681716323,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681716342,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681716332,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681716332,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681716337,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681716338,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681716342,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681716342,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681716342,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681716342,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant kSuUnftzkQk8Yzv22tK46,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant kSuUnftzkQk8Yzv22tK46', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681716660,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768681716661,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1730ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant kSuUnftzkQk8Yzv22tK46,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:28:12
   Duration  23.17s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x18 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681928214,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768681961889,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681961890,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681967709,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681968002,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681968019,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681968009,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681968010,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681968014,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681968015,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681968019,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681968019,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681968019,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681968019,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681968315,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681968316,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant pSlaeCrmusV0YwZPmsDJ5,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant pSlaeCrmusV0YwZPmsDJ5', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 7234ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant pSlaeCrmusV0YwZPmsDJ5,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:31:53
   Duration  50.80s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x19 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681995856,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681998692,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681998693,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768681998736,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681999111,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681999126,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681999118,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681999118,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681999122,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681999122,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681999126,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681999126,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681999126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681999126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 9eFwqRUUH1XOZdo_Z8cjt,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 9eFwqRUUH1XOZdo_Z8cjt', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681999485,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768681999485,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1707ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 9eFwqRUUH1XOZdo_Z8cjt,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:33:02
   Duration  11.13s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x20 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688758268,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768688770000,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688770000,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688778571,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768688778878,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688778897,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768688778887,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688778888,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688778892,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688778892,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688778896,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688778897,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688778897,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688778897,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768688779208,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768688779209,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vQFcpKSBdBdyBet-DKX5q,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant vQFcpKSBdBdyBet-DKX5q', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 10041ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vQFcpKSBdBdyBet-DKX5q,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:25:36
   Duration  38.89s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x21 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688855902,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768688887690,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688887690,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688891514,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768688891825,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688891844,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768688891833,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688891834,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688891839,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688891839,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688891843,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688891843,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688891844,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688891844,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768688892153,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768688892153,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant t_GZepDvW9IgKVHCNANsC,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant t_GZepDvW9IgKVHCNANsC', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5299ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant t_GZepDvW9IgKVHCNANsC,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:26:38
   Duration  87.98s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x22 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688926858,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688942520,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688942521,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768688942586,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768688942918,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688942937,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768688942927,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688942927,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688942932,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688942932,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688942936,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688942937,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688942937,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688942937,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 60HN0CbGixSYLfhz8cM7K,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 60HN0CbGixSYLfhz8cM7K', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768688943244,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768688943245,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1580ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 60HN0CbGixSYLfhz8cM7K,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:28:26
   Duration  32.89s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x23 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689107458,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

{"level":30,"time":1768689134294,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689134295,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689137672,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768689137980,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689137995,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768689137987,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689137987,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689137991,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689137991,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689137995,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689137995,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689137995,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689137995,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768689138301,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768689138301,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant RMvTzV_eMA4CWNs67pUY5,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant RMvTzV_eMA4CWNs67pUY5', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4939ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant RMvTzV_eMA4CWNs67pUY5,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:31:36
   Duration  41.80s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x24 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689238972,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689248095,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689248096,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689248144,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689248468,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689248494,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768689248475,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689248483,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689248489,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689248489,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689248494,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689248494,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689248494,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689248494,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 07SCME81rKRbcPRuMCmWi,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 07SCME81rKRbcPRuMCmWi', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689248815,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768689248815,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1621ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 07SCME81rKRbcPRuMCmWi,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:33:48
   Duration  18.97s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x25 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689260567,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768689292844,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689292845,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689298094,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768689298397,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689298414,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768689298404,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689298405,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689298410,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689298410,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689298414,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689298414,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689298414,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689298414,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768689298716,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768689298716,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KmSPoM6lzzRbzDk4cZIQ2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant KmSPoM6lzzRbzDk4cZIQ2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6698ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KmSPoM6lzzRbzDk4cZIQ2,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:34:08
   Duration  46.43s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x26 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689333102,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689338428,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689338429,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689338518,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689338859,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689338876,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768689338866,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689338866,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689338871,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689338871,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689338876,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689338876,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689338876,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689338876,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 1He9zjfjclleNM8lFqCeH,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 1He9zjfjclleNM8lFqCeH', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689339192,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768689339192,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1705ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 1He9zjfjclleNM8lFqCeH,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:35:14
   Duration  21.41s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x27 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689374075,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689382741,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689382742,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689382793,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689383107,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689383126,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768689383115,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689383116,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689383120,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689383120,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689383126,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689383126,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689383126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689383126,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant VzUu5A3Mq5lOeHgz2WU_2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant VzUu5A3Mq5lOeHgz2WU_2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689383436,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768689383437,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1621ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant VzUu5A3Mq5lOeHgz2WU_2,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»

 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:36:01
   Duration  20.98s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x28 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690617479,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690649525,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690649525,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690649574,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690649868,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690649885,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768690649875,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690649876,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690649880,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690649880,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690649884,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690649884,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690649885,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690649885,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant eC3Mwhki85srTVhw8T0rt,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant eC3Mwhki85srTVhw8T0rt', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
{"level":30,"time":1768690650194,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690650195,"env":"test","msg":"DB: pool closed."}
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1540ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant eC3Mwhki85srTVhw8T0rt,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:56:43
   Duration  45.61s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x29 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690700455,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768690718358,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690718359,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690723473,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768690723770,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690723790,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768690723778,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690723779,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690723783,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690723784,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690723789,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690723789,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690723790,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690723790,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768690724096,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690724096,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant plsXKJ-ujGHsrohenXta9,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant plsXKJ-ujGHsrohenXta9', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6565ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant plsXKJ-ujGHsrohenXta9,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:58:08
   Duration  31.67s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x30 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690761351,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768690779206,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690779206,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690782438,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768690782734,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690782745,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768690782739,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690782740,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690782742,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690782742,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690782745,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690782745,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690782745,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690782745,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768690783042,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690783042,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant E4_BhAEjcMw4VGCdyfLMt,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant E4_BhAEjcMw4VGCdyfLMt', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4661ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant E4_BhAEjcMw4VGCdyfLMt,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:58:59
   Duration  39.59s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x31 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690806885,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690810975,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690810976,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690811029,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690811328,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690811347,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768690811336,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690811337,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690811342,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690811342,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690811347,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690811347,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690811347,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690811347,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant CNv8LWk0X7dvBdEIySFk2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant CNv8LWk0X7dvBdEIySFk2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690811649,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768690811650,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1490ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant CNv8LWk0X7dvBdEIySFk2,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:59:59
   Duration  11.92s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x32 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690831062,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768690838592,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690838592,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690843539,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768690843829,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690843847,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768690843837,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690843838,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690843842,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690843843,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690843847,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690843847,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690843847,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690843847,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768690844153,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690844153,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Okuh7KiG06Z_e4MXiUsht,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Okuh7KiG06Z_e4MXiUsht', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6442ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Okuh7KiG06Z_e4MXiUsht,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:00:11
   Duration  31.98s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x33 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690887298,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690891684,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690891684,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690891727,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690892060,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690892080,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768690892070,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690892070,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690892075,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690892075,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690892080,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690892080,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690892080,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690892080,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0s85VVBeIvbGCDna54Qvw,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 0s85VVBeIvbGCDna54Qvw', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690892375,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768690892376,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1597ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0s85VVBeIvbGCDna54Qvw,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16

 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:18
   Duration  13.32s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»

c[3J RERUN  server/services/WorkflowService.ts x34 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690903728,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690907714,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690907714,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690907762,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690908059,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690908079,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768690908068,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690908069,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690908074,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690908074,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690908078,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690908078,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690908079,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690908079,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant -FAcnEm5_ZTqXGfN2Aod2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant -FAcnEm5_ZTqXGfN2Aod2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768690908392,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690908392,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1503ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant -FAcnEm5_ZTqXGfN2Aod2,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:32
   Duration  15.35s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x35 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690922037,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690935328,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690935329,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690935385,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690935689,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690935709,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768690935698,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690935698,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690935703,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690935704,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690935709,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690935709,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690935709,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690935709,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant s61_lqC4PCDcxB-_QJwIK,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant s61_lqC4PCDcxB-_QJwIK', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690936015,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768690936016,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1514ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant s61_lqC4PCDcxB-_QJwIK,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:48
   Duration  27.08s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x36 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690994687,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691023281,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691023281,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691023398,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691023752,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691023775,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691023762,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691023762,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691023767,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691023767,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691023775,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691023775,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691023775,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691023775,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768691024086,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768691024086,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oOSq1MvkgnooSt4G5C89L,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant oOSq1MvkgnooSt4G5C89L', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1715ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oOSq1MvkgnooSt4G5C89L,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:02:46
   Duration  55.54s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x37 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691057512,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691065272,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691065272,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691065352,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691065677,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691065700,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768691065688,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691065689,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691065693,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691065693,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691065700,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691065700,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691065700,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691065700,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ky0x7nbGtpe2F5PNhJhRg,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ky0x7nbGtpe2F5PNhJhRg', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1621ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768691066021,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768691066021,"env":"test","msg":"DB: pool closed."}

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ky0x7nbGtpe2F5PNhJhRg,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:04:00
   Duration  21.84s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x38 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691122000,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691129870,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691129871,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691129922,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691130241,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768691130262,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691130250,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691130251,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691130256,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691130256,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691130261,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691130261,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691130262,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691130262,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vcUuCFJiRIqx2yd3Gt7Fb,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant vcUuCFJiRIqx2yd3Gt7Fb', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691130590,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768691130591,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1650ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vcUuCFJiRIqx2yd3Gt7Fb,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:05:12
   Duration  17.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x39 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691211191,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768691239999,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691240000,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691244481,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768691244804,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691244822,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691244812,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691244812,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691244817,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691244817,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691244821,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691244821,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691244821,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691244821,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768691245133,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768691245134,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant f7aONFnBu1VFkIBPtu9TO,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant f7aONFnBu1VFkIBPtu9TO', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6033ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant f7aONFnBu1VFkIBPtu9TO,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:06:18
   Duration  64.85s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x40 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691288998,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691291763,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691291764,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691291816,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691292145,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691292163,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768691292152,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691292153,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691292158,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691292158,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691292163,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691292163,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691292163,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691292163,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vBDy63K4L7hMjAQnSEbE1,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant vBDy63K4L7hMjAQnSEbE1', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691292477,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768691292478,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1568ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vBDy63K4L7hMjAQnSEbE1,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:07:25
   Duration  45.34s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»

c[3J RERUN  server/middleware/auth.ts x41 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test


ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
TypeError: Router.use() requires a middleware function
 Γ¥» router.use node_modules/express/lib/router/index.js:462:11
 Γ¥» server/routes/ai.doc.routes.ts:73:8
     71| 
     72| // Middleware
     73| router.use(hybridAuth);
       |        ^
     74| 
     75| /**
 Γ¥» server/routes/index.ts:9:1
 Γ¥» server/routes.ts:11:1
 Γ¥» tests/helpers/integrationTestHelper.ts:23:1

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»


 Test Files  1 failed (1)
      Tests  no tests
   Start at  17:50:27
   Duration  171ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/middleware/auth.ts x42 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test


ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
TypeError: Router.use() requires a middleware function
 Γ¥» router.use node_modules/express/lib/router/index.js:462:11
 Γ¥» server/routes/ai.doc.routes.ts:73:8
     71| 
     72| // Middleware
     73| router.use(hybridAuth);
       |        ^
     74| 
     75| /**
 Γ¥» server/routes/index.ts:9:1
 Γ¥» server/routes.ts:11:1
 Γ¥» tests/helpers/integrationTestHelper.ts:23:1

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»


 Test Files  1 failed (1)
      Tests  no tests
   Start at  17:50:40
   Duration  134ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/middleware/auth.ts x43 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768693878025,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768693914995,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768693914995,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768693915043,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768693915371,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768693915389,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768693915378,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768693915379,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768693915384,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768693915384,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768693915389,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768693915389,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768693915389,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768693915389,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4Gu_7Hs_rJuPW7I2ur8NF,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 4Gu_7Hs_rJuPW7I2ur8NF', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768693915707,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768693915708,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1542ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4Gu_7Hs_rJuPW7I2ur8NF,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:51:04
   Duration  51.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x44 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768693962248,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768693969053,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768693969053,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768693971129,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768693971420,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768693971435,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768693971426,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768693971427,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768693971431,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768693971431,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768693971435,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768693971435,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768693971435,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768693971435,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768693971722,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768693971722,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant qRzIBSGGHTtMZoTvUiJcj,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant qRzIBSGGHTtMZoTvUiJcj', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3522ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant qRzIBSGGHTtMZoTvUiJcj,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:52:32
   Duration  18.68s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x45 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694009937,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768694038215,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694038215,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694038491,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694038791,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694038810,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694038800,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694038801,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694038805,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694038805,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694038809,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694038809,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694038810,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694038810,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694039108,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694039108,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant zFST5d5_br9VXHbY_-Z3G,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant zFST5d5_br9VXHbY_-Z3G', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1721ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant zFST5d5_br9VXHbY_-Z3G,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:53:10
   Duration  44.48s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x46 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694137343,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694140603,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694140604,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694140676,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694140972,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694140992,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694140981,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694140982,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694140986,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694140987,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694140991,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694140992,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694140992,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694140992,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694141293,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694141294,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant biWHLEwM1ZlgSLs05tksX,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant biWHLEwM1ZlgSLs05tksX', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1538ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant biWHLEwM1ZlgSLs05tksX,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:54:15
   Duration  80.45s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x47 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694156261,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694158450,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694158450,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694158491,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694158783,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694158799,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768694158790,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694158790,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694158794,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694158795,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694158799,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694158799,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694158799,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694158799,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XAz09FxSRsUb5EOanpKu7,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant XAz09FxSRsUb5EOanpKu7', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694159085,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768694159085,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1437ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XAz09FxSRsUb5EOanpKu7,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^

     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»

 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:55:49
   Duration  7.03s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x48 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694467737,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694472610,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694472611,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694472670,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694472964,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694472984,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768694472972,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694472973,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694472977,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694472977,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694472983,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694472983,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694472983,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694472984,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant yZfzZ8NToWMC1aHldX1YL,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant yZfzZ8NToWMC1aHldX1YL', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694473288,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768694473289,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1612ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant yZfzZ8NToWMC1aHldX1YL,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:00:46
   Duration  25.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x49 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694487728,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694491659,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694491660,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694491712,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694492018,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694492041,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768694492029,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694492030,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694492035,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694492035,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694492041,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694492041,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694492041,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694492041,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant LFZRpWSCEZ_-Z-vPcG7Ja,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant LFZRpWSCEZ_-Z-vPcG7Ja', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694492362,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1623ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768694492362,"env":"test","msg":"DB: pool closed."}

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant LFZRpWSCEZ_-Z-vPcG7Ja,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:01:14
   Duration  16.84s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x50 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694512173,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768694558559,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694558560,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694567812,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694568124,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694568155,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694568135,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694568136,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694568140,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694568140,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694568154,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694568155,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694568155,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694568155,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694568495,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694568495,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ksXqziJWRAynWhlMmO36D,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ksXqziJWRAynWhlMmO36D', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 10830ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ksXqziJWRAynWhlMmO36D,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:01:39
   Duration  64.72s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x51 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694675398,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768694710094,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694710095,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694711962,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
{"level":30,"time":1768694712281,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694712303,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694712291,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694712292,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694712297,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694712297,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694712302,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694712302,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694712303,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694712303,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694712626,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694712627,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant tx1XR0pk78xcTY2YleAK9,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant tx1XR0pk78xcTY2YleAK9', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3382ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant tx1XR0pk78xcTY2YleAK9,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:02:55
   Duration  130.33s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x52 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694763824,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768694768033,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694768034,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694774358,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694774665,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694774686,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694774674,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694774675,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694774680,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694774680,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694774686,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694774686,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694774686,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694774686,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694775006,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694775007,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant SsjkgCGyJr2W2VxMeK56a,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant SsjkgCGyJr2W2VxMeK56a', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 7919ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant SsjkgCGyJr2W2VxMeK56a,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:05:13
   Duration  59.00s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x53 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694815234,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694819625,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694819626,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694819679,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694820011,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694820031,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768694820019,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694820020,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694820025,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694820026,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694820030,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694820031,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694820031,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694820031,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant wkTweDAaOCohTPvP-l8zN,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant wkTweDAaOCohTPvP-l8zN', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694820350,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1600ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768694820351,"env":"test","msg":"DB: pool closed."}

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant wkTweDAaOCohTPvP-l8zN,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:06:35
   Duration  18.47s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x54 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694864156,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694867085,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694867086,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694867123,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694867421,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694867433,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768694867426,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694867426,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694867429,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694867429,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694867432,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694867432,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694867433,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694867433,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vhYXxjAhAZO0jdZkccjlm,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant vhYXxjAhAZO0jdZkccjlm', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694867731,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768694867731,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1466ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant vhYXxjAhAZO0jdZkccjlm,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:07:00
   Duration  44.38s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x55 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695008581,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695020288,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695020289,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695020347,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768695020671,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695020688,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768695020679,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695020679,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695020683,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695020684,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695020688,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695020688,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695020688,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695020688,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant SsKBTzm7sk6snLPCbGhPI,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant SsKBTzm7sk6snLPCbGhPI', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768695021018,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768695021019,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1587ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant SsKBTzm7sk6snLPCbGhPI,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:09:55
   Duration  25.39s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x56 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695132626,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 9ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
ReferenceError: properties is not defined
 Γ¥» shouldConnectToDb tests/setup.ts:105:90
 Γ¥» tests/setup.ts:127:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:12:00
   Duration  36.67s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x57 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695241177,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] Check DB Connection: TEST_TYPE=undefined, DB_URL=PRESENT

{"level":30,"time":1768695255851,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695255851,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695257596,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768695257890,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695257907,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768695257897,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695257898,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695257901,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695257901,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695257906,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695257906,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695257907,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695257907,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768695258203,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768695258203,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:201:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:201:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Y0E5Tg17HDk4cayrSUETh,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Y0E5Tg17HDk4cayrSUETh', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3152ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Y0E5Tg17HDk4cayrSUETh,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:12:38
   Duration  99.54s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x58 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695347941,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695350952,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695350953,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695351002,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768695351312,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695351331,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768695351320,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695351321,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695351325,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695351326,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695351331,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695351331,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695351331,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695351331,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KmWWUiV-xaL5Ap6UTz7Eq,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant KmWWUiV-xaL5Ap6UTz7Eq', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768695351635,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768695351636,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1550ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KmWWUiV-xaL5Ap6UTz7Eq,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:14:49
   Duration  42.42s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/integration/auth/protected.routes.test.ts x59 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695563009,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695682662,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695682663,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695686502,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768695686801,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695686812,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768695686806,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695686807,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695686809,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695686809,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695686812,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695686812,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695686812,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695686812,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768695687126,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768695687126,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant F9s5C4zhePFtBmW5DHCCr,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant F9s5C4zhePFtBmW5DHCCr', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5300ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant F9s5C4zhePFtBmW5DHCCr,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:19:14
   Duration  132.42s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x60 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768701504976,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768701515654,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768701515655,"env":"test","msg":"DB: Created pool proxy to set search_path=\"test_schema_w0_v3\",public on all connections"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768701520649,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768701520944,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768701520962,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768701520952,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768701520953,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768701520957,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768701520957,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768701520962,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768701520962,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768701520962,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768701520962,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768701521284,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768701521285,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant aBYrduIuRPU91JTfsO-vV,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant aBYrduIuRPU91JTfsO-vV', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6452ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant aBYrduIuRPU91JTfsO-vV,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»

 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  19:56:33
   Duration  98.92s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x61 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768701779103,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768702007599,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768702007600,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768702030304,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768702030605,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768702030623,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768702030613,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768702030613,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768702030618,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768702030618,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768702030623,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768702030623,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768702030623,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768702030623,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768702030933,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768702030934,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 2Zj8qOjIK5zUfCfqOaoiT,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 2Zj8qOjIK5zUfCfqOaoiT', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 24173ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
[vitest-pool]: Timeout terminating forks worker for test files C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts.

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 2Zj8qOjIK5zUfCfqOaoiT,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/1]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  19:59:19
   Duration  465.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x62 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768702259775,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768702275518,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768702275518,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768702299802,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768702301709,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768702301727,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768702301717,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768702301717,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768702301721,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768702301721,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768702301727,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768702301727,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768702301727,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768702301727,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768702302167,"env":"test","module":"user-credentials-repository","userId":"814c79db-92c7-4e0d-9133-c74e500014d4","msg":"User credentials created"}
{"level":30,"time":1768702302262,"env":"test","module":"email-queue","jobId":"d94816ec-b3b0-4442-ac47-b70480200491","to":"test-dizfuvntRCAeT6xDd6tuL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702302311,"env":"test","module":"auth-routes","userId":"814c79db-92c7-4e0d-9133-c74e500014d4","email":"test-dizfuvntRCAeT6xDd6tuL@example.com","msg":"User registered"}
{"level":30,"time":1768702302927,"env":"test","module":"user-credentials-repository","userId":"8b95fd84-0600-4794-8484-43a883e04588","msg":"User credentials created"}
{"level":30,"time":1768702303024,"env":"test","module":"email-queue","jobId":"8b5e87c1-33fb-48e6-bd83-9317ccea135c","to":"protected-test-8QbvwVQw-AVXxgNi5ADNd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702303074,"env":"test","module":"auth-routes","userId":"8b95fd84-0600-4794-8484-43a883e04588","email":"protected-test-8QbvwVQw-AVXxgNi5ADNd@example.com","msg":"User registered"}
{"level":30,"time":1768702303699,"env":"test","module":"auth-routes","userId":"8b95fd84-0600-4794-8484-43a883e04588","msg":"User logged in successfully"}
{"level":30,"time":1768702303743,"env":"test","module":"audit-log-service","userId":"8b95fd84-0600-4794-8484-43a883e04588","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702304162,"env":"test","module":"user-credentials-repository","userId":"4cd23187-ff65-4da6-b5d4-a75973cd08c4","msg":"User credentials created"}
{"level":30,"time":1768702304254,"env":"test","module":"email-queue","jobId":"231b0765-b1fe-4535-ab04-a3229c723b45","to":"protected-test-GeG4hD5gXl822jhxgx3PM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702304298,"env":"test","module":"auth-routes","userId":"4cd23187-ff65-4da6-b5d4-a75973cd08c4","email":"protected-test-GeG4hD5gXl822jhxgx3PM@example.com","msg":"User registered"}
{"level":30,"time":1768702304869,"env":"test","module":"auth-routes","userId":"4cd23187-ff65-4da6-b5d4-a75973cd08c4","msg":"User logged in successfully"}
{"level":30,"time":1768702304915,"env":"test","module":"audit-log-service","userId":"4cd23187-ff65-4da6-b5d4-a75973cd08c4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702304921,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702305288,"env":"test","module":"user-credentials-repository","userId":"5bfdc984-d028-4cee-b774-6d08f2d7d78b","msg":"User credentials created"}
{"level":30,"time":1768702305379,"env":"test","module":"email-queue","jobId":"bc1f397f-2c0e-4a3f-853c-e009b8ff7955","to":"protected-test-FJ1qMJZp6Q6Gmqve4lNBN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702305423,"env":"test","module":"auth-routes","userId":"5bfdc984-d028-4cee-b774-6d08f2d7d78b","email":"protected-test-FJ1qMJZp6Q6Gmqve4lNBN@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Set default search_path for database: test_schema_w0_v3, public
Γ£à Enforced search_path: test_schema_w0_v3, public

{"level":30,"time":1768702306004,"env":"test","module":"auth-routes","userId":"5bfdc984-d028-4cee-b774-6d08f2d7d78b","msg":"User logged in successfully"}
{"level":30,"time":1768702306049,"env":"test","module":"audit-log-service","userId":"5bfdc984-d028-4cee-b774-6d08f2d7d78b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702306054,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702306442,"env":"test","module":"user-credentials-repository","userId":"cb0be8c4-cea0-4236-986f-c5183c54b496","msg":"User credentials created"}
{"level":30,"time":1768702306536,"env":"test","module":"email-queue","jobId":"8ba425ba-d018-4f94-a4a0-69b5cc158f8f","to":"protected-test-ym1mx5QvX9JYGP1iztogW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702306587,"env":"test","module":"auth-routes","userId":"cb0be8c4-cea0-4236-986f-c5183c54b496","email":"protected-test-ym1mx5QvX9JYGP1iztogW@example.com","msg":"User registered"}
{"level":30,"time":1768702307175,"env":"test","module":"auth-routes","userId":"cb0be8c4-cea0-4236-986f-c5183c54b496","msg":"User logged in successfully"}
{"level":30,"time":1768702307223,"env":"test","module":"audit-log-service","userId":"cb0be8c4-cea0-4236-986f-c5183c54b496","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702307227,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702307585,"env":"test","module":"user-credentials-repository","userId":"f775e6c8-1d06-40f3-ba52-c757f5617f81","msg":"User credentials created"}
{"level":30,"time":1768702307674,"env":"test","module":"email-queue","jobId":"71802594-4e72-429d-8fcb-2eb355639549","to":"protected-test-BRHy5wrvhXTMRHtGhbHS_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702307720,"env":"test","module":"auth-routes","userId":"f775e6c8-1d06-40f3-ba52-c757f5617f81","email":"protected-test-BRHy5wrvhXTMRHtGhbHS_@example.com","msg":"User registered"}
{"level":30,"time":1768702308294,"env":"test","module":"auth-routes","userId":"f775e6c8-1d06-40f3-ba52-c757f5617f81","msg":"User logged in successfully"}
{"level":30,"time":1768702308338,"env":"test","module":"audit-log-service","userId":"f775e6c8-1d06-40f3-ba52-c757f5617f81","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702308342,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768702308342,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702308702,"env":"test","module":"user-credentials-repository","userId":"240e521c-5784-49a8-b964-dc2f209c475c","msg":"User credentials created"}
{"level":30,"time":1768702308795,"env":"test","module":"email-queue","jobId":"e37f5165-a362-4f46-a8b7-a9cd7be85138","to":"protected-test-dWzIsjWIzSf2PHDVcDJ52@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702308839,"env":"test","module":"auth-routes","userId":"240e521c-5784-49a8-b964-dc2f209c475c","email":"protected-test-dWzIsjWIzSf2PHDVcDJ52@example.com","msg":"User registered"}
{"level":30,"time":1768702309445,"env":"test","module":"auth-routes","userId":"240e521c-5784-49a8-b964-dc2f209c475c","msg":"User logged in successfully"}
{"level":30,"time":1768702309490,"env":"test","module":"audit-log-service","userId":"240e521c-5784-49a8-b964-dc2f209c475c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702309901,"env":"test","module":"user-credentials-repository","userId":"eb59e78b-9175-4c8f-abf0-b2c585a637bb","msg":"User credentials created"}
{"level":30,"time":1768702309993,"env":"test","module":"email-queue","jobId":"404deddc-9b05-4715-9f76-38a60278d0d6","to":"protected-test-StNZ06FoPoL60MDiKJP1O@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702310036,"env":"test","module":"auth-routes","userId":"eb59e78b-9175-4c8f-abf0-b2c585a637bb","email":"protected-test-StNZ06FoPoL60MDiKJP1O@example.com","msg":"User registered"}
{"level":30,"time":1768702310606,"env":"test","module":"auth-routes","userId":"eb59e78b-9175-4c8f-abf0-b2c585a637bb","msg":"User logged in successfully"}
{"level":30,"time":1768702310650,"env":"test","module":"audit-log-service","userId":"eb59e78b-9175-4c8f-abf0-b2c585a637bb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702310654,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702311007,"env":"test","module":"user-credentials-repository","userId":"7349bf13-01d3-41b8-be20-c7f4b4e75625","msg":"User credentials created"}
{"level":30,"time":1768702311095,"env":"test","module":"email-queue","jobId":"70e77cd0-10b2-4daf-b295-56b6e5c8b6a3","to":"protected-test-kBWPPYpfhoXp2JiWolneG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702311139,"env":"test","module":"auth-routes","userId":"7349bf13-01d3-41b8-be20-c7f4b4e75625","email":"protected-test-kBWPPYpfhoXp2JiWolneG@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
Γ£à Current search_path: test_schema_w0_v3, public
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768702311720,"env":"test","module":"auth-routes","userId":"7349bf13-01d3-41b8-be20-c7f4b4e75625","msg":"User logged in successfully"}
{"level":30,"time":1768702311766,"env":"test","module":"audit-log-service","userId":"7349bf13-01d3-41b8-be20-c7f4b4e75625","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702311769,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702312143,"env":"test","module":"user-credentials-repository","userId":"2a0ed1cb-f19f-43f7-8661-916bb6fe062a","msg":"User credentials created"}
{"level":30,"time":1768702312236,"env":"test","module":"email-queue","jobId":"87059a33-64dd-4d54-83b4-27dd23c80be9","to":"protected-test-T-rP-trzb8K_J221V5a9u@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702312285,"env":"test","module":"auth-routes","userId":"2a0ed1cb-f19f-43f7-8661-916bb6fe062a","email":"protected-test-T-rP-trzb8K_J221V5a9u@example.com","msg":"User registered"}
{"level":30,"time":1768702312883,"env":"test","module":"auth-routes","userId":"2a0ed1cb-f19f-43f7-8661-916bb6fe062a","msg":"User logged in successfully"}
{"level":30,"time":1768702312928,"env":"test","module":"audit-log-service","userId":"2a0ed1cb-f19f-43f7-8661-916bb6fe062a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=2a0ed1cb-f19f-43f7-8661-916bb6fe062a, updates={"defaultMode":"advanced","updatedAt":"2026-01-18T02:11:53.020Z"}
{"level":30,"time":1768702313442,"env":"test","module":"user-credentials-repository","userId":"fcb86c53-44ee-4534-a575-efd521158303","msg":"User credentials created"}
{"level":30,"time":1768702313531,"env":"test","module":"email-queue","jobId":"d0bb20aa-1c24-475b-85b8-7dc48591e8d0","to":"protected-test-qM6g-ye5M6ZPaH3goz7Gz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702313576,"env":"test","module":"auth-routes","userId":"fcb86c53-44ee-4534-a575-efd521158303","email":"protected-test-qM6g-ye5M6ZPaH3goz7Gz@example.com","msg":"User registered"}
{"level":30,"time":1768702314184,"env":"test","module":"auth-routes","userId":"fcb86c53-44ee-4534-a575-efd521158303","msg":"User logged in successfully"}
{"level":30,"time":1768702314235,"env":"test","module":"audit-log-service","userId":"fcb86c53-44ee-4534-a575-efd521158303","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702314240,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702314626,"env":"test","module":"user-credentials-repository","userId":"90c30ad1-ab54-4156-9268-a738e3f6453f","msg":"User credentials created"}
{"level":30,"time":1768702314714,"env":"test","module":"email-queue","jobId":"67149683-bcf5-41ce-b164-80fb96aedd2f","to":"protected-test-vTdaUzj-wCChpBQposDc0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702314758,"env":"test","module":"auth-routes","userId":"90c30ad1-ab54-4156-9268-a738e3f6453f","email":"protected-test-vTdaUzj-wCChpBQposDc0@example.com","msg":"User registered"}
{"level":30,"time":1768702315373,"env":"test","module":"auth-routes","userId":"90c30ad1-ab54-4156-9268-a738e3f6453f","msg":"User logged in successfully"}
{"level":30,"time":1768702315418,"env":"test","module":"audit-log-service","userId":"90c30ad1-ab54-4156-9268-a738e3f6453f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702315931,"env":"test","module":"user-credentials-repository","userId":"b640fe0c-deac-4685-a3b0-c627ec3549ae","msg":"User credentials created"}
{"level":30,"time":1768702316026,"env":"test","module":"email-queue","jobId":"66677895-3c1f-4fbb-bc76-b082792d8604","to":"protected-test-XgJkAXsehoyKIAmkWNK4Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702316070,"env":"test","module":"auth-routes","userId":"b640fe0c-deac-4685-a3b0-c627ec3549ae","email":"protected-test-XgJkAXsehoyKIAmkWNK4Y@example.com","msg":"User registered"}
{"level":30,"time":1768702316647,"env":"test","module":"auth-routes","userId":"b640fe0c-deac-4685-a3b0-c627ec3549ae","msg":"User logged in successfully"}
{"level":30,"time":1768702316691,"env":"test","module":"audit-log-service","userId":"b640fe0c-deac-4685-a3b0-c627ec3549ae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702316695,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702317052,"env":"test","module":"user-credentials-repository","userId":"103582ef-a3e8-499b-97a3-ea0a27f6e793","msg":"User credentials created"}
{"level":30,"time":1768702317149,"env":"test","module":"email-queue","jobId":"6c6e03c5-0f3f-41b1-96e5-a83f7768eee3","to":"protected-test-KahoPzHwjOZpj6IwwcLAN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702317195,"env":"test","module":"auth-routes","userId":"103582ef-a3e8-499b-97a3-ea0a27f6e793","email":"protected-test-KahoPzHwjOZpj6IwwcLAN@example.com","msg":"User registered"}
{"level":30,"time":1768702317771,"env":"test","module":"auth-routes","userId":"103582ef-a3e8-499b-97a3-ea0a27f6e793","msg":"User logged in successfully"}
{"level":30,"time":1768702317815,"env":"test","module":"audit-log-service","userId":"103582ef-a3e8-499b-97a3-ea0a27f6e793","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702318785,"env":"test","module":"user-credentials-repository","userId":"59104d7b-2f12-48dd-a9dd-f7d74ba1319e","msg":"User credentials created"}
{"level":30,"time":1768702318882,"env":"test","module":"email-queue","jobId":"4d7b934b-ae15-4058-9876-907c4370a436","to":"protected-test-D2Dta8Ytvsgyyo25JsJ--@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702318932,"env":"test","module":"auth-routes","userId":"59104d7b-2f12-48dd-a9dd-f7d74ba1319e","email":"protected-test-D2Dta8Ytvsgyyo25JsJ--@example.com","msg":"User registered"}
{"level":30,"time":1768702319514,"env":"test","module":"auth-routes","userId":"59104d7b-2f12-48dd-a9dd-f7d74ba1319e","msg":"User logged in successfully"}
{"level":30,"time":1768702319573,"env":"test","module":"audit-log-service","userId":"59104d7b-2f12-48dd-a9dd-f7d74ba1319e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702319577,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702319938,"env":"test","module":"user-credentials-repository","userId":"9106b46e-1fc6-4696-b110-5e654e0a4716","msg":"User credentials created"}
{"level":30,"time":1768702320027,"env":"test","module":"email-queue","jobId":"b17c403d-583a-4c9e-b326-8a75e14ded82","to":"protected-test-hLHntdM-kErgIeeIIYMjt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702320075,"env":"test","module":"auth-routes","userId":"9106b46e-1fc6-4696-b110-5e654e0a4716","email":"protected-test-hLHntdM-kErgIeeIIYMjt@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768702320660,"env":"test","module":"auth-routes","userId":"9106b46e-1fc6-4696-b110-5e654e0a4716","msg":"User logged in successfully"}
{"level":30,"time":1768702320704,"env":"test","module":"audit-log-service","userId":"9106b46e-1fc6-4696-b110-5e654e0a4716","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702320710,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768702320710,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702321079,"env":"test","module":"user-credentials-repository","userId":"d60144bb-52ae-4d3c-81dc-f60547c53c48","msg":"User credentials created"}
{"level":30,"time":1768702321175,"env":"test","module":"email-queue","jobId":"b1853c88-ad8f-43ce-871d-9d692bd7b08a","to":"protected-test-V4y6kgrw3GuvKPgexXeHU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702321219,"env":"test","module":"auth-routes","userId":"d60144bb-52ae-4d3c-81dc-f60547c53c48","email":"protected-test-V4y6kgrw3GuvKPgexXeHU@example.com","msg":"User registered"}
{"level":30,"time":1768702321800,"env":"test","module":"auth-routes","userId":"d60144bb-52ae-4d3c-81dc-f60547c53c48","msg":"User logged in successfully"}
{"level":30,"time":1768702321845,"env":"test","module":"audit-log-service","userId":"d60144bb-52ae-4d3c-81dc-f60547c53c48","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702321849,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702322207,"env":"test","module":"user-credentials-repository","userId":"4dff340c-ffca-44ae-93f7-9899f4324286","msg":"User credentials created"}
{"level":30,"time":1768702322302,"env":"test","module":"email-queue","jobId":"70778211-2951-4009-8d53-cbf6c5202b83","to":"protected-test--uKfL5y4bgeAej96FmgI_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702322347,"env":"test","module":"auth-routes","userId":"4dff340c-ffca-44ae-93f7-9899f4324286","email":"protected-test--uKfL5y4bgeAej96FmgI_@example.com","msg":"User registered"}
{"level":30,"time":1768702322930,"env":"test","module":"auth-routes","userId":"4dff340c-ffca-44ae-93f7-9899f4324286","msg":"User logged in successfully"}
{"level":30,"time":1768702322974,"env":"test","module":"audit-log-service","userId":"4dff340c-ffca-44ae-93f7-9899f4324286","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702322978,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702323333,"env":"test","module":"user-credentials-repository","userId":"eda5e976-975e-4030-b569-2928fc170412","msg":"User credentials created"}
{"level":30,"time":1768702323426,"env":"test","module":"email-queue","jobId":"1c9c8a79-fb80-4367-80db-aa250ce336cc","to":"protected-test-LPvnjjt0sUFj9VihiJwFv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702323469,"env":"test","module":"auth-routes","userId":"eda5e976-975e-4030-b569-2928fc170412","email":"protected-test-LPvnjjt0sUFj9VihiJwFv@example.com","msg":"User registered"}
{"level":30,"time":1768702324057,"env":"test","module":"auth-routes","userId":"eda5e976-975e-4030-b569-2928fc170412","msg":"User logged in successfully"}
{"level":30,"time":1768702324102,"env":"test","module":"audit-log-service","userId":"eda5e976-975e-4030-b569-2928fc170412","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702324108,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702324467,"env":"test","module":"user-credentials-repository","userId":"ad1b11ef-da5b-45c0-a635-618c3f5bfae6","msg":"User credentials created"}
{"level":30,"time":1768702324553,"env":"test","module":"email-queue","jobId":"c56551aa-3a5f-4220-9461-5d5c365fbc27","to":"protected-test-ma7O3dll_VY3-jSf56XzB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702324597,"env":"test","module":"auth-routes","userId":"ad1b11ef-da5b-45c0-a635-618c3f5bfae6","email":"protected-test-ma7O3dll_VY3-jSf56XzB@example.com","msg":"User registered"}
{"level":30,"time":1768702325172,"env":"test","module":"auth-routes","userId":"ad1b11ef-da5b-45c0-a635-618c3f5bfae6","msg":"User logged in successfully"}
{"level":30,"time":1768702325216,"env":"test","module":"audit-log-service","userId":"ad1b11ef-da5b-45c0-a635-618c3f5bfae6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702325219,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702325579,"env":"test","module":"user-credentials-repository","userId":"6d735add-0b40-450b-a80a-fe6017035315","msg":"User credentials created"}
{"level":30,"time":1768702325673,"env":"test","module":"email-queue","jobId":"4d27a8af-af25-4237-9de5-da0ec6937560","to":"protected-test-AJLUM3_veF_-8ZGxYVKWW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702325717,"env":"test","module":"auth-routes","userId":"6d735add-0b40-450b-a80a-fe6017035315","email":"protected-test-AJLUM3_veF_-8ZGxYVKWW@example.com","msg":"User registered"}
{"level":30,"time":1768702326302,"env":"test","module":"auth-routes","userId":"6d735add-0b40-450b-a80a-fe6017035315","msg":"User logged in successfully"}
{"level":30,"time":1768702326347,"env":"test","module":"audit-log-service","userId":"6d735add-0b40-450b-a80a-fe6017035315","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702326351,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702326721,"env":"test","module":"user-credentials-repository","userId":"1b7c8cee-0d03-4acf-9938-4bf353e5fcde","msg":"User credentials created"}
{"level":30,"time":1768702326810,"env":"test","module":"email-queue","jobId":"3e0aa44b-edd9-49e5-af07-4cada32b9273","to":"protected-test-LjEswuhqHxwaHwSVxn2th@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702326854,"env":"test","module":"auth-routes","userId":"1b7c8cee-0d03-4acf-9938-4bf353e5fcde","email":"protected-test-LjEswuhqHxwaHwSVxn2th@example.com","msg":"User registered"}
{"level":30,"time":1768702327429,"env":"test","module":"auth-routes","userId":"1b7c8cee-0d03-4acf-9938-4bf353e5fcde","msg":"User logged in successfully"}
{"level":30,"time":1768702327475,"env":"test","module":"audit-log-service","userId":"1b7c8cee-0d03-4acf-9938-4bf353e5fcde","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702327479,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702327859,"env":"test","module":"user-credentials-repository","userId":"9fccfac6-cd52-4ed5-9927-52aa9e2508bc","msg":"User credentials created"}
{"level":30,"time":1768702327957,"env":"test","module":"email-queue","jobId":"c7100526-0eaa-4746-9372-3f4187b9705d","to":"protected-test-C4kQxROtxILMUbjfQHoVQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702328006,"env":"test","module":"auth-routes","userId":"9fccfac6-cd52-4ed5-9927-52aa9e2508bc","email":"protected-test-C4kQxROtxILMUbjfQHoVQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768702328587,"env":"test","module":"auth-routes","userId":"9fccfac6-cd52-4ed5-9927-52aa9e2508bc","msg":"User logged in successfully"}
{"level":30,"time":1768702328632,"env":"test","module":"audit-log-service","userId":"9fccfac6-cd52-4ed5-9927-52aa9e2508bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702328988,"env":"test","module":"user-credentials-repository","userId":"cf7539ba-13a7-48b5-b932-ca76de2762a6","msg":"User credentials created"}
{"level":30,"time":1768702329075,"env":"test","module":"email-queue","jobId":"5d6054f9-ef53-4568-95d7-84e8a3ad502c","to":"protected-test-DAWwe0PTVA0EuVSLn7-vf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702329118,"env":"test","module":"auth-routes","userId":"cf7539ba-13a7-48b5-b932-ca76de2762a6","email":"protected-test-DAWwe0PTVA0EuVSLn7-vf@example.com","msg":"User registered"}
{"level":30,"time":1768702329695,"env":"test","module":"auth-routes","userId":"cf7539ba-13a7-48b5-b932-ca76de2762a6","msg":"User logged in successfully"}
{"level":30,"time":1768702329740,"env":"test","module":"audit-log-service","userId":"cf7539ba-13a7-48b5-b932-ca76de2762a6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702330192,"env":"test","module":"user-credentials-repository","userId":"4f62fa4a-2238-4590-8390-b1873750b91b","msg":"User credentials created"}
{"level":30,"time":1768702330279,"env":"test","module":"email-queue","jobId":"87b8a955-d23b-41ab-a3ec-54469d02f8b9","to":"protected-test-qTMpO3AZTpLzECzrajPHs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702330324,"env":"test","module":"auth-routes","userId":"4f62fa4a-2238-4590-8390-b1873750b91b","email":"protected-test-qTMpO3AZTpLzECzrajPHs@example.com","msg":"User registered"}
{"level":30,"time":1768702330900,"env":"test","module":"auth-routes","userId":"4f62fa4a-2238-4590-8390-b1873750b91b","msg":"User logged in successfully"}
{"level":30,"time":1768702330944,"env":"test","module":"audit-log-service","userId":"4f62fa4a-2238-4590-8390-b1873750b91b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702331298,"env":"test","module":"user-credentials-repository","userId":"66f93467-d5c6-4e87-878e-f534cb5c02c1","msg":"User credentials created"}
{"level":30,"time":1768702331390,"env":"test","module":"email-queue","jobId":"534e9599-9ee2-4a25-ad1b-d94f16ec8b81","to":"user2-pTx_CZv8PJtc_x-L6zEfH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702331435,"env":"test","module":"auth-routes","userId":"66f93467-d5c6-4e87-878e-f534cb5c02c1","email":"user2-pTx_CZv8PJtc_x-L6zEfH@example.com","msg":"User registered"}
{"level":30,"time":1768702331974,"env":"test","module":"auth-routes","userId":"66f93467-d5c6-4e87-878e-f534cb5c02c1","msg":"User logged in successfully"}
{"level":30,"time":1768702332019,"env":"test","module":"audit-log-service","userId":"66f93467-d5c6-4e87-878e-f534cb5c02c1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702332070,"env":"test","module":"rbac-middleware","userId":"66f93467-d5c6-4e87-878e-f534cb5c02c1","userRole":"viewer","permission":"project:delete","path":"/3a58639c-d4ad-432c-b195-fa181f17d3e2","msg":"Permission denied"}
{"level":30,"time":1768702332426,"env":"test","module":"user-credentials-repository","userId":"fcf8ed0f-3eae-4f74-8b9e-9d230c29f8c8","msg":"User credentials created"}
{"level":30,"time":1768702332523,"env":"test","module":"email-queue","jobId":"ee92c0c2-e375-4041-a541-5aed6a69fd6f","to":"protected-test-H-OuisQKLtuAWKbNd6_sk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702332568,"env":"test","module":"auth-routes","userId":"fcf8ed0f-3eae-4f74-8b9e-9d230c29f8c8","email":"protected-test-H-OuisQKLtuAWKbNd6_sk@example.com","msg":"User registered"}
{"level":30,"time":1768702333188,"env":"test","module":"auth-routes","userId":"fcf8ed0f-3eae-4f74-8b9e-9d230c29f8c8","msg":"User logged in successfully"}
{"level":30,"time":1768702333233,"env":"test","module":"audit-log-service","userId":"fcf8ed0f-3eae-4f74-8b9e-9d230c29f8c8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702333646,"env":"test","module":"user-credentials-repository","userId":"2dca827c-f9bc-4518-9ca5-22368b2135c7","msg":"User credentials created"}
{"level":30,"time":1768702333736,"env":"test","module":"email-queue","jobId":"5852b3a9-5da2-4879-b919-629cf454e026","to":"protected-test-AVBIjorcCAtPZ-D83PW67@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702333781,"env":"test","module":"auth-routes","userId":"2dca827c-f9bc-4518-9ca5-22368b2135c7","email":"protected-test-AVBIjorcCAtPZ-D83PW67@example.com","msg":"User registered"}
{"level":30,"time":1768702334368,"env":"test","module":"auth-routes","userId":"2dca827c-f9bc-4518-9ca5-22368b2135c7","msg":"User logged in successfully"}
{"level":30,"time":1768702334413,"env":"test","module":"audit-log-service","userId":"2dca827c-f9bc-4518-9ca5-22368b2135c7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702334815,"env":"test","module":"user-credentials-repository","userId":"4aafe66b-05fc-4248-8ad9-b3ba7b34b5bf","msg":"User credentials created"}
{"level":30,"time":1768702334904,"env":"test","module":"email-queue","jobId":"626f30e0-8f49-4b79-ba51-b02f5b15e77e","to":"protected-test-NyljVvYfvZFOW2DSKqJBo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702334948,"env":"test","module":"auth-routes","userId":"4aafe66b-05fc-4248-8ad9-b3ba7b34b5bf","email":"protected-test-NyljVvYfvZFOW2DSKqJBo@example.com","msg":"User registered"}
{"level":30,"time":1768702335526,"env":"test","module":"auth-routes","userId":"4aafe66b-05fc-4248-8ad9-b3ba7b34b5bf","msg":"User logged in successfully"}
{"level":30,"time":1768702335574,"env":"test","module":"audit-log-service","userId":"4aafe66b-05fc-4248-8ad9-b3ba7b34b5bf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702335993,"env":"test","module":"user-credentials-repository","userId":"6d944820-bc14-4ae9-ae15-9828f84e34d8","msg":"User credentials created"}
{"level":30,"time":1768702336088,"env":"test","module":"email-queue","jobId":"ce409357-5c39-40fd-8852-6db13e10c929","to":"protected-test-molhVxMIUZne4Wv5PLTZ0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702336134,"env":"test","module":"auth-routes","userId":"6d944820-bc14-4ae9-ae15-9828f84e34d8","email":"protected-test-molhVxMIUZne4Wv5PLTZ0@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768702336726,"env":"test","module":"auth-routes","userId":"6d944820-bc14-4ae9-ae15-9828f84e34d8","msg":"User logged in successfully"}
{"level":30,"time":1768702336771,"env":"test","module":"audit-log-service","userId":"6d944820-bc14-4ae9-ae15-9828f84e34d8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702337580,"env":"test","module":"user-credentials-repository","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","msg":"User credentials created"}
{"level":30,"time":1768702337668,"env":"test","module":"email-queue","jobId":"24bb80a6-b2b6-455d-a90a-d0563da3c122","to":"protected-test-htT9BdnlNzmKDWchwW8-U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702337713,"env":"test","module":"auth-routes","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","email":"protected-test-htT9BdnlNzmKDWchwW8-U@example.com","msg":"User registered"}
{"level":30,"time":1768702338304,"env":"test","module":"auth-routes","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","msg":"User logged in successfully"}
{"level":30,"time":1768702338347,"env":"test","module":"audit-log-service","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702338844,"env":"test","module":"auth-routes","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","msg":"User logged in successfully"}
{"level":30,"time":1768702338887,"env":"test","module":"audit-log-service","userId":"5c5d0c49-1826-4102-85dc-f8c93f138455","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702339279,"env":"test","module":"user-credentials-repository","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","msg":"User credentials created"}
{"level":30,"time":1768702339371,"env":"test","module":"email-queue","jobId":"64ec40b6-8368-445f-bba5-05f375eb7101","to":"protected-test-7-YCDXbfrqNygFIC7KRkR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702339415,"env":"test","module":"auth-routes","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","email":"protected-test-7-YCDXbfrqNygFIC7KRkR@example.com","msg":"User registered"}
{"level":30,"time":1768702339984,"env":"test","module":"auth-routes","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","msg":"User logged in successfully"}
{"level":30,"time":1768702340029,"env":"test","module":"audit-log-service","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702340546,"env":"test","module":"auth-routes","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","msg":"User logged in successfully"}
{"level":30,"time":1768702340590,"env":"test","module":"audit-log-service","userId":"9bd2a00b-3a97-4524-9cf1-fc591f3ea025","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702340945,"env":"test","module":"user-credentials-repository","userId":"6b75d751-d941-4b3d-a1b7-8b4ca5399d20","msg":"User credentials created"}
{"level":30,"time":1768702341037,"env":"test","module":"email-queue","jobId":"85b60673-aefb-4d83-9d05-2de4411c96a8","to":"user2-5nGMW1h9kOEG39z4xGEew@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702341082,"env":"test","module":"auth-routes","userId":"6b75d751-d941-4b3d-a1b7-8b4ca5399d20","email":"user2-5nGMW1h9kOEG39z4xGEew@example.com","msg":"User registered"}
{"level":30,"time":1768702341574,"env":"test","module":"auth-routes","userId":"6b75d751-d941-4b3d-a1b7-8b4ca5399d20","msg":"User logged in successfully"}
{"level":30,"time":1768702341623,"env":"test","module":"audit-log-service","userId":"6b75d751-d941-4b3d-a1b7-8b4ca5399d20","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702342081,"env":"test","module":"user-credentials-repository","userId":"d43c52b2-fed6-4958-a17e-571cfcec44c5","msg":"User credentials created"}
{"level":30,"time":1768702342173,"env":"test","module":"email-queue","jobId":"8e1d2d58-11f9-4ecc-ac46-23ac9b3bce41","to":"protected-test-3kb6P4SR14JSM11AaaGt1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702342222,"env":"test","module":"auth-routes","userId":"d43c52b2-fed6-4958-a17e-571cfcec44c5","email":"protected-test-3kb6P4SR14JSM11AaaGt1@example.com","msg":"User registered"}
{"level":30,"time":1768702342806,"env":"test","module":"auth-routes","userId":"d43c52b2-fed6-4958-a17e-571cfcec44c5","msg":"User logged in successfully"}
{"level":30,"time":1768702342850,"env":"test","module":"audit-log-service","userId":"d43c52b2-fed6-4958-a17e-571cfcec44c5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768702343317,"env":"test","module":"intake-service","runId":"b0876121-f9b2-4a60-a109-06ba8be230aa","slug":"public-Bg9s7oBfgp5-PWWItP0WS","msg":"Created intake run"}
{"level":30,"time":1768702343717,"env":"test","module":"user-credentials-repository","userId":"9f150887-be5e-4bb7-9a48-0b9d966ad2a4","msg":"User credentials created"}
{"level":30,"time":1768702343808,"env":"test","module":"email-queue","jobId":"17c840df-6a0a-4987-b39a-f337803ec8d2","to":"protected-test-UeXerPSizhvMImN72Hp7d@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702343852,"env":"test","module":"auth-routes","userId":"9f150887-be5e-4bb7-9a48-0b9d966ad2a4","email":"protected-test-UeXerPSizhvMImN72Hp7d@example.com","msg":"User registered"}
{"level":30,"time":1768702344427,"env":"test","module":"auth-routes","userId":"9f150887-be5e-4bb7-9a48-0b9d966ad2a4","msg":"User logged in successfully"}
{"level":30,"time":1768702344473,"env":"test","module":"audit-log-service","userId":"9f150887-be5e-4bb7-9a48-0b9d966ad2a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702344939,"env":"test","module":"intake-service","runId":"b4c5646f-2db4-471e-b810-95e820ce68cb","slug":"optional-a0vtAZ0uBLUSwYoq9eXVd","userId":"9f150887-be5e-4bb7-9a48-0b9d966ad2a4","msg":"Created intake run"}
{"level":30,"time":1768702345285,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768702345286,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ£ô tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 70587ms
       Γ£ô should allow access with valid Bearer token  1233ms
       Γ£ô should reject access without Authorization header  1130ms
       Γ£ô should reject access with empty Bearer token  1133ms
       Γ£ô should reject access with malformed Authorization header  1173ms
       Γ£ô should reject access with wrong token type  1114ms
       Γ£ô should allow POST with valid Bearer token  1200ms
       Γ£ô should reject POST without Bearer token  1111ms
       Γ£ô should reject POST with invalid token  1116ms
       Γ£ô should allow PUT with valid Bearer token  1300ms
       Γ£ô should reject PUT without Bearer token  1171ms
       Γ£ô should allow DELETE with valid Bearer token  1325ms
       Γ£ô should reject DELETE without Bearer token  1129ms
       Γ£ô should allow PATCH with valid Bearer token  1731ms
       Γ£ô should reject PATCH without Bearer token  1151ms
       Γ£ô should handle Bearer token with extra spaces  1134ms
       Γ£ô should handle very long invalid token  1139ms
       Γ£ô should handle empty Authorization header  1129ms
       Γ£ô should handle Authorization header with only Bearer  1130ms
       Γ£ô should handle multiple Authorization headers  1111ms
       Γ£ô should reject token with SQL injection attempt  1131ms
       Γ£ô should reject token with XSS attempt  1128ms
       Γ£ô should reject token with missing userId  1157ms
       Γ£ô should reject token with non-existent userId  1196ms
       Γ£ô should not allow user to access another user's resources  2237ms
       Γ£ô should inject userId into request context  1211ms
       Γ£ô should inject tenantId into request context  1181ms
       Γ£ô should inject role into request context  1159ms
       Γ£ô should not apply general rate limiting to authenticated requests  1601ms
       Γ£ô should handle request with both Bearer token and cookies  1709ms
       Γ£ô should prioritize Bearer token over cookie when both present  2787ms
       Γ£ô should allow unauthenticated access to optional auth routes  1645ms
       Γ£ô should enhance optional auth routes with user context when authenticated  1667ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  20:08:44
   Duration  198.79s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
