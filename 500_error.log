
[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768607891326,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768607891412,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768607891437,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: public
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768607893564,"env":"test","module":"user-credentials-repository","userId":"4KHlUFMtjYFakr0Yri7pI","msg":"User credentials created"}
{"level":30,"time":1768607893785,"env":"test","module":"auth-routes","userId":"4KHlUFMtjYFakr0Yri7pI","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768607894129,"env":"test","module":"user-credentials-repository","userId":"k8qUycsGoKCLFYYbcqXQh","msg":"User credentials created"}
{"level":30,"time":1768607894245,"env":"test","module":"auth-routes","userId":"k8qUycsGoKCLFYYbcqXQh","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768607894576,"env":"test","module":"user-credentials-repository","userId":"y553-ni20kZPi7dIjGgHy","msg":"User credentials created"}
{"level":30,"time":1768607894692,"env":"test","module":"auth-routes","userId":"y553-ni20kZPi7dIjGgHy","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768607895024,"env":"test","module":"user-credentials-repository","userId":"mG1YETXXCyXh0lZdbgqoZ","msg":"User credentials created"}
{"level":30,"time":1768607895141,"env":"test","module":"auth-routes","userId":"mG1YETXXCyXh0lZdbgqoZ","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768607895471,"env":"test","module":"user-credentials-repository","userId":"VakfJ93qv1IbI9ab3Plo-","msg":"User credentials created"}
{"level":30,"time":1768607895642,"env":"test","module":"auth-routes","userId":"VakfJ93qv1IbI9ab3Plo-","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768607895975,"env":"test","module":"user-credentials-repository","userId":"l7vVZNRGSEFl88VVGWXzo","msg":"User credentials created"}
{"level":30,"time":1768607896094,"env":"test","module":"auth-routes","userId":"l7vVZNRGSEFl88VVGWXzo","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768607896440,"env":"test","module":"user-credentials-repository","userId":"Agq2pSDDRbH9qvjF-spph","msg":"User credentials created"}
{"level":50,"time":1768607896444,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768607896776,"env":"test","module":"user-credentials-repository","userId":"tMcsolwla4ECANgDahlKI","msg":"User credentials created"}
{"level":30,"time":1768607897001,"env":"test","module":"auth-routes","userId":"tMcsolwla4ECANgDahlKI","sessionId":"69d7cdfd-4864-4d0f-b987-0771e35133bc","msg":"Session revoked"}
{"level":30,"time":1768607897391,"env":"test","module":"user-credentials-repository","userId":"Vy7EhvNoQ4PrqUv4sDrGT","msg":"User credentials created"}
{"level":30,"time":1768607897726,"env":"test","module":"user-credentials-repository","userId":"DyEdH1nsyT5VBsfOu-HwO","msg":"User credentials created"}
{"level":30,"time":1768607898228,"env":"test","module":"user-credentials-repository","userId":"cH9xGY7nI0agq2IYOrSog","msg":"User credentials created"}
{"level":30,"time":1768607898810,"env":"test","module":"user-credentials-repository","userId":"uAXKCiTNcq0GlrSh_qfyr","msg":"User credentials created"}
{"level":50,"time":1768607898814,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768607899145,"env":"test","module":"user-credentials-repository","userId":"7jhkVuR8Rznaoj5pbGmbQ","msg":"User credentials created"}
{"level":30,"time":1768607899676,"env":"test","module":"auth-routes","userId":"7jhkVuR8Rznaoj5pbGmbQ","msg":"All other sessions revoked"}
{"level":50,"time":1768607899731,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7jhkVuR8Rznaoj5pbGmbQ","all_sessions_revoked","security","7jhkVuR8Rznaoj5pbGmbQ","security","7jhkVuR8Rznaoj5pbGmbQ",null,"::ffff:127.0.0.1",null,"2026-01-16T23:58:19.676Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7jhkVuR8Rznaoj5pbGmbQ","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768607899735,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7jhkVuR8Rznaoj5pbGmbQ","all_sessions_revoked","security","7jhkVuR8Rznaoj5pbGmbQ","security","7jhkVuR8Rznaoj5pbGmbQ",null,"::ffff:127.0.0.1",null,"2026-01-16T23:58:19.676Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768607900084,"env":"test","module":"user-credentials-repository","userId":"1r9cYdJhD0g-9tx-nWic6","msg":"User credentials created"}
{"level":30,"time":1768607900311,"env":"test","module":"auth-routes","userId":"1r9cYdJhD0g-9tx-nWic6","msg":"All other sessions revoked"}
{"level":50,"time":1768607900364,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1r9cYdJhD0g-9tx-nWic6","all_sessions_revoked","security","1r9cYdJhD0g-9tx-nWic6","security","1r9cYdJhD0g-9tx-nWic6",null,"::ffff:127.0.0.1",null,"2026-01-16T23:58:20.311Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1r9cYdJhD0g-9tx-nWic6","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768607900365,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1r9cYdJhD0g-9tx-nWic6","all_sessions_revoked","security","1r9cYdJhD0g-9tx-nWic6","security","1r9cYdJhD0g-9tx-nWic6",null,"::ffff:127.0.0.1",null,"2026-01-16T23:58:20.311Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768607900700,"env":"test","module":"user-credentials-repository","userId":"zaQ8eurUcst-ZeXk93iZy","msg":"User credentials created"}
{"level":30,"time":1768607901046,"env":"test","module":"user-credentials-repository","userId":"gyLv64Hh8l28qxoQXX-oS","msg":"User credentials created"}
{"level":50,"time":1768607901049,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768607901381,"env":"test","module":"user-credentials-repository","userId":"LOurXxQy4m-HlC8WM5LXZ","msg":"User credentials created"}
{"level":30,"time":1768607901499,"env":"test","module":"auth-routes","userId":"LOurXxQy4m-HlC8WM5LXZ","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768607901888,"env":"test","module":"user-credentials-repository","userId":"3NZZ6JCwSd_sNB6xDr4mZ","msg":"User credentials created"}
{"level":30,"time":1768607902007,"env":"test","module":"auth-routes","userId":"3NZZ6JCwSd_sNB6xDr4mZ","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768607902177,"env":"test","module":"auth-routes","userId":"3NZZ6JCwSd_sNB6xDr4mZ","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":30,"time":1768607902573,"env":"test","module":"user-credentials-repository","userId":"UZcPAY7exo_klREux3AFx","msg":"User credentials created"}
{"level":30,"time":1768607902685,"env":"test","module":"auth-routes","userId":"UZcPAY7exo_klREux3AFx","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768607903022,"env":"test","module":"user-credentials-repository","userId":"eHoucrjxa4BOF67JDwDc-","msg":"User credentials created"}
{"level":30,"time":1768607903134,"env":"test","module":"auth-routes","userId":"eHoucrjxa4BOF67JDwDc-","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768607903462,"env":"test","module":"user-credentials-repository","userId":"BAtKSYgefl7Dde9Wig5cY","msg":"User credentials created"}
{"level":30,"time":1768607903637,"env":"test","module":"auth-routes","userId":"BAtKSYgefl7Dde9Wig5cY","deviceId":"793bde9e-4084-4cf1-bb1b-85fe4acb05f9","msg":"Trusted device revoked"}
{"level":30,"time":1768607904025,"env":"test","module":"user-credentials-repository","userId":"synC4w6o9kThYRbw7yzW_","msg":"User credentials created"}
{"level":30,"time":1768607904355,"env":"test","module":"user-credentials-repository","userId":"CBdldDKq-jd3vAVUEHdVT","msg":"User credentials created"}
{"level":30,"time":1768607904801,"env":"test","module":"user-credentials-repository","userId":"fmHFjQ6lo5ZpirAgk0ViV","msg":"User credentials created"}
{"level":30,"time":1768607905259,"env":"test","module":"user-credentials-repository","userId":"XLesxei0Xa3pKgCq4-K8i","msg":"User credentials created"}
{"level":30,"time":1768607905477,"env":"test","module":"auth-service","tokenHash":"1ac55e27641294a52a54ad26b5e6b849291d8913e77c17a61fe88ad2d63da83a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768607905764,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768607905764,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 14355[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 564[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 455[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 447[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 449[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 500[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 453[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 348[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 612[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 338[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 503[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 578[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 340[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 927[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all trusted devices[39m[33m 624[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 338[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 345[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 507[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update existing trusted device expiry [33m 675[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 454[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 448[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should revoke a trusted device [33m 562[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 331[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 440[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 447[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on token refresh [33m 848[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m23 passed[39m[22m[90m (25)[39m
[2m   Start at [22m 17:58:08
[2m   Duration [22m 17.11s[2m (transform 672ms, setup 140ms, import 2.16s, tests 14.35s, environment 0ms)[22m

