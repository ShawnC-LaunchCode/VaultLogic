npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w14_v3

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_v3

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14_v3,public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5_v3,public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w14_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14_v3%2Cpublic

{"level":30,"time":1768676031833,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5_v3%2Cpublic

{"level":30,"time":1768676031836,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676031890,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676031888,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w14_v3, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w14_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/organizationInvites.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w14_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/organizationService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w13_v3

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_v3

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2_v3,public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13_v3,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2_v3%2Cpublic

{"level":30,"time":1768676032788,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w13_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13_v3%2Cpublic

{"level":30,"time":1768676032812,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676032841,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676032867,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w2_v3, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w2_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault.autonumber.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/transferOwnership.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676033965,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676033974,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676033976,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676033991,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676033984,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676034083,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_v3

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_v3

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_v3

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w12_v3

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_v3

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6_v3,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10_v3,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12_v3,public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8_v3,public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4_v3,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_v3

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6_v3%2Cpublic

{"level":30,"time":1768676034644,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10_v3%2Cpublic

{"level":30,"time":1768676034656,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8_v3%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w12_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12_v3%2Cpublic

{"level":30,"time":1768676034663,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676034663,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4_v3%2Cpublic

{"level":30,"time":1768676034670,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676034686,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676034715,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676034716,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676034716,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676034731,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3_v3,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3_v3%2Cpublic

{"level":30,"time":1768676034816,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676034860,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w10_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w10_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w6_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth.routes.real.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w8_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w4_v3, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w4_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/trusted.devices.real.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth.flows.real.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w3_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/session.management.real.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/mfa.flow.real.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676039597,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676039597,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676039598,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676039600,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676039648,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_v3

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_v3

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_v3

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_v3

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11_v3,public

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1_v3,public

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9_v3,public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11_v3%2Cpublic

{"level":30,"time":1768676044114,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1_v3%2Cpublic

{"level":30,"time":1768676044118,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9_v3%2Cpublic

{"level":30,"time":1768676044141,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676044156,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676044166,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7_v3,public

{"level":30,"time":1768676044191,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7_v3%2Cpublic

{"level":30,"time":1768676044233,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676044285,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w1_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault-v4-regression.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768676044575,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w11_v3, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w9_v3, public

{"level":30,"time":1768676044627,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w7_v3, public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w7_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/jwt.authentication.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w7_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/session.management.integration.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w7_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/auth.middleware.integration.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w14_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w0_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w13_v3
Î“Ã…âŒ Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w2_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676046215,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676046236,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676046223,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676046223,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676046229,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676046230,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676046235,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676046235,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676046236,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676046236,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768676046453,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676046453,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 14222[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should generate basic autonumber without prefix
     [2m[90mÎ“Ã¥Ã´[39m[22m should generate autonumber with prefix
     [2m[90mÎ“Ã¥Ã´[39m[22m should generate autonumber with yearly reset format
     [2m[90mÎ“Ã¥Ã´[39m[22m should be atomic and prevent race conditions
     [2m[90mÎ“Ã¥Ã´[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676046743,"env":"test","module":"user-credentials-repository","userId":"287de0f5-d679-41a0-a2da-1de8d2dfeb13","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676046935,"env":"test","module":"email-queue","jobId":"866ed0aa-3a4b-4174-9e76-c1ff17662d02","to":"newuser_1768676031298@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676047010,"env":"test","module":"email-queue","jobId":"240bfe8f-1233-42b5-b30d-5e292d71b6f2","to":"test-crVlbiG30vXwWPJcWuPVE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stderr | tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should create placeholder user for non-existent email
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,71f52155-6bfe-4922-8e93-9a87638d0143,{"after":{"invitedEmail":"newuser_1768676031298@test.com","token":"8ea852a28cb07fb1b0584599a9e1ca0f35feddd63189ed8f1e9e9a34df412848"}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.invite_send',
    'organization',
    '71f52155-6bfe-4922-8e93-9a87638d0143',
    '{"after":{"invitedEmail":"newuser_1768676031298@test.com","token":"8ea852a28cb07fb1b0584599a9e1ca0f35feddd63189ed8f1e9e9a34df412848"}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:81:28
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
    length: 541,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (e76ca36b-6a69-4fce-9600-3af60d3dba1c, null, null, 00000000-0000-0000-0000-000000000021, organization.invite_send, null, null, organization, 71f52155-6bfe-4922-8e93-9a87638d0143, {"after": {"token": "8ea852a28cb07fb1b0584599a9e1ca0f35feddd6318..., null, null, null, 2026-01-17 18:54:07.386692, 2026-01-17 18:54:07.386692).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w10_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

stderr | tests/integration/organizationService.test.ts > OrganizationService Integration > getUserOrganizations > should return all organizations for user
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,fb8c8761-1a2e-485e-ae1b-0fac61689e10,{"after":{"name":"User Org Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 3 lines matching cause stack trace ...
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000011',
    'organization.create',
    'organization',
    'fb8c8761-1a2e-485e-ae1b-0fac61689e10',
    '{"after":{"name":"User Org Test Int","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:100:25
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
    length: 523,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (be1e79ba-f823-4c14-8565-aa02e2dd2bda, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, fb8c8761-1a2e-485e-ae1b-0fac61689e10, {"after": {"name": "User Org Test Int", "slug": null}}, null, null, null, 2026-01-17 18:54:07.396981, 2026-01-17 18:54:07.396981).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w10_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":50,"time":1768676047117,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["287de0f5-d679-41a0-a2da-1de8d2dfeb13","d9ff75185106c4f8c6a53a8908b7333316ad6e6d8dd5040f484a39f44429fcf1","2026-02-16T18:54:07.012Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:54:07.013Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(287de0f5-d679-41a0-a2da-1de8d2dfeb13) is not present in table \"users\".","schema":"test_schema_w10_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768676047128,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676047129,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 3516[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow access with valid Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject access without Authorization header
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject access with empty Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject access with malformed Authorization header
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject access with wrong token type
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow POST with valid Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject POST without Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject POST with invalid token
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow PUT with valid Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject PUT without Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow DELETE with valid Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject DELETE without Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow PATCH with valid Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject PATCH without Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle Bearer token with extra spaces
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle very long invalid token
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle empty Authorization header
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle Authorization header with only Bearer
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle multiple Authorization headers
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token with SQL injection attempt
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token with XSS attempt
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token with missing userId
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token with non-existent userId
       [2m[90mÎ“Ã¥Ã´[39m[22m should not allow user to access another user's resources
       [2m[90mÎ“Ã¥Ã´[39m[22m should inject userId into request context
       [2m[90mÎ“Ã¥Ã´[39m[22m should inject tenantId into request context
       [2m[90mÎ“Ã¥Ã´[39m[22m should inject role into request context
       [2m[90mÎ“Ã¥Ã´[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle request with both Bearer token and cookies
       [2m[90mÎ“Ã¥Ã´[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90mÎ“Ã¥Ã´[39m[22m should enhance optional auth routes with user context when authenticated
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w12_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w12_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w12_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w12_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w12_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w12_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w12_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w12_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w12_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: error: deadlock detected
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 485,
    severity: 'ERROR',
    code: '40P01',
    detail: 'Process 9522 waits for AccessExclusiveLock on relation 2469523 of database 16391; blocked by process 11080.\n' +
      'Process 11080 waits for RowShareLock on relation 2468947 of database 16391; blocked by process 9522.',
    hint: 'See server log for query details.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: 'SQL statement "ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk""\n' +
      'PL/pgSQL function inline_code_block line 2 at SQL statement',
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'deadlock.c',
    line: '1130',
    routine: 'DeadLockReport'
  }
}

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w6_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w6_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w10_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w16_v3

stderr | tests/integration/organizationService.test.ts > OrganizationService Integration > updateOrganization > should deny non-admin from updating organization
CRITICAL: User lookup failed validation in beforeEach: undefined

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16_v3,public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w16_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16_v3%2Cpublic

{"level":30,"time":1768676048950,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676048985,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676049022,"env":"test","module":"user-credentials-repository","userId":"ae4b5101-74cc-479c-94e0-eb46eb6fe9fe","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676049068,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["74899e8f-beba-4b2c-b75a-7db0f2f2eee9","$2b$12$BJ2eFnFdyEq3S95FMjpAaeUGFhYVLM3Um23q.92eW5IIqz0zl/pZe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(74899e8f-beba-4b2c-b75a-7db0f2f2eee9) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"74899e8f-beba-4b2c-b75a-7db0f2f2eee9","msg":"Failed to create user credentials"}
{"level":50,"time":1768676049068,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["74899e8f-beba-4b2c-b75a-7db0f2f2eee9","$2b$12$BJ2eFnFdyEq3S95FMjpAaeUGFhYVLM3Um23q.92eW5IIqz0zl/pZe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(74899e8f-beba-4b2c-b75a-7db0f2f2eee9) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676049238,"env":"test","module":"email-queue","jobId":"59eca112-0067-4643-b81a-8417c482a656","to":"test-1768676048531-s9613y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768676049354,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["ae4b5101-74cc-479c-94e0-eb46eb6fe9fe","b6a3cdbd82d9d1c58646ea7f14be88a39e8f301ae84b542944e489ecf35cf16d","2026-02-16T18:54:09.241Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:09.242Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ae4b5101-74cc-479c-94e0-eb46eb6fe9fe) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w16_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w4_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/WorkflowTemplateService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676049766,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["YsIOSYma1NdYhw-Y0PWRO","$2b$12$l8vGIF/vi.y7WO.1L.U1WugOUxxFkUycpxI71R/j6npGruA9PbEx2"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(YsIOSYma1NdYhw-Y0PWRO) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"YsIOSYma1NdYhw-Y0PWRO","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768676050154,"env":"test","module":"user-credentials-repository","userId":"eab0c1a5-1c6b-4670-a2a2-9391f89d2f93","msg":"User credentials created"}
{"level":30,"time":1768676050344,"env":"test","module":"email-queue","jobId":"572ca0ec-3568-4f06-a02c-69186233e6bf","to":"test-1768676049387-hm8768@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768676050385,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stderr | tests/integration/transferOwnership.test.ts > Transfer Ownership > Database Transfer > should transfer database ownership
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,d27114de-2de3-4311-8d0d-ba021a032c2b,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000031',
    'organization.create',
    'organization',
    'd27114de-2de3-4311-8d0d-ba021a032c2b',
    '{"after":{"name":"Transfer Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: 522,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (929cd477-b1a3-42db-8d20-9717db5b0ba1, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, d27114de-2de3-4311-8d0d-ba021a032c2b, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:10.798443, 2026-01-17 18:54:10.798443).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":50,"time":1768676050452,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["15d76bbc26d2acdce9284ce0ad51dbf2","e65c2da4fb6abfff9ef05bb8e2d90bf86bcdf32f6851841460b8065094ef2aeb","2026-02-16T18:54:10.320Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:10.321Z"],"cause":{"length":334,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(15d76bbc26d2acdce9284ce0ad51dbf2) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should reject invalid TOTP code during setup
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 15d76bbc26d2acdce9284ce0ad51dbf2,e65c2da4fb6abfff9ef05bb8e2d90bf86bcdf32f6851841460b8065094ef2aeb,2026-02-16T18:54:10.320Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:10.321Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '15d76bbc26d2acdce9284ce0ad51dbf2',
    'e65c2da4fb6abfff9ef05bb8e2d90bf86bcdf32f6851841460b8065094ef2aeb',
    '2026-02-16T18:54:10.320Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:10.321Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 334,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(15d76bbc26d2acdce9284ce0ad51dbf2) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w6_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768676050471,"env":"test","module":"auth-routes","userId":"eab0c1a5-1c6b-4670-a2a2-9391f89d2f93","email":"test-1768676049387-hm8768@example.com","msg":"User registered"}
{"level":30,"time":1768676050471,"env":"test","module":"auth-routes","userId":"fda8a17cb54dc4a6b4d8138613086320","msg":"User logged in successfully"}
{"level":50,"time":1768676050478,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676050484,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676050516,"env":"test","module":"auth-routes","email":"test-1768676049700-npsquu@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676050609,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768676050623,"env":"test","module":"audit-log-service","userId":"fda8a17cb54dc4a6b4d8138613086320","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676050641,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676050983,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d8a63f96-0243-47c9-ab40-6c5cf63cb1b5","$2b$12$LKJZBDLQM/yrQ6v.WGH3JuApzBxlg3DD.XjWR2JyJOcZ9oWIiwWRe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d8a63f96-0243-47c9-ab40-6c5cf63cb1b5) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d8a63f96-0243-47c9-ab40-6c5cf63cb1b5","msg":"Failed to create user credentials"}
{"level":50,"time":1768676050983,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d8a63f96-0243-47c9-ab40-6c5cf63cb1b5","$2b$12$LKJZBDLQM/yrQ6v.WGH3JuApzBxlg3DD.XjWR2JyJOcZ9oWIiwWRe"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d8a63f96-0243-47c9-ab40-6c5cf63cb1b5) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768676051069,"env":"test","module":"auth-routes","email":"test-1768676049700-npsquu@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
stderr | tests/integration/organizationService.test.ts > OrganizationService Integration > removeMember > should allow admin to remove member
CRITICAL: User lookup failed validation in beforeEach: undefined

{"level":50,"time":1768676051235,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["fda8a17cb54dc4a6b4d8138613086320","bcaf242020b4b6ca320dcde4f41ceca40e8d82a5e5c12a8c12434fe4c029ea01","2026-02-16T18:54:11.114Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:11.114Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fda8a17cb54dc4a6b4d8138613086320) is not present in table \"users\".","schema":"test_schema_w12_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should mark current session correctly
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: fda8a17cb54dc4a6b4d8138613086320,bcaf242020b4b6ca320dcde4f41ceca40e8d82a5e5c12a8c12434fe4c029ea01,2026-02-16T18:54:11.114Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:11.114Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'fda8a17cb54dc4a6b4d8138613086320',
    'bcaf242020b4b6ca320dcde4f41ceca40e8d82a5e5c12a8c12434fe4c029ea01',
    '2026-02-16T18:54:11.114Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:11.114Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 335,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(fda8a17cb54dc4a6b4d8138613086320) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w12_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676051271,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:85:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676051336,"env":"test","module":"auth-routes","email":"test-1768676049700-npsquu@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676051539,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/transferOwnership.test.ts > Transfer Ownership > Database Transfer > should allow org member to transfer org database
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,2e4b4d44-90a2-4fd7-8110-495c3a92a35e,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000031',
    'organization.create',
    'organization',
    '2e4b4d44-90a2-4fd7-8110-495c3a92a35e',
    '{"after":{"name":"Transfer Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: 522,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (a28f4852-bc7c-4c43-96c6-1500135de499, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 2e4b4d44-90a2-4fd7-8110-495c3a92a35e, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:11.896828, 2026-01-17 18:54:11.896828).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

stderr | tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should set expiry to 7 days from now
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,eeb3c559-51bb-4146-a2cd-1270df20934d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.create',
    'organization',
    'eeb3c559-51bb-4146-a2cd-1270df20934d',
    '{"after":{"name":"Invite Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: 520,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (d1f31541-850e-4a24-a0c6-fba41aeb4b3a, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, eeb3c559-51bb-4146-a2cd-1270df20934d, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:11.901678, 2026-01-17 18:54:11.901678).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":40,"time":1768676052136,"env":"test","module":"BrandingService","tenantId":"00000000-0000-0000-0000-000000000098","msg":"Tenant not found"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768676052376,"env":"test","module":"email-queue","jobId":"8d68cadb-a27a-486b-9626-9e79e95ec754","to":"newuser_1768676031298@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
stderr | tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should set expiry to 7 days from now
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,eeb3c559-51bb-4146-a2cd-1270df20934d,{"after":{"invitedEmail":"newuser_1768676031298@test.com","token":"c34f7730ea347d144e3b4cc3914dd1aca2e5d7a14f3dcb16168f7e52d5540813"}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.invite_send',
    'organization',
    'eeb3c559-51bb-4146-a2cd-1270df20934d',
    '{"after":{"invitedEmail":"newuser_1768676031298@test.com","token":"c34f7730ea347d144e3b4cc3914dd1aca2e5d7a14f3dcb16168f7e52d5540813"}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:143:28
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
    length: 538,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (cff08ca7-5b65-48f2-b42d-6bef42313073, null, null, 00000000-0000-0000-0000-000000000021, organization.invite_send, null, null, organization, eeb3c559-51bb-4146-a2cd-1270df20934d, {"after": {"token": "c34f7730ea347d144e3b4cc3914dd1aca2e5d7a14f3..., null, null, null, 2026-01-17 18:54:12.82709, 2026-01-17 18:54:12.82709).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":50,"time":1768676052476,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7872af7d-cc2b-48ca-b798-98d714e9db9c","$2b$12$llKp.UeNf6kGGjf3mLD/EuxPWquOvlsCedmAlNOFNq4vp7zcNd7Ay"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7872af7d-cc2b-48ca-b798-98d714e9db9c) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7872af7d-cc2b-48ca-b798-98d714e9db9c","msg":"Failed to create user credentials"}
{"level":50,"time":1768676052476,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7872af7d-cc2b-48ca-b798-98d714e9db9c","$2b$12$llKp.UeNf6kGGjf3mLD/EuxPWquOvlsCedmAlNOFNq4vp7zcNd7Ay"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7872af7d-cc2b-48ca-b798-98d714e9db9c) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w15_v3

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768676052774,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676052775,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15_v3,public

{"level":50,"time":1768676052805,"env":"test","module":"auth-routes","email":"test-1768676052321-h06dze@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
 [31mÎ“Â¥Â»[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 21477[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create organization and auto-create admin membership [33m 1343[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return all organizations for user[39m[33m 803[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return empty array for user with no memberships[39m[33m 767[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to update organization[39m[33m 524[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should deny non-admin from updating organization[39m[32m 296[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return all members of organization[39m[33m 598[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to promote member[39m[33m 519[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to demote other admin[39m[33m 358[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent self-demotion[39m[33m 584[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to remove member[39m[33m 365[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent self-removal[39m[33m 511[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow member to leave organization[39m[33m 477[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to leave organization[39m[33m 487[2mms[22m[39m
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w15_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15_v3%2Cpublic

{"level":30,"time":1768676052839,"env":"test","msg":"DB: initializing... Local"}
stderr | tests/integration/transferOwnership.test.ts > Transfer Ownership > Transfer Validation > should only allow transfer to self when targetOwnerType is user
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,941068b4-9afd-4f31-82bd-044a6d206727,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000031',
    'organization.create',
    'organization',
    '941068b4-9afd-4f31-82bd-044a6d206727',
    '{"after":{"name":"Transfer Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: 522,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (0630c92f-6d74-434d-8437-cebe9940f2ad, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 941068b4-9afd-4f31-82bd-044a6d206727, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:13.223021, 2026-01-17 18:54:13.223021).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":30,"time":1768676052889,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768676052931,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676052938,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676053211,"env":"test","module":"auth-routes","email":"test-1768676052480-e05g37@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w15_v3, public

{"level":50,"time":1768676053315,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should login with valid credentials
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676053375,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["b75d9a232f75341a2229b017da7301fc","7508b4c3867c1266a9be517c26d00624a06f1daf07b7e3cac34fe34ee915889e","2026-02-16T18:54:13.219Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:13.219Z"],"cause":{"length":334,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should exclude revoked sessions
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: b75d9a232f75341a2229b017da7301fc,7508b4c3867c1266a9be517c26d00624a06f1daf07b7e3cac34fe34ee915889e,2026-02-16T18:54:13.219Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:13.219Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'b75d9a232f75341a2229b017da7301fc',
    '7508b4c3867c1266a9be517c26d00624a06f1daf07b7e3cac34fe34ee915889e',
    '2026-02-16T18:54:13.219Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:13.219Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 334,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w8_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w8_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.workflows.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768676053963,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["99liJXI7RyTQk5nH97JCv","$2b$12$4UY28.i.c.Vqj7BIKb9UCO.gLzevOM2EeBJ94dfCwEFa7S0S4euKa"],"cause":{"length":331,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(99liJXI7RyTQk5nH97JCv) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"99liJXI7RyTQk5nH97JCv","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676054117,"env":"test","module":"auth-routes","email":"test-1768676053646-sd8j0c@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 2e4913c816b2a463d6a027635129ee6b

{"level":50,"time":1768676054239,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676054244,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768676054268,"env":"test","module":"auth-routes","userId":"b75d9a232f75341a2229b017da7301fc","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676054328,"env":"test","module":"auth-routes","email":"test-1768676053910-vq6niq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676054334,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b75d9a232f75341a2229b017da7301fc","login_success","security","b75d9a232f75341a2229b017da7301fc","security","b75d9a232f75341a2229b017da7301fc","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:14.268Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:14.268Z"],"cause":{"length":307,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b75d9a232f75341a2229b017da7301fc","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w17_v3

stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should exclude revoked sessions
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b75d9a232f75341a2229b017da7301fc,login_success,security,b75d9a232f75341a2229b017da7301fc,security,b75d9a232f75341a2229b017da7301fc,{"metadata":{"timestamp":"2026-01-17T18:54:14.268Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:14.268Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'b75d9a232f75341a2229b017da7301fc',
    'login_success',
    'security',
    'b75d9a232f75341a2229b017da7301fc',
    'security',
    'b75d9a232f75341a2229b017da7301fc',
    '{"metadata":{"timestamp":"2026-01-17T18:54:14.268Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:14.268Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 307,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should exclude revoked sessions
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b75d9a232f75341a2229b017da7301fc,login_success,security,b75d9a232f75341a2229b017da7301fc,security,b75d9a232f75341a2229b017da7301fc,{"metadata":{"timestamp":"2026-01-17T18:54:14.268Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:14.268Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'b75d9a232f75341a2229b017da7301fc',
    'login_success',
    'security',
    'b75d9a232f75341a2229b017da7301fc',
    'security',
    'b75d9a232f75341a2229b017da7301fc',
    '{"metadata":{"timestamp":"2026-01-17T18:54:14.268Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:14.268Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 307,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676054337,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b75d9a232f75341a2229b017da7301fc","login_success","security","b75d9a232f75341a2229b017da7301fc","security","b75d9a232f75341a2229b017da7301fc","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:14.268Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:14.268Z"],"cause":{"length":307,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b75d9a232f75341a2229b017da7301fc) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":50,"time":1768676054423,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17_v3,public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w17_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17_v3%2Cpublic

{"level":30,"time":1768676054479,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676054484,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676054485,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676054518,"env":"test","msg":"DB: initialized flag set."}
 [31mÎ“Â¥Â»[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 22378[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should transfer user-owned project to org[39m[32m 188[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent transfer to org if user is not a member[39m[33m 1274[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow org member to transfer org-owned project to another org they belong to[39m[32m 217[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detach workflow from project when transferring to different owner[39m[33m 533[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should keep workflow in project when transferring to same owner[39m[33m 418[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent non-member from transferring org workflow[39m[32m 177[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should transfer database ownership[39m[33m 1273[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow org member to transfer org database[39m[33m 1253[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent transfer to org if user is not a member[39m[32m 239[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should only allow transfer to self when targetOwnerType is user[39m[33m 1419[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[33m 927[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w17_v3, public

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w4_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/repositories/WorkflowTemplateRepository.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676055076,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676055178,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for e3477130e929c7e821a5014be40492df

{"level":30,"time":1768676055423,"env":"test","module":"user-credentials-repository","userId":"fjG10kVHI2b2h-zwe4wvL","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 950c6b4e3e7244fa9f40d7ad5d8b6e96

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676055578,"env":"test","module":"user-credentials-repository","userId":"6c508c0d-153f-42f8-89aa-130c75bbc90d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768676055660,"env":"test","module":"email-queue","jobId":"be8b5546-acaa-4de6-9186-886bb16b3851","to":"test-1768676054993-w5l9c@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768676055660,"env":"test","module":"auth-routes","error":{},"msg":"Forgot password error"}
{"level":30,"time":1768676055674,"env":"test","module":"email-queue","jobId":"975191fa-c9a2-4931-8757-28f400dbc8bf","to":"test-1768676055181-u4bjbc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768676055722,"env":"test","module":"auth-routes","userId":"6c508c0d-153f-42f8-89aa-130c75bbc90d","email":"test-1768676055181-u4bjbc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768676055883,"env":"test","module":"email-queue","jobId":"5f58b9a3-9c14-46d1-9380-08e3c8ade96c","to":"existing_1768676031298@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768676055958,"env":"test","module":"user-credentials-repository","userId":"LH_UUdlViHdlQRC2rdMaE","msg":"User credentials created"}
{"level":30,"time":1768676055995,"env":"test","module":"auth-routes","userId":"e3477130e929c7e821a5014be40492df","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":40,"time":1768676056099,"env":"test","module":"auth-routes","userId":"6c508c0d-153f-42f8-89aa-130c75bbc90d","email":"test-1768676055181-u4bjbc@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:91:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w18_v3

{"level":50,"time":1768676056100,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676056174,"env":"test","module":"auth-routes","userId":"1662fe9ae493c61276cb4ed6435439e5","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18_v3,public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w18_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18_v3%2Cpublic

{"level":30,"time":1768676056244,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":30,"time":1768676056300,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

{"level":30,"time":1768676056359,"env":"test","module":"user-credentials-repository","userId":"wChvr20Cyq1H4t7IGtqO8","msg":"User credentials created"}
{"level":50,"time":1768676056389,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1662fe9ae493c61276cb4ed6435439e5","login_success","security","1662fe9ae493c61276cb4ed6435439e5","security","1662fe9ae493c61276cb4ed6435439e5","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:16.174Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:16.174Z"],"cause":{"length":318,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1662fe9ae493c61276cb4ed6435439e5) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1662fe9ae493c61276cb4ed6435439e5","eventType":"login_success","msg":"Failed to log security event"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should order sessions by last used (most recent first)
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,1662fe9ae493c61276cb4ed6435439e5,login_success,security,1662fe9ae493c61276cb4ed6435439e5,security,1662fe9ae493c61276cb4ed6435439e5,{"metadata":{"timestamp":"2026-01-17T18:54:16.174Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:16.174Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '1662fe9ae493c61276cb4ed6435439e5',
    'login_success',
    'security',
    '1662fe9ae493c61276cb4ed6435439e5',
    'security',
    '1662fe9ae493c61276cb4ed6435439e5',
    '{"metadata":{"timestamp":"2026-01-17T18:54:16.174Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:16.174Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 318,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(1662fe9ae493c61276cb4ed6435439e5) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w7_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,1662fe9ae493c61276cb4ed6435439e5,login_success,security,1662fe9ae493c61276cb4ed6435439e5,security,1662fe9ae493c61276cb4ed6435439e5,{"metadata":{"timestamp":"2026-01-17T18:54:16.174Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:16.174Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '1662fe9ae493c61276cb4ed6435439e5',
    'login_success',
    'security',
    '1662fe9ae493c61276cb4ed6435439e5',
    'security',
    '1662fe9ae493c61276cb4ed6435439e5',
    '{"metadata":{"timestamp":"2026-01-17T18:54:16.174Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:16.174Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 318,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(1662fe9ae493c61276cb4ed6435439e5) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w7_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676056390,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1662fe9ae493c61276cb4ed6435439e5","login_success","security","1662fe9ae493c61276cb4ed6435439e5","security","1662fe9ae493c61276cb4ed6435439e5","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:16.174Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:16.174Z"],"cause":{"length":318,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1662fe9ae493c61276cb4ed6435439e5) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w18_v3, public

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w11_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/organizations-audit-fixes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":50,"time":1768676056759,"env":"test","module":"auth-routes","email":"test-1768676056104-9njbz2@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676056826,"env":"test","module":"auth-routes","email":"test-1768676055262-fy4mbc@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676056919,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676056992,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676057145,"env":"test","module":"auth-routes","email":"test-1768676055262-fy4mbc@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676057258,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676057263,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w1_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w9_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w7_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w7_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768676057745,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676057766,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676057754,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676057755,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676057761,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676057761,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676057765,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676057765,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676057766,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676057766,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676057812,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676057836,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676057823,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676057824,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676057828,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676057829,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676057836,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676057836,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676057836,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676057836,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676057847,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676057866,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676057854,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676057855,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676057859,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676057859,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676057865,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676057865,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676057866,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676057866,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676057898,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676057919,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676057906,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676057907,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676057912,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676057912,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676057918,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676057919,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676057919,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676057919,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768676057998,"env":"test","module":"auth","msg":"No default tenant found in database"}
{"level":50,"time":1768676057998,"env":"test","module":"auth","err":{"type":"Error","message":"System not properly configured - no tenant found","stack":"Error: System not properly configured - no tenant found\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:52:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-id","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768676057999,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mLogin Status: [33m401[39m
Login Body: {
  "message": "Authentication failed",
  "error": "auth_failed"
}

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676058012,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676058012,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 14401[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a select column with options
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a multiselect column with options
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate select value against options
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate multiselect values as array
       [2m[90mÎ“Ã¥Ã´[39m[22m should create an autonumber column with sequence
       [2m[90mÎ“Ã¥Ã´[39m[22m should format autonumber with prefix
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a note for a row
       [2m[90mÎ“Ã¥Ã´[39m[22m should get all notes for a row
       [2m[90mÎ“Ã¥Ã´[39m[22m should delete a note
       [2m[90mÎ“Ã¥Ã´[39m[22m should not allow deleting notes by other users
       [2m[90mÎ“Ã¥Ã´[39m[22m should create an API token
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate API token scopes
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke (delete) an API token
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny access with expired token
       [2m[90mÎ“Ã¥Ã´[39m[22m should grant table permission
       [2m[90mÎ“Ã¥Ã´[39m[22m should list table permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should update table permission role
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke table permission
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should paginate rows efficiently
       [2m[90mÎ“Ã¥Ã´[39m[22m should return user-friendly error for invalid column type
       [2m[90mÎ“Ã¥Ã´[39m[22m should return user-friendly error for missing required fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle network errors gracefully
{"level":50,"time":1768676058297,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bd775b47-e95b-479e-a4ca-8a6217d8a6a7","$2b$12$cw/jd0q3VX6aAwXbzEudRe44SHnC.YArX7AdU12eiamVAznSAAotm"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bd775b47-e95b-479e-a4ca-8a6217d8a6a7) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bd775b47-e95b-479e-a4ca-8a6217d8a6a7","msg":"Failed to create user credentials"}
{"level":50,"time":1768676058297,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bd775b47-e95b-479e-a4ca-8a6217d8a6a7","$2b$12$cw/jd0q3VX6aAwXbzEudRe44SHnC.YArX7AdU12eiamVAznSAAotm"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bd775b47-e95b-479e-a4ca-8a6217d8a6a7) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

{"level":30,"time":1768676058314,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676058315,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676058349,"env":"test","module":"user-credentials-repository","userId":"a04f6d6b-7804-4106-9c20-5769674887b1","msg":"User credentials created"}
stderr | tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should reject invalid token
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,ca5d600e-1ed4-4505-8e91-788ead56e739,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.create',
    'organization',
    'ca5d600e-1ed4-4505-8e91-788ead56e739',
    '{"after":{"name":"Invite Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: 521,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (4dc6b185-81ad-4cdf-87f0-f1d6e434bae3, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, ca5d600e-1ed4-4505-8e91-788ead56e739, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:18.724126, 2026-01-17 18:54:18.724126).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w11_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":50,"time":1768676058449,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5297d8d6-46ed-442a-bdb6-32903d833e26","$2b$12$NWwmFSVmrb5Wy8f2TRUcbuI1Ps8fHDmbmhlak2OTzQpCYisSdA/bK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5297d8d6-46ed-442a-bdb6-32903d833e26) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5297d8d6-46ed-442a-bdb6-32903d833e26","msg":"Failed to create user credentials"}
{"level":50,"time":1768676058449,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5297d8d6-46ed-442a-bdb6-32903d833e26","$2b$12$NWwmFSVmrb5Wy8f2TRUcbuI1Ps8fHDmbmhlak2OTzQpCYisSdA/bK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5297d8d6-46ed-442a-bdb6-32903d833e26) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768676058455,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["a04f6d6b-7804-4106-9c20-5769674887b1","c7bdc55fb70f3475331dbab25e73834fa858d1b91b3e64332378c22903055e81","2026-01-18T18:54:18.350Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a04f6d6b-7804-4106-9c20-5769674887b1) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/auth.middleware.integration.test.ts:35:15

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676058466,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676058466,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

{"level":30,"time":1768676058469,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676058470,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676058471,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676058472,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 14702[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should generate valid JWT token on successful login
       [2m[90mÎ“Ã¥Ã´[39m[22m should include correct payload in JWT token
       [2m[90mÎ“Ã¥Ã´[39m[22m should set JWT expiry to 15 minutes
       [2m[90mÎ“Ã¥Ã´[39m[22m should accept valid JWT token on protected routes
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject request without authorization header
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject request with malformed token
       [2m[90mÎ“Ã¥Ã´[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token with invalid signature
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject expired JWT token
       [2m[90mÎ“Ã¥Ã´[39m[22m should return token_expired error code for expired tokens
       [2m[90mÎ“Ã¥Ã´[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90mÎ“Ã¥Ã´[39m[22m should work with Bearer token on POST requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should work with Bearer token on PUT requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should work with Bearer token on DELETE requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should exchange valid session cookie for JWT token
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject token exchange without valid cookie
       [2m[90mÎ“Ã¥Ã´[39m[22m should prefer Bearer token over cookie when both present
       [2m[90mÎ“Ã¥Ã´[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow GET requests with cookie auth only
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow anonymous access to public workflows
       [2m[90mÎ“Ã¥Ã´[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90mÎ“Ã¥Ã´[39m[22m should refresh access token using refresh token
       [2m[90mÎ“Ã¥Ã´[39m[22m should rotate refresh token on use
       [2m[90mÎ“Ã¥Ã´[39m[22m should detect token reuse and revoke all user tokens
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke refresh token on logout
       [2m[90mÎ“Ã¥Ã´[39m[22m should clear refresh token cookie on logout
 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 24343[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 352[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 666[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 897[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should require authentication[32m 25[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 904[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 708[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 640[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 724[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 765[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 325[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2090[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 537[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 424[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 732[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676058662,"env":"test","module":"auth-routes","email":"test-1768676057849-zl84p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768676058768,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should filter sessions by current user only
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 14859[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow access with valid JWT Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 401 when no token provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 401 with invalid token
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 401 with expired token
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should authenticate with JWT Bearer token
       [2m[90mÎ“Ã¥Ã´[39m[22m should authenticate with refresh token cookie (GET only)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject cookie auth for POST requests (mutation-strict)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject cookie auth for PUT requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject cookie auth for DELETE requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow cookie auth for HEAD requests
       [2m[90mÎ“Ã¥Ã´[39m[22m should prioritize JWT over cookie when both present
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 401 when no auth provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 401 when both JWT and cookie are invalid
       [2m[90mÎ“Ã¥Ã´[39m[22m should authenticate with JWT if provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should authenticate with cookie if JWT not provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed anonymously if no auth provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed anonymously if both JWT and cookie are invalid
       [2m[90mÎ“Ã¥Ã´[39m[22m should only allow safe methods for cookie auth
       [2m[90mÎ“Ã¥Ã´[39m[22m should ignore cookies when Bearer token present
       [2m[90mÎ“Ã¥Ã´[39m[22m should attach userId to request
       [2m[90mÎ“Ã¥Ã´[39m[22m should attach userEmail to request
       [2m[90mÎ“Ã¥Ã´[39m[22m should return consistent error format for missing token
       [2m[90mÎ“Ã¥Ã´[39m[22m should return consistent error format for invalid token
       [2m[90mÎ“Ã¥Ã´[39m[22m should return consistent error format for expired token
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle malformed JWT gracefully
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle JWT with wrong algorithm
 [31mÎ“Â¥Â»[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 14853[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create refresh token on login
       [2m[90mÎ“Ã¥Ã´[39m[22m should track device metadata in session
       [2m[90mÎ“Ã¥Ã´[39m[22m should create separate sessions for multiple device logins
       [2m[90mÎ“Ã¥Ã´[39m[22m should list all active sessions for user
       [2m[90mÎ“Ã¥Ã´[39m[22m should mark current session correctly
       [2m[90mÎ“Ã¥Ã´[39m[22m should not include revoked sessions
       [2m[90mÎ“Ã¥Ã´[39m[22m should order sessions by last used (most recent first)
       [2m[90mÎ“Ã¥Ã´[39m[22m should require authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke specific session
       [2m[90mÎ“Ã¥Ã´[39m[22m should prevent revoking current session
       [2m[90mÎ“Ã¥Ã´[39m[22m should not allow revoking other users sessions
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent session ID
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke all sessions except current
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke all trusted devices
       [2m[90mÎ“Ã¥Ã´[39m[22m should require active session
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject refresh token after 30 days
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle multiple concurrent logins
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle concurrent token refreshes
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676058827,"env":"test","module":"auth-routes","email":"test-1768676057849-zl84p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676058929,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should filter sessions by current user only
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for c633d10beb27f257f56c41684b0278a6

{"level":50,"time":1768676059044,"env":"test","module":"auth-routes","email":"test-1768676057858-mhgllf@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

{"level":50,"time":1768676059184,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:85:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":50,"time":1768676059363,"env":"test","module":"auth-routes","userId":"71618da1568ae4a91e96a124f5c58ad3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768676059383,"env":"test","module":"auth-routes","userId":"0ac871e1ad8f707029568c9e8e473c6b","msg":"User logged in successfully"}
{"level":50,"time":1768676059444,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"0ac871e1ad8f707029568c9e8e473c6b","login_success","security","0ac871e1ad8f707029568c9e8e473c6b","security","0ac871e1ad8f707029568c9e8e473c6b","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:19.383Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-17T18:54:19.384Z"],"cause":{"length":318,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0ac871e1ad8f707029568c9e8e473c6b) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0ac871e1ad8f707029568c9e8e473c6b","eventType":"login_success","msg":"Failed to log security event"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,0ac871e1ad8f707029568c9e8e473c6b,login_success,security,0ac871e1ad8f707029568c9e8e473c6b,security,0ac871e1ad8f707029568c9e8e473c6b,{"metadata":{"timestamp":"2026-01-17T18:54:19.383Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-17T18:54:19.384Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '0ac871e1ad8f707029568c9e8e473c6b',
    'login_success',
    'security',
    '0ac871e1ad8f707029568c9e8e473c6b',
    'security',
    '0ac871e1ad8f707029568c9e8e473c6b',
    '{"metadata":{"timestamp":"2026-01-17T18:54:19.383Z"}}',
    '::ffff:127.0.0.1',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    '2026-01-17T18:54:19.384Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 318,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(0ac871e1ad8f707029568c9e8e473c6b) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w7_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,0ac871e1ad8f707029568c9e8e473c6b,login_success,security,0ac871e1ad8f707029568c9e8e473c6b,security,0ac871e1ad8f707029568c9e8e473c6b,{"metadata":{"timestamp":"2026-01-17T18:54:19.383Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-17T18:54:19.384Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '0ac871e1ad8f707029568c9e8e473c6b',
    'login_success',
    'security',
    '0ac871e1ad8f707029568c9e8e473c6b',
    'security',
    '0ac871e1ad8f707029568c9e8e473c6b',
    '{"metadata":{"timestamp":"2026-01-17T18:54:19.383Z"}}',
    '::ffff:127.0.0.1',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    '2026-01-17T18:54:19.384Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 318,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(0ac871e1ad8f707029568c9e8e473c6b) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w7_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676059447,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"0ac871e1ad8f707029568c9e8e473c6b","login_success","security","0ac871e1ad8f707029568c9e8e473c6b","security","0ac871e1ad8f707029568c9e8e473c6b","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:19.383Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-17T18:54:19.384Z"],"cause":{"length":318,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0ac871e1ad8f707029568c9e8e473c6b) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676059483,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/organizationInvites.test.ts > Organization Invites > getPendingInvitesForUser > should return pending invites for user email
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,93809eec-4146-4e40-8bc9-64a031c95462,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.create',
    'organization',
    '93809eec-4146-4e40-8bc9-64a031c95462',
    '{"after":{"name":"Invite Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: 521,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (db4803ae-e9ca-4264-b938-5cc2ef5e6b4e, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 93809eec-4146-4e40-8bc9-64a031c95462, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:19.867804, 2026-01-17 18:54:19.867804).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w11_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":50,"time":1768676059522,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["a8b3b53fb33295d5f837a529074c6978","d9fb4cde0b1623406fd1033596e6d7382c668cf116275bb5fd60a632d696a14d","2026-02-16T18:54:19.421Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:19.421Z"],"cause":{"length":334,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a8b3b53fb33295d5f837a529074c6978) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should filter sessions by current user only
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: a8b3b53fb33295d5f837a529074c6978,d9fb4cde0b1623406fd1033596e6d7382c668cf116275bb5fd60a632d696a14d,2026-02-16T18:54:19.421Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:19.421Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'a8b3b53fb33295d5f837a529074c6978',
    'd9fb4cde0b1623406fd1033596e6d7382c668cf116275bb5fd60a632d696a14d',
    '2026-02-16T18:54:19.421Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:19.421Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 334,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(a8b3b53fb33295d5f837a529074c6978) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w9_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676059530,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676059550,"env":"test","module":"auth-routes","email":"test-1768676057858-mhgllf@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676059678,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768676059859,"env":"test","module":"auth-routes","userId":"71618da1568ae4a91e96a124f5c58ad3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768676059900,"env":"test","module":"auth-routes","userId":"0ac871e1ad8f707029568c9e8e473c6b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768676059982,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676059995,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676060001,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768676060163,"env":"test","module":"auth-routes","userId":"71618da1568ae4a91e96a124f5c58ad3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768676060196,"env":"test","module":"email-queue","jobId":"2c09c181-9ecd-4356-93d6-9497e3576591","to":"existing_1768676031298@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768676060280,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/organizationInvites.test.ts > Organization Invites > getPendingInvitesForUser > should return pending invites for user email
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,93809eec-4146-4e40-8bc9-64a031c95462,{"after":{"invitedEmail":"existing_1768676031298@test.com","token":"4edff292127546d772b11a8f8c7b973ca3d525c18fa2eeabd12b704b1be7005e"}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.invite_send',
    'organization',
    '93809eec-4146-4e40-8bc9-64a031c95462',
    '{"after":{"invitedEmail":"existing_1768676031298@test.com","token":"4edff292127546d772b11a8f8c7b973ca3d525c18fa2eeabd12b704b1be7005e"}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:278:34
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:20 {
    length: 539,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (1f0b7cd0-3d77-4dd1-b8e2-f91d2307cbf9, null, null, 00000000-0000-0000-0000-000000000021, organization.invite_send, null, null, organization, 93809eec-4146-4e40-8bc9-64a031c95462, {"after": {"token": "4edff292127546d772b11a8f8c7b973ca3d525c18fa..., null, null, null, 2026-01-17 18:54:20.65658, 2026-01-17 18:54:20.65658).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w11_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":30,"time":1768676060553,"env":"test","module":"auth-routes","userId":"5c1c5348740435f97d341a60cdb3a6ff","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676060692,"env":"test","module":"audit-log-service","userId":"5c1c5348740435f97d341a60cdb3a6ff","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768676060712,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676060713,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w22_v3

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m23 failed[39m[2m)[22m[33m 26572[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token with valid refresh token[39m[33m 337[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token after use[39m[33m 419[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when refresh token is missing[39m[33m 339[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for invalid refresh token[39m[33m 420[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for expired refresh token[39m[33m 445[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for revoked refresh token[39m[33m 346[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 when user is not found[39m[33m 413[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update refresh token metadata on rotation[39m[33m 427[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 340[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set secure cookie in production[39m[33m 348[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set proper cookie attributes[39m[33m 695[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include user role information in response[39m[33m 419[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 429[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 806[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 415[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support multiple active refresh tokens per user[39m[33m 510[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all user tokens on password reset[39m[33m 452[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should use cryptographically strong random tokens[39m[33m 334[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should hash refresh tokens before storing in database[39m[33m 409[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent refresh token reuse after rotation[39m[33m 428[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should validate token ownership[39m[33m 421[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set HttpOnly flag to prevent XSS[39m[33m 429[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set SameSite=Strict to prevent CSRF[39m[33m 531[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set proper cookie path[39m[33m 352[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set appropriate expiry (30 days)[39m[33m 419[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w22_v3,public

{"level":50,"time":1768676060904,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["71618da1568ae4a91e96a124f5c58ad3","7d2d13a034cdb5a38b239f865cb99a6b80cdd9afd98f0e19dac2a5f1e87bdf06","2026-02-16T18:54:20.826Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:20.826Z"],"cause":{"length":334,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(71618da1568ae4a91e96a124f5c58ad3) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 71618da1568ae4a91e96a124f5c58ad3,7d2d13a034cdb5a38b239f865cb99a6b80cdd9afd98f0e19dac2a5f1e87bdf06,2026-02-16T18:54:20.826Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:20.826Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '71618da1568ae4a91e96a124f5c58ad3',
    '7d2d13a034cdb5a38b239f865cb99a6b80cdd9afd98f0e19dac2a5f1e87bdf06',
    '2026-02-16T18:54:20.826Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:20.826Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 334,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(71618da1568ae4a91e96a124f5c58ad3) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w9_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w22_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w22_v3%2Cpublic

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w21_v3

{"level":50,"time":1768676060965,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w21_v3,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w21_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w21_v3%2Cpublic

{"level":30,"time":1768676061077,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676061126,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w22_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w22_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/PdfQueueService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676061491,"env":"test","module":"auth-routes","email":"test-1768676060969-ynonoz@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w21_v3, public

{"level":50,"time":1768676061592,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w21_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault.api-tokens.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676061655,"env":"test","module":"auth-routes","email":"test-1768676060969-ynonoz@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":50,"time":1768676061776,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676061783,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768676061913,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stderr | tests/unit/services/WorkflowTemplateService.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w16_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w16_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w16_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w16_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w16_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w16_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w16_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w16_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w16_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: error: deadlock detected
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 487,
    severity: 'ERROR',
    code: '40P01',
    detail: 'Process 11977 waits for AccessExclusiveLock on relation 2497836 of database 16391; blocked by process 11976.\n' +
      'Process 11976 waits for RowShareLock on relation 2497570 of database 16391; blocked by process 11977.',
    hint: 'See server log for query details.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: 'SQL statement "ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk""\n' +
      'PL/pgSQL function inline_code_block line 2 at SQL statement',
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'deadlock.c',
    line: '1130',
    routine: 'DeadLockReport'
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676062020,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676062020,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 27896[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete registration, verify email, then login[39m[33m 444[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 614[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record all login attempts[39m[33m 2620[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA setup and login with TOTP[39m[33m 1325[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with backup code when TOTP unavailable[39m[33m 1347[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 1391[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should invalidate all sessions after password reset[39m[33m 429[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on each use[39m[33m 600[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect and prevent refresh token reuse (token theft)[39m[33m 718[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 2455[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1433[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w20_v3

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w20_v3,public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w20_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w20_v3%2Cpublic

{"level":30,"time":1768676062547,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676062603,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w20_v3, public

{"level":50,"time":1768676062945,"env":"test","module":"auth-routes","email":"test-1768676062097-be0d8u@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676062945,"env":"test","module":"auth-routes","userId":"12fba2032cf7b02d5585779d9de56ff5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w16_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/oauth2.sessions.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676063042,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":50,"time":1768676063067,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/refresh-token > should refresh access token with valid refresh token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w24_v3

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w24_v3,public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w24_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w24_v3%2Cpublic

{"level":30,"time":1768676063256,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676063320,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w24_v3, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w24_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/engine/templateNode.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676063997,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676064293,"env":"test","module":"auth-routes","email":"test-1768676063797-p977pq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768676064331,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768676064421,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/refresh-token > should rotate refresh token after use
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w25_v3

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w25_v3,public

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w25_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w25_v3%2Cpublic

{"level":30,"time":1768676064859,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676064909,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676065073,"env":"test","module":"auth-routes","email":"test-1768676063982-cr6n6p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768676065223,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking other user's session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/organizationInvites.test.ts > Organization Invites > revokeInvite > should prevent accepting revoked invite
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,45133a9b-c797-4dd3-be9b-bbe82acfcccf,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    '00000000-0000-0000-0000-000000000021',
    'organization.create',
    'organization',
    '45133a9b-c797-4dd3-be9b-bbe82acfcccf',
    '{"after":{"name":"Invite Test Org","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: 520,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (47890425-0835-42a9-97f8-471881700412, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 45133a9b-c797-4dd3-be9b-bbe82acfcccf, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 18:54:25.635003, 2026-01-17 18:54:25.635003).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w6_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w25_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w24_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/organizations-workflow.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676065622,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676065623,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 34317[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create placeholder user for non-existent email[39m[33m 2210[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create invite for existing user without creating placeholder[39m[33m 966[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent duplicate pending invites[39m[33m 746[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent inviting existing members[39m[33m 783[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require admin access to create invite[39m[33m 720[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set expiry to 7 days from now[39m[33m 2647[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept invite and create membership[39m[33m 780[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should convert placeholder user to real user on accept[39m[33m 659[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject expired invite[39m[33m 1821[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject already accepted invite[39m[33m 503[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should verify email matches invite[39m[33m 484[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject invalid token [33m 1281[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return pending invites for user email[39m[33m 3298[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not return expired invites[39m[33m 888[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not return accepted invites[39m[33m 775[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow admin to revoke invite[39m[33m 1033[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent accepting revoked invite[39m[33m 960[2mms[22m[39m
{"level":30,"time":1768676065712,"env":"test","module":"auth-routes","userId":"9da7d431a4edb33d34f3bc978371877f","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

{"level":50,"time":1768676065850,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"9da7d431a4edb33d34f3bc978371877f","login_success","security","9da7d431a4edb33d34f3bc978371877f","security","9da7d431a4edb33d34f3bc978371877f","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:25.712Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:25.712Z"],"cause":{"length":319,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9da7d431a4edb33d34f3bc978371877f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"9da7d431a4edb33d34f3bc978371877f","eventType":"login_success","msg":"Failed to log security event"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking other user's session
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,9da7d431a4edb33d34f3bc978371877f,login_success,security,9da7d431a4edb33d34f3bc978371877f,security,9da7d431a4edb33d34f3bc978371877f,{"metadata":{"timestamp":"2026-01-17T18:54:25.712Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:25.712Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '9da7d431a4edb33d34f3bc978371877f',
    'login_success',
    'security',
    '9da7d431a4edb33d34f3bc978371877f',
    'security',
    '9da7d431a4edb33d34f3bc978371877f',
    '{"metadata":{"timestamp":"2026-01-17T18:54:25.712Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:25.712Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 319,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(9da7d431a4edb33d34f3bc978371877f) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w15_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking other user's session
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,9da7d431a4edb33d34f3bc978371877f,login_success,security,9da7d431a4edb33d34f3bc978371877f,security,9da7d431a4edb33d34f3bc978371877f,{"metadata":{"timestamp":"2026-01-17T18:54:25.712Z"}},::ffff:127.0.0.1,,2026-01-17T18:54:25.712Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '9da7d431a4edb33d34f3bc978371877f',
    'login_success',
    'security',
    '9da7d431a4edb33d34f3bc978371877f',
    'security',
    '9da7d431a4edb33d34f3bc978371877f',
    '{"metadata":{"timestamp":"2026-01-17T18:54:25.712Z"}}',
    '::ffff:127.0.0.1',
    null,
    '2026-01-17T18:54:25.712Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 319,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(9da7d431a4edb33d34f3bc978371877f) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w15_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":50,"time":1768676065851,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"9da7d431a4edb33d34f3bc978371877f","login_success","security","9da7d431a4edb33d34f3bc978371877f","security","9da7d431a4edb33d34f3bc978371877f","{\"metadata\":{\"timestamp\":\"2026-01-17T18:54:25.712Z\"}}","::ffff:127.0.0.1",null,"2026-01-17T18:54:25.712Z"],"cause":{"length":319,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9da7d431a4edb33d34f3bc978371877f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":50,"time":1768676065857,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768676065859,"env":"test","module":"email-queue","jobId":"d9a4b834-6d64-49af-aed5-f46e2b53fd86","to":"test-1768676065132-ju5ptc@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768676065859,"env":"test","module":"auth-routes","error":{},"msg":"Forgot password error"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w9_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w19_v3

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w19_v3,public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w19_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w19_v3%2Cpublic

{"level":30,"time":1768676066291,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676066333,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676066337,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676066358,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676066344,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676066345,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676066352,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676066352,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676066358,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676066358,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676066358,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676066358,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w23_v3

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w23_v3,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w23_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w23_v3%2Cpublic

{"level":30,"time":1768676066674,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":30,"time":1768676066730,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w19_v3, public

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w17_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/lifecycle-hooks-execution.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676066937,"env":"test","module":"user-credentials-repository","userId":"fe0608c6-d674-4a29-bded-e4c5421c30fa","msg":"User credentials created"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w23_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w17_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault.permissions.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676067139,"env":"test","module":"email-queue","jobId":"daef05cb-7198-47cd-90bb-77020474f200","to":"test-JFrRbGhoU1THMnnoR48-0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768676067219,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["81f5e8a554cc23fe177bf9a84f4bbcab","14ca57c9b64d72edba176f947c39a9b5ffaf98c68575324c297a07aeabf0aef1","2026-02-16T18:54:27.161Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:27.161Z"],"cause":{"length":323,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(81f5e8a554cc23fe177bf9a84f4bbcab) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Regeneration > should return error if MFA not enabled
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 81f5e8a554cc23fe177bf9a84f4bbcab,14ca57c9b64d72edba176f947c39a9b5ffaf98c68575324c297a07aeabf0aef1,2026-02-16T18:54:27.161Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:27.161Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '81f5e8a554cc23fe177bf9a84f4bbcab',
    '14ca57c9b64d72edba176f947c39a9b5ffaf98c68575324c297a07aeabf0aef1',
    '2026-02-16T18:54:27.161Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:27.161Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 323,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(81f5e8a554cc23fe177bf9a84f4bbcab) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676067226,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768676067268,"env":"test","module":"auth-routes","userId":"fe0608c6-d674-4a29-bded-e4c5421c30fa","email":"test-JFrRbGhoU1THMnnoR48-0@example.com","msg":"User registered"}
{"level":30,"time":1768676067401,"env":"test","module":"email-queue","jobId":"126d22e2-102f-40a2-83dd-8c86feef6b84","to":"test-1768676066625-wa1sjn@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w26_v3

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w26_v3,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w26_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w26_v3%2Cpublic

{"level":30,"time":1768676067678,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768676067712,"env":"test","module":"tenant-middleware","userId":"fe0608c6-d674-4a29-bded-e4c5421c30fa","path":"/","msg":"User does not have an associated tenant"}
stderr | tests/integration/api.workflows.test.ts > Workflows API Integration Tests
[FATAL] setupIntegrationTest failed: Error: Project creation failed: {"message":"Tenant required","error":"no_tenant","details":"Your account is not associated with any tenant. Please contact support."}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:153:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.workflows.test.ts:42:11

{"level":30,"time":1768676067722,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676067723,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676067727,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [31mÎ“Â¥Â»[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m17 skipped[39m[2m)[22m[33m 15419[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a new draft workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject without permission
       [2m[90mÎ“Ã¥Ã´[39m[22m should list workflows
       [2m[90mÎ“Ã¥Ã´[39m[22m should filter by status
       [2m[90mÎ“Ã¥Ã´[39m[22m should search by name
       [2m[90mÎ“Ã¥Ã´[39m[22m should update draft workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should not allow editing published workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should publish workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should list workflow versions
       [2m[90mÎ“Ã¥Ã´[39m[22m should move workflow to a project
       [2m[90mÎ“Ã¥Ã´[39m[22m should move workflow to Main Folder (projectId = null)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move to non-existent project
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move without authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move of workflow user does not own
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move with invalid projectId format
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move without projectId in body
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject move to project user does not have access to
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w26_v3, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w26_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/ai/workflowEdit.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676068624,"env":"test","module":"auth-routes","email":"test-1768676067645-fryffg@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w21_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676068742,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should keep current session active
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w21_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676068778,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676068779,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 34578[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full MFA setup flow[39m[33m 368[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject invalid TOTP code during setup[39m[33m 2670[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow MFA setup if already enabled[39m[33m 429[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should generate unique backup codes[39m[33m 724[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should store hashed backup codes[39m[33m 636[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for enabled users[39m[33m 1099[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA login with valid TOTP[39m[33m 2142[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject invalid TOTP during login[39m[33m 693[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should accept TOTP codes within 60-second window[39m[33m 489[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with valid backup code[39m[33m 323[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark backup code as used[39m[33m 1261[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent backup code reuse[39m[33m 2039[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should try TOTP before backup code[39m[33m 710[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return MFA status for user[39m[33m 628[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return backup codes count for MFA users[39m[33m 754[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should disable MFA with password verification[39m[33m 824[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require correct password to disable MFA[39m[33m 1032[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should regenerate backup codes[39m[33m 435[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return error if MFA not enabled[39m[33m 2552[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should enforce MFA for tenant users when required by tenant[39m[33m 415[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676069275,"env":"test","module":"auth-routes","email":"test-1768676068552-l2zvst@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":50,"time":1768676069300,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["823e962b2c394cc1819d6304d5d07a41","d4ddbe76c144bc65a57cb4bd6acda4168cd1ecbc2148584559d9b44e52159ff9","2026-02-16T18:54:29.241Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-17T18:54:29.241Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(823e962b2c394cc1819d6304d5d07a41) is not present in table \"users\".","schema":"test_schema_w17_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should keep current session active
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 823e962b2c394cc1819d6304d5d07a41,d4ddbe76c144bc65a57cb4bd6acda4168cd1ecbc2148584559d9b44e52159ff9,2026-02-16T18:54:29.241Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-17T18:54:29.241Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '823e962b2c394cc1819d6304d5d07a41',
    'd4ddbe76c144bc65a57cb4bd6acda4168cd1ecbc2148584559d9b44e52159ff9',
    '2026-02-16T18:54:29.241Z',
    false,
    '{"ip":"::ffff:127.0.0.1"}',
    null,
    '::ffff:127.0.0.1',
    'Location Unknown',
    '2026-01-17T18:54:29.241Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 335,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(823e962b2c394cc1819d6304d5d07a41) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w17_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676069376,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676069382,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes
Failed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,bd24c6f9-b112-4b93-9671-2be7a829731c,organization.create,organization,661cb32f-60cf-497f-85d2-329bb6739239,{"after":{"name":"Test Org Audit","slug":null}}
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
    ... 2 lines matching cause stack trace ...
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)',
  params: [
    null,
    'bd24c6f9-b112-4b93-9671-2be7a829731c',
    'organization.create',
    'organization',
    '661cb32f-60cf-497f-85d2-329bb6739239',
    '{"after":{"name":"Test Org Audit","slug":null}}'
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:186:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
    length: 520,
    severity: 'ERROR',
    code: '23502',
    detail: 'Failing row contains (25571ae1-79cc-4209-b932-1382b6698e17, null, null, bd24c6f9-b112-4b93-9671-2be7a829731c, organization.create, null, null, organization, 661cb32f-60cf-497f-85d2-329bb6739239, {"after": {"name": "Test Org Audit", "slug": null}}, null, null, null, 2026-01-17 18:54:30.340881, 2026-01-17 18:54:30.340881).',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w17_v3',
    table: 'audit_logs',
    column: 'entity_type',
    dataType: undefined,
    constraint: undefined,
    file: 'execMain.c',
    line: '2032',
    routine: 'ExecConstraints'
  }
}

{"level":50,"time":1768676070030,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676070037,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768676071130,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676071130,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 37012[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should register a new user successfully[39m[33m 843[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 400 for invalid email format[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 400 for weak password[32m 5[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 409 for duplicate email[39m[33m 2674[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set httpOnly refresh token cookie[39m[33m 418[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with valid credentials[39m[33m 1430[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1119[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 for non-existent user[32m 153[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 403 for unverified email [33m 922[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 1440[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return requiresMfa=true for MFA-enabled users[39m[33m 314[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts[39m[33m 3916[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should logout and clear refresh token cookie[39m[33m 322[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should refresh access token with valid refresh token[39m[33m 1693[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 for missing refresh token[32m 6[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token after use[39m[33m 1335[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should send password reset email for existing user[39m[33m 1430[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should not reveal if email exists (security)[32m 62[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reset password with valid token[39m[33m 1509[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 400 for invalid token[32m 78[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 400 for weak new password[39m[33m 340[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return current user for valid token[39m[33m 1473[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 for missing token[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 for invalid token[32m 7[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should complete MFA login with valid TOTP code[39m[33m 355[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should reject invalid MFA code[39m[33m 735[2mms[22m[39m
[DEBUG] BaseRepository.update projects: id=c6b661cb-06ef-4fdc-9619-aa2bcd5b4dc0, updates={"ownerType":"org","ownerUuid":"661cb32f-60cf-497f-85d2-329bb6739239"}
stderr | tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #1: Project transfer cascades runs ownership > should cascade ownership to workflow runs when project is transferred
[DEBUG] WorkflowRepository.update id=a2d6a71b-6a0c-4fa9-9f37-1faf4de70612 updates={"ownerType":"org","ownerUuid":"661cb32f-60cf-497f-85d2-329bb6739239"}

[DEBUG] BaseRepository.update workflow_templates: id=fa722e60-f771-4046-b059-2746355dba55, updates={"key":"engagement_letter_v2"}
{"level":30,"time":1768676071424,"env":"test","module":"auth-routes","userId":"0f4f41ba24576bc024113f446c9b0013","msg":"User logged in successfully"}
{"level":30,"time":1768676071567,"env":"test","module":"audit-log-service","userId":"0f4f41ba24576bc024113f446c9b0013","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w27_v3

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w27_v3,public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w27_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w27_v3%2Cpublic

{"level":30,"time":1768676072609,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676072656,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676072727,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676072728,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31mÎ“Â¥Â»[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 17020[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should cascade ownership to workflow runs when project is transferred [33m 1491[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent double-acceptance via transaction[39m[32m 52[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not create invite if email fails[39m[32m 49[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow re-invite after invite expires[39m[32m 50[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow last admin to delete empty organization[39m[32m 50[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent deletion if org owns assets[39m[32m 49[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should cleanup placeholder user when invite is revoked[39m[32m 50[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should fail fast on non-existent org[39m[32m 149[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":50,"time":1768676072968,"env":"test","module":"auth-routes","userId":"c205df5b33da79af8782315ec1f2554c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w27_v3, public

{"level":50,"time":1768676073100,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should revoke all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w22_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/dataBlocks.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w29_v3

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676074328,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w29_v3,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w29_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w29_v3%2Cpublic

{"level":30,"time":1768676074401,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676074442,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":50,"time":1768676074506,"env":"test","module":"auth-routes","email":"test-1768676073846-do3yt@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w30_v3

{"level":50,"time":1768676074727,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should handle user with single session gracefully
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w30_v3,public

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w30_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w30_v3%2Cpublic

stderr | tests/unit/services/AuthService.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17)
    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:173:34
    at processTicksAndRejections (node:internal/process/task_queues:103:5) {
  codeFrame: 'vi.mock(import("../../../server/db"), async (importOriginal) => {\n' +
    '  const actual = await importOriginal()\n' +
    '  return {\n' +
    '    ...actual,\n' +
    '    // your mocked methods\n' +
    '  }\n' +
    '})'
}

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w29_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w20_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/workflows/runtime-pipelines.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676074994,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676074995,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 14452[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676076521,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["6db77549be6ec168d3fa9bc1c4242f67","af062484e60727f1f96b04b9a8b965a9167c0776e112744c94fa8973ab490bee","2026-02-16T18:54:36.390Z",false,"{\"ip\":\"192.168.1.100\",\"userAgent\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0\"}","Chrome on Windows","192.168.1.100","Location Unknown","2026-01-17T18:54:36.399Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6db77549be6ec168d3fa9bc1c4242f67) is not present in table \"users\".","schema":"test_schema_w20_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > Session Security > should include device metadata in sessions
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 6db77549be6ec168d3fa9bc1c4242f67,af062484e60727f1f96b04b9a8b965a9167c0776e112744c94fa8973ab490bee,2026-02-16T18:54:36.390Z,false,{"ip":"192.168.1.100","userAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0"},Chrome on Windows,192.168.1.100,Location Unknown,2026-01-17T18:54:36.399Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '6db77549be6ec168d3fa9bc1c4242f67',
    'af062484e60727f1f96b04b9a8b965a9167c0776e112744c94fa8973ab490bee',
    '2026-02-16T18:54:36.390Z',
    false,
    '{"ip":"192.168.1.100","userAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0"}',
    'Chrome on Windows',
    '192.168.1.100',
    'Location Unknown',
    '2026-01-17T18:54:36.399Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 335,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(6db77549be6ec168d3fa9bc1c4242f67) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w20_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676076526,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w28_v3

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w28_v3,public

{"level":30,"time":1768676076673,"env":"test","module":"user-credentials-repository","userId":"vW0sc-YtFGfe7Ii3IQS9r","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w28_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w28_v3%2Cpublic

{"level":30,"time":1768676076714,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676076748,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676076817,"env":"test","module":"auth-routes","userId":"vW0sc-YtFGfe7Ii3IQS9r","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w28_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w25_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.templates-runs.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w31_v3

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w31_v3,public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w31_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w31_v3%2Cpublic

{"level":30,"time":1768676077740,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676077773,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768676077880,"env":"test","module":"auth-routes","email":"test-1768676077390-2ypnih@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676078084,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > Session Security > should not expose sensitive token data
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768676078088,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w31_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w31_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/analytics_service.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

{"level":30,"time":1768676078677,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676078678,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 30356[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should throw error if template belongs to different project [33m 588[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should automatically unset other primaries when setting new primary[39m[33m 1079[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should list all templates for workflow version[39m[33m 678[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should return empty array for version with no templates[39m[33m 641[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should get template mapping by id and version[39m[33m 1078[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should throw error if mapping not found[39m[33m 611[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should get template by key[39m[33m 583[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should throw error if key not found [33m 880[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should get primary template for workflow version[39m[33m 626[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should return null when no primary template exists[39m[33m 561[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update mapping key [33m 761[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should update isPrimary flag[39m[33m 571[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should throw error if new key already exists[39m[33m 1096[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should throw error if mapping not found[39m[33m 665[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should unset other primaries when setting isPrimary to true[39m[33m 634[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should detach template from workflow version[39m[33m 1220[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should throw error if mapping not found[39m[33m 555[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should set template as primary[39m[33m 505[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should throw error if mapping not found[39m[33m 611[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should support operations within a transaction[39m[33m 698[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should rollback on transaction error[39m[33m 553[2mms[22m[39m
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w25_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w19_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w25_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w19_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

stderr | tests/integration/datavault.permissions.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w23_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w23_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w23_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w23_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w23_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w23_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w23_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w23_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w23_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: error: deadlock detected
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 485,
    severity: 'ERROR',
    code: '40P01',
    detail: 'Process 9522 waits for AccessExclusiveLock on relation 2525112 of database 16391; blocked by process 14990.\n' +
      'Process 14990 waits for RowShareLock on relation 2524652 of database 16391; blocked by process 9522.',
    hint: 'See server log for query details.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: 'SQL statement "ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk""\n' +
      'PL/pgSQL function inline_code_block line 2 at SQL statement',
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'deadlock.c',
    line: '1130',
    routine: 'DeadLockReport'
  }
}

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676079964,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676079979,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676079971,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676079971,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676079975,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676079976,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676079979,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676079979,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676079979,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676079979,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676080104,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676080105,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

 [31mÎ“Â¥Â»[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 45952[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for current user[39m[33m 326[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current session correctly[39m[33m 3321[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked sessions[39m[33m 2937[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order sessions by last used (most recent first)[39m[33m 2587[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should filter sessions by current user only[39m[33m 3113[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 for unauthenticated request[32m 6[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1386[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 1279[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent session[39m[33m 348[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's session[39m[33m 3321[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all other sessions[39m[33m 341[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should keep current session active[39m[33m 2735[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 if no active session found [33m 1978[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all trusted devices[39m[33m 1488[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle user with single session gracefully[39m[33m 1576[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should include device metadata in sessions[39m[33m 1968[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not expose sensitive token data[39m[33m 1267[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track session activity timestamps[39m[33m 1447[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w32_v3

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w32_v3,public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w32_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w32_v3%2Cpublic

{"level":30,"time":1768676080551,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676080591,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676080594,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676080595,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[31m14 failed[39m[2m)[22m[33m 16389[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 1: Create organization[39m[33m 306[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 2: Invite member via email[39m[32m 50[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 3: Accept invite[39m[32m 52[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 4: Create workflow owned by user[39m[32m 162[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 5: Transfer workflow to organization[39m[32m 97[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 6: Org member (user2) can access workflow[39m[32m 98[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 7: Org member (user2) can update workflow[39m[32m 97[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 8: Org admin (user1) can still access workflow after transfer[39m[32m 96[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Step 9: Non-member (user3) CANNOT access org workflow[32m 103[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Step 10: Non-member (user3) CANNOT update org workflow[32m 94[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Step 11: Non-member (user3) CANNOT transfer org workflow[32m 102[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 12: Org member can see workflow in list[39m[32m 117[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Step 13: Non-member CANNOT see workflow in list[32m 97[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 14: Remove member from org[39m[32m 50[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Step 15: Removed member (user2) can no longer access workflow[32m 101[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Step 16: Re-add member and verify access restored[39m[32m 46[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Cannot invite same email twice (pending invite exists)[39m[32m 48[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Cannot accept expired invite[39m[32m 46[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m Cannot transfer workflow to org user is not a member of[39m[32m 44[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Member cannot promote themselves to admin[32m 47[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Member cannot remove admin[32m 48[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Only members can view organization details[32m 49[2mms[22m[39m
       [32mÎ“Â£Ã´[39m Only members can view organization members list[32m 51[2mms[22m[39m
{"level":30,"time":1768676080663,"env":"test","module":"user-credentials-repository","userId":"d03a78b3-24a3-434c-b5b0-87bb5a82dc3a","msg":"User credentials created"}
{"level":30,"time":1768676080917,"env":"test","module":"email-queue","jobId":"e17da824-eac8-4287-bbf6-03d374084c10","to":"test-62zn8JyvSoSIrOgGMBjA2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w32_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w19_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/externalSends.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676081038,"env":"test","module":"auth-routes","userId":"d03a78b3-24a3-434c-b5b0-87bb5a82dc3a","email":"test-62zn8JyvSoSIrOgGMBjA2@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w24_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676081445,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676081472,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676081457,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676081458,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676081465,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676081466,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676081472,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676081472,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676081472,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676081472,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test
Î“ÃœÃ¡âˆ©â••Ã… Skipping auditLogs cleanup: auditLogs or testUserId is undefined { auditLogs: true, testUserId: undefined }

stderr | tests/integration/lifecycle-hooks-execution.test.ts > Lifecycle Hooks Execution
[FATAL] setupIntegrationTest failed: Error: Project creation failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed query: insert into \"projects\" (\"id\", \"title\", \"name\", \"description\", \"creator_id\", \"tenant_id\", \"created_by\", \"owner_id\", \"owner_type\", \"owner_uuid\", \"status\", \"archived\", \"created_at\", \"updated_at\") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, $8, default, default) returning \"id\", \"title\", \"name\", \"description\", \"creator_id\", \"tenant_id\", \"created_by\", \"owner_id\", \"owner_type\", \"owner_uuid\", \"status\", \"archived\", \"created_at\", \"updated_at\"\nparams: Test Project,Test Project,,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,9a20dd35-0457-4039-8261-f82f39b7dde4,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,false"}}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:153:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

{"level":30,"time":1768676081515,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676081515,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676081852,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676081853,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 15757[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute beforePage hook and capture console output
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute afterPage hook with user input data
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute Python afterPage hook
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mÎ“Ã¥Ã´[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute multiple hooks in correct order
       [2m[90mÎ“Ã¥Ã´[39m[22m should list all hooks for a workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should update a hook
       [2m[90mÎ“Ã¥Ã´[39m[22m should delete a hook
       [2m[90mÎ“Ã¥Ã´[39m[22m should test a hook with sample data
       [2m[90mÎ“Ã¥Ã´[39m[22m should retrieve execution logs for a run
       [2m[90mÎ“Ã¥Ã´[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 14693[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should create draft version on successful AI edit
     [2m[90mÎ“Ã¥Ã´[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90mÎ“Ã¥Ã´[39m[22m should not create version when no changes detected (checksum match)
     [2m[90mÎ“Ã¥Ã´[39m[22m should reject unauthorized access
     [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations
     [2m[90mÎ“Ã¥Ã´[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90mÎ“Ã¥Ã´[39m[22m should create BEFORE and AFTER snapshots
     [2m[90mÎ“Ã¥Ã´[39m[22m should rollback on validation failure
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768676081989,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["20e19eee-b5b3-4b3b-a4be-b8fc1b0c9338","$2b$12$OJDRN7V2AcRs4PBvUaosOupGpUJOSzYtERT3apvMEH57fXhlN/rIy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(20e19eee-b5b3-4b3b-a4be-b8fc1b0c9338) is not present in table \"users\".","schema":"test_schema_w26_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"20e19eee-b5b3-4b3b-a4be-b8fc1b0c9338","msg":"Failed to create user credentials"}
{"level":50,"time":1768676081989,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["20e19eee-b5b3-4b3b-a4be-b8fc1b0c9338","$2b$12$OJDRN7V2AcRs4PBvUaosOupGpUJOSzYtERT3apvMEH57fXhlN/rIy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(20e19eee-b5b3-4b3b-a4be-b8fc1b0c9338) is not present in table \"users\".","schema":"test_schema_w26_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
 [31mÎ“Â¥Â»[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 7668[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should hash a password using bcrypt with 12 rounds[32m 240[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should generate different hashes for same password [33m 495[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle empty passwords[32m 240[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle long passwords[32m 219[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle unicode characters in password[32m 225[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return true for correct password [33m 436[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return false for incorrect password [33m 426[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should be case-sensitive [33m 442[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should handle empty password comparison [33m 416[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept valid email addresses[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails with consecutive dots[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails without @ symbol[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails without domain[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails with spaces[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject null or undefined[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject emails with local part longer than 64 characters[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept valid strong passwords[32m 16[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject passwords shorter than 8 characters[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject passwords longer than 128 characters[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject weak passwords with zxcvbn score < 3[32m 5[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should provide helpful feedback for weak passwords[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject password containing user's email[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject password containing user's name[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept strong password even with user inputs provided[32m 3[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept password with exactly 8 characters if strong enough[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept password with exactly 128 characters if strong[32m 82[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return score in result object[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should create a valid JWT token for a user[32m 3[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should include userId, email, tenantId, and role in token payload[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should set token expiry to 15 minutes by default[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error if JWT_SECRET is not configured[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle null tenantId and role[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should verify and decode a valid token[32m 2[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should throw error for expired token [33m 1103[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for invalid token signature[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for malformed token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for invalid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for empty header[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle Bearer with multiple spaces[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return true for JWT-like tokens[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return false for non-JWT tokens[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return false for empty token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return false for null/undefined[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should create a valid portal token for an email[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should include email and portal flag in token payload[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should set token expiry to 24 hours[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should verify and decode a valid portal token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for non-portal token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for token without email[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error for expired portal token[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should generate password reset token for existing user[39m[32m 224[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for non-existent user[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should invalidate previous reset tokens[39m[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return userId for valid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for invalid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for expired token[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for used token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should mark token as used[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should generate verification token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should have 24 hour expiry[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should verify email with valid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return false for invalid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return false for expired token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should delete token after successful verification[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should create refresh token with 30-day expiry[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should store device metadata[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return userId for valid token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for revoked token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should return null for expired token[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should rotate valid token and return new one[39m[32m 2[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should return null for unknown token[39m[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should revoke all tokens on reuse detection[39m[32m 2[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should return null for expired token[39m[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should revoke specific token[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should revoke all tokens for user[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should cleanup expired refresh tokens[39m[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should cleanup expired password reset tokens[39m[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should cleanup expired email verification tokens[39m[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should cleanup old login attempts via accountLockoutService[39m[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should use JWT_SECRET if provided[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should warn if JWT_SECRET is less than 32 characters[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject token with modified payload[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject token with valid structure but invalid signature[32m 1[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should handle password with special characters [33m 433[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle password with only spaces[32m 213[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should handle password with newlines and tabs [33m 426[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject password with null bytes (if validation exists) [33m 433[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject email with unicode domain (security fix)[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle email with plus addressing[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle email with subdomain[32m 0[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should accept email with numeric TLD[32m 1[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should prevent timing attacks on token validation[32m 1[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should support full user authentication lifecycle[39m[32m 227[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should support complete password reset workflow[39m[32m 2[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should prevent reuse of password reset tokens[39m[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should support multiple valid refresh tokens per user[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should revoke all user tokens on security event[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle database connection failures gracefully[32m 3[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should handle transaction failures[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should throw error if JWT signing fails[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should hash password in reasonable time (< 500ms)[32m 230[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should compare password in reasonable time (< 500ms) [33m 488[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should create JWT token in < 10ms[32m 2[2mms[22m[39m
         [32mÎ“Â£Ã´[39m should verify JWT token in < 50ms[32m 2[2mms[22m[39m
stderr | tests/integration/datavault.permissions.test.ts > DataVault Table Permissions API (v4 Micro-Phase 6)
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.permissions.test.ts:22:11

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676082004,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676082005,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w34_v3

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w34_v3,public

 [31mÎ“Â¥Â»[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 15955[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to read table
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow writer to read table
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow reader to read table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny non-member from reading table
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to update table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny writer from updating table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny reader from updating table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny writer from deleting table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny reader from deleting table
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny non-member from deleting table
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to view permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny writer from viewing permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny reader from viewing permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to grant permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to update existing permission (upsert)
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny writer from granting permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should prevent modifying table owner permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to revoke permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should deny writer from revoking permissions
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce owner includes write and read
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce write includes read but not owner
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce read is read-only
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w34_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w34_v3%2Cpublic

{"level":30,"time":1768676082342,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768676082397,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w34_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w26_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/ownershipAccess.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768676084812,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676084812,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 30846[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create a workflow template mapping[39m[33m 992[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create non-primary mapping by default[39m[33m 1029[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should find all templates for a workflow version[39m[33m 877[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return empty array for version with no templates[39m[33m 772[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order by createdAt desc (newest first)[39m[33m 1175[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should find mapping by workflow version and key[39m[33m 962[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return undefined for non-existent key[39m[33m 1358[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should find primary template for workflow version[39m[33m 1529[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return undefined when no primary template exists[39m[33m 661[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set a template as primary and unset others[39m[33m 741[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle setting primary when none existed before[39m[33m 781[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not delete mapping if workflow version does not match[39m[33m 776[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return true if key exists in workflow version[39m[33m 705[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return false if key does not exist[39m[33m 763[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude specified id when checking existence[39m[33m 994[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return true if key exists on different mapping[39m[33m 674[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update mapping fields[39m[33m 759[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should find mapping by id[39m[33m 1121[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return undefined for non-existent id [33m 750[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676084996,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676085415,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676085416,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m24 failed[39m[2m)[22m[33m 23425[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for current user[39m[32m 74[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 914[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return empty array when user has no active sessions[39m[32m 75[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not include expired sessions[39m[33m 338[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not include revoked sessions[39m[33m 329[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should parse device name from user agent[39m[33m 325[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for unauthenticated request[39m[33m 342[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke a specific session[39m[33m 330[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent session[39m[33m 431[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 407[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking another user's session[39m[33m 330[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for unauthenticated request[39m[33m 440[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 424[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all trusted devices[39m[33m 337[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 400 when no active session found[39m[33m 432[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 for unauthenticated request[39m[33m 412[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should mark current device as trusted[39m[33m 358[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should update existing trusted device expiry[39m[33m 352[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 352[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should not include revoked devices[39m[33m 442[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should revoke a trusted device[39m[33m 419[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 422[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track IP address for sessions[39m[33m 415[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track user agent for sessions[39m[33m 353[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on token refresh[39m[33m 523[2mms[22m[39m
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w26_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w26_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w37_v3

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w37_v3,public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w37_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w37_v3%2Cpublic

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768676087155,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676087238,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w38_v3

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w38_v3,public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w33_v3

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w38_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w38_v3%2Cpublic

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w33_v3,public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w33_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w33_v3%2Cpublic

{"level":30,"time":1768676087683,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676087710,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w40_v3

{"level":30,"time":1768676087728,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/workflows/runtime-pipelines.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w29_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w29_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w29_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w29_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w29_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w29_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w29_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w29_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w29_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: error: deadlock detected
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 485,
    severity: 'ERROR',
    code: '40P01',
    detail: 'Process 14989 waits for AccessExclusiveLock on relation 2541233 of database 16391; blocked by process 9879.\n' +
      'Process 9879 waits for RowShareLock on relation 2540634 of database 16391; blocked by process 14989.',
    hint: 'See server log for query details.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: 'SQL statement "ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk""\n' +
      'PL/pgSQL function inline_code_block line 2 at SQL statement',
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'deadlock.c',
    line: '1130',
    routine: 'DeadLockReport'
  }
}

{"level":30,"time":1768676087758,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w40_v3,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w40_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w40_v3%2Cpublic

{"level":30,"time":1768676087890,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676087936,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w33_v3, public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w33_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/intake.workflow.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w37_v3, public

{"level":30,"time":1768676088227,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676088227,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w37_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/datavault/EditableCell.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w40_v3, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676088322,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w40_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/variableSafety.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676088385,"env":"test","msg":"DB: initialized flag set."}
 [31mÎ“Â¥Â»[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 16275[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should write data to DataVault via WriteBlock
     [2m[90mÎ“Ã¥Ã´[39m[22m should query data from DataVault via QueryBlock and use in Logic
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w38_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w38_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/runs.components.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

stderr | tests/integration/workflows/runtime-pipelines.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
        CREATE OR REPLACE FUNCTION datavault_get_next_autonumber(
          p_tenant_id UUID,
          p_table_id UUID,
          p_column_id UUID,
          p_context_key TEXT,
          p_min_digits INTEGER DEFAULT 1,
          p_prefix TEXT DEFAULT '',
          p_format TEXT DEFAULT NULL
        )
        RETURNS TEXT
        LANGUAGE plpgsql
        AS $$
        DECLARE
          v_sequence_name TEXT;
          v_next_val BIGINT;
          v_year TEXT;
          v_formatted TEXT;
          v_final_result TEXT;
          v_prefix TEXT;
        BEGIN
          -- Use MD5 hash for sequence name to ensure uniqueness and stay within 63 char limit
          -- Format: seq_{md5_hash}
          v_sequence_name := 'seq_' || md5(p_tenant_id::text || '_' || p_column_id::text);
          
          -- Handle Year-based updates
          IF p_format = 'YYYY' THEN
              v_year := to_char(current_date, 'YYYY');
              v_sequence_name := v_sequence_name || '_' || v_year;
          END IF;

          -- Create sequence if not exists
          EXECUTE format('CREATE SEQUENCE IF NOT EXISTS %I START 1', v_sequence_name);
          
          -- Get next value
          EXECUTE format('SELECT nextval(%L)', v_sequence_name) INTO v_next_val;
          
          -- Ensure defaults for NULL inputs to prevent NULL results
          v_prefix := COALESCE(p_prefix, '');
          
          -- Format the number
          v_formatted := lpad(v_next_val::text, COALESCE(p_min_digits, 4), '0');
          
          -- Combine
          -- Logic: [Prefix-] [Year-] Number
          
          -- 1. Start with Prefix (if exists, add dash)
          IF v_prefix <> '' THEN
             v_final_result := v_prefix || '-';
          ELSE
             v_final_result := '';
          END IF;
          
          -- 2. Add Year (if exists, add dash)
          IF p_format = 'YYYY' THEN
               v_final_result := v_final_result || v_year || '-';
          END IF;
          
          -- 3. Add Number
          v_final_result := v_final_result || v_formatted;
          
          RETURN v_final_result;
        END;
        $$;
      
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:420:3)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '        CREATE OR REPLACE FUNCTION datavault_get_next_autonumber(\n' +
    '          p_tenant_id UUID,\n' +
    '          p_table_id UUID,\n' +
    '          p_column_id UUID,\n' +
    '          p_context_key TEXT,\n' +
    '          p_min_digits INTEGER DEFAULT 1,\n' +
    "          p_prefix TEXT DEFAULT '',\n" +
    '          p_format TEXT DEFAULT NULL\n' +
    '        )\n' +
    '        RETURNS TEXT\n' +
    '        LANGUAGE plpgsql\n' +
    '        AS $$\n' +
    '        DECLARE\n' +
    '          v_sequence_name TEXT;\n' +
    '          v_next_val BIGINT;\n' +
    '          v_year TEXT;\n' +
    '          v_formatted TEXT;\n' +
    '          v_final_result TEXT;\n' +
    '          v_prefix TEXT;\n' +
    '        BEGIN\n' +
    '          -- Use MD5 hash for sequence name to ensure uniqueness and stay within 63 char limit\n' +
    '          -- Format: seq_{md5_hash}\n' +
    "          v_sequence_name := 'seq_' || md5(p_tenant_id::text || '_' || p_column_id::text);\n" +
    '          \n' +
    '          -- Handle Year-based updates\n' +
    "          IF p_format = 'YYYY' THEN\n" +
    "              v_year := to_char(current_date, 'YYYY');\n" +
    "              v_sequence_name := v_sequence_name || '_' || v_year;\n" +
    '          END IF;\n' +
    '\n' +
    '          -- Create sequence if not exists\n' +
    "          EXECUTE format('CREATE SEQUENCE IF NOT EXISTS %I START 1', v_sequence_name);\n" +
    '          \n' +
    '          -- Get next value\n' +
    "          EXECUTE format('SELECT nextval(%L)', v_sequence_name) INTO v_next_val;\n" +
    '          \n' +
    '          -- Ensure defaults for NULL inputs to prevent NULL results\n' +
    "          v_prefix := COALESCE(p_prefix, '');\n" +
    '          \n' +
    '          -- Format the number\n' +
    "          v_formatted := lpad(v_next_val::text, COALESCE(p_min_digits, 4), '0');\n" +
    '          \n' +
    '          -- Combine\n' +
    '          -- Logic: [Prefix-] [Year-] Number\n' +
    '          \n' +
    '          -- 1. Start with Prefix (if exists, add dash)\n' +
    "          IF v_prefix <> '' THEN\n" +
    "             v_final_result := v_prefix || '-';\n" +
    '          ELSE\n' +
    "             v_final_result := '';\n" +
    '          END IF;\n' +
    '          \n' +
    '          -- 2. Add Year (if exists, add dash)\n' +
    "          IF p_format = 'YYYY' THEN\n" +
    "               v_final_result := v_final_result || v_year || '-';\n" +
    '          END IF;\n' +
    '          \n' +
    '          -- 3. Add Number\n' +
    '          v_final_result := v_final_result || v_formatted;\n' +
    '          \n' +
    '          RETURN v_final_result;\n' +
    '        END;\n' +
    '        $$;\n' +
    '      ',
  params: [],
  cause: error: cannot change name of input parameter "p_prefix"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:420:3)
      at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
    length: 204,
    severity: 'ERROR',
    code: '42P13',
    detail: undefined,
    hint: 'Use DROP FUNCTION datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text) first.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'pg_proc.c',
    line: '486',
    routine: 'ProcedureCreate'
  }
}

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w36_v3

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w35_v3

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w36_v3,public

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w36_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w36_v3%2Cpublic

{"level":30,"time":1768676089417,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w35_v3,public

{"level":30,"time":1768676089461,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w35_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w35_v3%2Cpublic

{"level":30,"time":1768676089509,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676089554,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w28_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w28_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676089709,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w36_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676089812,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676089812,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w31_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.runs.graph.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

 [31mÎ“Â¥Â»[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m14 failed[39m[2m)[22m[33m 27088[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should resolve template by key from workflowTemplates mapping[39m[33m 647[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should throw error if template key not found[39m[33m 945[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should store output in runOutputs table[39m[33m 789[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should resolve template by templateId directly[39m[33m 581[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should throw error if templateId not found[39m[33m 777[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should use docxRenderer2 by default (v2 engine)[39m[33m 1097[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should use legacy engine when engine="legacy"[39m[33m 509[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should generate PDF when toPdf=true[39m[33m 482[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should default to DOCX when toPdf=false[39m[33m 699[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip execution when condition evaluates to false[39m[33m 584[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should execute when condition evaluates to true [33m 809[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should resolve simple bindings[39m[33m 768[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle binding resolution errors gracefully [33m 940[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record failed output in runOutputs table[39m[33m 624[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not throw errors (should return error in result) [33m 774[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should deny access to templates from different tenant[39m[33m 1086[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require either templateKey or templateId[39m[33m 900[2mms[22m[39m
 [31mÎ“Â¥Â»[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m14 failed[39m[2m)[22m[33m 29528[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should enqueue a PDF conversion job[39m[33m 756[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create output with empty storagePath initially[39m[33m 1323[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return job status for pending job[39m[33m 1241[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return null for non-existent job[39m[33m 683[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should parse attempt count from error field[39m[33m 1324[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should convert DOCX to PDF immediately[39m[33m 877[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle conversion errors gracefully[39m[33m 746[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should start and stop service [33m 1030[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not start if already running[39m[33m 399[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle stop when not running[39m[33m 857[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should process pending jobs when queue is processed[39m[33m 772[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should process multiple jobs in batch[39m[33m 1000[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle missing DOCX output gracefully[39m[33m 1083[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support enqueue within transaction[39m[33m 1960[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support convertImmediate within transaction[39m[33m 965[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w35_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676089925,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w31_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.projects.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676089947,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676089935,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676089935,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676089940,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676089941,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676089946,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676089946,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676089947,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676089947,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676090156,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676090157,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

 [31mÎ“Â¥Â»[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 16362[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create DataVault row on workflow completion
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90mÎ“Ã¥Ã´[39m[22m should skip document generation when visibleIf condition is false
       [2m[90mÎ“Ã¥Ã´[39m[22m should generate document when visibleIf condition is true
{"level":30,"time":1768676090677,"env":"test","module":"user-credentials-repository","userId":"9c974cad-ee6f-4408-bc02-baa887036751","msg":"User credentials created"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676090929,"env":"test","module":"email-queue","jobId":"9b06a81c-baa6-46f9-afdf-3a4a8ea7e4d1","to":"test-7yiQxwGxAxnp5BQDVptSw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768676091052,"env":"test","module":"auth-routes","userId":"9c974cad-ee6f-4408-bc02-baa887036751","email":"test-7yiQxwGxAxnp5BQDVptSw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stderr | tests/integration/api.templates-runs.test.ts > Templates and Runs API Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Tenant for Templates Org,14ee40dd-8d05-46f2-9874-d554e25ef194
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11 {
  query: 'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"',
  params: [
    'Test Tenant for Templates Org',
    '14ee40dd-8d05-46f2-9874-d554e25ef194'
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11 {
    length: 347,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(14ee40dd-8d05-46f2-9874-d554e25ef194) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w23_v3',
    table: 'organizations',
    column: undefined,
    dataType: undefined,
    constraint: 'organizations_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768676091243,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676091244,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

 [31mÎ“Â¥Â»[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 15040[2mms[22m[39m
         [2m[90mÎ“Ã¥Ã´[39m[22m should create template with file upload
         [2m[90mÎ“Ã¥Ã´[39m[22m should reject non-docx files
         [2m[90mÎ“Ã¥Ã´[39m[22m should reject without file
         [2m[90mÎ“Ã¥Ã´[39m[22m should list templates
         [2m[90mÎ“Ã¥Ã´[39m[22m should get template by ID
         [2m[90mÎ“Ã¥Ã´[39m[22m should extract placeholders
         [2m[90mÎ“Ã¥Ã´[39m[22m should update template name
         [2m[90mÎ“Ã¥Ã´[39m[22m should delete template
         [2m[90mÎ“Ã¥Ã´[39m[22m should execute workflow
         [2m[90mÎ“Ã¥Ã´[39m[22m should include logs in debug mode
         [2m[90mÎ“Ã¥Ã´[39m[22m should reject without required permission
         [2m[90mÎ“Ã¥Ã´[39m[22m should list runs
         [2m[90mÎ“Ã¥Ã´[39m[22m should filter by workflowId
         [2m[90mÎ“Ã¥Ã´[39m[22m should get run by ID
         [2m[90mÎ“Ã¥Ã´[39m[22m should get run logs
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w42_v3

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w42_v3,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w42_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w42_v3%2Cpublic

{"level":30,"time":1768676091896,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676091948,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w39_v3

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w44_v3

[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w44_v3,public

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w39_v3,public

{"level":30,"time":1768676092250,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676092250,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w44_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w44_v3%2Cpublic

{"level":30,"time":1768676092257,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w39_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w39_v3%2Cpublic

{"level":30,"time":1768676092277,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w42_v3, public

{"level":30,"time":1768676092310,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676092329,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w42_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/collections.e2e.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

 [31mÎ“Â¥Â»[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 15020[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should generate events and metrics on run completion
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w43_v3

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w43_v3,public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w43_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w43_v3%2Cpublic

{"level":30,"time":1768676092553,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676092604,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w44_v3, public

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w39_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w32_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/regression-REG-1.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w32_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.runs.docx.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w43_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w43_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/oauth2.google.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...


[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676093439,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w32_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w32_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w46_v3

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w46_v3,public

{"level":30,"time":1768676095500,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676095501,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w46_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w46_v3%2Cpublic

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

 [31mÎ“Â¥Â»[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 15577[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m PREVIEW MODE: Should simulate send and NOT call fetch[39m[32m 208[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m LIVE MODE: Should call fetch with mapped payload[39m[33m 344[2mms[22m[39m
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w41_v3

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w41_v3,public

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w41_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w41_v3%2Cpublic

{"level":30,"time":1768676095779,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676095828,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w41_v3, public

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w41_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.expression-validation.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676096263,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676096303,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676096585,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w46_v3, public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w46_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/datavault/TableCard.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w45_v3

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w45_v3,public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w45_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w45_v3%2Cpublic

{"level":30,"time":1768676098991,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676099040,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w45_v3, public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w45_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.dataSources.native.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

stderr | tests/integration/ownershipAccess.test.ts > Ownership Access Control > canManageOrg > should return false for non-member
Setup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: 'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing',
  params: [
    '00000000-0000-0000-0000-000000000001',
    'user1@test.com',
    'User 1',
    '00000000-0000-0000-0000-000000000099',
    '00000000-0000-0000-0000-000000000002',
    'user2@test.com',
    'User 2',
    '00000000-0000-0000-0000-000000000099'
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: 315,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w18_v3',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768676100274,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

stderr | tests/integration/intake.workflow.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w33_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w33_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w33_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w33_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w33_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w33_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w33_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w33_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w33_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: error: deadlock detected
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 485,
    severity: 'ERROR',
    code: '40P01',
    detail: 'Process 15000 waits for AccessExclusiveLock on relation 2559906 of database 16391; blocked by process 9879.\n' +
      'Process 9879 waits for RowShareLock on relation 2559572 of database 16391; blocked by process 15000.',
    hint: 'See server log for query details.',
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: 'SQL statement "ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk""\n' +
      'PL/pgSQL function inline_code_block line 2 at SQL statement',
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'deadlock.c',
    line: '1130',
    routine: 'DeadLockReport'
  }
}

stderr | tests/integration/ownershipAccess.test.ts > Ownership Access Control > getUserOrgIds > should return empty array for user with no memberships
Setup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: 'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing',
  params: [
    '00000000-0000-0000-0000-000000000001',
    'user1@test.com',
    'User 1',
    '00000000-0000-0000-0000-000000000099',
    '00000000-0000-0000-0000-000000000002',
    'user2@test.com',
    'User 2',
    '00000000-0000-0000-0000-000000000099'
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: 315,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w33_v3',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w40_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w47_v3

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w40_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w47_v3,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w47_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w47_v3%2Cpublic

{"level":30,"time":1768676102047,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676102084,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w37_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w37_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w47_v3, public

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w36_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/js_helpers.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

stderr | tests/integration/ownershipAccess.test.ts > Ownership Access Control > canCreateWithOwnership > should allow creating user-owned asset if ownerUuid matches userId
Setup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: 'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing',
  params: [
    '10000000-0000-0000-0000-000000000001',
    'Test Org 1',
    '00000000-0000-0000-0000-000000000099',
    '10000000-0000-0000-0000-000000000002',
    'Test Org 2',
    '00000000-0000-0000-0000-000000000099'
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: 347,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w36_v3',
    table: 'organizations',
    column: undefined,
    dataType: undefined,
    constraint: 'organizations_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w33_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w33_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w36_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stderr | tests/ui/datavault/EditableCell.test.tsx > EditableCell Component > Error Handling > reverts value on save error
Failed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w36_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676103399,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676103419,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676103407,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676103408,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676103413,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676103413,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676103418,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676103418,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676103419,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676103419,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

stderr | tests/ui/datavault/EditableCell.test.tsx > EditableCell Component > Error Handling > displays error indicator on save failure
Failed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676103644,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676103666,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676103655,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676103655,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676103660,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676103661,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676103666,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676103666,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676103666,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676103666,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/ui/datavault/EditableCell.test.tsx > EditableCell Component > Boolean Type (Checkbox) > shows loading spinner when saving checkbox
Warning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":30,"time":1768676103859,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676103884,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676103870,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676103871,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676103876,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676103876,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676103883,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676103883,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676103884,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676103884,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768676103896,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676103897,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676103910,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676103911,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676103952,"env":"test","module":"user-credentials-repository","userId":"9a9d1aa8-5f36-4ea7-a9e6-b05890345388","msg":"User credentials created"}
 [32mÎ“Â£Ã´[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 17003[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should show download options for successful runs [33m 559[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should call onChange when status filter changes [33m 302[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 18150[2mms[22m[39m
{"level":50,"time":1768676104050,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["9a9d1aa8-5f36-4ea7-a9e6-b05890345388","499513f7c569cc4b368d4cbadcad9361529f6d3e4033a463f3d3eeb6097042e6","2026-01-18T18:55:03.953Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9a9d1aa8-5f36-4ea7-a9e6-b05890345388) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/intake.workflow.test.ts > Intake Workflow Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

{"level":30,"time":1768676104064,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676104065,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676104137,"env":"test","module":"user-credentials-repository","userId":"efb76248-c08d-4724-8cbf-aa84b4ac7b1c","msg":"User credentials created"}
stderr | tests/integration/ownershipAccess.test.ts > Ownership Access Control > canCreateWithOwnership > should deny creating org-owned asset if user is not member
Setup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: 'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing',
  params: [
    '10000000-0000-0000-0000-000000000001',
    'Test Org 1',
    '00000000-0000-0000-0000-000000000099',
    '10000000-0000-0000-0000-000000000002',
    'Test Org 2',
    '00000000-0000-0000-0000-000000000099'
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: 347,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w35_v3',
    table: 'organizations',
    column: undefined,
    dataType: undefined,
    constraint: 'organizations_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768676104183,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["efb76248-c08d-4724-8cbf-aa84b4ac7b1c","7d900f4cffb4d545f6f3a26e3683b915bca5ec714e50c3c118ebff6f9876dd46","2026-01-18T18:55:04.137Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(efb76248-c08d-4724-8cbf-aa84b4ac7b1c) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39m[Shim] Request to /api/auth/google, Session User ID: undefined

 [31mÎ“Â¥Â»[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 16909[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should allow designating a workflow as Intake
     [2m[90mÎ“Ã¥Ã´[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768676104539,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676104540,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

 [31mÎ“Â¥Â»[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 15552[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a new project
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject without authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject with invalid data
       [2m[90mÎ“Ã¥Ã´[39m[22m should list projects for tenant
       [2m[90mÎ“Ã¥Ã´[39m[22m should support pagination
       [2m[90mÎ“Ã¥Ã´[39m[22m should get project by ID
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent project
       [2m[90mÎ“Ã¥Ã´[39m[22m should update project
       [2m[90mÎ“Ã¥Ã´[39m[22m should soft-delete project
       [2m[90mÎ“Ã¥Ã´[39m[22m should not allow cross-tenant access
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

stderr | tests/integration/ownershipAccess.test.ts > Ownership Access Control > Cross-org Access Control > should not allow member of org1 to access org2-owned assets
Setup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: 'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing',
  params: [
    '10000000-0000-0000-0000-000000000001',
    'Test Org 1',
    '00000000-0000-0000-0000-000000000099',
    '10000000-0000-0000-0000-000000000002',
    'Test Org 2',
    '00000000-0000-0000-0000-000000000099'
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: 347,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w42_v3',
    table: 'organizations',
    column: undefined,
    dataType: undefined,
    constraint: 'organizations_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676104968,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676104969,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 17717[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 246[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 842[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 482[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m BlockRunner logic resolves alias with aliasMap[39m[33m 412[2mms[22m[39m
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

stderr | tests/integration/api.runs.graph.test.ts > Stage 8: Runs API Integration Tests
Cleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: cf2eb56b-546b-4f89-ae69-c43513964b57
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: 'delete from "workflows" where  = $1',
  params: [ 'cf2eb56b-546b-4f89-ae69-c43513964b57' ],
  cause: error: syntax error at or near "="
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: 90,
    severity: 'ERROR',
    code: '42601',
    detail: undefined,
    hint: undefined,
    position: '32',
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'scan.l',
    line: '1244',
    routine: 'scanner_yyerror'
  }
}

{"level":30,"time":1768676105171,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676105172,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [31mÎ“Â¥Â»[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 16290[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should list all runs with pagination
       [2m[90mÎ“Ã¥Ã´[39m[22m should filter runs by status
       [2m[90mÎ“Ã¥Ã´[39m[22m should filter runs by workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should filter runs by project
       [2m[90mÎ“Ã¥Ã´[39m[22m should filter runs by date range
       [2m[90mÎ“Ã¥Ã´[39m[22m should search runs by query string
       [2m[90mÎ“Ã¥Ã´[39m[22m should get run by ID with all details
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent run
       [2m[90mÎ“Ã¥Ã´[39m[22m should get logs for a run
       [2m[90mÎ“Ã¥Ã´[39m[22m should re-run workflow with same inputs
       [2m[90mÎ“Ã¥Ã´[39m[22m should re-run workflow with override inputs
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent run
       [2m[90mÎ“Ã¥Ã´[39m[22m should export runs to CSV
       [2m[90mÎ“Ã¥Ã´[39m[22m should export runs with filters applied
       [2m[90mÎ“Ã¥Ã´[39m[22m should compare two runs
       [2m[90mÎ“Ã¥Ã´[39m[22m should identify changed input keys
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 if run A not found
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 if run B not found
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce tenant isolation on runs list
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w49_v3

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w49_v3,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w42_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w49_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w49_v3%2Cpublic

{"level":30,"time":1768676105894,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676105950,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w42_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w44_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w48_v3

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w49_v3, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w49_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/workflow_versioning.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676106352,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676106352,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w48_v3,public

 [31mÎ“Â¥Â»[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 24575[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow access to user-owned asset by owner[32m 295[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should deny access to user-owned asset by non-owner [33m 468[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow access to org-owned asset by org member [33m 448[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should deny access to org-owned asset by non-member[32m 294[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow access to null ownership (legacy data)[32m 227[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return true for org member [33m 352[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return false for non-member[32m 283[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return true for org admin [33m 364[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return true for org admin [33m 354[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return false for org member (non-admin) [33m 349[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return false for non-member [33m 682[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return all org IDs for a user [33m 442[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array for user with no memberships [33m 1718[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow creating user-owned asset if ownerUuid matches userId [33m 678[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should deny creating user-owned asset if ownerUuid does not match userId [33m 319[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow creating org-owned asset if user is member[39m[33m 678[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should deny creating org-owned asset if user is not member [33m 647[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow member of org1 to access org2-owned assets[39m[33m 1015[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow member of multiple orgs to access all their org assets [33m 710[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w48_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w48_v3%2Cpublic

{"level":30,"time":1768676106422,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676106468,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676106825,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676106854,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676106838,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676106839,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676106845,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676106846,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676106854,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676106854,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676106854,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676106854,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w48_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w48_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/oauth2.callback.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w52_v3

{"level":50,"time":1768676107045,"env":"test","module":"auth","msg":"No default tenant found in database"}
{"level":50,"time":1768676107045,"env":"test","module":"auth","err":{"type":"Error","message":"System not properly configured - no tenant found","stack":"Error: System not properly configured - no tenant found\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:52:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768676107046,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768676107067,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676107067,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w52_v3,public

 [31mÎ“Â¥Â»[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 15834[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a collection
       [2m[90mÎ“Ã¥Ã´[39m[22m should list collections
       [2m[90mÎ“Ã¥Ã´[39m[22m should get a collection by ID
       [2m[90mÎ“Ã¥Ã´[39m[22m should update a collection
       [2m[90mÎ“Ã¥Ã´[39m[22m should create text field
       [2m[90mÎ“Ã¥Ã´[39m[22m should create email field
       [2m[90mÎ“Ã¥Ã´[39m[22m should create number field
       [2m[90mÎ“Ã¥Ã´[39m[22m should create select field with options
       [2m[90mÎ“Ã¥Ã´[39m[22m should create boolean field
       [2m[90mÎ“Ã¥Ã´[39m[22m should list all fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should update field
       [2m[90mÎ“Ã¥Ã´[39m[22m should create a record
       [2m[90mÎ“Ã¥Ã´[39m[22m should create multiple records
       [2m[90mÎ“Ã¥Ã´[39m[22m should list records with pagination
       [2m[90mÎ“Ã¥Ã´[39m[22m should get a single record
       [2m[90mÎ“Ã¥Ã´[39m[22m should update a record
       [2m[90mÎ“Ã¥Ã´[39m[22m should find records by filters
       [2m[90mÎ“Ã¥Ã´[39m[22m should delete a record
       [2m[90mÎ“Ã¥Ã´[39m[22m should list collections with stats
       [2m[90mÎ“Ã¥Ã´[39m[22m should enforce required fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate field types
       [2m[90mÎ“Ã¥Ã´[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w52_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w52_v3%2Cpublic

{"level":30,"time":1768676107159,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676107210,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768676107248,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768676107249,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768676107314,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768676107314,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768676107315,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w50_v3

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w50_v3,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w50_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w50_v3%2Cpublic

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w52_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/dynamic_options_workflow.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676107607,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["afb2a2ae-8f34-49a9-b032-6a6116a6e1dd","$2b$12$8h1/JVdh3b1DeRRyr7CsMe63NySj9uSzYs.Ns599yHE.HNZ3nnE2K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(afb2a2ae-8f34-49a9-b032-6a6116a6e1dd) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"afb2a2ae-8f34-49a9-b032-6a6116a6e1dd","msg":"Failed to create user credentials"}
{"level":50,"time":1768676107608,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["afb2a2ae-8f34-49a9-b032-6a6116a6e1dd","$2b$12$8h1/JVdh3b1DeRRyr7CsMe63NySj9uSzYs.Ns599yHE.HNZ3nnE2K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(afb2a2ae-8f34-49a9-b032-6a6116a6e1dd) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":50,"time":1768676107966,"env":"test","module":"auth","msg":"No default tenant found in database"}
{"level":50,"time":1768676107966,"env":"test","module":"auth","err":{"type":"Error","message":"System not properly configured - no tenant found","stack":"Error: System not properly configured - no tenant found\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:52:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-refresh","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768676107967,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768676107979,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676107979,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":50,"time":1768676108253,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,12df800c-cb45-4117-9fff-4458016a93e6,viewer,google,easy,true,,,,,2026-01-17T18:55:08.156Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,12df800c-cb45-4117-9fff-4458016a93e6,viewer,google,easy,true,,,,,2026-01-17T18:55:08.156Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-idtoken","idtoken@example.com",null,null,null,"12df800c-cb45-4117-9fff-4458016a93e6","viewer","google","easy",true,null,null,null,null,"2026-01-17T18:55:08.156Z"]},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768676108255,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
 [31mÎ“Â¥Â»[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 16367[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should execute workflow with template node and generate DOCX
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle missing template data gracefully
       [2m[90mÎ“Ã¥Ã´[39m[22m should download DOCX output from successful run
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for PDF when not generated
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent run
       [2m[90mÎ“Ã¥Ã´[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676108410,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676108470,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":50,"time":1768676108808,"env":"test","module":"auth","msg":"No default tenant found in database"}
{"level":40,"time":1768676108809,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":50,"time":1768676108808,"env":"test","module":"auth","err":{"type":"Error","message":"System not properly configured - no tenant found","stack":"Error: System not properly configured - no tenant found\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:52:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-minimal","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768676108808,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":40,"time":1768676108809,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w50_v3, public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":50,"time":1768676108937,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w50_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/expression-editor.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":40,"time":1768676108996,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768676108996,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":50,"time":1768676109055,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768676109114,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676109114,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 17089[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should successfully authenticate with valid Google ID token[39m[32m 166[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 400 when ID token is missing[32m 54[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 403 when Origin header is invalid[32m 53[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 when Google token verification fails[32m 78[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return 401 when email is not verified by Google[32m 66[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update existing user on subsequent logins[39m[32m 156[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token record in database[39m[33m 497[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should support both "token" and "idToken" fields[39m[32m 290[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should respect rate limiting [33m 422[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should handle missing profile information gracefully[39m[32m 130[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should verify valid Google ID token[32m 64[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should throw error when token verification fails[32m 62[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should throw error when email is not verified[32m 58[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should throw error when payload is null[32m 59[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676109301,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676109302,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w53_v3

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mÎ“Â¥Â»[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 17568[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should block Next when required visible question is empty[39m[32m 52[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should NOT block Next when required question is hidden[39m[33m 489[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should block when required becomes visible and is empty[39m[33m 346[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip hidden required page entirely[39m[33m 517[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should enforce required on visible page[39m[33m 600[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should evaluate visibility consistently across modes[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle malformed visibility expression gracefully[32m 2[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w53_v3,public

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w53_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w53_v3%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w55_v3

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55_v3,public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w55_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55_v3%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676109896,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676109931,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676109911,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676109912,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676109922,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676109922,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676109930,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676109931,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676109931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676109931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w54_v3

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w41_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w41_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676110352,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54_v3,public

{"level":30,"time":1768676110415,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w54_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54_v3%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676110674,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676110723,"env":"test","module":"user-credentials-repository","userId":"04747730-2823-4391-b658-8e0ef5573084","msg":"User credentials created"}
{"level":30,"time":1768676110738,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768676110778,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w53_v3, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w53_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/datavault/DatabaseSettingsPage.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676110998,"env":"test","module":"email-queue","jobId":"606ae72b-1309-41a6-8294-f9188666c8db","to":"test-Qy3JDPc31tkNP3BnB00Fr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768676111132,"env":"test","module":"auth-routes","userId":"04747730-2823-4391-b658-8e0ef5573084","email":"test-Qy3JDPc31tkNP3BnB00Fr@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w55_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w55_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w56_v3

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56_v3,public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676111390,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w56_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56_v3%2Cpublic

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

{"level":30,"time":1768676111455,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w54_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w54_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/components/datavault/TableGridView.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676112005,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676112006,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

 [32mÎ“Â£Ã´[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 17075[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should call onDelete when delete button is clicked [33m 1090[2mms[22m[39m
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676112411,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676112411,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676112563,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676112623,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w57_v3

 [31mÎ“Â¥Â»[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 17263[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate a correct expression with valid variables
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate expression with string concatenation
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject expression with invalid syntax
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject without authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject missing required fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should return available variables for a node
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject without authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject non-existent workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m should return list of helper functions with metadata
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject without authentication
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57_v3,public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w56_v3, public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w57_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57_v3%2Cpublic

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w56_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/datavault/ColumnTypeIcon.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768676113430,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676113461,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676113443,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676113443,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676113450,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676113453,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676113460,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676113460,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676113460,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676113460,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w51_v3

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w51_v3,public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676114037,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w58_v3

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w51_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w51_v3%2Cpublic

{"level":30,"time":1768676114080,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676114092,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676114134,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58_v3,public

{"level":30,"time":1768676114209,"env":"test","module":"user-credentials-repository","userId":"a2ac8208-0807-459c-aeeb-f88dcb0ae02c","msg":"User credentials created"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w58_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58_v3%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768676114433,"env":"test","module":"email-queue","jobId":"2549658a-ea39-42ed-bc88-49038df9d7f4","to":"test-kdJuBTVmI3H92NCwsGUMC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w57_v3, public

{"level":50,"time":1768676114577,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["a2ac8208-0807-459c-aeeb-f88dcb0ae02c","38041c9d7af61746e1058d09a876d4ddca6a54d32636a31c98a34136353a8d1d","2026-02-16T18:55:14.437Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:55:14.438Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a2ac8208-0807-459c-aeeb-f88dcb0ae02c) is not present in table \"users\".","schema":"test_schema_w47_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w51_v3, public

stderr | tests/integration/api.dataSources.native.test.ts > Data Sources API - Native Catalog
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

{"level":30,"time":1768676114596,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w57_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/datavault/TemplateCard.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676114596,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w51_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.snapshots.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [31mÎ“Â¥Â»[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 16155[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should list databases and databases' tables in the catalog
     [2m[90mÎ“Ã¥Ã´[39m[22m should create a native_table data source
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676115191,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676115243,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w58_v3, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w58_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/collab.client.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w61_v3

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w60_v3

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61_v3,public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w61_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61_v3%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60_v3,public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w60_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60_v3%2Cpublic

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w59_v3

{"level":30,"time":1768676116086,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676116112,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676116097,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676116098,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676116103,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676116104,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676116111,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676116111,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676116112,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676116112,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59_v3,public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w59_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59_v3%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676116610,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676116654,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676116680,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676116713,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676116868,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676116904,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768676116948,"env":"test","workflowId":"b9e6b275-13de-44e3-a80c-42812da5a5ba","msg":"No current or pinned version found for workflow, run might be unstable"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w61_v3, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w60_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w61_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w60_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/metrics.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w59_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w59_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676117535,"env":"test","module":"runs-routes","runId":"93730987-9104-442a-bde0-1d36a77885e5","sectionId":"b313d147-5d3f-478d-9556-53cdf2f02c65","valuesType":"object","isArray":true,"valuesLength":0,"bodyKeys":["values"],"msg":"Section submit request received"}
{"level":40,"time":1768676117965,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676118754,"env":"test","module":"runs-routes","runId":"93730987-9104-442a-bde0-1d36a77885e5","sectionId":"b313d147-5d3f-478d-9556-53cdf2f02c65","msg":"Section submitted successfully"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":30,"time":1768676118816,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676118817,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [31mÎ“Â¥Â»[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 17284[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should execute a JS block that uses helper functions[39m[33m 2146[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676121005,"env":"test","module":"version-service","workflowId":"9c179d3d-d34c-4c78-8a9e-816e380ed8ef","versionId":"8b1e6011-49f9-4948-9d76-e38a594b2e9b","userId":"6f8a6c7c-b3cc-4e77-aca4-258d394768cd","versionNumber":1,"msg":"Published new version"}
{"level":30,"time":1768676121200,"env":"test","module":"version-service","workflowId":"9c179d3d-d34c-4c78-8a9e-816e380ed8ef","versionId":"d01f233a-88b0-4c48-94e8-61800d3f5ff7","userId":"6f8a6c7c-b3cc-4e77-aca4-258d394768cd","versionNumber":2,"msg":"Published new version"}
{"level":30,"time":1768676121685,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676121685,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 16437[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should create a version and populate changelog [33m 529[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w63_v3

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63_v3,public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w63_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63_v3%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768676122889,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676123276,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676123310,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w63_v3, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w63_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w62_v3

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62_v3,public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w62_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62_v3%2Cpublic

{"level":30,"time":1768676125059,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676125110,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w62_v3, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w62_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.ai.personalization.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":50,"time":1768676226672,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":50,"time":1768676227617,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676228218,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676228218,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 122322[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[32m 230[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should include optional scope in authorization URL[32m 97[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should validate valid OAuth2 state token[32m 95[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject invalid OAuth2 state token[32m 96[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject expired OAuth2 state token[32m 92[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should clean up OAuth2 state after use[32m 90[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle callback with missing state parameter[32m 95[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle callback with missing code parameter[32m 94[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle OAuth2 provider error responses[32m 91[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should track OAuth2 connection status[39m[32m 184[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should store OAuth2 state in connection metadata[32m 90[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should use cryptographically secure random state[32m 90[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should prevent state reuse after validation[32m 87[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should include PKCE support metadata in state record[32m 92[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should validate redirect URI matches allowed URIs[32m 102[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should encode redirect URI in authorization URL[32m 87[2mms[22m[39m
stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > useExpressionValidation > should validate expression after debounce
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > useExpressionValidation > should return validation errors for invalid expression
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > useExpressionValidation > should debounce validation calls
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > useExpressionValidation > should not validate when workflowId or nodeId is missing
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > useExpressionValidation > should not validate when workflowId or nodeId is missing
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > Expression validation integration > should validate helper functions in expressions
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > Expression validation integration > should validate complex expressions with multiple helpers
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > Expression validation integration > should handle syntax errors
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > Expression Editor component behavior > should update validation when expression changes
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

stderr | tests/ui/expression-editor.test.tsx > Expression Editor Hooks > Expression Editor component behavior > should update validation when expression changes
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768676229938,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676229938,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 123012[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update validation when expression changes [33m 309[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w64_v3

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64_v3,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w64_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64_v3%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w65_v3

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65_v3,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676230860,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676230890,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w65_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65_v3%2Cpublic

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676231190,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676231191,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":30,"time":1768676231213,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676231213,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w64_v3, public

 [32mÎ“Â£Ã´[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 122118[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 122288[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w64_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/common/Breadcrumbs.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676231509,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676231546,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w65_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/shared/conditionEvaluator.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w66_v3

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w67_v3

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66_v3,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67_v3,public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w66_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66_v3%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w67_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67_v3%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676232827,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676232836,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676232869,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676232871,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w67_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w66_v3, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w67_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w66_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/utils/conditionalLogic-simple.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676233545,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676233545,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 123677[2mms[22m[39m
{"level":30,"time":1768676233613,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676233614,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 122789[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w68_v3

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68_v3,public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w69_v3

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w68_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68_v3%2Cpublic

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69_v3,public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w69_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69_v3%2Cpublic

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768676234743,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676234743,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 128224[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676235017,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676235046,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w56_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676235136,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676235167,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w68_v3, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w68_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/conditions/conditionEvaluation.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w70_v3

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w69_v3, public

{"level":30,"time":1768676235599,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676235599,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w69_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/session.management.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

 [32mÎ“Â£Ã´[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 123343[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70_v3,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w70_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70_v3%2Cpublic

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768676235969,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676235991,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676235978,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676235978,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676235985,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676235985,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676235991,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676235991,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676235991,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676235991,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676236233,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676236266,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w70_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w70_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.ai.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w71_v3

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71_v3,public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w71_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71_v3%2Cpublic

{"level":30,"time":1768676237062,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676237093,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676237276,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676237276,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 123784[2mms[22m[39m
{"level":30,"time":1768676237355,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676237355,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w71_v3, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w71_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/analytics_preservation.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

 [31mÎ“Â¥Â»[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 123852[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should maintain immutability of runs across versions[39m[33m 369[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w73_v3

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73_v3,public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w73_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73_v3%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676238869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676238870,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 123436[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676238953,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676238953,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768676238955,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676238984,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676238998,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676239030,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676239027,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768676239027,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768676239028,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768676239032,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768676239039,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676239040,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676239040,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 123621[2mms[22m[39m
stderr | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx > TableGridView - Drag & Drop > renders DndContext wrapper
Warning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676239307,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676239308,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 117215[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w73_v3, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w73_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/mfa.flow.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w72_v3

{"level":30,"time":1768676239590,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676239590,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

{"level":30,"time":1768676239645,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [32mÎ“Â£Ã´[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 123985[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676239658,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676239659,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676239667,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676239667,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72_v3,public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w72_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72_v3%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w74_v3

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74_v3,public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w74_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74_v3%2Cpublic

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w75_v3

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75_v3,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w76_v3

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w75_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75_v3%2Cpublic

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76_v3,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w76_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76_v3%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":30,"time":1768676240285,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676240285,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676240286,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676240325,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w77_v3

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676240451,"env":"test","msg":"DB: initializing... Local"}
 [32mÎ“Â£Ã´[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 115833[2mms[22m[39m
{"level":30,"time":1768676240499,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77_v3,public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w77_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77_v3%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w72_v3, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676240692,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w72_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/components/datavault/CellRenderer.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676240731,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676240789,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676240821,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w74_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w74_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ui/builder.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676241079,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676241114,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w75_v3, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w75_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/intake.portal.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w76_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w76_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/utils/conditionalLogic.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w78_v3

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78_v3,public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w78_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78_v3%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w77_v3, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w77_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/WorkflowPatchService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676241962,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676241990,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w78_v3, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w78_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/repeater.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676246060,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676246060,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 16374[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w79_v3

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79_v3,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w79_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79_v3%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stderr | tests/unit/shared/conditionEvaluator.test.ts > conditionEvaluator > Comparison operators > Unknown operator > should default to true and log warning
Unknown operator: unknown_operator

{"level":30,"time":1768676247082,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676247082,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 16794[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676247456,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676247482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w80_v3

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80_v3,public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w80_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80_v3%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w79_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/utils/encryption.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w65_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676248333,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676248359,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676248648,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676248649,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 17040[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w80_v3, public

{"level":50,"time":1768676248685,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768676248686,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248687,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768676248688,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248688,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768676248688,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248689,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w80_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/captcha.service.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768676248795,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768676248795,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248796,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768676248796,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248797,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768676248797,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248797,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768676248797,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248798,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768676248798,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248798,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768676248799,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768676248799,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676248800,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 17132[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w81_v3

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81_v3,public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w81_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81_v3%2Cpublic

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w82_v3

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82_v3,public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w82_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82_v3%2Cpublic

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676249909,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676249939,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676250114,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676250146,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w81_v3, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w81_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/utils/pagination.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w82_v3, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w82_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/middleware/auth.middleware.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...


[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676250747,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676250748,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676250753,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676250754,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 16770[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 16794[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w83_v3

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w84_v3

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83_v3,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w71_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w83_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83_v3%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84_v3,public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w84_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84_v3%2Cpublic

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768676251954,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676251954,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 16843[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w70_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676252368,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676252421,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676252531,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676252573,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w83_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w83_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/WorkflowChangeAnalyzer.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w84_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/listPipeline.semantics.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676253348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676253348,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 16923[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should preserve lifetime user count when a user is deleted [33m 675[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w86_v3

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w71_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w85_v3

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86_v3,public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w86_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86_v3%2Cpublic

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85_v3,public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w85_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85_v3%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768676254539,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676254539,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 16673[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676254668,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676254708,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676254849,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768676254881,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w86_v3, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w86_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/RunExecutionCoordinator.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w85_v3, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w85_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/components/datavault/SortableColumnHeader.test.tsx
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w87_v3

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87_v3,public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w87_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87_v3%2Cpublic

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676255980,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676256008,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w87_v3, public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w87_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/HelperLibrary.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676539076,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

{"level":30,"time":1768676539308,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

stderr | tests/unit/components/datavault/CellRenderer.test.tsx
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w72_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w72_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w72_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w72_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w72_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w72_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w72_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w72_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w72_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w72_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 

stderr | tests/unit/components/datavault/CellRenderer.test.tsx
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w72_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:289:11 {
  query: 'ALTER TABLE "test_schema_w72_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

stderr | tests/unit/components/datavault/CellRenderer.test.tsx
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

stderr | tests/ui/builder.test.ts
Î“Â¥Ã® FAILED MIGRATION 0003_fix_ai_settings.sql: Failed query: SET search_path TO "test_schema_w74_v3", public;

ALTER TABLE "ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar;

DO $$ BEGIN
 ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "users"("id") ON DELETE set null ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w74_v3", public;

ALTER TABLE "ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar;

DO $$ BEGIN
 ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "users"("id") ON DELETE set null ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w74_v3", public;\n' +
    '\n' +
    'ALTER TABLE "ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "users"("id") ON DELETE set null ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w74_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 

stderr | tests/ui/builder.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w74_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:289:11 {
  query: 'ALTER TABLE "test_schema_w74_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

stderr | tests/ui/builder.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

{"level":30,"time":1768676539361,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

 [31mÎ“Â¥Â»[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m | [22m[33m12 skipped[39m[2m)[22m[33m 300293[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m renders text value in display mode
     [2m[90mÎ“Ã¥Ã´[39m[22m renders number value correctly
     [2m[90mÎ“Ã¥Ã´[39m[22m renders boolean value as Yes/No
     [2m[90mÎ“Ã¥Ã´[39m[22m renders date value formatted
     [2m[90mÎ“Ã¥Ã´[39m[22m shows text input in edit mode for text columns
     [2m[90mÎ“Ã¥Ã´[39m[22m shows number input in edit mode for number columns
     [2m[90mÎ“Ã¥Ã´[39m[22m shows checkbox in edit mode for boolean columns
     [2m[90mÎ“Ã¥Ã´[39m[22m calls onCommit when Enter is pressed
     [2m[90mÎ“Ã¥Ã´[39m[22m calls onCancel when Escape is pressed
     [2m[90mÎ“Ã¥Ã´[39m[22m handles empty values
     [2m[90mÎ“Ã¥Ã´[39m[22m handles null values
     [2m[90mÎ“Ã¥Ã´[39m[22m shows "Unsupported type" for unknown column types
{"level":30,"time":1768676539401,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 300101[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should add a question node
     [2m[90mÎ“Ã¥Ã´[39m[22m should add a compute node
     [2m[90mÎ“Ã¥Ã´[39m[22m should export graph in correct format
     [2m[90mÎ“Ã¥Ã´[39m[22m should load graph from API format
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

{"level":30,"time":1768676539494,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

{"level":30,"time":1768676539671,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w76_v3"."audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid
params: 

stderr | tests/unit/utils/conditionalLogic.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w76_v3"."audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:296:11 {
  query: 'ALTER TABLE "test_schema_w76_v3"."audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

stderr | tests/unit/utils/conditionalLogic.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

{"level":30,"time":1768676540014,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m | [22m[33m29 skipped[39m[2m)[22m[33m 300349[2mms[22m[39m
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for exact string match
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for non-matching string
         [2m[90mÎ“Ã¥Ã´[39m[22m should handle numeric equality
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for different values
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for same values
         [2m[90mÎ“Ã¥Ã´[39m[22m should find substring in string
         [2m[90mÎ“Ã¥Ã´[39m[22m should find item in array
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false when not found
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for greater number
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for equal or smaller number
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for smaller number
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for equal or larger number
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for value in range
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for value at boundaries (inclusive)
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for value outside range
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for null
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for undefined
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for empty string
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for non-empty values
         [2m[90mÎ“Ã¥Ã´[39m[22m should return true for non-empty string
         [2m[90mÎ“Ã¥Ã´[39m[22m should return false for null/undefined/empty
       [2m[90mÎ“Ã¥Ã´[39m[22m should show question by default with no conditions
       [2m[90mÎ“Ã¥Ã´[39m[22m should apply show action when condition is met
       [2m[90mÎ“Ã¥Ã´[39m[22m should hide question when show condition is not met
       [2m[90mÎ“Ã¥Ã´[39m[22m should apply hide action when condition is met
       [2m[90mÎ“Ã¥Ã´[39m[22m should make question required when require action is met
       [2m[90mÎ“Ã¥Ã´[39m[22m should make question optional when make_optional action is met
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle multiple conditions with AND logic
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle multiple conditions with OR logic
{"level":30,"time":1768676540080,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w88_v3

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w89_v3

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88_v3,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89_v3,public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w88_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88_v3%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w89_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89_v3%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

stderr | tests/integration/intake.portal.test.ts
Î“Â¥Ã® FAILED MIGRATION 0001_fix_collection_schema.sql: Failed query: SET search_path TO "test_schema_w75_v3", public;

-- Fix collection schema to match expected structure

-- Add collection_field_type enum
CREATE TYPE "test_schema_w75_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');

-- Rename required column to is_required in collection_fields
ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";

-- Update type column to use enum instead of varchar
ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;
ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w75_v3"."collection_field_type" USING "type"::"test_schema_w75_v3"."collection_field_type";

-- Add default_value column to collection_fields
ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;

-- Add missing indexes
CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");
CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w75_v3", public;

-- Fix collection schema to match expected structure

-- Add collection_field_type enum
CREATE TYPE "test_schema_w75_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');

-- Rename required column to is_required in collection_fields
ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";

-- Update type column to use enum instead of varchar
ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;
ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w75_v3"."collection_field_type" USING "type"::"test_schema_w75_v3"."collection_field_type";

-- Add default_value column to collection_fields
ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;

-- Add missing indexes
CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");
CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w75_v3", public;\n' +
    '\n' +
    '-- Fix collection schema to match expected structure\r\n' +
    '\r\n' +
    '-- Add collection_field_type enum\r\n' +
    `CREATE TYPE "test_schema_w75_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');\r\n` +
    '\r\n' +
    '-- Rename required column to is_required in collection_fields\r\n' +
    'ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";\r\n' +
    '\r\n' +
    '-- Update type column to use enum instead of varchar\r\n' +
    'ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;\r\n' +
    'ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w75_v3"."collection_field_type" USING "type"::"test_schema_w75_v3"."collection_field_type";\r\n' +
    '\r\n' +
    '-- Add default_value column to collection_fields\r\n' +
    'ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;\r\n' +
    '\r\n' +
    '-- Add missing indexes\r\n' +
    'CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");\r\n' +
    'CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");\r\n',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w75_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 

stderr | tests/integration/intake.portal.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w75_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:289:11 {
  query: 'ALTER TABLE "test_schema_w75_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

stderr | tests/integration/intake.portal.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

stderr | tests/unit/services/WorkflowPatchService.test.ts
Î“Â¥Ã® FAILED MIGRATION 0001_fix_collection_schema.sql: Failed query: SET search_path TO "test_schema_w77_v3", public;

-- Fix collection schema to match expected structure

-- Add collection_field_type enum
CREATE TYPE "test_schema_w77_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');

-- Rename required column to is_required in collection_fields
ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";

-- Update type column to use enum instead of varchar
ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;
ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w77_v3"."collection_field_type" USING "type"::"test_schema_w77_v3"."collection_field_type";

-- Add default_value column to collection_fields
ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;

-- Add missing indexes
CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");
CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w77_v3", public;

-- Fix collection schema to match expected structure

-- Add collection_field_type enum
CREATE TYPE "test_schema_w77_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');

-- Rename required column to is_required in collection_fields
ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";

-- Update type column to use enum instead of varchar
ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;
ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w77_v3"."collection_field_type" USING "type"::"test_schema_w77_v3"."collection_field_type";

-- Add default_value column to collection_fields
ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;

-- Add missing indexes
CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");
CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w77_v3", public;\n' +
    '\n' +
    '-- Fix collection schema to match expected structure\r\n' +
    '\r\n' +
    '-- Add collection_field_type enum\r\n' +
    `CREATE TYPE "test_schema_w77_v3"."collection_field_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'file', 'select', 'multi_select', 'json');\r\n` +
    '\r\n' +
    '-- Rename required column to is_required in collection_fields\r\n' +
    'ALTER TABLE "collection_fields" RENAME COLUMN "required" TO "is_required";\r\n' +
    '\r\n' +
    '-- Update type column to use enum instead of varchar\r\n' +
    'ALTER TABLE "collection_fields" ALTER COLUMN "type" DROP DEFAULT;\r\n' +
    'ALTER TABLE "collection_fields" ALTER COLUMN "type" TYPE "test_schema_w77_v3"."collection_field_type" USING "type"::"test_schema_w77_v3"."collection_field_type";\r\n' +
    '\r\n' +
    '-- Add default_value column to collection_fields\r\n' +
    'ALTER TABLE "collection_fields" ADD COLUMN IF NOT EXISTS "default_value" jsonb;\r\n' +
    '\r\n' +
    '-- Add missing indexes\r\n' +
    'CREATE INDEX IF NOT EXISTS "collection_fields_slug_idx" ON "collection_fields" USING btree ("slug");\r\n' +
    'CREATE INDEX IF NOT EXISTS "collection_fields_type_idx" ON "collection_fields" USING btree ("type");\r\n',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w77_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 

stderr | tests/unit/services/WorkflowPatchService.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w77_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:289:11 {
  query: 'ALTER TABLE "test_schema_w77_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

stderr | tests/unit/services/WorkflowPatchService.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

{"level":30,"time":1768676540754,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676540776,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 301267[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should prefill allowed fields from URL parameters
       [2m[90mÎ“Ã¥Ã´[39m[22m should ignore disallowed prefill keys
       [2m[90mÎ“Ã¥Ã´[39m[22m should not prefill when allowPrefill is false
       [2m[90mÎ“Ã¥Ã´[39m[22m should not prefill file upload or sensitive fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should generate CAPTCHA challenge
       [2m[90mÎ“Ã¥Ã´[39m[22m should require CAPTCHA when workflow config requires it
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate correct CAPTCHA and allow submission
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject incorrect CAPTCHA answer
       [2m[90mÎ“Ã¥Ã´[39m[22m should not require CAPTCHA when workflow config disables it
       [2m[90mÎ“Ã¥Ã´[39m[22m should send email receipt when configured
       [2m[90mÎ“Ã¥Ã´[39m[22m should not send email when sendEmailReceipt is false
       [2m[90mÎ“Ã¥Ã´[39m[22m should skip email when receiptEmailVar is not found
       [2m[90mÎ“Ã¥Ã´[39m[22m should exclude sensitive fields from email summary
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to update intakeConfig
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow builder to update intakeConfig
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject viewer from updating intakeConfig
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate intakeConfig schema
       [2m[90mÎ“Ã¥Ã´[39m[22m should include intakeConfig in response
 [31mÎ“Â¥Â»[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[33m21 skipped[39m[2m)[22m[33m 300709[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should resolve section tempId to real UUID when creating step
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle multi-level tempId references
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject duplicate step alias on create
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow same alias on update of same step
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject duplicate alias on update to different step
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject completely unknown operation
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject malformed operation (missing required fields)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations (dropTable)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations (dropColumn)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations (deleteRows)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations (updateRowData)
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow safe DataVault operations (createTable, addColumns)
       [2m[90mÎ“Ã¥Ã´[39m[22m should rollback all ops if any op fails
       [2m[90mÎ“Ã¥Ã´[39m[22m should clear tempId mappings between batch calls
       [2m[90mÎ“Ã¥Ã´[39m[22m should create visibility rule on step
       [2m[90mÎ“Ã¥Ã´[39m[22m should parse complex condition expressions
       [2m[90mÎ“Ã¥Ã´[39m[22m should attach document to workflow (document.add)
       [2m[90mÎ“Ã¥Ã´[39m[22m should bind document fields to workflow variables (document.bindFields)
       [2m[90mÎ“Ã¥Ã´[39m[22m should reject binding to non-existent step alias
       [2m[90mÎ“Ã¥Ã´[39m[22m should create DataVault table with columns (datavault.createTable)
       [2m[90mÎ“Ã¥Ã´[39m[22m should create writeback mapping (datavault.createWritebackMapping)
{"level":30,"time":1768676540895,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

stderr | tests/unit/services/repeater.test.ts
Î“Â¥Ã® FAILED MIGRATION 0002_fix_audit_logs.sql: Failed query: SET search_path TO "test_schema_w78_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w78_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w78_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w78_v3", public;


DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;
EXCEPTION
 WHEN duplicate_column THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w78_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
 ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";
 ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w78_v3"."users"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;

CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");
CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");
CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");

params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w78_v3", public;\n' +
    '\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "tenant_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "workspace_id" uuid;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" ADD COLUMN IF NOT EXISTS "user_id" varchar;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_column THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_tenant_id_tenants_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w78_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'DO $$ BEGIN\r\n' +
    ' ALTER TABLE "audit_logs" DROP CONSTRAINT IF EXISTS "audit_logs_user_id_users_id_fk";\r\n' +
    ' ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w78_v3"."users"("id") ON DELETE no action ON UPDATE no action;\r\n' +
    'EXCEPTION\r\n' +
    ' WHEN duplicate_object THEN null;\r\n' +
    'END $$;\r\n' +
    '\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_tenant_idx" ON "audit_logs" ("tenant_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_user_idx" ON "audit_logs" ("user_id");\r\n' +
    'CREATE INDEX IF NOT EXISTS "audit_logs_action_idx" ON "audit_logs" ("action");\r\n',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: Failed query: ALTER TABLE "test_schema_w78_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 

stderr | tests/unit/services/repeater.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Failed to apply manual failsafe fixes: DrizzleQueryError: Failed query: ALTER TABLE "test_schema_w78_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:289:11 {
  query: 'ALTER TABLE "test_schema_w78_v3"."ai_settings" ADD COLUMN IF NOT EXISTS "updated_by" varchar',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

stderr | tests/unit/services/repeater.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature
    FROM pg_proc
    WHERE proname = 'datavault_get_next_autonumber';
  
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:394:25)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '    SELECT proname, proargnames, proargtypes, oid::regprocedure as signature\n' +
    '    FROM pg_proc\n' +
    "    WHERE proname = 'datavault_get_next_autonumber';\n" +
    '  ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w90_v3

{"level":30,"time":1768676540955,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 300070[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate min instances constraint
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate max instances constraint
       [2m[90mÎ“Ã¥Ã´[39m[22m should validate required fields in instances
       [2m[90mÎ“Ã¥Ã´[39m[22m should pass validation for valid repeater
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle null value as empty instances
       [2m[90mÎ“Ã¥Ã´[39m[22m should create empty repeater with min instances
       [2m[90mÎ“Ã¥Ã´[39m[22m should add instance to repeater
       [2m[90mÎ“Ã¥Ã´[39m[22m should not add instance if max reached
       [2m[90mÎ“Ã¥Ã´[39m[22m should remove instance from repeater
       [2m[90mÎ“Ã¥Ã´[39m[22m should not remove instance if min would be violated
       [2m[90mÎ“Ã¥Ã´[39m[22m should reorder instances
       [2m[90mÎ“Ã¥Ã´[39m[22m should flatten repeater data for variable resolution
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle empty instances
       [2m[90mÎ“Ã¥Ã´[39m[22m should generate instance title from template
       [2m[90mÎ“Ã¥Ã´[39m[22m should use default template if not provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should return empty string if showInstanceTitle is false
       [2m[90mÎ“Ã¥Ã´[39m[22m should skip validation for hidden fields
       [2m[90mÎ“Ã¥Ã´[39m[22m should require visible fields based on condition
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676541017,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676541035,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90_v3,public

{"level":30,"time":1768676541081,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w90_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90_v3%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768676541119,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w88_v3, public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w89_v3, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w88_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/shared/validation/PageValidator.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w89_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/utils/variableResolver.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676541730,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w91_v3

{"level":30,"time":1768676541757,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91_v3,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w92_v3

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w91_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91_v3%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w93_v3

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92_v3,public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93_v3,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w92_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92_v3%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w93_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93_v3%2Cpublic

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w90_v3, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w90_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/shared/validation/stepConfigSchemas.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...


[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676542497,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676542529,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676542623,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676542626,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676542654,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676542664,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w91_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/workflows/validation.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w92_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/middleware/rbac.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w93_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/AIService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676546138,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546138,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768676546140,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768676546152,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546155,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546156,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546156,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546156,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546157,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768676546159,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768676546161,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546161,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768676546162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768676546164,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768676546164,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546165,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546168,"env":"test","msg":"DB: closing pool..."}
 [32mÎ“Â£Ã´[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 298705[2mms[22m[39m
{"level":30,"time":1768676546169,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 297002[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 299792[2mms[22m[39m
{"level":30,"time":1768676546223,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546224,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546248,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546249,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546267,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546267,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546302,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546303,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 292546[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 295035[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 291174[2mms[22m[39m
{"level":30,"time":1768676546323,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546323,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 297311[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 295129[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676546445,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676546445,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 292771[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w96_v3

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w97_v3

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w94_v3

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96_v3,public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w96_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96_v3%2Cpublic

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w95_v3

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97_v3,public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w100_v3

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w97_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97_v3%2Cpublic

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94_v3,public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w99_v3

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100_v3,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95_v3,public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w94_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94_v3%2Cpublic

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w100_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100_v3%2Cpublic

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99_v3,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w95_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95_v3%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w98_v3

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w99_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99_v3%2Cpublic

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w101_v3

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98_v3,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w98_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98_v3%2Cpublic

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101_v3,public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w101_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101_v3%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w102_v3

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548362,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676548410,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102_v3,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548453,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w102_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102_v3%2Cpublic

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548480,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768676548510,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548512,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676548533,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676548572,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548584,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548586,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676548641,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676548644,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548725,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676548766,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676548853,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w94_v3, public

{"level":30,"time":1768676548897,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w96_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/engine.expr.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w94_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/workflow/QueryBlock.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w97_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w99_v3, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w100_v3, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w97_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/WorkflowOptimizationService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w99_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/TemplateAnalysisService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w100_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/intakeQuestionVisibility.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w95_v3, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w98_v3, public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w95_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

stderr | tests/unit/engine/Performance.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676549126,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w98_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/isolatedVmBridge.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676549162,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w101_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/ScriptEngine.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w102_v3, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w102_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/docxRenderer2.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

{"level":30,"time":1768676560210,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676560211,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [32mÎ“Â£Ã´[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 20476[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676560865,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676560865,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

 [32mÎ“Â£Ã´[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 20408[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w103_v3

{"level":30,"time":1768676561040,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676561040,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 21281[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103_v3,public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w103_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103_v3%2Cpublic

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768676561285,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":40,"time":1768676561289,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768676561290,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768676561291,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768676561293,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768676561295,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768676561295,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768676561296,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768676561297,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768676561298,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768676561301,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768676561301,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768676561301,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768676561301,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676561302,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 19895[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w104_v3

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should parse valid JSON response correctly
[22m[39mTest Setup: Initializing AIService

stderr | tests/unit/services/AIService.test.ts > AIService Unit Tests > reviseWorkflow should parse valid JSON response correctly
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.
Test Setup Failed: TypeError: () => ({
      generateWorkflow: __vite_ssr_import_0__.vi.fn().mockResolvedValue({
        title: "Generated Fl...<omitted>...}) is not a constructor
    at new Mock (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/spy/dist/index.js:262:27)
    at new AIService (C:/Users/scoot/poll/VaultLogic/server/services/AIService.ts:68:30)
    at C:/Users/scoot/poll/VaultLogic/tests/unit/services/AIService.test.ts:97:25
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
{"level":30,"time":1768676561652,"env":"test","msg":"DB: closing pool..."}
    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)
    at runHook (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1514:51)
    at callSuiteHook (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1520:25)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676561653,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676561667,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676561668,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/unit/services/AIService.test.ts [2m([22m[2m10 tests[22m[2m | [22m[31m1 failed[39m[2m | [22m[33m9 skipped[39m[2m)[22m[33m 20129[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m reviseWorkflow should parse valid JSON response correctly[39m[32m 9[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m reviseWorkflow should handle JSON markdown code blocks
     [2m[90mÎ“Ã¥Ã´[39m[22m reviseWorkflow should throw on invalid JSON
       [2m[90mÎ“Ã¥Ã´[39m[22m generateWorkflow should return a generated workflow
       [2m[90mÎ“Ã¥Ã´[39m[22m suggestWorkflowImprovements should return suggestions
       [2m[90mÎ“Ã¥Ã´[39m[22m suggestTemplateBindings should return bindings
       [2m[90mÎ“Ã¥Ã´[39m[22m suggestValues should return values
       [2m[90mÎ“Ã¥Ã´[39m[22m generateLogic should return logic rules
       [2m[90mÎ“Ã¥Ã´[39m[22m debugLogic should return issues
       [2m[90mÎ“Ã¥Ã´[39m[22m visualizeLogic should return graph data
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

 [32mÎ“Â£Ã´[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 20300[2mms[22m[39m
{"level":30,"time":1768676561699,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104_v3,public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w104_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104_v3%2Cpublic

{"level":30,"time":1768676561757,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w105_v3

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105_v3,public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w105_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105_v3%2Cpublic

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w106_v3

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106_v3,public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w103_v3, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w106_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106_v3%2Cpublic

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w103_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/shared/workflowLogic.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676562341,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676562389,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w107_v3

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107_v3,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w107_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107_v3%2Cpublic

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676562632,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676562679,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w104_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/client/choice-utils.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676562921,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676562960,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w105_v3, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w105_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/intakeNavigation.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w108_v3

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676563237,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676563288,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w106_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108_v3,public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w106_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/workflows/conditionTruthTable.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w108_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108_v3%2Cpublic

{"level":30,"time":1768676563370,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676563400,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w107_v3, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w107_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/client/list-choice-options.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w108_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w108_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/services/BrandingService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676567981,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676567981,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676567984,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676567984,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768676567992,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768676567995,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676567995,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 20908[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":40,"time":1768676567995,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768676567997,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768676567999,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768676568002,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768676568009,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676568010,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 20836[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 20952[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 20646[2mms[22m[39m
{"level":30,"time":1768676568073,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676568073,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676568118,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676568118,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 20725[2mms[22m[39m
{"level":30,"time":1768676568125,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676568126,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676568127,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676568137,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676568138,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 20999[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 20639[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768676568204,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
{"level":30,"time":1768676568205,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676568206,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 20203[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 20964[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w110_v3

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w109_v3

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110_v3,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w110_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110_v3%2Cpublic

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w113_v3

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109_v3,public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w112_v3

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w109_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109_v3%2Cpublic

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113_v3,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w113_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113_v3%2Cpublic

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112_v3,public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w112_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112_v3%2Cpublic

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w111_v3

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111_v3,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w111_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111_v3%2Cpublic

{"level":30,"time":1768676569856,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676569865,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676569905,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768676569917,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w116_v3

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676569989,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676570032,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676570065,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116_v3,public

{"level":30,"time":1768676570107,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w116_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116_v3%2Cpublic

{"level":30,"time":1768676570161,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676570205,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w111_v3, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w111_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/services/EmailTemplateMetadataService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w115_v3

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w110_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/docxHelpers.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115_v3,public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w109_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w115_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115_v3%2Cpublic

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w112_v3, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w109_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/shared/validation/Validator.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w113_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/BlockRunner.validate.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w112_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/docxRenderer.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w116_v3, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w116_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/ListTools.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676571210,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676571263,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w115_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w115_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/ai.service.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w117_v3

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117_v3,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w117_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117_v3%2Cpublic

{"level":30,"time":1768676572485,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676572533,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w117_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault.row-notes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676573157,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w114_v3

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114_v3,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w114_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114_v3%2Cpublic

{"level":30,"time":1768676575314,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676575344,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w114_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w114_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api.ai.doc.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w96_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stderr | tests/unit/shared/workflowLogic.test.ts > workflowLogic > evaluateRules > Operators > Unknown operator > should return false and log warning for unknown operator
Unknown operator: unknown_operator

{"level":30,"time":1768676593355,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676593356,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 32812[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w118_v3

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118_v3,public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w118_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118_v3%2Cpublic

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676594831,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676594861,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w118_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/schema/documentEngine.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stderr | tests/unit/client/choice-utils.test.ts > choice-utils > handles missing content gracefully
[generateOptionsFromList] Invalid list data: null

{"level":30,"time":1768676596789,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676596789,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 35582[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w119_v3

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119_v3,public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w119_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119_v3%2Cpublic

{"level":30,"time":1768676598180,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676598219,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w119_v3, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w119_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/repositories/DocumentTemplateRepository.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768676605138,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768676605138,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768676605139,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676605140,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 43654[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w120_v3

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120_v3,public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w120_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120_v3%2Cpublic

{"level":30,"time":1768676607863,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676607888,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w120_v3, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w120_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/datavault.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676608639,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676608639,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 46927[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w121_v3

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121_v3,public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w121_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121_v3%2Cpublic

{"level":30,"time":1768676610092,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676610123,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w121_v3, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w121_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/DocumentTemplateService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676614623,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676614623,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 52567[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w122_v3

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122_v3,public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w122_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122_v3%2Cpublic

{"level":30,"time":1768676616760,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676616792,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w122_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w122_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/debugging/Lineage.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676618972,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676618972,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 56240[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w123_v3

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123_v3,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w123_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123_v3%2Cpublic

{"level":30,"time":1768676621199,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676621227,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w123_v3, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w123_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/engine.run-conditions.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w108_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676743213,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676743213,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 173899[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w124_v3

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124_v3,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w124_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124_v3%2Cpublic

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676744709,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676744750,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w111_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w124_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w124_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/schema/collections.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":30,"time":1768676745341,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676745341,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 176737[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676746610,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676746610,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 178004[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w125_v3

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125_v3,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w125_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125_v3%2Cpublic

{"level":30,"time":1768676746956,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

{"level":30,"time":1768676747004,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w125_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w125_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/CollectionService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 179565[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w126_v3

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126_v3,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w126_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126_v3%2Cpublic

{"level":30,"time":1768676748469,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676748504,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w113_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w113_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w126_v3, public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w126_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/branding.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":40,"time":1768676749623,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768676749635,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676749636,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 180883[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w127_v3

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127_v3,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w127_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127_v3%2Cpublic

{"level":30,"time":1768676751037,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768676751087,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w128_v3

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128_v3,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w128_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128_v3%2Cpublic

{"level":30,"time":1768676751329,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676751366,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w127_v3, public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w127_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/workflow/PreviewExecution.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w128_v3, public

{"level":40,"time":1768676751797,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676751798,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676751798,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 182273[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w128_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/lib/queries/QueryRunner.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w129_v3

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129_v3,public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w129_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129_v3%2Cpublic

{"level":30,"time":1768676754176,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676754218,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w129_v3, public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w129_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/api.ai.logic.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w116_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676764422,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676764422,"env":"test","module":"workflow-generation-service","duration":3,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768676764426,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768676764430,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768676764432,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768676764433,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768676764434,"env":"test","module":"workflow-generation-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768676764436,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768676764436,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768676764437,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768676764437,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768676764438,"env":"test","module":"workflow-suggestion-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768676764439,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676764439,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 194585[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w130_v3

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130_v3,public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w130_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130_v3%2Cpublic

{"level":30,"time":1768676766015,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676766047,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w130_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w130_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/RecordService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w115_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w115_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676787653,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676787653,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 215808[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w131_v3

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131_v3,public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w131_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131_v3%2Cpublic

{"level":30,"time":1768676789347,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676789373,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w131_v3, public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w131_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/debug_import.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w117_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w114_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w119_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w119_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676817636,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676817636,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 220072[2mms[22m[39m
{"level":30,"time":1768676817661,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676817662,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 223485[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768676818233,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676818234,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676818241,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676818242,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

 [32mÎ“Â£Ã´[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 208772[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

 [32mÎ“Â£Ã´[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 210987[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w133_v3

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w132_v3

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133_v3,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132_v3,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w133_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133_v3%2Cpublic

{"level":30,"time":1768676819209,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w132_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132_v3%2Cpublic

{"level":30,"time":1768676819231,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768676819245,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676819268,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should skip question when condition is false
[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should execute question when condition is true
[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should execute question when condition is true
[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should skip compute node when condition is false
[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should execute compute node when condition is true
[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should handle complex workflow with multiple conditions
[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Conditional Execution > should handle complex workflow with multiple conditions
[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Debug Mode > should return trace when debug is enabled
[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

stderr | tests/unit/engine.run-conditions.test.ts > Engine - Conditional Execution > Debug Mode > should not return trace when debug is disabled
[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768676819526,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676819526,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w133_v3, public

 [32mÎ“Â£Ã´[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 198939[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w133_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/DatavaultColumnsService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w132_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w134_v3

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w120_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/StepService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w135_v3

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134_v3,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135_v3,public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w134_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134_v3%2Cpublic

{"level":30,"time":1768676819889,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w135_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135_v3%2Cpublic

{"level":30,"time":1768676819894,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676819931,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768676819934,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w134_v3, public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w135_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w135_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/repositories/DatavaultColumnsRepository.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w135_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/DatavaultTablesService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w136_v3

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136_v3,public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w136_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136_v3%2Cpublic

{"level":30,"time":1768676821069,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676821100,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w136_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w136_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/repositories/DatavaultTablesRepository.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w123_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stderr | tests/unit/debugging/Lineage.test.ts > Debug & Lineage > should generate execution trace with lineage
[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

{"level":30,"time":1768676823751,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676823751,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 207498[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w137_v3

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137_v3,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w137_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137_v3%2Cpublic

{"level":30,"time":1768676825061,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676825087,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w126_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/DataSourceService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w127_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w129_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676826630,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676826631,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 82578[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768676826930,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676826930,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w130_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mÎ“Â£Ã´[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 80475[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768676827312,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676827314,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676827314,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676827342,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
{"level":30,"time":1768676827342,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":1,"changeCount":0,"msg":"AI logic generation succeeded"}
{"level":30,"time":1768676827352,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676827361,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676827362,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676827362,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768676827370,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676827371,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 76778[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 79395[2mms[22m[39m
{"level":30,"time":1768676827431,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676827432,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 73834[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676827474,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768676827475,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 76628[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mÎ“Â£Ã´[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 62067[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w138_v3

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138_v3,public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w138_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138_v3%2Cpublic

{"level":30,"time":1768676828240,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676828277,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w141_v3

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w144_v3

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141_v3,public

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w141_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141_v3%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144_v3,public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w138_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/services/CollectionFieldService.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...


[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w144_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144_v3%2Cpublic

stderr | tests/unit/writes/WriteRunner.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17)
    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:173:34
    at processTicksAndRejections (node:internal/process/task_queues:103:5) {
  codeFrame: 'vi.mock(import("../../../server/db"), async (importOriginal) => {\n' +
    '  const actual = await importOriginal()\n' +
    '  return {\n' +
    '    ...actual,\n' +
    '    // your mocked methods\n' +
    '  }\n' +
    '})'
}

{"level":30,"time":1768676828685,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768676828691,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676828691,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768676828692,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768676828693,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768676828694,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32mÎ“Â£Ã´[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 623[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w139_v3

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139_v3,public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w140_v3

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w142_v3

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w139_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139_v3%2Cpublic

{"level":30,"time":1768676828922,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768676828951,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140_v3,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w131_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w140_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140_v3%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142_v3,public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w142_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142_v3%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w143_v3

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 683[2mms[22m[39m
{"level":30,"time":1768676829197,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143_v3,public

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1233[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return workflow if user is the creator [33m 588[2mms[22m[39m
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w143_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143_v3%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768676829259,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768676829264,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768676829266,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768676829272,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768676829274,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w139_v3, public

{"level":30,"time":1768676829295,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676829296,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 532[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w139_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/unit/api.ai.revise.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

 [32mÎ“Â£Ã´[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 40453[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w145_v3

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1702[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145_v3,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w145_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145_v3%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 647[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w146_v3

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w147_v3

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146_v3,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w146_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146_v3%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w148_v3

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147_v3,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 563[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w147_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147_v3%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148_v3,public

 [32mÎ“Â£Ã´[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 539[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w148_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148_v3%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 535[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w149_v3

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w151_v3

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149_v3,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w149_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149_v3%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151_v3,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 656[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w151_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151_v3%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768676831397,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676831404,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32mÎ“Â£Ã´[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 532[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w150_v3

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150_v3,public

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w150_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150_v3%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 659[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w154_v3

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

 [2m[90mÎ“Ã¥Ã´[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768676835412,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768676836524,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768676836524,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768676836566,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768676836567,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768676836567,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768676836567,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768676836567,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
{"level":30,"time":1768676836607,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
{"level":30,"time":1768676836638,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768676836625,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768676836625,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768676836631,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768676836632,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676836635,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768676836635,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768676836638,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768676836638,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768676836638,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768676836638,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768676836639,"env":"test","msg":"Loading Vite for development..."}
{"level":30,"time":1768676841372,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Âª vite.ts module loaded successfully"}
{"level":30,"time":1768676841372,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768676841372,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Starting Vite setup..."}
{"level":30,"time":1768676841372,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Resolving Vite config..."}
{"level":30,"time":1768676841375,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Vite config resolved"}
{"level":30,"time":1768676841375,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Server options prepared, creating Vite server..."}
{"level":30,"time":1768676841412,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Vite server created successfully"}
{"level":30,"time":1768676841412,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768676841412,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Vite middlewares mounted"}
{"level":30,"time":1768676841412,"env":"test","source":"express","msg":"â‰¡Æ’Ã´Â¥ setupVite: Vite setup complete!"}
{"level":30,"time":1768676841412,"env":"test","msg":"Vite setup complete"}
{"level":50,"time":1768676841414,"env":"test","module":"collab-server","err":{"type":"Error","message":"listen EADDRINUSE: address already in use 0.0.0.0:5000","stack":"Error: listen EADDRINUSE: address already in use 0.0.0.0:5000\n    at Server.setupListenHandle [as _listen2] (node:net:1940:16)\n    at listenInCluster (node:net:1997:12)\n    at node:net:2206:7\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)","code":"EADDRINUSE","errno":-4091,"syscall":"listen","address":"0.0.0.0","port":5000},"msg":"WebSocket Server Error"}
{"level":50,"time":1768676842084,"env":"test","module":"email-queue","error":{},"msg":"Error in email queue processor"}
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w152_v3

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w153_v3

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w156_v3

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154_v3,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152_v3,public

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w156_v3,public

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153_v3,public

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w154_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154_v3%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w152_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152_v3%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w156_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w156_v3%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w153_v3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153_v3%2Cpublic

{"level":30,"time":1768676846428,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mÎ“Â£Ã´[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 14137[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 13909[2mms[22m[39m
 [32mÎ“Â£Ã´[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 13795[2mms[22m[39m
{"level":30,"time":1768676846474,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w156_v3, public

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w156_v3
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/api-docs.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768676874719,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

stderr | tests/integration/api.ai.doc.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: 
        CREATE OR REPLACE FUNCTION datavault_cleanup_sequence(p_column_id UUID)
        RETURNS VOID
        LANGUAGE plpgsql
        AS $$
        DECLARE
            r RECORD;
        BEGIN
            -- Cleanup based on hashing pattern used above is harder without keeping track.
            -- For tests, we might skip precise cleanup or try to match partially?
            -- Since we used MD5(tenant + column), we can't search by LIKE easily without tenant_id.
            -- But standard cleanup might just drop by specific logic or we ignore it for tests.
            -- Actually, to properly clean, we'd need tenant_id.
            -- For now, invalidation is sufficient.
            NULL;
        END;
        $$;
      
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:487:3)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: '\n' +
    '        CREATE OR REPLACE FUNCTION datavault_cleanup_sequence(p_column_id UUID)\n' +
    '        RETURNS VOID\n' +
    '        LANGUAGE plpgsql\n' +
    '        AS $$\n' +
    '        DECLARE\n' +
    '            r RECORD;\n' +
    '        BEGIN\n' +
    '            -- Cleanup based on hashing pattern used above is harder without keeping track.\n' +
    '            -- For tests, we might skip precise cleanup or try to match partially?\n' +
    "            -- Since we used MD5(tenant + column), we can't search by LIKE easily without tenant_id.\n" +
    '            -- But standard cleanup might just drop by specific logic or we ignore it for tests.\n' +
    "            -- Actually, to properly clean, we'd need tenant_id.\n" +
    '            -- For now, invalidation is sufficient.\n' +
    '            NULL;\n' +
    '        END;\n' +
    '        $$;\n' +
    '      ',
  params: [],
  cause: Error: Cannot use a pool after calling end on the pool
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
}

{"level":30,"time":1768676883333,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 308621[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should analyze a DOCX file and return variables
       [2m[90mÎ“Ã¥Ã´[39m[22m should fail if no file is provided
       [2m[90mÎ“Ã¥Ã´[39m[22m should suggest mappings between template and workflow variables
       [2m[90mÎ“Ã¥Ã´[39m[22m should return improvement suggestions
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w132_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w130_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w133_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w132_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w134_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

{"level":30,"time":1768676888217,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676888217,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 69638[2mms[22m[39m
{"level":30,"time":1768676888297,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676888298,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

 [32mÎ“Â£Ã´[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 69683[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-17T19:08:08.400Z"}
{"level":30,"time":1768676888402,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676888403,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 69133[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

{"level":30,"time":1768676888751,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676888751,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 69370[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w135_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w135_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-17T19:08:10.222Z"}
{"level":30,"time":1768676890225,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676890226,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 69805[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w136_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676913063,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676913063,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 88509[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676960180,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676960180,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 132568[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676968178,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768676968199,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768676968205,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768676968209,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768676968210,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676968211,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 139915[2mms[22m[39m
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m   Applying 0002_fix_audit_logs.sql...

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m   Applying 0003_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m   Applying 0004_restore_autonumber.sql...

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mÎ“Â£Ã  Applied 5 migration files.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mÎ“Â£Ã  Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768676994381,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768676994381,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 157811[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 29 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/analytics_service.test.ts > Analytics Service Integration
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default)
params: user-NaDt2nzG5cLtVjIo8QWLg,user-NaDt2nzG5cLtVjIo8QWLg@test.com,44e65e53-38a0-4c8b-8942-814fd1ca22ee,admin,owner
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/analytics_service.test.ts:38:9
     36|         tenantId = tenant.id;
     37|         userId = `user-${nanoid()}`;
     38|         await db.insert(users).values({ id: userId, email: `${userId}@Î“Ã‡Âª
       |         ^
     39|         const [p] = await db.insert(projects).values({ title: "P", namÎ“Ã‡Âª
     40| 

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/analytics_service.test.ts:38:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(44e65e53-38a0-4c8b-8942-814fd1ca22ee) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/322]Î“Ã„Â»

 FAIL  tests/integration/api.ai.doc.test.ts [ tests/integration/api.ai.doc.test.ts ]
 FAIL  tests/integration/intake.portal.test.ts [ tests/integration/intake.portal.test.ts ]
 FAIL  tests/ui/builder.test.ts [ tests/ui/builder.test.ts ]
 FAIL  tests/unit/services/repeater.test.ts [ tests/unit/services/repeater.test.ts ]
 FAIL  tests/unit/services/WorkflowPatchService.test.ts [ tests/unit/services/WorkflowPatchService.test.ts ]
 FAIL  tests/unit/utils/conditionalLogic.test.ts [ tests/unit/utils/conditionalLogic.test.ts ]
 FAIL  tests/unit/components/datavault/CellRenderer.test.tsx [ tests/unit/components/datavault/CellRenderer.test.tsx ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/322]Î“Ã„Â»

 FAIL  tests/integration/api.dataSources.native.test.ts > Data Sources API - Native Catalog
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/api.dataSources.native.test.ts:20:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/322]Î“Ã„Â»

 FAIL  tests/integration/api.dataSources.native.test.ts > Data Sources API - Native Catalog
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/api.dataSources.native.test.ts:30:19
     28| 
     29|     afterAll(async () => {
     30|         await ctx.cleanup();
       |                   ^
     31|     });
     32| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/322]Î“Ã„Â»

 FAIL  tests/integration/api.expression-validation.test.ts > Expression Validation API Integration Tests
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/api.expression-validation.test.ts:70:8
     68|         },
     69|       })
     70|       .expect(201);
       |        ^
     71| 
     72|     workflowId = workflowResponse.body.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/322]Î“Ã„Â»

 FAIL  tests/integration/api.projects.test.ts > Projects API Integration Tests
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/api.projects.test.ts:66:8
     64|         lastName: "User",
     65|       })
     66|       .expect(201);
       |        ^
     67| 
     68|     authToken = registerResponse.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/322]Î“Ã„Â»

 FAIL  tests/integration/api.runs.docx.test.ts > Runs API - DOCX Generation Integration Tests
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/api.runs.docx.test.ts:113:8
    111|       .post('/api/auth/register')
    112|       .send({ email, password: 'TestPassword123!@#Strong' })
    113|       .expect(201);
       |        ^
    114| 
    115|     authToken = registerResponse.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/322]Î“Ã„Â»

 FAIL  tests/integration/api.runs.graph.test.ts > Stage 8: Runs API Integration Tests
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, $4, $5, default, default, default, default, $6, $7, $8, $9, $10) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: cad7c950-a881-42ee-bfdb-82c585ae0d50,018a22ed-0fc1-4e0e-bc32-de3bcfd16062,1,true,{"nodes":[{"id":"start","type":"question","config":{"key":"start","question":"Start Question","type":"short_text"}}],"edges":[],"startNodeId":"start"},test-user-runs-stage8,true,2026-01-17T18:55:04.573Z,2026-01-17T18:55:04.334Z,2026-01-17T18:55:04.334Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/api.runs.graph.test.ts:176:23
    174|     workflowId = workflow.id;
    175| 
    176|     const [version] = await db.insert(schema.workflowVersions).values({
       |                       ^
    177|       ...vData,
    178|       workflowId, // Ensure link

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/api.runs.graph.test.ts:176:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(018a22ed-0fc1-4e0e-bc32-de3bcfd16062) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/322]Î“Ã„Â»

 FAIL  tests/integration/api.templates-runs.test.ts > Templates and Runs API Integration Tests
Error: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Tenant for Templates Org,14ee40dd-8d05-46f2-9874-d554e25ef194
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:130:19
    128| 
    129|     // Create organization for ACL testing
    130|     const [org] = await db.insert(schema.organizations).values({
       |                   ^
    131|       name: `${tenantName} Org`,
    132|       tenantId: tenantId,
 Î“Â¥Â» tests/integration/api.templates-runs.test.ts:59:11

Caused by: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:130:19
 Î“Â¥Â» tests/integration/api.templates-runs.test.ts:59:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(14ee40dd-8d05-46f2-9874-d554e25ef194) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/322]Î“Ã„Â»

 FAIL  tests/integration/api.templates-runs.test.ts > Templates and Runs API Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/api.templates-runs.test.ts:85:15
     83| 
     84|   afterAll(async () => {
     85|     await ctx.cleanup();
       |               ^
     86|   });
     87| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/322]Î“Ã„Â»

 FAIL  tests/integration/api.workflows.test.ts > Workflows API Integration Tests
Error: Project creation failed: {"message":"Tenant required","error":"no_tenant","details":"Your account is not associated with any tenant. Please contact support."}
 Î“Â¥Â» Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:153:15
    151| 
    152|       if (projectResponse.status !== 201) {
    153|         throw new Error(`Project creation failed: ${JSON.stringify(proÎ“Ã‡Âª
       |               ^
    154|       }
    155| 
 Î“Â¥Â» tests/integration/api.workflows.test.ts:42:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/322]Î“Ã„Â»

 FAIL  tests/integration/api.workflows.test.ts > Workflows API Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/api.workflows.test.ts:52:15
     50| 
     51|   afterAll(async () => {
     52|     await ctx.cleanup();
       |               ^
     53|   });
     54| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/322]Î“Ã„Â»

 FAIL  tests/integration/collections.e2e.test.ts > Collections System E2E Tests
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, default, $7, $8, $9, default, default, $10, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-user-collections-e2e,test-collections-e2e@example.com,Collections E2E Test User,Collections,E2E Test User,5405be44-c2c6-4e30-a43f-3207f3ece8ce,owner,local,easy,
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/collections.e2e.test.ts:34:20
     32| 
     33|     // Create test user
     34|     const [user] = await db.insert(users).values({
       |                    ^
     35|       id: 'test-user-collections-e2e',
     36|       email: 'test-collections-e2e@example.com',

Caused by: error: duplicate key value violates unique constraint "users_pkey"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/collections.e2e.test.ts:34:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 204, severity: 'ERROR', code: '23505', detail: 'Key (id)=(test-user-collections-e2e) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/322]Î“Ã„Â»

 FAIL  tests/integration/dataBlocks.test.ts > Data Block Integration Tests
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 47b322f8-f419-4ceb-9e51-aa568834299a,datablock-test@example.com,65cd4ac1-a9cf-4856-8e88-0fb07a7f70fc,admin,owner,google
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/dataBlocks.test.ts:49:24
     47|         tenantId = tenant.id;
     48| 
     49|         const [user] = await db.insert(users).values({
       |                        ^
     50|             id: uuidv4(),
     51|             email: testEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/dataBlocks.test.ts:49:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(65cd4ac1-a9cf-4856-8e88-0fb07a7f70fc) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w29_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/322]Î“Ã„Â»

 FAIL  tests/integration/datavault-v4-regression.test.ts > DataVault v4 Regression Tests
Error: Login failed: {"message":"Authentication failed","error":"auth_failed"}
 Î“Â¥Â» tests/integration/datavault-v4-regression.test.ts:134:13
    132| 
    133|     if (loginResponse.status !== 200) {
    134|       throw new Error(`Login failed: ${JSON.stringify(loginResponse.boÎ“Ã‡Âª
       |             ^
    135|     }
    136| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/322]Î“Ã„Â»

 FAIL  tests/integration/datavault.autonumber.test.ts > DataVault Autonumber Integration Tests
Error: Failed query: insert into "datavault_tables" ("id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, default, default) returning "id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at"
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,,Autonumber Test Table,autonumber_test_table,Testing autonumber functionality
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» DatavaultTablesRepository.create server/repositories/BaseRepository.ts:90:22
     88|     const database = this.getDb(tx);
     89| 
     90|     const [record] = await database
       |                      ^
     91|       .insert(this.table as any)
     92|       .values(data as any)
 Î“Â¥Â» DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:171:19
 Î“Â¥Â» tests/integration/datavault.autonumber.test.ts:29:19

Caused by: error: insert or update on table "datavault_tables" violates foreign key constraint "datavault_tables_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» DatavaultTablesRepository.create server/repositories/BaseRepository.ts:90:22
 Î“Â¥Â» DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:171:19
 Î“Â¥Â» tests/integration/datavault.autonumber.test.ts:29:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 359, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(15f19932-cda8-4294-a8e2-851fe4a1a2ad) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'datavault_tables', dataType: undefined, constraint: 'datavault_tables_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/322]Î“Ã„Â»

 FAIL  tests/integration/datavault.permissions.test.ts > DataVault Table Permissions API (v4 Micro-Phase 6)
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/datavault.permissions.test.ts:22:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/322]Î“Ã„Â»

 FAIL  tests/integration/datavault.permissions.test.ts > DataVault Table Permissions API (v4 Micro-Phase 6)
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/datavault.permissions.test.ts:66:15
     64| 
     65|   afterAll(async () => {
     66|     await ctx.cleanup();
       |               ^
     67|   });
     68| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/322]Î“Ã„Â»

 FAIL  tests/integration/dynamic_options_workflow.test.ts > Dynamic Options Integration Flow
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/dynamic_options_workflow.test.ts:49:33
     47|         // Get default section
     48|         const sections = await sectionRepository.findByWorkflowId(workÎ“Ã‡Âª
     49|         sectionId = sections[0].id;
       |                                 ^
     50|     });
     51| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/322]Î“Ã„Â»

 FAIL  tests/integration/dynamic_options_workflow.test.ts > Dynamic Options Integration Flow
Error: Workflow not found
 Î“Â¥Â» WorkflowService.verifyAccess server/services/WorkflowService.ts:82:13
     80| 
     81|     if (!workflow) {
     82|       throw new Error("Workflow not found");
       |             ^
     83|     }
     84| 
 Î“Â¥Â» WorkflowService.deleteWorkflow server/services/WorkflowService.ts:292:5
 Î“Â¥Â» tests/integration/dynamic_options_workflow.test.ts:54:26

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/322]Î“Ã„Â»

 FAIL  tests/integration/intake.workflow.test.ts > Intake Workflow Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/intake.workflow.test.ts:11:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/322]Î“Ã„Â»

 FAIL  tests/integration/intake.workflow.test.ts > Intake Workflow Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/intake.workflow.test.ts:21:19
     19| 
     20|     afterAll(async () => {
     21|         await ctx.cleanup();
       |                   ^
     22|     });
     23| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[22/322]Î“Ã„Â»

 FAIL  tests/integration/lifecycle-hooks-execution.test.ts > Lifecycle Hooks Execution
Error: Project creation failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed query: insert into \"projects\" (\"id\", \"title\", \"name\", \"description\", \"creator_id\", \"tenant_id\", \"created_by\", \"owner_id\", \"owner_type\", \"owner_uuid\", \"status\", \"archived\", \"created_at\", \"updated_at\") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, $8, default, default) returning \"id\", \"title\", \"name\", \"description\", \"creator_id\", \"tenant_id\", \"created_by\", \"owner_id\", \"owner_type\", \"owner_uuid\", \"status\", \"archived\", \"created_at\", \"updated_at\"\nparams: Test Project,Test Project,,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,9a20dd35-0457-4039-8261-f82f39b7dde4,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,d03a78b3-24a3-434c-b5b0-87bb5a82dc3a,false"}}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:153:15
    151| 
    152|       if (projectResponse.status !== 201) {
    153|         throw new Error(`Project creation failed: ${JSON.stringify(proÎ“Ã‡Âª
       |               ^
    154|       }
    155| 
 Î“Â¥Â» tests/integration/lifecycle-hooks-execution.test.ts:41:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[23/322]Î“Ã„Â»

 FAIL  tests/integration/lifecycle-hooks-execution.test.ts > Lifecycle Hooks Execution
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/lifecycle-hooks-execution.test.ts:89:15
     87| 
     88|   afterAll(async () => {
     89|     await ctx.cleanup();
       |               ^
     90|   });
     91| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[24/322]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 92ab96ba-a815-4dbe-aa53-00229dd7f23c,test@example.com,Test User,b9dd83df-9071-4138-8254-48f1eb876971
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:114:20
    112| 
    113|     // Create test user
    114|     const [user] = await db.insert(users).values({
       |                    ^
    115|       id: mockUserId,
    116|       email: 'test@example.com',

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:114:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b9dd83df-9071-4138-8254-48f1eb876971) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[25/322]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:35:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[26/322]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:45:19
     43| 
     44|     afterAll(async () => {
     45|         await ctx.cleanup();
       |                   ^
     46|     });
     47| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[27/322]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[28/322]Î“Ã„Â»

 FAIL  tests/integration/auth/jwt.authentication.test.ts > JWT Authentication Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/jwt.authentication.test.ts:40:19
     38| 
     39|     afterAll(async () => {
     40|         await ctx.cleanup();
       |                   ^
     41|     });
     42| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[29/322]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[30/322]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[31/322]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[32/322]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:40:19
     38| 
     39|     afterAll(async () => {
     40|         await ctx.cleanup();
       |                   ^
     41|     });
     42| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[33/322]Î“Ã„Â»

 FAIL  tests/integration/workflows/runtime-pipelines.test.ts > Runtime Pipelines Integration Tests
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: AhDjzvfqIm3alxOn65QoP,test-pipeline-user@example.com,164bf30f-4aff-48cc-b6ef-2c7be7d79b89,admin,owner
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/workflows/runtime-pipelines.test.ts:75:20
     73| 
     74|     // Create test user
     75|     const [user] = await db.insert(users).values({
       |                    ^
     76|       id: testUserId,
     77|       email: 'test-pipeline-user@example.com',

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/workflows/runtime-pipelines.test.ts:75:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(164bf30f-4aff-48cc-b6ef-2c7be7d79b89) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w27_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[34/322]Î“Ã„Â»


Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 282 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/api.snapshots.test.ts > Stage 13: Workflow Snapshots & Versioning > should maintain immutability of runs across versions
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, $4, $5, default, default, default, default, $6, $7, $8, $9, $10) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 28ebae1a-4cca-4bb9-9176-9b0d0debc6df,aec5f11a-7a61-43bd-b7ec-0b038a9f2a09,1,true,{"nodes":[{"id":"q1","type":"question","config":{"key":"q1","question":"Version 1 Question","type":"short_text"}}],"edges":[],"startNodeId":"q1"},test-user-id,true,2026-01-17T18:57:16.804Z,2026-01-17T18:57:16.585Z,2026-01-17T18:57:16.585Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/api.snapshots.test.ts:182:28
    180| 
    181|         // 2. Publish Version 1
    182|         const [version1] = await db.insert(schema.workflowVersions).vaÎ“Ã‡Âª
       |                            ^
    183|             ...vData,
    184|             workflowId,

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/api.snapshots.test.ts:182:28

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(aec5f11a-7a61-43bd-b7ec-0b038a9f2a09) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w52_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[35/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:73:39
     71|         });
     72| 
     73|       expect(registerResponse.status).toBe(201);
       |                                       ^
     74|       expect(registerResponse.body.user.emailVerified).toBe(false);
     75|       trackUser(registerResponse.body.user.id);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[36/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7e6decc71267ddf28b898ce82c06215c,$2b$12$n8Sz8rUZZHR0e84DU42NAegfOd1x/3gaQ6GLTqj5NCG.3yT9J5ufa,2026-01-17T18:54:09.632Z,2026-01-17T18:54:09.632Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:105:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:105:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7e6decc71267ddf28b898ce82c06215c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[37/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
AssertionError: expected 1 to be 3 // Object.is equality

- Expected
+ Received

- 3
+ 1

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:174:31
    172|       });
    173| 
    174|       expect(attempts.length).toBe(3);
       |                               ^
    175|       expect(attempts.filter(a => !a.successful).length).toBe(2);
    176|       expect(attempts.filter(a => a.successful).length).toBe(1);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[38/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:197:36
    195|         .set("Authorization", `Bearer ${token}`);
    196| 
    197|       expect(setupResponse.status).toBe(200);
       |                                    ^
    198|       expect(setupResponse.body.qrCodeDataUrl).toBeDefined();
    199|       expect(setupResponse.body.backupCodes).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[39/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:276:44
    274| 
    275|       const mfaSecret = await db.query.mfaSecrets.findFirst({
    276|         where: eq(mfaSecrets.userId, user!.id),
       |                                            ^
    277|       });
    278| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[40/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:332:43
    330|         .send({ email });
    331| 
    332|       expect(resetRequestResponse.status).toBe(200);
       |                                           ^
    333| 
    334|       // Step 2: Get reset token from database (in real app, sent via Î“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[41/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should invalidate all sessions after password reset
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e8c32b59c538a166d24941b1c9641233,$2b$12$3zpUFrF1tdGft0TQeyGqTeuflPm4n8nO8fluf4TioYWiW.XZIXGOu,2026-01-17T18:54:16.677Z,2026-01-17T18:54:16.677Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:383:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:383:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e8c32b59c538a166d24941b1c9641233) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[42/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2fd5e025e9f2ea27a4e4ec13a6295e6f,$2b$12$WF1bDlBWaMcq3oi2ZSge..WmKwi3Y.wImt/./.JXa6rGH/bI2mGM.,2026-01-17T18:54:17.364Z,2026-01-17T18:54:17.364Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:430:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:430:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2fd5e025e9f2ea27a4e4ec13a6295e6f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[43/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 52ad2cbc5f1d26d6a24a5c4f710c3070,$2b$12$sGs/t3LFldKetmIB31.VE.h9FJQht2bExRsG1ABAabayVU7jdUCD.,2026-01-17T18:54:18.067Z,2026-01-17T18:54:18.067Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:464:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:464:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(52ad2cbc5f1d26d6a24a5c4f710c3070) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[44/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:528:39
    526|         .set("Authorization", `Bearer ${token}`);
    527| 
    528|       expect(sessionsResponse.status).toBe(200);
       |                                       ^
    529|       expect(sessionsResponse.body.sessions).toBeDefined();
    530|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[45/322]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 216ed4047e6907390313bab81121c539,$2b$12$crC0JksrkciY5wcwYzR8KeRbNLC7P.r.ePUSDTmY.H65QfQoJ6Wry,2026-01-17T18:54:21.967Z,2026-01-17T18:54:21.967Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:534:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:534:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(216ed4047e6907390313bab81121c539) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[46/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/register > should register a new user successfully
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:78:31
     76|         });
     77| 
     78|       expect(response.status).toBe(201);
       |                               ^
     79|       expect((response.body).message).toContain("Registration successfÎ“Ã‡Âª
     80|       expect((response.body).token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[47/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/register > should return 409 for duplicate email
AssertionError: expected 500 to be 409 // Object.is equality

- Expected
+ Received

- 409
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:139:31
    137|         .send({ email, password, firstName: "Second" });
    138| 
    139|       expect(response.status).toBe(409);
       |                               ^
    140|       expect(response.body.message).toContain("already exists");
    141|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[48/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/register > should set httpOnly refresh token cookie
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:151:31
    149|         .send({ email, password, firstName: "Test" });
    150| 
    151|       expect(response.status).toBe(201);
       |                               ^
    152|       expect(response.headers['set-cookie']).toBeDefined();
    153| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[49/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should login with valid credentials
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:171:31
    169|         .send({ email, password });
    170| 
    171|       expect(response.status).toBe(200);
       |                               ^
    172|       expect((response.body).message).toBe("Login successful");
    173|       expect((response.body).token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[50/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return requiresMfa=true for MFA-enabled users
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ca0b151e4989a2d818b36423b8201723,$2b$12$8jXxClwkdDMUykW1Hs1v9eGiSWnq2mROiTpqYrJF8GZfWVuBQNGjC,2026-01-17T18:54:17.809Z,2026-01-17T18:54:17.809Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:252:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:252:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ca0b151e4989a2d818b36423b8201723) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[51/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
AssertionError: expected 500 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:287:31
    285|         });
    286| 
    287|       expect(response.status).toBe(423);
       |                               ^
    288|       expect(response.body).toBeDefined();
    289|       expect(response.body.error || response.body.message).toBeDefinedÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[52/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/logout > should logout and clear refresh token cookie
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ae2f4b552361120ad5bf37bbb35bcccd,$2b$12$5GMZ7pMLqieTatSEqtwzTO8PoFoI01JW3mxE1wFxoxGQJ9D9sPAs6,2026-01-17T18:54:22.051Z,2026-01-17T18:54:22.051Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:295:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:295:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ae2f4b552361120ad5bf37bbb35bcccd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[53/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/refresh-token > should refresh access token with valid refresh token
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:334:23
    332| 
    333|       const cookies = (loginResponse.headers as any)['set-cookie'] as Î“Ã‡Âª
    334|       expect(cookies).toBeDefined();
       |                       ^
    335|       const refreshTokenCookie = cookies!.find(c => c.startsWith('refrÎ“Ã‡Âª
    336|       expect(refreshTokenCookie).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[54/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/refresh-token > should rotate refresh token after use
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:372:23
    370| 
    371|       const cookies = (loginResponse.headers as any)['set-cookie'] as Î“Ã‡Âª
    372|       expect(cookies).toBeDefined();
       |                       ^
    373|       const oldCookie = cookies!.find(c => c.startsWith('refresh_tokenÎ“Ã‡Âª
    374|       expect(oldCookie).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[55/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/forgot-password > should send password reset email for existing user
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:406:31
    404|         .send({ email });
    405| 
    406|       expect(response.status).toBe(200);
       |                               ^
    407|       expect(response.body.message).toContain("reset link");
    408|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[56/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.generatePasswordResetToken server/services/AuthService.ts:508:9
    506| 
    507|         await sendPasswordResetEmail(email, plainToken);
    508|         log.info({ email }, 'Password reset email sent');
       |         ^
    509| 
    510|         return plainToken;
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:427:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[57/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should return 400 for weak new password
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a0fea90efbfce01253c3a0aef1656a42,$2b$12$K6Lp1jl4bl4l3U5fW/0rCOnKsqPqoio1IRuFnogmzrf60zSmSoDsa,2026-01-17T18:54:28.490Z,2026-01-17T18:54:28.490Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:469:33

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:469:33

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a0fea90efbfce01253c3a0aef1656a42) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[58/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > GET /api/auth/me > should return current user for valid token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:500:31
    498|         .set("Authorization", `Bearer ${token}`);
    499| 
    500|       expect(response.status).toBe(200);
       |                               ^
    501|       expect(response.body.email).toBe(email);
    502|       expect(response.body.id).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[59/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > MFA Routes > POST /api/auth/mfa/verify-login > should complete MFA login with valid TOTP code
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 436a3a7a8ab45a52eda12985d9ecba69,$2b$12$oa.13QZXKfi0YRQh.OXXbOJ4gm2Kepr/CTh1EJHwveiD5Lgcc3iI6,2026-01-17T18:54:30.317Z,2026-01-17T18:54:30.317Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:523:57

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:523:57

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(436a3a7a8ab45a52eda12985d9ecba69) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[60/322]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > MFA Routes > POST /api/auth/mfa/verify-login > should reject invalid MFA code
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 140bb73cd8820dd66410acbe682a9cbe,$2b$12$Uf5CGcOxj/64T6mfGagKLOu7waAW27Vh51Ss1jcRdsYr.pl7Y7WSm,2026-01-17T18:54:31.073Z,2026-01-17T18:54:31.073Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:549:28

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:549:28

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(140bb73cd8820dd66410acbe682a9cbe) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[61/322]Î“Ã„Â»

 FAIL  tests/integration/externalSends.test.ts > External Send Block Integration > PREVIEW MODE: Should simulate send and NOT call fetch
 FAIL  tests/integration/externalSends.test.ts > External Send Block Integration > LIVE MODE: Should call fetch with mapped payload
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Send Workflow,3bc58fe5-f25f-45c5-b174-80964b51fc55,3bc58fe5-f25f-45c5-b174-80964b51fc55,5e9312ff-34d6-4375-9a91-7d65e8b0c8e0
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/externalSends.test.ts:90:28
     88| 
     89|         // 4. Setup Workflow & Version & Section
     90|         const [workflow] = await db.insert(workflows).values({
       |                            ^
     91|             projectId,
     92|             title: 'Send Workflow',

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/externalSends.test.ts:90:28

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3bc58fe5-f25f-45c5-b174-80964b51fc55) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[62/322]Î“Ã„Â»

 FAIL  tests/integration/js_helpers.test.ts > Detailed Verification: JS Helper Availability > should execute a JS block that uses helper functions
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/js_helpers.test.ts:185:28
    183|         );
    184| 
    185|         expect(savedValue).toBeDefined();
       |                            ^
    186|         const result = savedValue.value as any;
    187| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[63/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should complete full MFA setup flow
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7e9c6fc4b53c6bc2fe86472e715f3ef7,$2b$12$uKgwoyNpc8qAdWq8mXuEGOWM1FX2PeQ4RU/csJB9s9V9uclF8abFy,2026-01-17T18:54:08.813Z,2026-01-17T18:54:08.813Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:59:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:59:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7e9c6fc4b53c6bc2fe86472e715f3ef7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[64/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should reject invalid TOTP code during setup
AssertionError: expected 401 to be 400 // Object.is equality

- Expected
+ Received

- 400
+ 401

 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:145:37
    143|         .send({ token: "000000" }); // Invalid code
    144| 
    145|       expect(verifyResponse.status).toBe(400);
       |                                     ^
    146|       expect(verifyResponse.body.message).toContain("Invalid");
    147| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[65/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should not allow MFA setup if already enabled
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0e86f9a86ed38b17c09e93b2089d7641,$2b$12$aO3kJTk6Jy3pZc.bRE3Y0.TuiADI0K82.h2RwLh.Kt3CcrNDVQKgW,2026-01-17T18:54:11.883Z,2026-01-17T18:54:11.883Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:157:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:157:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0e86f9a86ed38b17c09e93b2089d7641) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[66/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should generate unique backup codes
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3a38aac1fb6915019c59572662b6025d,$2b$12$bXHVG/wBaLEGWZFwLmNqo.oDjwpUnZc/nwFo4YyYCw2BIlWZdn27q,2026-01-17T18:54:12.684Z,2026-01-17T18:54:12.684Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:171:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:171:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3a38aac1fb6915019c59572662b6025d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[67/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Setup Flow > should store hashed backup codes
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e0da74e2bc53059f7e775580f9d88274,$2b$12$DZmMq9Dd13P3aLrNqvRdK.gP/9p/sjAZ6PzYS3rHne3PrcMTytyRa,2026-01-17T18:54:13.329Z,2026-01-17T18:54:13.329Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:190:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:190:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e0da74e2bc53059f7e775580f9d88274) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[68/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Login Flow > should require MFA for enabled users
Error: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: 2e4913c816b2a463d6a027635129ee6b,$2b$10$c2Dr.PJZbuBnuH4H2jjYjuP3aR8vZkkH7IY.24FEU2xeoox6/E8yK,false,2026-01-17T18:54:14.290Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$SW4/hcs.Ow0w59qmMdYTR.pCvWopQjhLnYfQdMQ8/CbuZH76aikzy,false,2026-01-17T18:54:14.291Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$uxN8J0.ZPiNqMDqT5ZnfpupEUzmo/G6owX6AdbT5/jythj5yYqXqS,false,2026-01-17T18:54:14.289Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$a0EPtwK4bjofNrg5JPqmO.kK5mB4A8pw7xlg.RhqN5f8RiRnzTp/y,false,2026-01-17T18:54:14.289Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$PV5vP2TcfqF657gG/lnuteRBt7kGpK07iNi5HGjZM/8VzQTinLMSy,false,2026-01-17T18:54:14.349Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$D/xRzGML14V3ySFHMAUxQe.Dq1pDit2kDJ8Y1I0MTfVDzfz9vQt8W,false,2026-01-17T18:54:14.350Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$KNBj/Ft3t2k1KS9Q/Al7Ru2EL4yvkARDeGMOZLk3lHtBuxozE33.6,false,2026-01-17T18:54:14.350Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$lKuExHFQAmdZYOJARu9E0.QVZKm4VepXjykyZM/6chomGGK/tW.1q,false,2026-01-17T18:54:14.352Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$j2cG8AtGKygNvYTY7gOvneheKw/EGl4Z5/ai//QgVHO9fE.2KyosO,false,2026-01-17T18:54:14.408Z,2e4913c816b2a463d6a027635129ee6b,$2b$10$KD1szWUY9u0UAL./SRkVruKFdUA2EdcV3dtlKSIiVjb0AUy5iiDEW,false,2026-01-17T18:54:14.408Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:258:3
    256|   );
    257| 
    258|   await db.insert(mfaBackupCodes).values(hashedCodes);
       |   ^
    259| 
    260|   return {
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:220:43

Caused by: error: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:258:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:220:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2e4913c816b2a463d6a027635129ee6b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[69/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Login Flow > should complete MFA login with valid TOTP
AssertionError: expected 404 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 404

 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:254:34
    252|         });
    253| 
    254|       expect(mfaResponse.status).toBe(200);
       |                                  ^
    255|       expect(mfaResponse.body.token).toBeDefined();
    256|       expect(mfaResponse.body.user).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[70/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Login Flow > should reject invalid TOTP during login
Error: [TEST UTILS] MFA Secret verification failed for 1e3409132bc98633494ce6ac51645610
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:268:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[71/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Login Flow > should accept TOTP codes within 60-second window
Error: [TEST UTILS] MFA Secret verification failed for cb2128807a5e4bd24c7c67d7eddd833d
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:286:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[72/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Flow > should login with valid backup code
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 83a1b37c11b263d5a608e1b20f60d5b7,$2b$12$LRVwHwcvH5fuG.xCwz6EHuEVPJBTWOkfhMADBMIa9IuIW6A3kj5U6,2026-01-17T18:54:18.076Z,2026-01-17T18:54:18.076Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:318:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:318:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(83a1b37c11b263d5a608e1b20f60d5b7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[73/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Flow > should mark backup code as used
Error: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: c633d10beb27f257f56c41684b0278a6,$2b$10$FNRlpnZLrfYoCRHL4vhfluIUz9VBoGEXSGCBcgmcnqJdZ78Vv/YAS,false,2026-01-17T18:54:19.149Z,c633d10beb27f257f56c41684b0278a6,$2b$10$2oEsh6EDOqGTGyU1XzmZweCKNpM4l/KSOYCZeo6PEcsFVi7ivbji.,false,2026-01-17T18:54:19.149Z,c633d10beb27f257f56c41684b0278a6,$2b$10$Ev3x7P80i3QMjC89EalCz.tguwqjupdaUx4OUHC.8t4uIWxDIEoya,false,2026-01-17T18:54:19.146Z,c633d10beb27f257f56c41684b0278a6,$2b$10$fkGHVhNng23VtusL71h0TOlk38YqfuUqjXw6umoY8PO7y4RFqSAMm,false,2026-01-17T18:54:19.147Z,c633d10beb27f257f56c41684b0278a6,$2b$10$QFVFvUGUPP7ybcQPNxBeFu3AW3wf0368rpRaPV6.OXOAszlbqU50O,false,2026-01-17T18:54:19.208Z,c633d10beb27f257f56c41684b0278a6,$2b$10$KWxBnVyneKsQZLURLKGbbOjEjBD7fKog1eVDFgjIsz5D4CGHbZSkG,false,2026-01-17T18:54:19.208Z,c633d10beb27f257f56c41684b0278a6,$2b$10$49.8Fnu7yr1vkGdlxPmM6Oeg6swwX8f5OA7tzegt9/NB14HD6fE3S,false,2026-01-17T18:54:19.208Z,c633d10beb27f257f56c41684b0278a6,$2b$10$8F09hi7ue9NCOuWaaW2N2OnNCpbW45z9Q7yal19ZYyTus94fvaqYW,false,2026-01-17T18:54:19.208Z,c633d10beb27f257f56c41684b0278a6,$2b$10$frBjEIzQ7207Ys4Xo3bClOn.2.QGQLjfUkO7r5KWyBjIhgv4kL15i,false,2026-01-17T18:54:19.266Z,c633d10beb27f257f56c41684b0278a6,$2b$10$pu5VLSSEFiR9zi4kOfzk5e2nkQqiYv1IfxPtI1rkHYDzqyw7vqpja,false,2026-01-17T18:54:19.266Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:258:3
    256|   );
    257| 
    258|   await db.insert(mfaBackupCodes).values(hashedCodes);
       |   ^
    259| 
    260|   return {
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:370:43

Caused by: error: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:258:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:370:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c633d10beb27f257f56c41684b0278a6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[74/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Flow > should prevent backup code reuse
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:410:44
    408| 
    409|       const mfaSecret = await db.query.mfaSecrets.findFirst({
    410|         where: eq(mfaSecrets.userId, user!.id),
       |                                            ^
    411|       });
    412| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[75/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Flow > should try TOTP before backup code
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: ecfd227a0e55081ae4c676e8d387a0e0,JUUGSZ3LPM6G2VBYIY4S4MDGERDHSMDEMVBFQYJSJY4UIL22OYYA,true,2026-01-17T18:54:22.017Z,2026-01-17T18:54:22.017Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:452:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:452:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ecfd227a0e55081ae4c676e8d387a0e0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[76/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Status > should return MFA status for user
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 1b17c90ccef30539e977b437d37d3734,$2b$12$mT8kAhYprhHiFBMQFoBkQuTu93fFp6ZLYONkQzvqAGsm1m9ssvoIG,2026-01-17T18:54:22.721Z,2026-01-17T18:54:22.721Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:475:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:475:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1b17c90ccef30539e977b437d37d3734) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[77/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Status > should return backup codes count for MFA users
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 79db6f6375af5d17884f75d329e30b22,FBTHWMJOEF3GQWRBN5KGCLSTLN3GCR3LGJBXAMSBGARXMUL5HIRQ,true,2026-01-17T18:54:23.470Z,2026-01-17T18:54:23.470Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:492:43

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:492:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 311, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(79db6f6375af5d17884f75d329e30b22) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[78/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Disable Flow > should disable MFA with password verification
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 49d7f17cc334b83938d6319692a6be8a,NVGDGULPNBTSQ2L5OZ2VIU3CNBNHU43QKI5CGRSBNVCFK4T2MMZQ,true,2026-01-17T18:54:24.273Z,2026-01-17T18:54:24.273Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:529:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:529:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 311, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(49d7f17cc334b83938d6319692a6be8a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[79/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > MFA Disable Flow > should require correct password to disable MFA
Error: [TEST UTILS] MFA Secret verification failed for ac275ec719b467c2ee13905bf2302540
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:579:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[80/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Regeneration > should regenerate backup codes
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 37eff8ba1ecf8bfb2e9047ecd54fe27c,HJWUSVDBGBTSMU2YFZKTS23YLJ5GEYZGIJDD662PKFRWMPBEJJ3A,true,2026-01-17T18:54:25.764Z,2026-01-17T18:54:25.764Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:613:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:613:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 311, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(37eff8ba1ecf8bfb2e9047ecd54fe27c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[81/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Backup Code Regeneration > should return error if MFA not enabled
AssertionError: expected 401 to be 400 // Object.is equality

- Expected
+ Received

- 400
+ 401

 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:657:31
    655|         .set("Authorization", `Bearer ${loginResponse.body.token}`);
    656| 
    657|       expect(response.status).toBe(400);
       |                               ^
    658|       expect(response.body.message).toContain("not enabled");
    659|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[82/322]Î“Ã„Â»

 FAIL  tests/integration/mfa.flow.real.test.ts > MFA Flow Integration Tests (REAL) > Tenant-Level MFA Enforcement > should enforce MFA for tenant users when required by tenant
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b134b59d8bc8a3b770a82eb75763ab2b,$2b$12$p82bpiFeoZIjNtWKery3eexv89N5glQ1Iop8Vhg699xPOgN9CrZr2,2026-01-17T18:54:28.716Z,2026-01-17T18:54:28.716Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:673:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/mfa.flow.real.test.ts:673:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b134b59d8bc8a3b770a82eb75763ab2b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[83/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should create placeholder user for non-existent email
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:91:37
     89|             });
     90| 
     91|             expect(placeholderUser).toBeDefined();
       |                                     ^
     92|             expect(placeholderUser?.isPlaceholder).toBe(true);
     93|             expect(placeholderUser?.placeholderEmail).toBe(newUserEmaiÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[84/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should create invite for existing user without creating placeholder
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should prevent duplicate pending invites
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should prevent inviting existing members
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should require admin access to create invite
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should reject already accepted invite
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > getPendingInvitesForUser > should not return expired invites
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > getPendingInvitesForUser > should not return accepted invites
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768676031298@test.com,Existing User,00000000-0000-0000-0000-000000000098
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:46:9
     44|         await db.delete(users).where(inArray(users.id, [adminUserId, eÎ“Ã‡Âª
     45| 
     46|         await db.insert(users).values([
       |         ^
     47|             { id: adminUserId, email: 'admin@test.com', fullName: 'AdmÎ“Ã‡Âª
     48|             { id: existingUserId, email: existingUserEmail, fullName: Î“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:46:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000098) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[85/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > createInvite > should set expiry to 7 days from now
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:149:39
    147|             });
    148| 
    149|             expect(invite?.expiresAt).toBeDefined();
       |                                       ^
    150|             if (invite?.expiresAt) {
    151|                 const expectedExpiry = new Date(beforeCreate);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[86/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should accept invite and create membership
 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should convert placeholder user to real user on accept
Error: Failed query: delete from "users" where "users"."id" in ($1, $2)
params: 00000000-0000-0000-0000-000000000021,00000000-0000-0000-0000-000000000022
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:44:9
     42|             )
     43|         );
     44|         await db.delete(users).where(inArray(users.id, [adminUserId, eÎ“Ã‡Âª
       |         ^
     45| 
     46|         await db.insert(users).values([

Caused by: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:44:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 335, severity: 'ERROR', code: '23503', detail: 'Key (id)=(00000000-0000-0000-0000-000000000021) is still referenced from table "audit_logs".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'audit_logs', dataType: undefined, constraint: 'audit_logs_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[87/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should reject expired invite
AssertionError: expected undefined to be 'expired' // Object.is equality

- Expected: 
"expired"

+ Received: 
undefined

 Î“Â¥Â» tests/integration/organizationInvites.test.ts:237:36
    235|             });
    236| 
    237|             expect(invite?.status).toBe('expired');
       |                                    ^
    238|         });
    239| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[88/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > acceptInvite > should verify email matches invite
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:53:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[89/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > getPendingInvitesForUser > should return pending invites for user email
AssertionError: expected [] to have a length of 1 but got +0

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/organizationInvites.test.ts:286:29
    284|             const invites = await organizationService.getPendingInviteÎ“Ã‡Âª
    285| 
    286|             expect(invites).toHaveLength(1);
       |                             ^
    287|             expect(invites[0].orgName).toBe('Invite Test Org');
    288|             expect(invites[0].token).toBe(inviteResult.token);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[90/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > revokeInvite > should allow admin to revoke invite
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:328:34

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[91/322]Î“Ã„Â»

 FAIL  tests/integration/organizationInvites.test.ts > Organization Invites > revokeInvite > should prevent accepting revoked invite
Error: Organization not found
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:449:13
    447| 
    448|     if (!org) {
    449|       throw new Error('Organization not found');
       |             ^
    450|     }
    451| 
 Î“Â¥Â» tests/integration/organizationInvites.test.ts:344:34

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[92/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #2: Invite acceptance race condition > should prevent double-acceptance via transaction
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:164:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[93/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #3: Invite email failure rollback > should not create invite if email fails
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:192:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[94/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #5: Expired invites > should allow re-invite after invite expires
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:215:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[95/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #7: Delete organization > should allow last admin to delete empty organization
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:244:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[96/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #7: Delete organization > should prevent deletion if org owns assets
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:262:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[97/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #8: Placeholder user cleanup > should cleanup placeholder user when invite is revoked
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:295:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[98/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-audit-fixes.test.ts > Organization Audit Fixes > FIX #9: Transfer validation order > should fail fast on non-existent org
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, default, default, default, default, default, default, default, $4, $5, $6, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Transfer Test,bd24c6f9-b112-4b93-9671-2be7a829731c,bd24c6f9-b112-4b93-9671-2be7a829731c,draft,user,bd24c6f9-b112-4b93-9671-2be7a829731c
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/BaseRepository.ts:90:22
     88|     const database = this.getDb(tx);
     89| 
     90|     const [record] = await database
       |                      ^
     91|       .insert(this.table as any)
     92|       .values(data as any)
 Î“Â¥Â» WorkflowRepository.create server/repositories/WorkflowRepository.ts:25:22
 Î“Â¥Â» server/services/WorkflowService.ts:123:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:324:24

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg/lib/client.js:545:17
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/BaseRepository.ts:90:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/WorkflowRepository.ts:25:22
 Î“Â¥Â» server/services/WorkflowService.ts:123:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-audit-fixes.test.ts:324:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bd24c6f9-b112-4b93-9671-2be7a829731c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[99/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 1: Create organization
Error: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, $2, default, default, default, $3, $4, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Organization,Integration test organization,5bae1144-8e87-4b34-b190-29d98f8db3ba,6cd41dc3-fee2-4b05-acca-802cfaf24885
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» server/services/OrganizationService.ts:54:21
     52|     return db.transaction(async (tx) => {
     53|       // Create organization with tenant scoping
     54|       const [org] = await tx
       |                     ^
     55|         .insert(organizations)
     56|         .values({
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:92:19

Caused by: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg/lib/client.js:545:17
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» server/services/OrganizationService.ts:54:21
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:92:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5bae1144-8e87-4b34-b190-29d98f8db3ba) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[100/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 2: Invite member via email
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:117:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[101/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 3: Accept invite
Error: Invite not found
 Î“Â¥Â» OrganizationService.acceptInvite server/services/OrganizationService.ts:702:13
    700| 
    701|     if (!invite) {
    702|       throw new Error('Invite not found');
       |             ^
    703|     }
    704| 
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:141:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[102/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 4: Create workflow owned by user
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, default, default, default, default, default, default, default, $5, $6, $7, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow for Transfer,Will be transferred to org,6cd41dc3-fee2-4b05-acca-802cfaf24885,6cd41dc3-fee2-4b05-acca-802cfaf24885,draft,user,6cd41dc3-fee2-4b05-acca-802cfaf24885
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/BaseRepository.ts:90:22
     88|     const database = this.getDb(tx);
     89| 
     90|     const [record] = await database
       |                      ^
     91|       .insert(this.table as any)
     92|       .values(data as any)
 Î“Â¥Â» WorkflowRepository.create server/repositories/WorkflowRepository.ts:25:22
 Î“Â¥Â» server/services/WorkflowService.ts:123:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:167:24

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg/lib/client.js:545:17
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/BaseRepository.ts:90:22
 Î“Â¥Â» WorkflowRepository.create server/repositories/WorkflowRepository.ts:25:22
 Î“Â¥Â» server/services/WorkflowService.ts:123:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:167:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6cd41dc3-fee2-4b05-acca-802cfaf24885) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[103/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 5: Transfer workflow to organization
Error: Workflow not found
 Î“Â¥Â» WorkflowService.verifyAccess server/services/WorkflowService.ts:82:13
     80| 
     81|     if (!workflow) {
     82|       throw new Error("Workflow not found");
       |             ^
     83|     }
     84| 
 Î“Â¥Â» WorkflowService.transferOwnership server/services/WorkflowService.ts:805:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:185:27

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[104/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 6: Org member (user2) can access workflow
Error: Workflow not found
 Î“Â¥Â» WorkflowService.verifyAccess server/services/WorkflowService.ts:82:13
     80| 
     81|     if (!workflow) {
     82|       throw new Error("Workflow not found");
       |             ^
     83|     }
     84| 
 Î“Â¥Â» WorkflowService.getWorkflowWithDetails server/services/WorkflowService.ts:159:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:207:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[105/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 7: Org member (user2) can update workflow
Error: Workflow not found
 Î“Â¥Â» WorkflowService.verifyAccess server/services/WorkflowService.ts:82:13
     80| 
     81|     if (!workflow) {
     82|       throw new Error("Workflow not found");
       |             ^
     83|     }
     84| 
 Î“Â¥Â» WorkflowService.updateWorkflow server/services/WorkflowService.ts:239:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:219:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[106/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 8: Org admin (user1) can still access workflow after transfer
Error: Workflow not found
 Î“Â¥Â» WorkflowService.verifyAccess server/services/WorkflowService.ts:82:13
     80| 
     81|     if (!workflow) {
     82|       throw new Error("Workflow not found");
       |             ^
     83|     }
     84| 
 Î“Â¥Â» WorkflowService.getWorkflowWithDetails server/services/WorkflowService.ts:159:22
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:233:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[107/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 12: Org member can see workflow in list
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:274:62
    272| 
    273|       expect(workflows).toBeDefined();
    274|       expect(workflows.some((w) => w.id === testWorkflowId)).toBe(trueÎ“Ã‡Âª
       |                                                              ^
    275|     });
    276| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[108/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 14: Remove member from org
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.removeMember server/services/OrganizationService.ts:312:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:285:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[109/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Complete Organization Workflow > Step 16: Re-add member and verify access restored
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:410:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:307:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[110/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Edge Cases and Security > Cannot invite same email twice (pending invite exists)
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:323:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[111/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Edge Cases and Security > Cannot accept expired invite
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.createInvite server/services/OrganizationService.ts:438:5
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:348:22

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[112/322]Î“Ã„Â»

 FAIL  tests/integration/organizations-workflow.test.ts > Organization Workflow Integration Tests > Edge Cases and Security > Cannot transfer workflow to org user is not a member of
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/organizations-workflow.test.ts:373:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[113/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > getUserOrganizations > should return all organizations for user
AssertionError: expected 0 to be greater than 0
 Î“Â¥Â» tests/integration/organizationService.test.ts:108:37
    106|             const userOrgs = await organizationService.getUserOrganizaÎ“Ã‡Âª
    107| 
    108|             expect(userOrgs.length).toBeGreaterThan(0);
       |                                     ^
    109|             const foundOrg = userOrgs.find(o => o.id === org.id);
    110|             expect(foundOrg).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[114/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > getUserOrganizations > should return empty array for user with no memberships
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,ccc793b2-eb04-48fb-a091-70f76ca68a4b,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,ccc793b2-eb04-48fb-a091-70f76ca68a4b,ccc793b2-eb04-48fb-a091-70f76ca68a4b
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ccc793b2-eb04-48fb-a091-70f76ca68a4b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[115/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > updateOrganization > should allow admin to update organization
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,60f28933-54e1-4823-ba91-5bdcd940b8a1,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,60f28933-54e1-4823-ba91-5bdcd940b8a1,60f28933-54e1-4823-ba91-5bdcd940b8a1
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(60f28933-54e1-4823-ba91-5bdcd940b8a1) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[116/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > updateOrganization > should deny non-admin from updating organization
 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > removeMember > should allow admin to remove member
Error: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId
 Î“Â¥Â» tests/integration/organizationService.test.ts:54:19
     52|         if (!userCheck?.tenantId) {
     53|             console.error('CRITICAL: User lookup failed validation in Î“Ã‡Âª
     54|             throw new Error(`Test setup failed: User ${testUserId1} miÎ“Ã‡Âª
       |                   ^
     55|         }
     56|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[117/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > getOrganizationMembers > should return all members of organization
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,1443668c-298a-4e56-9c7f-7eb4f2ab59b8,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,1443668c-298a-4e56-9c7f-7eb4f2ab59b8,1443668c-298a-4e56-9c7f-7eb4f2ab59b8
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1443668c-298a-4e56-9c7f-7eb4f2ab59b8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[118/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > promoteMember > should allow admin to promote member
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,cbc271d3-7d11-4095-8833-bb2e5bf39612,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,cbc271d3-7d11-4095-8833-bb2e5bf39612,cbc271d3-7d11-4095-8833-bb2e5bf39612
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(cbc271d3-7d11-4095-8833-bb2e5bf39612) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[119/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > demoteMember > should allow admin to demote other admin
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/organizationService.test.ts:197:25

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[120/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > demoteMember > should prevent self-demotion
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,4038d3f6-6f96-400d-8d1b-36d697e9549a,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,4038d3f6-6f96-400d-8d1b-36d697e9549a,4038d3f6-6f96-400d-8d1b-36d697e9549a
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4038d3f6-6f96-400d-8d1b-36d697e9549a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[121/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > removeMember > should prevent self-removal
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,5083be75-62e8-4401-8008-30fc876cabd1,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,5083be75-62e8-4401-8008-30fc876cabd1,5083be75-62e8-4401-8008-30fc876cabd1
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5083be75-62e8-4401-8008-30fc876cabd1) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[122/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > leaveOrganization > should allow member to leave organization
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,e06404c9-c661-4aed-9479-58babff8e665,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,e06404c9-c661-4aed-9479-58babff8e665,e06404c9-c661-4aed-9479-58babff8e665
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e06404c9-c661-4aed-9479-58babff8e665) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[123/322]Î“Ã„Â»

 FAIL  tests/integration/organizationService.test.ts > OrganizationService Integration > leaveOrganization > should allow admin to leave organization
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,3e818843-a4a3-4160-a1fa-ad5beafa2385,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,3e818843-a4a3-4160-a1fa-ad5beafa2385,3e818843-a4a3-4160-a1fa-ad5beafa2385
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9
     31| 
     32|         // Create test users with tenantId using upsert to guarantee sÎ“Ã‡Âª
     33|         await db.insert(users).values([
       |         ^
     34|             { id: testUserId1, email: 'orgtest1_int@test.com', fullNamÎ“Ã‡Âª
     35|             { id: testUserId2, email: 'orgtest2_int@test.com', fullNamÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/organizationService.test.ts:33:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(3e818843-a4a3-4160-a1fa-ad5beafa2385) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[124/322]Î“Ã„Â»

 FAIL  tests/integration/ownershipAccess.test.ts > Ownership Access Control > canCreateWithOwnership > should allow creating org-owned asset if user is member
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/ownershipAccess.test.ts:190:7
    188| 
    189|     it('should allow creating org-owned asset if user is member', asynÎ“Ã‡Âª
    190|       await db.insert(organizationMemberships).values({
       |       ^
    191|         orgId: orgId1,
    192|         userId: userId1,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/ownershipAccess.test.ts:190:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w35_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[125/322]Î“Ã„Â»

 FAIL  tests/integration/ownershipAccess.test.ts > Ownership Access Control > Cross-org Access Control > should not allow member of org1 to access org2-owned assets
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/ownershipAccess.test.ts:208:7
    206|   describe('Cross-org Access Control', () => {
    207|     it('should not allow member of org1 to access org2-owned assets', Î“Ã‡Âª
    208|       await db.insert(organizationMemberships).values({
       |       ^
    209|         orgId: orgId1,
    210|         userId: userId1,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/ownershipAccess.test.ts:208:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(10000000-0000-0000-0000-000000000001) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[126/322]Î“Ã„Â»

 FAIL  tests/integration/regression-REG-1.test.ts > REG-1: Workflow Logic Regression > 1. Required + Show/Hide (Questions) > should block Next when required visible question is empty
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 5d300646-8515-4a8c-aa92-cd373239df59,Required Question Test,99fb24d7-cfda-449b-82f9-2dbc894862c2,99fb24d7-cfda-449b-82f9-2dbc894862c2,aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2,a09b3af0-b662-48a7-9513-54350390f0bd
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13
     98|             workflowVersionId = uuidv4();
     99| 
    100|             await db.insert(workflows).values({
       |             ^
    101|                 id: workflowId,
    102|                 projectId,

Caused by: error: null value in column "status" of relation "workflows" violates not-null constraint
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (5d300646-8515-4a8c-aa92-cd373239df59, Required Question Test, null, 99fb24d7-cfda-449b-82f9-2dbc894862c2, null, 2026-01-17 18:55:07.202273, 2026-01-17 18:55:07.202273, 99fb24d7-cfda-449b-82f9-2dbc894862c2, aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2, null, null, null, a09b3af0-b662-48a7-9513-54350390f0bd, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[127/322]Î“Ã„Â»

 FAIL  tests/integration/regression-REG-1.test.ts > REG-1: Workflow Logic Regression > 1. Required + Show/Hide (Questions) > should NOT block Next when required question is hidden
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 04d5f5be-0537-4359-af0e-dd2324ab395c,Required Question Test,99fb24d7-cfda-449b-82f9-2dbc894862c2,99fb24d7-cfda-449b-82f9-2dbc894862c2,aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2,a14424af-011c-4a3b-8229-bb480302336f
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13
     98|             workflowVersionId = uuidv4();
     99| 
    100|             await db.insert(workflows).values({
       |             ^
    101|                 id: workflowId,
    102|                 projectId,

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(99fb24d7-cfda-449b-82f9-2dbc894862c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w43_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[128/322]Î“Ã„Â»

 FAIL  tests/integration/regression-REG-1.test.ts > REG-1: Workflow Logic Regression > 1. Required + Show/Hide (Questions) > should block when required becomes visible and is empty
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 1a73a3db-85d9-4364-a43b-7546a3d01b06,Required Question Test,99fb24d7-cfda-449b-82f9-2dbc894862c2,99fb24d7-cfda-449b-82f9-2dbc894862c2,aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2,8b395a03-efb1-4f64-8993-8591fad28d10
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13
     98|             workflowVersionId = uuidv4();
     99| 
    100|             await db.insert(workflows).values({
       |             ^
    101|                 id: workflowId,
    102|                 projectId,

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:100:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(99fb24d7-cfda-449b-82f9-2dbc894862c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w43_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[129/322]Î“Ã„Â»

 FAIL  tests/integration/regression-REG-1.test.ts > REG-1: Workflow Logic Regression > 2. Required + Show/Hide (Pages) > should skip hidden required page entirely
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: e8c39eca-511d-4591-a3ec-be94caea891b,Page Visibility Test,99fb24d7-cfda-449b-82f9-2dbc894862c2,99fb24d7-cfda-449b-82f9-2dbc894862c2,aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2,651b820b-82fc-423f-bd2a-893befd3931c
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:272:13
    270|             workflowVersionId = uuidv4();
    271| 
    272|             await db.insert(workflows).values({
       |             ^
    273|                 id: workflowId,
    274|                 projectId,

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:272:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(99fb24d7-cfda-449b-82f9-2dbc894862c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[130/322]Î“Ã„Â»

 FAIL  tests/integration/regression-REG-1.test.ts > REG-1: Workflow Logic Regression > 2. Required + Show/Hide (Pages) > should enforce required on visible page
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 27897eae-4e64-495c-a5fa-71ce4c6571fc,Page Required Test,99fb24d7-cfda-449b-82f9-2dbc894862c2,99fb24d7-cfda-449b-82f9-2dbc894862c2,aa9a7cd6-b96e-4fe2-892e-6ce2615cc8d2,2fcf25fc-01c7-407b-bec5-d3d78b63cb25
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:357:13
    355|             workflowVersionId = uuidv4();
    356| 
    357|             await db.insert(workflows).values({
       |             ^
    358|                 id: workflowId,
    359|                 projectId,

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/regression-REG-1.test.ts:357:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(99fb24d7-cfda-449b-82f9-2dbc894862c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w41_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[131/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should list all active sessions for current user
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f208ba7658f248010ca1267351e9769d,$2b$12$1yDjdWubpqKY9y7yQFTcPuoCVhxuP6AvBurm0gBOMK1Fmo5V/A.oK,2026-01-17T18:54:08.945Z,2026-01-17T18:54:08.946Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/session.management.real.test.ts:57:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/session.management.real.test.ts:57:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f208ba7658f248010ca1267351e9769d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[132/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should mark current session correctly
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:119:30
    117|       const token = login2.body.token;
    118|       const cookies = (login2.headers as any)["set-cookie"] as string[Î“Ã‡Âª
    119|       const cookie = cookies.find((c) => c.startsWith("refresh_token="Î“Ã‡Âª
       |                              ^
    120| 
    121|       // List sessions with cookie (should identify current session)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[133/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should exclude revoked sessions
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:155:50
    153|         .update(refreshTokens)
    154|         .set({ revoked: true })
    155|         .where(eq(refreshTokens.id, allTokens[0].id));
       |                                                  ^
    156| 
    157|       // List sessions

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[134/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should order sessions by last used (most recent first)
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:190:36
    188| 
    189|       // Should be ordered by lastUsedAt descending
    190|       for (let i = 1; i < sessions.length; i++) {
       |                                    ^
    191|         const prev = new Date(sessions[i - 1].lastUsedAt);
    192|         const curr = new Date(sessions[i].lastUsedAt);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[135/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > GET /api/auth/sessions > should filter sessions by current user only
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:222:37
    220|         .set("Authorization", `Bearer ${user1Login.body.token}`);
    221| 
    222|       expect(response.body.sessions.length).toBe(2);
       |                                     ^
    223|     });
    224| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[136/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:254:40
    252| 
    253|       const sessions = sessionsResponse.body.sessions;
    254|       const sessionToRevoke = sessions.find((s: any) => !s.current);
       |                                        ^
    255| 
    256|       // Revoke non-current session

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[137/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:289:30
    287|       const token = login.body.token;
    288|       const cookies = (login.headers as any)["set-cookie"] as string[];
    289|       const cookie = cookies.find((c) => c.startsWith("refresh_token="Î“Ã‡Âª
       |                              ^
    290| 
    291|       // Get sessions

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[138/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: afeb58a98f90a3642aca70578400cce8,$2b$12$fup.bTg0qUz9PJFlCNpCguFVFjlK07qSyLGHcDkZEzzjKytwkGqMK,2026-01-17T18:54:23.920Z,2026-01-17T18:54:23.920Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/session.management.real.test.ts:312:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/session.management.real.test.ts:312:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(afeb58a98f90a3642aca70578400cce8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[139/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/:sessionId > should prevent revoking other user's session
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:347:49
    345|         .set("Authorization", `Bearer ${user1Login.body.token}`);
    346| 
    347|       const user1SessionId = user1Sessions.body.sessions[0].id;
       |                                                 ^
    348| 
    349|       // Try to revoke user 1's session as user 2

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[140/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should revoke all other sessions
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b5011a8470be55cc6627a8fdcc0664a6,$2b$12$vYoDMxHyssmdgR62MFdgaOn0z/A43BMP3J1nKMp9o./OuehsICwSy,2026-01-17T18:54:27.585Z,2026-01-17T18:54:27.585Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/session.management.real.test.ts:360:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/session.management.real.test.ts:360:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b5011a8470be55cc6627a8fdcc0664a6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[141/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should keep current session active
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:406:30
    404|       const token = currentLogin.body.token;
    405|       const cookies = (currentLogin.headers as any)["set-cookie"] as sÎ“Ã‡Âª
    406|       const cookie = cookies.find((c) => c.startsWith("refresh_token="Î“Ã‡Âª
       |                              ^
    407| 
    408|       // Revoke all others

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[142/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should revoke all trusted devices
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:458:30
    456|       const token = login.body.token;
    457|       const cookies = (login.headers as any)["set-cookie"] as string[];
    458|       const cookie = cookies.find((c) => c.startsWith("refresh_token="Î“Ã‡Âª
       |                              ^
    459| 
    460|       // Trust a device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[143/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > DELETE /api/auth/sessions/all > should handle user with single session gracefully
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:490:30
    488|       const token = login.body.token;
    489|       const cookies = (login.headers as any)["set-cookie"] as string[];
    490|       const cookie = cookies.find((c) => c.startsWith("refresh_token="Î“Ã‡Âª
       |                              ^
    491| 
    492|       // Revoke all (but only one exists)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[144/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > Session Security > should include device metadata in sessions
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:526:37
    524|         .set("Authorization", `Bearer ${token}`);
    525| 
    526|       const session = response.body.sessions[0];
       |                                     ^
    527| 
    528|       expect(session.deviceName).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[145/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > Session Security > should not expose sensitive token data
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/session.management.real.test.ts:544:37
    542|         .set("Authorization", `Bearer ${login.body.token}`);
    543| 
    544|       const session = response.body.sessions[0];
       |                                     ^
    545| 
    546|       // Should NOT include token hash or metadata

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[146/322]Î“Ã„Â»

 FAIL  tests/integration/session.management.real.test.ts > Session Management Integration Tests (REAL) > Session Security > should track session activity timestamps
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 16c531083ce660a407d272c366637416,$2b$12$9Ezrh1K4kBV/Yu.DbquXEuhM02eeKnHp2HQmFLsrV/X8WqxgNJVPe,2026-01-17T18:54:39.927Z,2026-01-17T18:54:39.927Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» tests/integration/session.management.real.test.ts:552:43

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» tests/integration/session.management.real.test.ts:552:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(16c531083ce660a407d272c366637416) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[147/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Project Transfer > should transfer user-owned project to org
 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Project Transfer > should prevent transfer to org if user is not a member
 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Workflow Transfer > should detach workflow from project when transferring to different owner
 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Database Transfer > should prevent transfer to org if user is not a member
Error: User must belong to a tenant to create organizations
 Î“Â¥Â» OrganizationService.createOrganization server/services/OrganizationService.ts:49:13
     47| 
     48|     if (!user?.tenantId) {
     49|       throw new Error('User must belong to a tenant to create organizaÎ“Ã‡Âª
       |             ^
     50|     }
     51| 
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:57:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[148/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Project Transfer > should allow org member to transfer org-owned project to another org they belong to
 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Workflow Transfer > should prevent non-member from transferring org workflow
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000031,transfer1@test.com,Transfer User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000032,transfer2@test.com,Transfer User 2,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000099
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:48:9
     46| 
     47|         // Create test users
     48|         await db.insert(users).values([
       |         ^
     49|             { id: userId1, email: 'transfer1@test.com', fullName: 'TraÎ“Ã‡Âª
     50|             { id: userId2, email: 'transfer2@test.com', fullName: 'TraÎ“Ã‡Âª

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:48:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[149/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Workflow Transfer > should keep workflow in project when transferring to same owner
Error: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Transfer Test Org,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000031
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» server/services/OrganizationService.ts:54:21
     52|     return db.transaction(async (tx) => {
     53|       // Create organization with tenant scoping
     54|       const [org] = await tx
       |                     ^
     55|         .insert(organizations)
     56|         .values({
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:57:21

Caused by: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg/lib/client.js:545:17
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» server/services/OrganizationService.ts:54:21
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:57:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 346, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[150/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Database Transfer > should transfer database ownership
Error: Access denied: Organization admin role required
 Î“Â¥Â» requireOrgAdmin server/utils/ownershipAccess.ts:195:11
    193|   const isAdmin = await canManageOrg(userId, orgId);
    194|   if (!isAdmin) {
    195|     throw new Error('Access denied: Organization admin role required');
       |           ^
    196|   }
    197| }
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:410:5
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:64:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[151/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Database Transfer > should allow org member to transfer org database
Error: Access denied: You do not have permission to create assets with this ownership
 Î“Â¥Â» DatavaultDatabasesService.createDatabase server/services/DatavaultDatabasesService.ts:70:15
     68|       const canCreate = await canCreateWithOwnership(input.creatorId, Î“Ã‡Âª
     69|       if (!canCreate) {
     70|         throw new Error('Access denied: You do not have permission to Î“Ã‡Âª
       |               ^
     71|       }
     72|     }
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:290:30

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[152/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Transfer Validation > should only allow transfer to self when targetOwnerType is user
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 941068b4-9afd-4f31-82bd-044a6d206727,00000000-0000-0000-0000-000000000032,member
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:420:5
    418| 
    419|     // Add membership
    420|     await db.insert(organizationMemberships).values({
       |     ^
    421|       orgId,
    422|       userId: targetUserId,
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:64:9

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:420:5
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:64:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 399, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(941068b4-9afd-4f31-82bd-044a6d206727) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[153/322]Î“Ã„Â»

 FAIL  tests/integration/transferOwnership.test.ts > Transfer Ownership > Transfer Validation > should allow transfer from user to self (org member transferring org asset to themselves)
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 7f8e5b6a-f233-4e46-83f5-bded13b34bc1,00000000-0000-0000-0000-000000000032,member
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:420:5
    418| 
    419|     // Add membership
    420|     await db.insert(organizationMemberships).values({
       |     ^
    421|       orgId,
    422|       userId: targetUserId,
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:64:9

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» OrganizationService.addMember server/services/OrganizationService.ts:420:5
 Î“Â¥Â» tests/integration/transferOwnership.test.ts:64:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(7f8e5b6a-f233-4e46-83f5-bded13b34bc1) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[154/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 42d69879a3d00a860180c7735bd9a32e,$2b$12$y7FAJaX8uT0Rs8FZVbq/U.7GQAvbm2OCahBMi/vYPOm35pRSwBM9O,2026-01-17T18:54:08.963Z,2026-01-17T18:54:08.963Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:58:55

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:58:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(42d69879a3d00a860180c7735bd9a32e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[155/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 989c6a6e456c88c9791ca5d42da6524b,$2b$12$Xv2ygHJ41h.7Xkgs9kvSCurZzWqGNkqqgXBsrI2d9O9H8we.HBvjC,2026-01-17T18:54:09.591Z,2026-01-17T18:54:09.591Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:97:55

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:97:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(989c6a6e456c88c9791ca5d42da6524b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[156/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 1871d3406d8ea4af52654709a67d0f78,LASV46BZK5TUIZDQHYXTMRRTMNEUSVBOMJMGCSTQIZJDCZS5FRLA,true,2026-01-17T18:54:10.463Z,2026-01-17T18:54:10.463Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:124:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:124:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1871d3406d8ea4af52654709a67d0f78) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[157/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: b64d6b4c9b10c35b329e8e3872a912e0,H5XGGR3RJ54TY5JKER3FC22XIJSDS62PIQ2V4IKHNZXEYV3FGB5Q,true,2026-01-17T18:54:11.407Z,2026-01-17T18:54:11.407Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:183:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:183:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b64d6b4c9b10c35b329e8e3872a912e0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[158/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 90aa77605ae17d19b7c7398c93e8e06e,$2b$12$8WVCzz1Kg97yBKQmPkUEiuHbHRANnVgkdk8GVOmsc4Api4ewnXKxq,2026-01-17T18:54:12.170Z,2026-01-17T18:54:12.170Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:240:55

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:240:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(90aa77605ae17d19b7c7398c93e8e06e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[159/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 92500246d01773a01f8df2afa388d98c,$2b$12$fciv.1q/NT9gATUYFEnE3ewkGUSMibbmKZ33E4sT4DvW91sgmwGLq,2026-01-17T18:54:12.825Z,2026-01-17T18:54:12.825Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:272:55

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:272:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(92500246d01773a01f8df2afa388d98c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[160/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: a45c004e1c96767eb9d476f67fb525c9,IERWQZ3QJNYDIKDVIFZVI43XENHUM5CJJQQWKVDIINUUSLROGZKA,true,2026-01-17T18:54:13.540Z,2026-01-17T18:54:13.540Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:305:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:305:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 311, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a45c004e1c96767eb9d476f67fb525c9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[161/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Error: [TEST UTILS] MFA Secret verification failed for 1c5592593d2d38dca2ec5848704a3ebe
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:341:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[162/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: aaa8db99ba9272db3615ecdb61db9b7e,$2b$12$VTw6Bjh0y7EgHnNitrImjejUYYtr9.0dHasGdiR2JrZknFMmGrS4u,2026-01-17T18:54:14.641Z,2026-01-17T18:54:14.641Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
    164| 
    165|   // Create credentials
    166|   await db.insert(userCredentials).values({
       |   ^
    167|     userId,
    168|     passwordHash,
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:391:55

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createTestUser tests/helpers/testUtils.ts:166:3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:206:20
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:391:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(aaa8db99ba9272db3615ecdb61db9b7e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[163/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for f8b201ec95585825f2a44eea03c55497
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:412:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[164/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Error: [TEST UTILS] MFA Secret verification failed for 67108ed2bd9bc0a0be9b690d13bab1cf
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:228:22
    226|     where: eq(mfaSecrets.userId, userData.userId)
    227|   });
    228|   if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fÎ“Ã‡Âª
       |                      ^
    229|   if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableÎ“Ã‡Âª
    230|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:459:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[165/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 7b307d2253723b2a4c7c211cb33b6a14,N4SWW3CQHFWE23SFKZ4UG62LF5KDEYJPJRPHIXSUPMZXQSD5M4RQ,true,2026-01-17T18:54:17.689Z,2026-01-17T18:54:17.689Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:497:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:497:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7b307d2253723b2a4c7c211cb33b6a14) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[166/322]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Error: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 0de49f4a793e2dbf84b3c9cca0801368,IFPH2LTUMJVS442AMQSHK3SNHJBGY53BGJGXI43DOU4US43EMRGA,true,2026-01-17T18:54:18.418Z,2026-01-17T18:54:18.418Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
    214| 
    215|   // Store MFA secret
    216|   await db.insert(mfaSecrets).values({
       |   ^
    217|     userId: userData.userId,
    218|     secret: secret.base32,
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:528:55

Caused by: error: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:216:3
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:528:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0de49f4a793e2dbf84b3c9cca0801368) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[167/322]Î“Ã„Â»

 FAIL  tests/integration/variableSafety.test.ts > Variable Schema Safety & Resolution > REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: c60f23c8-7ff3-46f3-8aa7-b14fc7cbb58f,safety - aff5d073-f06b-465e-83d5-97e7106d6496 @example.com,2af48cae-790d-4b83-a521-e610a83ec2ef,admin,owner,local
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9
     49| 
     50|         userId = uuidv4();
     51|         await db.insert(usersSchema).values({
       |         ^
     52|             id: userId,
     53|             email: `safety - ${uuidv4()} @example.com`,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2af48cae-790d-4b83-a521-e610a83ec2ef) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w36_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[168/322]Î“Ã„Â»

 FAIL  tests/integration/variableSafety.test.ts > Variable Schema Safety & Resolution > ScriptEngine resolves alias 'input_variable' when aliasMap is provided
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 30ef8b25-a07f-4354-9d0b-6d2d35bdc038,Safety Workflow,7bf9cb13-0fce-4888-9e37-4581d5add422,7bf9cb13-0fce-4888-9e37-4581d5add422,f521e288-ebaf-429a-8f24-8e70453ce491,7c00e9b0-e8a8-448c-8b46-01ecb4c81303
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/variableSafety.test.ts:75:9
     73|         workflowId = uuidv4();
     74|         versionId = uuidv4();
     75|         await db.insert(workflowsSchema).values({
       |         ^
     76|             id: workflowId,
     77|             projectId,

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/variableSafety.test.ts:75:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(7bf9cb13-0fce-4888-9e37-4581d5add422) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[169/322]Î“Ã„Â»

 FAIL  tests/integration/variableSafety.test.ts > Variable Schema Safety & Resolution > REPRO: BlockRunner fails to resolve alias in CreateRecordConfig
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: c30b95e7-1702-4f25-92b3-c52f98888a4c,safety - f784c7fd-b7bb-47f0-8c3d-35d13adafc72 @example.com,aa1274c5-44f5-4a1c-8e86-aed9549fab5c,admin,owner,local
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9
     49| 
     50|         userId = uuidv4();
     51|         await db.insert(usersSchema).values({
       |         ^
     52|             id: userId,
     53|             email: `safety - ${uuidv4()} @example.com`,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(aa1274c5-44f5-4a1c-8e86-aed9549fab5c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[170/322]Î“Ã„Â»

 FAIL  tests/integration/variableSafety.test.ts > Variable Schema Safety & Resolution > BlockRunner logic resolves alias with aliasMap
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 7938fb49-fae2-45df-b97b-ea75c55869ae,safety - 0cdc6c16-7312-463a-85aa-8b6b102374f0 @example.com,92f7db04-9b50-4419-840e-4a63848817dd,admin,owner,local
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9
     49| 
     50|         userId = uuidv4();
     51|         await db.insert(usersSchema).values({
       |         ^
     52|             id: userId,
     53|             email: `safety - ${uuidv4()} @example.com`,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/variableSafety.test.ts:51:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(92f7db04-9b50-4419-840e-4a63848817dd) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[171/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.callback.test.ts > OAuth2 3-Legged Flow - Callback Handling > OAuth2 Authorization Flow Initiation > should initiate OAuth2 3-legged flow and generate authorization URL
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 Î“Â¥Â» tests/integration/auth/oauth2.callback.test.ts:125:37
    123|         });
    124| 
    125|       expect(createResponse.status).toBe(201);
       |                                     ^
    126|       testConnectionId = createResponse.body.id;
    127| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[172/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.callback.test.ts > OAuth2 3-Legged Flow - Callback Handling > OAuth2 Connection Status > should track OAuth2 connection status
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 Î“Â¥Â» tests/integration/auth/oauth2.callback.test.ts:309:37
    307|         });
    308| 
    309|       expect(createResponse.status).toBe(201);
       |                                     ^
    310|       const connectionId = createResponse.body.id;
    311| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[173/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.google.test.ts > OAuth2 Google Authentication Flow > POST /api/auth/google - Google OAuth2 Login > should successfully authenticate with valid Google ID token
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:91:31
     89| 
     90|       // Verify response
     91|       expect(response.status).toBe(200);
       |                               ^
     92|       expect(response.body).toMatchObject({
     93|         message: 'Authentication successful',

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[174/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.google.test.ts > OAuth2 Google Authentication Flow > POST /api/auth/google - Google OAuth2 Login > should update existing user on subsequent logins
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default)
params: google-user-existing,existing@example.com,Old Name,Old,Name,40898d50-d9b9-467e-9b1d-0df98f147da1,creator,viewer,google,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:218:7
    216| 
    217|       // Create existing user
    218|       await db.insert(users).values({
       |       ^
    219|         id: userId,
    220|         email: 'existing@example.com',

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:218:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(40898d50-d9b9-467e-9b1d-0df98f147da1) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w43_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[175/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.google.test.ts > OAuth2 Google Authentication Flow > POST /api/auth/google - Google OAuth2 Login > should create refresh token record in database
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:297:31
    295|         });
    296| 
    297|       expect(response.status).toBe(200);
       |                               ^
    298| 
    299|       // Verify refresh token exists in database

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[176/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.google.test.ts > OAuth2 Google Authentication Flow > POST /api/auth/google - Google OAuth2 Login > should support both "token" and "idToken" fields
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:332:31
    330|         });
    331| 
    332|       expect(response.status).toBe(200);
       |                               ^
    333|       expect(response.body.message).toBe('Authentication successful');
    334|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[177/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.google.test.ts > OAuth2 Google Authentication Flow > POST /api/auth/google - Google OAuth2 Login > should handle missing profile information gracefully
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.google.test.ts:395:31
    393|         });
    394| 
    395|       expect(response.status).toBe(200);
       |                               ^
    396|       expect(response.body.user).toMatchObject({
    397|         email: 'minimal@example.com',

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[178/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should list all active sessions for current user
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: h637GXrdj2J1p5p0Ug-WF,session-test-QEVOMXKeC2lh_kTwisz1H@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[179/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should return empty array when user has no active sessions
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: m0QUpnjyVzJRLCHK-DkJZ,session-test-UlRK4Ia6nUDpH1N3F5SFQ@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[180/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should not include expired sessions
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UpvlsJEs5PrlLM3-haw63,session-test-PhXEaknWcW9GYuKdAytDD@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[181/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should not include revoked sessions
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5OpCcIGRtG4nizyXqOWm-,session-test-cHgQLcLwfj9n2iPBASm1i@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[182/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should parse device name from user agent
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: STAjyzZW7hcZ9yi_o57Tp,session-test-XrJYuwABQCH5v_mm1RxLw@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[183/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > GET /api/auth/sessions - List Active Sessions > should return 401 for unauthenticated request
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: NN6OoTmMbd0hnDSSFMS8-,session-test-HUpuMTYuOGVHrqBUsguCJ@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[184/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should revoke a specific session
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fgYpak5pmks9YF0f2rQVs,session-test-m1TgFBWOnrxKJMAJvKmNJ@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[185/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should return 404 for non-existent session
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: dQe3CBm8TL2CHloA9KHgR,session-test-IhXvRq1dOFizFX7Oqi04X@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[186/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should prevent revoking current session
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: gKltLKSWY1a-hDwt6hCvT,session-test-Q4sIDMsEBzO3iqf5hEO_X@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[187/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should prevent revoking another user's session
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: KevilTxMhI2Ejt5oqwPCI,session-test-WzK-CmC_r42gJrAz9GmHv@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[188/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/:sessionId - Revoke Session > should return 401 for unauthenticated request
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: IgUbB2GVM0XfbFw9kI2rE,session-test-5wVrE0uAkwIm9fdOdWxvF@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[189/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/all - Logout All Other Devices > should revoke all sessions except current
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: G8u6PbIQzYNw8IUMi0GPr,session-test-6LQ8KgzaqhSo7xWCP-rJy@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[190/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/all - Logout All Other Devices > should revoke all trusted devices
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: F1tuHseMPlCsHiC3cRSqO,session-test-5t-dqpulVEh_SATOu-EHK@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[191/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/all - Logout All Other Devices > should return 400 when no active session found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: xs8Yrqsct05ABitmlL4Ng,session-test-tjWIqhG7yj3Hxo2N7S2An@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[192/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > DELETE /api/auth/sessions/all - Logout All Other Devices > should return 401 for unauthenticated request
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: R-Px6hHD2p2oGTMBitJME,session-test-sNnOrHGLCa8pJVbKEFjpw@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[193/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > POST /api/auth/trust-device > should mark current device as trusted
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: zsiBu1xH1AIDBWnapySDa,session-test-ioRQSXC-pHcBvPtQhCig0@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[194/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > POST /api/auth/trust-device > should update existing trusted device expiry
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 80tXLkbvOSifF7GvKC3l_,session-test-WnnM_W4Uy9THPBS4uIJ_E@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[195/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > GET /api/auth/trusted-devices > should list all trusted devices
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: huIJeVfKxEHrVtVphGjxa,session-test-LYCpQTssjyfZ6tPoyeSBU@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[196/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > GET /api/auth/trusted-devices > should not include revoked devices
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: QiARS3v_NJI1IXv6Hh7Ai,session-test-tr21zOctWR9ZaaH73IKrE@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[197/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > DELETE /api/auth/trusted-devices/:deviceId > should revoke a trusted device
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ITfrNb3_i7IPE3ok72sWS,session-test-xurjcqfQxyec0si6I7hV9@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[198/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: pKmzKiHiunMF7ajiieHfj,session-test-bpgEghAPE6ZLrvJf_21ua@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[199/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should track IP address for sessions
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fhUI2_oKxZFCgvcU52Qn6,session-test-njBffwAQ5ZeSTDBhXxdR3@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[200/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should track user agent for sessions
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: tm9CvIfqYM2y4TXfgF2xo,session-test-yF2jDVRHKSnk4oGYX4iB3@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[201/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should update lastUsedAt on token refresh
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: iB2n-9CCX72Hm-0otS4vZ,session-test-kinX1dcwEyeuycKB8PCex@example.com,Session Test,Session,Test,10c4453c-1ea0-4724-b608-26e07b297c5f,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20
     51|     testUserEmail = `session-test-${nanoid()}@example.com`;
     52| 
     53|     const [user] = await db.insert(users).values({
       |                    ^
     54|       id: nanoid(),
     55|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:53:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(10c4453c-1ea0-4724-b608-26e07b297c5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w27_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[202/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should refresh access token with valid refresh token
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: YsIOSYma1NdYhw-Y0PWRO,$2b$12$l8vGIF/vi.y7WO.1L.U1WugOUxxFkUycpxI71R/j6npGruA9PbEx2
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:42:29
     40| 
     41|     try {
     42|       const [credentials] = await database
       |                             ^
     43|         .insert(userCredentials)
     44|         .values({
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:72:5

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:42:29
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:72:5

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(YsIOSYma1NdYhw-Y0PWRO) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[203/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should rotate refresh token after use
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: yRR2aAg7EAY3sXNXdIuwL,refresh-test-d-n8i-QuXD0mhQxjMQs-v@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[204/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should return 401 when refresh token is missing
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: G-zoP-75tmgt9i0bmzwTg,refresh-test-74Uq4a0jY68fd0jtqaO2T@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[205/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should return 401 for invalid refresh token
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: _ytbLy9__FudqAZIodct4,refresh-test-4aM5tj_OmbAKhS9rgBRNL@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[206/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should return 401 for expired refresh token
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7R8Is894yn-zWwLOS3B-C,refresh-test-xuEawoNzkfYneg-cGQV5A@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[207/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should return 401 for revoked refresh token
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: E1N8-BYH9LjmajeTIKiqA,refresh-test-H-C9lKxBiD1oWDTdM3MJn@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[208/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should return 401 when user is not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LVkDr3rwWHgPJAhv3v9KO,refresh-test-EMUrxP2BbaWSyr15iWdMj@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[209/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should update refresh token metadata on rotation
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: i0obytgBJMW6ty1D28fnG,refresh-test-Ue4ZCxEF_FAv-wPhKYPo_@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[210/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should handle concurrent refresh token requests (token reuse detection)
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: KDJ1bRKm8MI8gfy7YIsEY,refresh-test-JMz-9UKOBerA_wskbPL8L@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[211/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set secure cookie in production
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Yu3-xgtESd3VG-ZFt_-T6,refresh-test-0Yb6lbVJvPa-WMVfK-LXE@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[212/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set proper cookie attributes
Error: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: 99liJXI7RyTQk5nH97JCv,$2b$12$4UY28.i.c.Vqj7BIKb9UCO.gLzevOM2EeBJ94dfCwEFa7S0S4euKa
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:42:29
     40| 
     41|     try {
     42|       const [credentials] = await database
       |                             ^
     43|         .insert(userCredentials)
     44|         .values({
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:72:5

Caused by: error: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:42:29
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:72:5

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(99liJXI7RyTQk5nH97JCv) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[213/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should include user role information in response
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 04TXcAoWRlK4oUDSo9VAI,refresh-test-GEgOeeHLDPZiEuinhXJ44@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[214/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oCN_KBoi7mc10pzJE2pbz,refresh-test-cODB0v5ziWPFCjjB5AJMx@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[215/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should support multiple active refresh tokens per user
Error: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: wChvr20Cyq1H4t7IGtqO8,ec70b58aa6a8cc6e41d1f8fc66ea3743f0b179d40ef7c982f344aa2f2f9a39d6,2026-02-16T18:54:16.359Z,false,{"ip":"127.0.0.1","userAgent":"Test Agent"},Unknown Browser on Unknown OS,127.0.0.1,Location Unknown,2026-01-17T18:54:16.360Z
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» AuthService.createRefreshToken server/services/AuthService.ts:343:9
    341|         const location = ipAddress ? getLocationFromIP(ipAddress) : nuÎ“Ã‡Âª
    342| 
    343|         await this.db.insert(refreshTokens).values({
       |         ^
    344|             userId,
    345|             token: tokenHash,
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:75:24

Caused by: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» AuthService.createRefreshToken server/services/AuthService.ts:343:9
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:75:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(wChvr20Cyq1H4t7IGtqO8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'refresh_tokens', dataType: undefined, constraint: 'refresh_tokens_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[216/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should revoke all user tokens on password reset
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: hYGgm9zUx7kCA9IpDPL4g,refresh-test-Nu4CPM4DuM1KzzuwgyRqN@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[217/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should use cryptographically strong random tokens
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fNi9hiirt60QjdA_GkOCc,refresh-test-TfjEWiNG1bEiSSytlkfek@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[218/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should hash refresh tokens before storing in database
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LQFpueqCHAqwmZDjvcFoH,refresh-test-hQ2fZBkbPQPDFsBbJdCY7@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[219/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should prevent refresh token reuse after rotation
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: -v0gqnBKloMJ54QpTzQ7a,refresh-test-7AM0Xz_sPJtH-tZH-wxD5@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[220/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should validate token ownership
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7D5LRRrkfIyP9EqL7NBsl,refresh-test-k0SXGI1WtbBHVuhkkqpFr@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[221/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Cookie Security > should set HttpOnly flag to prevent XSS
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: F_OHWQbuC9B_lMtiKQ3LX,refresh-test-uZdiNnyo1uCTsT9cxV39h@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[222/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Cookie Security > should set SameSite=Strict to prevent CSRF
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3BrhFJwR5Bh9nua6QfCyH,refresh-test-RoKkie4rdIVTwrE-QpjuX@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[223/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Cookie Security > should set proper cookie path
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: j2uDpQkpHfIvl__BSa21J,refresh-test-CpVJLN0qLrVFlk94eYIRT@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[224/322]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Cookie Security > should set appropriate expiry (30 days)
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: VsAPEG3UiANqsGh_nZtQl,refresh-test-RJxYi1ibTinf-i0r8vV32@example.com,Refresh Test,Refresh,Test,9daef8b3-5526-4d92-a8ba-e04f0a84b141,creator,owner,local,easy,true
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20
     53|     testUserEmail = `refresh-test-${nanoid()}@example.com`;
     54| 
     55|     const [user] = await db.insert(users).values({
       |                    ^
     56|       id: nanoid(),
     57|       email: testUserEmail,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:55:20

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9daef8b3-5526-4d92-a8ba-e04f0a84b141) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[225/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Template Key Resolution (New Path) > should resolve template by key from workflowTemplates mapping
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8149b31d-b981-4058-af4d-55d392d1bcb5,test-1768676076917@example.com,Test User,Test,User,d15d305c-6754-405d-800e-1622a06c9a5f,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d15d305c-6754-405d-800e-1622a06c9a5f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[226/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Template Key Resolution (New Path) > should throw error if template key not found
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 816cb68a-1032-4378-8aac-033ef30993b2,853ba9ad-8185-4c05-88da-20b01b7fb427,Engagement Letter,Main engagement letter,template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
    232|     overrides?: Partial<typeof schema.templates.$inferInsert>
    233|   ): Promise<TestTemplate> {
    234|     const [template] = await this.db
       |                        ^
    235|       .insert(schema.templates)
    236|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(853ba9ad-8185-4c05-88da-20b01b7fb427) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[227/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Template Key Resolution (New Path) > should store output in runOutputs table
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 347572e3-c21a-4c53-bb42-7ddb1fec186b,Test Project,Test Project,Test project for integration tests,7e047425-d59e-449b-8559-10aabd3b2b32,0a775e18-c974-47f2-98b2-d7d45e53d813,7e047425-d59e-449b-8559-10aabd3b2b32,7e047425-d59e-449b-8559-10aabd3b2b32
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
    120| 
    121|     // Create project with all required ownership fields
    122|     const [project] = await this.db
       |                       ^
    123|       .insert(schema.projects)
    124|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(7e047425-d59e-449b-8559-10aabd3b2b32) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[228/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Legacy Template ID Path (Backward Compatibility) > should resolve template by templateId directly
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: acc9b148-d9e3-4eba-b396-16feb36bec88,Test Project,Test Project,Test project for integration tests,6137a55d-62ec-40fa-a44e-d6028dafb686,0f6926ba-bd98-4d4b-b5a8-0fcd28f5bf67,6137a55d-62ec-40fa-a44e-d6028dafb686,6137a55d-62ec-40fa-a44e-d6028dafb686
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
    120| 
    121|     // Create project with all required ownership fields
    122|     const [project] = await this.db
       |                       ^
    123|       .insert(schema.projects)
    124|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6137a55d-62ec-40fa-a44e-d6028dafb686) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[229/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Legacy Template ID Path (Backward Compatibility) > should throw error if templateId not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 15710a20-45c1-4d8d-bb96-b5838781adb5,test-1768676079838@example.com,Test User,Test,User,6020e8d6-d1b4-4e9f-a678-2776c99023ce,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6020e8d6-d1b4-4e9f-a678-2776c99023ce) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[230/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Rendering Engine Selection > should use docxRenderer2 by default (v2 engine)
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 5a8c45c1-737b-4d45-b4f2-204ccdcc6acb,bcd89e9d-e72f-4aa2-a458-4bc828d4699e,Engagement Letter,Main engagement letter,template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
    232|     overrides?: Partial<typeof schema.templates.$inferInsert>
    233|   ): Promise<TestTemplate> {
    234|     const [template] = await this.db
       |                        ^
    235|       .insert(schema.templates)
    236|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 325, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(bcd89e9d-e72f-4aa2-a458-4bc828d4699e) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[231/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Rendering Engine Selection > should use legacy engine when engine="legacy"
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8a721f3b-8855-4747-8277-4df7c99f72dd,test-1768676081701@example.com,Test User,Test,User,7e0c7bee-96a5-4b73-8b0a-34a8e3415319,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(7e0c7bee-96a5-4b73-8b0a-34a8e3415319) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[232/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > PDF Generation > should generate PDF when toPdf=true
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3bc863ba-a2d8-49fb-9ffa-46b700843517,test-1768676082201@example.com,Test User,Test,User,fe72a101-c62a-4e87-8064-793cc8e28c03,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(fe72a101-c62a-4e87-8064-793cc8e28c03) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[233/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > PDF Generation > should default to DOCX when toPdf=false
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, default, $7, default, default, default, default, default, default, $8, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 77788a40-2a6d-4d46-8a04-a721b35051b6,Test Workflow,Test workflow,8607f052-e02c-4cf2-bc0b-ad1a9cd84374,8607f052-e02c-4cf2-bc0b-ad1a9cd84374,test-workflow-6569c6c9-dc1a-439f-8c08-d77acc9efdb0,4d34185f-3b72-47d9-a573-aef34ac626c3,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
    149|     }
    150|   ): Promise<TestWorkflow> {
    151|     const [workflow] = await this.db
       |                        ^
    152|       .insert(schema.workflows)
    153|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:87:35

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:87:35

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8607f052-e02c-4cf2-bc0b-ad1a9cd84374) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[234/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Conditional Execution > should skip execution when condition evaluates to false
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 415f2ab8-4dd6-41ae-ba6a-6d2584470c76,test-1768676083385@example.com,Test User,Test,User,aa852eea-1104-4b3c-a264-7e0bd221f3a4,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(aa852eea-1104-4b3c-a264-7e0bd221f3a4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[235/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Binding Resolution > should resolve simple bindings
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 6259b12f-7909-407b-8b68-cae1e84a9fde,972f38a1-059f-42db-9146-644875e5c038,Engagement Letter,Main engagement letter,template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
    232|     overrides?: Partial<typeof schema.templates.$inferInsert>
    233|   ): Promise<TestTemplate> {
    234|     const [template] = await this.db
       |                        ^
    235|       .insert(schema.templates)
    236|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 325, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(972f38a1-059f-42db-9146-644875e5c038) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[236/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Error Handling > should record failed output in runOutputs table
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3804875e-c86e-4b10-bebd-986e1a959f63,test-1768676086495@example.com,Test User,Test,User,6f48c293-a064-4f7c-a293-f2b660adda58,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:81:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6f48c293-a064-4f7c-a293-f2b660adda58) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[237/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Tenant Access Control > should deny access to templates from different tenant
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 1037dfa3-9ae8-42d5-b33b-acf94e689caa,c0c93c5e-5e7c-4872-9ae2-b1fd6d92b6c9,1,{},"Initial version",8c840604-ca7f-46d9-b77a-d4cedbef8311
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:166:23
    164|       .returning();
    165| 
    166|     const [version] = await this.db
       |                       ^
    167|       .insert(schema.workflowVersions)
    168|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:87:35

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:166:23
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:87:35

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 363, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(c0c93c5e-5e7c-4872-9ae2-b1fd6d92b6c9) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[238/322]Î“Ã„Â»

 FAIL  tests/unit/engine/templateNode.test.ts > Template Node - Multi-Template Support > Validation > should require either templateKey or templateId
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: a2780e65-48b7-4271-91d8-8f1e1c16a66a,e5e1d2e3-1f11-43f4-84ae-5b3344e19a9a,Engagement Letter,Main engagement letter,template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
    232|     overrides?: Partial<typeof schema.templates.$inferInsert>
    233|   ): Promise<TestTemplate> {
    234|     const [template] = await this.db
       |                        ^
    235|       .insert(schema.templates)
    236|       .values({
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
 Î“Â¥Â» tests/unit/engine/templateNode.test.ts:100:37

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(e5e1d2e3-1f11-43f4-84ae-5b3344e19a9a) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[239/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > create > should create a workflow template mapping
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,e5f58f54-a7d0-40be-aa87-2c6ad80ab308,e5f58f54-a7d0-40be-aa87-2c6ad80ab308,d487b9b3-e7e1-44f4-955e-134985b97488,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24
     50| 
     51|     // Create test workflow
     52|     const [workflow] = await db
       |                        ^
     53|       .insert(workflows)
     54|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e5f58f54-a7d0-40be-aa87-2c6ad80ab308) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[240/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > create > should create non-primary mapping by default
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: f8b78986-02bd-4c92-b382-50127b68f041,1,true,{},"Initial version",4e0832e8-e3bc-4e63-85cf-00baab3f6bb9
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:66:23
     64| 
     65|     // Create test workflow version
     66|     const [version] = await db
       |                       ^
     67|       .insert(workflowVersions)
     68|       .values({

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:66:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(f8b78986-02bd-4c92-b382-50127b68f041) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[241/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findByWorkflowVersionId > should find all templates for a workflow version
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,c95848ad-f30a-44b7-ba39-550d92a0c1e1,c95848ad-f30a-44b7-ba39-550d92a0c1e1,c95848ad-f30a-44b7-ba39-550d92a0c1e1
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c95848ad-f30a-44b7-ba39-550d92a0c1e1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[242/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findByWorkflowVersionId > should return empty array for version with no templates
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,377e5d5a-3af6-440e-af53-1884ed51ac96,377e5d5a-3af6-440e-af53-1884ed51ac96,377e5d5a-3af6-440e-af53-1884ed51ac96
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(377e5d5a-3af6-440e-af53-1884ed51ac96) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[243/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findByWorkflowVersionId > should order by createdAt desc (newest first)
Error: Failed query: insert into "workflow_templates" ("id", "workflow_version_id", "template_id", "key", "is_primary", "created_at", "updated_at") values (default, $1, $2, $3, default, default, default) returning "id", "workflow_version_id", "template_id", "key", "is_primary", "created_at", "updated_at"
params: 4811ea02-531d-4026-b6a4-66435de6f6de,098a1230-210d-4097-acdc-134832551c6d,first
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowTemplateRepository.create server/repositories/BaseRepository.ts:90:22
     88|     const database = this.getDb(tx);
     89| 
     90|     const [record] = await database
       |                      ^
     91|       .insert(this.table as any)
     92|       .values(data as any)
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:172:21

Caused by: error: insert or update on table "workflow_templates" violates foreign key constraint "workflow_templates_workflow_version_id_workflow_versions_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowTemplateRepository.create server/repositories/BaseRepository.ts:90:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:172:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 427, severity: 'ERROR', code: '23503', detail: 'Key (workflow_version_id)=(4811ea02-531d-4026-b6a4-66435de6f6de) is not present in table "workflow_versions".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'workflow_templates', dataType: undefined, constraint: 'workflow_templates_workflow_version_id_workflow_versions_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[244/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findByWorkflowVersionAndKey > should find mapping by workflow version and key
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 36b73bce-3dac-4d99-a306-67bb7e74881c,Template 1,First test template,/uploads/template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:80:25
     78| 
     79|     // Create test templates
     80|     const [template1] = await db
       |                         ^
     81|       .insert(templates)
     82|       .values({

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:80:25

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(36b73bce-3dac-4d99-a306-67bb7e74881c) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[245/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findByWorkflowVersionAndKey > should return undefined for non-existent key
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,c3075f50-704f-4443-925b-2228640754c2,c3075f50-704f-4443-925b-2228640754c2,f00c0fe2-3dcb-420e-8fe2-910fc4447bd6,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24
     50| 
     51|     // Create test workflow
     52|     const [workflow] = await db
       |                        ^
     53|       .insert(workflows)
     54|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c3075f50-704f-4443-925b-2228640754c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w21_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[246/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findPrimaryByWorkflowVersionId > should find primary template for workflow version
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 4eaa234d-b6db-4454-b15c-9d1ffb1db2a6,Template 1,First test template,/uploads/template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:80:25
     78| 
     79|     // Create test templates
     80|     const [template1] = await db
       |                         ^
     81|       .insert(templates)
     82|       .values({

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:80:25

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(4eaa234d-b6db-4454-b15c-9d1ffb1db2a6) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[247/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findPrimaryByWorkflowVersionId > should return undefined when no primary template exists
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,2e71c56a-4fdd-4257-bcc6-cee002b686a9,2e71c56a-4fdd-4257-bcc6-cee002b686a9,2e71c56a-4fdd-4257-bcc6-cee002b686a9
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2e71c56a-4fdd-4257-bcc6-cee002b686a9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[248/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > setPrimary > should set a template as primary and unset others
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,3d01fc7e-dd5d-4779-8b2b-730557058f54,3d01fc7e-dd5d-4779-8b2b-730557058f54,3d01fc7e-dd5d-4779-8b2b-730557058f54
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3d01fc7e-dd5d-4779-8b2b-730557058f54) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[249/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > setPrimary > should handle setting primary when none existed before
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,347b4499-b0c4-4570-9adf-e492de246ac7,347b4499-b0c4-4570-9adf-e492de246ac7,347b4499-b0c4-4570-9adf-e492de246ac7
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(347b4499-b0c4-4570-9adf-e492de246ac7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[250/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > setPrimary > should not delete mapping if workflow version does not match
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,93661a8c-7749-4446-8eca-1265bb4d3467,93661a8c-7749-4446-8eca-1265bb4d3467,93661a8c-7749-4446-8eca-1265bb4d3467
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(93661a8c-7749-4446-8eca-1265bb4d3467) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[251/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > existsByKey > should return true if key exists in workflow version
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,6ae60a4c-0788-4c8b-9298-951a9ba8a320,6ae60a4c-0788-4c8b-9298-951a9ba8a320,51a18ccd-117a-4a51-a453-3a05a20136ac,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24
     50| 
     51|     // Create test workflow
     52|     const [workflow] = await db
       |                        ^
     53|       .insert(workflows)
     54|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:52:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6ae60a4c-0788-4c8b-9298-951a9ba8a320) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[252/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > existsByKey > should return false if key does not exist
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,5d67b693-e102-4dcf-b83f-b2adbe0fc07c,5d67b693-e102-4dcf-b83f-b2adbe0fc07c,5d67b693-e102-4dcf-b83f-b2adbe0fc07c
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5d67b693-e102-4dcf-b83f-b2adbe0fc07c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[253/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > existsByKey > should exclude specified id when checking existence
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: e0b6ad65-cbdd-433b-9762-2529ee9541d3,1,true,{},"Initial version",1ab5ca04-b4cb-4a50-9ed2-d31477c95c50
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:66:23
     64| 
     65|     // Create test workflow version
     66|     const [version] = await db
       |                       ^
     67|       .insert(workflowVersions)
     68|       .values({

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:66:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 363, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(e0b6ad65-cbdd-433b-9762-2529ee9541d3) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[254/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > existsByKey > should return true if key exists on different mapping
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,6874484e-4dee-4832-acdd-85162a6acee9,6874484e-4dee-4832-acdd-85162a6acee9,6874484e-4dee-4832-acdd-85162a6acee9
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 312, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6874484e-4dee-4832-acdd-85162a6acee9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[255/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > update > should update mapping fields
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,7f97afb7-27f2-4079-a58b-ce6bfc2800d4,7f97afb7-27f2-4079-a58b-ce6bfc2800d4,7f97afb7-27f2-4079-a58b-ce6bfc2800d4
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23
     36| 
     37|     // Create test project
     38|     const [project] = await db
       |                       ^
     39|       .insert(projects)
     40|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:38:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(7f97afb7-27f2-4079-a58b-ce6bfc2800d4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[256/322]Î“Ã„Â»

 FAIL  tests/unit/repositories/WorkflowTemplateRepository.test.ts > WorkflowTemplateRepository > findById > should find mapping by id
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: c585fc5c-124a-44da-87be-0b31e8d15444,Template 2,Second test template,/uploads/template2.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:92:25
     90|     testTemplateId1 = template1.id;
     91| 
     92|     const [template2] = await db
       |                         ^
     93|       .insert(templates)
     94|       .values({

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/repositories/WorkflowTemplateRepository.test.ts:92:25

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(c585fc5c-124a-44da-87be-0b31e8d15444) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[257/322]Î“Ã„Â»

 FAIL  tests/unit/services/AIService.test.ts > AIService Unit Tests > reviseWorkflow should parse valid JSON response correctly
TypeError: () => ({
      generateWorkflow: __vite_ssr_import_0__.vi.fn().mockResolvedValue({
        title: "Generated Fl...<omitted>...}) is not a constructor
 Î“Â¥Â» new AIService server/services/AIService.ts:68:30
     66| 
     67|     // Initialize specialized services
     68|     this.generationService = new WorkflowGenerationService(client, proÎ“Ã‡Âª
       |                              ^
     69|     this.suggestionService = new WorkflowSuggestionService(client, proÎ“Ã‡Âª
     70|     this.revisionService = new WorkflowRevisionService(client, promptBÎ“Ã‡Âª
 Î“Â¥Â» tests/unit/services/AIService.test.ts:97:25

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[258/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Password Reset > generatePasswordResetToken() > should generate password reset token for existing user
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.generatePasswordResetToken server/services/AuthService.ts:508:9
    506| 
    507|         await sendPasswordResetEmail(email, plainToken);
    508|         log.info({ email }, 'Password reset email sent');
       |         ^
    509| 
    510|         return plainToken;
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:671:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[259/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Password Reset > generatePasswordResetToken() > should invalidate previous reset tokens
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.generatePasswordResetToken server/services/AuthService.ts:508:9
    506| 
    507|         await sendPasswordResetEmail(email, plainToken);
    508|         log.info({ email }, 'Password reset email sent');
       |         ^
    509| 
    510|         return plainToken;
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:695:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[260/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Refresh Token Management > rotateRefreshToken() > should rotate valid token and return new one
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.rotateRefreshToken server/services/AuthService.ts:396:9
    394|         // DEBUG LOG
    395|         // logger is available as 'log' from imports
    396|         log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBÎ“Ã‡Âª
       |         ^
    397| 
    398|         // Find token purely by hash to detect state
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:901:42

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[261/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Refresh Token Management > rotateRefreshToken() > should return null for unknown token
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.rotateRefreshToken server/services/AuthService.ts:396:9
    394|         // DEBUG LOG
    395|         // logger is available as 'log' from imports
    396|         log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBÎ“Ã‡Âª
       |         ^
    397| 
    398|         // Find token purely by hash to detect state
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:914:42

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[262/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Refresh Token Management > rotateRefreshToken() > should revoke all tokens on reuse detection
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.rotateRefreshToken server/services/AuthService.ts:396:9
    394|         // DEBUG LOG
    395|         // logger is available as 'log' from imports
    396|         log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBÎ“Ã‡Âª
       |         ^
    397| 
    398|         // Find token purely by hash to detect state
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:933:42

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[263/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Refresh Token Management > rotateRefreshToken() > should return null for expired token
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.rotateRefreshToken server/services/AuthService.ts:396:9
    394|         // DEBUG LOG
    395|         // logger is available as 'log' from imports
    396|         log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBÎ“Ã‡Âª
       |         ^
    397| 
    398|         // Find token purely by hash to detect state
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:950:42

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[264/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Token Cleanup > cleanupExpiredTokens() > should cleanup expired refresh tokens
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.cleanupExpiredTokens server/services/AuthService.ts:593:9
    591|         await accountLockoutService.cleanupOldAttempts();
    592| 
    593|         log.info('Cleaned up expired tokens and old login attempts');
       |         ^
    594|     }
    595| }
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:977:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[265/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Token Cleanup > cleanupExpiredTokens() > should cleanup expired password reset tokens
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.cleanupExpiredTokens server/services/AuthService.ts:593:9
    591|         await accountLockoutService.cleanupOldAttempts();
    592| 
    593|         log.info('Cleaned up expired tokens and old login attempts');
       |         ^
    594|     }
    595| }
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:982:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[266/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Token Cleanup > cleanupExpiredTokens() > should cleanup expired email verification tokens
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.cleanupExpiredTokens server/services/AuthService.ts:593:9
    591|         await accountLockoutService.cleanupOldAttempts();
    592| 
    593|         log.info('Cleaned up expired tokens and old login attempts');
       |         ^
    594|     }
    595| }
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:987:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[267/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Token Cleanup > cleanupExpiredTokens() > should cleanup old login attempts via accountLockoutService
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.cleanupExpiredTokens server/services/AuthService.ts:593:9
    591|         await accountLockoutService.cleanupOldAttempts();
    592| 
    593|         log.info('Cleaned up expired tokens and old login attempts');
       |         ^
    594|     }
    595| }
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:993:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[268/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Integration Scenarios > Complete Authentication Flow > should support full user authentication lifecycle
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.rotateRefreshToken server/services/AuthService.ts:396:9
    394|         // DEBUG LOG
    395|         // logger is available as 'log' from imports
    396|         log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBÎ“Ã‡Âª
       |         ^
    397| 
    398|         // Find token purely by hash to detect state
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:1239:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[269/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Integration Scenarios > Password Reset Flow > should support complete password reset workflow
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.generatePasswordResetToken server/services/AuthService.ts:508:9
    506| 
    507|         await sendPasswordResetEmail(email, plainToken);
    508|         log.info({ email }, 'Password reset email sent');
       |         ^
    509| 
    510|         return plainToken;
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:1259:28

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[270/322]Î“Ã„Â»

 FAIL  tests/unit/services/AuthService.test.ts > AuthService > Integration Scenarios > Password Reset Flow > should prevent reuse of password reset tokens
ReferenceError: log is not defined
 Î“Â¥Â» AuthService.generatePasswordResetToken server/services/AuthService.ts:508:9
    506| 
    507|         await sendPasswordResetEmail(email, plainToken);
    508|         log.info({ email }, 'Password reset email sent');
       |         ^
    509| 
    510|         return plainToken;
 Î“Â¥Â» tests/unit/services/AuthService.test.ts:1296:28

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[271/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > enqueue > should enqueue a PDF conversion job
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,05afaaab-ffd5-4ece-b1ad-5f593244ad2b,ca86efc6-2e12-41af-9b70-aafca0e21331,05afaaab-ffd5-4ece-b1ad-5f593244ad2b,05afaaab-ffd5-4ece-b1ad-5f593244ad2b
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23
     92| 
     93|     // Create test project
     94|     const [project] = await db
       |                       ^
     95|       .insert(projects)
     96|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ca86efc6-2e12-41af-9b70-aafca0e21331) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[272/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > enqueue > should create output with empty storagePath initially
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 191d808e-7261-4655-ad1b-a196ab82d924,1,true,{},"Initial version",0605bbd5-34ef-4d84-a176-bbf4f71a109f
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:124:23
    122| 
    123|     // Create test workflow version
    124|     const [version] = await db
       |                       ^
    125|       .insert(workflowVersions)
    126|       .values({

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:124:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(191d808e-7261-4655-ad1b-a196ab82d924) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[273/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > getJobStatus > should return job status for pending job
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: b8e35755-a0f2-4ff4-b233-623de1fff1d6,1,true,{},"Initial version",a1b51549-3180-441d-89a2-267e3e05c0d4
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:124:23
    122| 
    123|     // Create test workflow version
    124|     const [version] = await db
       |                       ^
    125|       .insert(workflowVersions)
    126|       .values({

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:124:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(b8e35755-a0f2-4ff4-b233-623de1fff1d6) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[274/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > getJobStatus > should return null for non-existent job
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,409b864c-6f66-4326-908d-f86d02ab10c8,a3ce51d2-96ee-4e89-a52c-3851182dce02,409b864c-6f66-4326-908d-f86d02ab10c8,409b864c-6f66-4326-908d-f86d02ab10c8
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23
     92| 
     93|     // Create test project
     94|     const [project] = await db
       |                       ^
     95|       .insert(projects)
     96|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 327, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a3ce51d2-96ee-4e89-a52c-3851182dce02) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[275/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > getJobStatus > should parse attempt count from error field
TypeError: Cannot read properties of null (reading 'attempt')
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:247:22
    245|       const status = await service.getJobStatus(output.id);
    246| 
    247|       expect(status!.attempt).toBe(2);
       |                      ^
    248|     });
    249|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[276/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > convertImmediate > should convert DOCX to PDF immediately
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,09176155-c896-428b-9762-55b358555e21,9735be64-4751-4d6f-90f8-061a0e2b9c0f,09176155-c896-428b-9762-55b358555e21,09176155-c896-428b-9762-55b358555e21
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23
     92| 
     93|     // Create test project
     94|     const [project] = await db
       |                       ^
     95|       .insert(projects)
     96|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(09176155-c896-428b-9762-55b358555e21) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[277/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > convertImmediate > should handle conversion errors gracefully
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,d5a2408e-1be4-40be-b0f0-cc9df918ed3f,561aa5ac-b3cc-4a99-b688-8268178b1ebf,d5a2408e-1be4-40be-b0f0-cc9df918ed3f,d5a2408e-1be4-40be-b0f0-cc9df918ed3f
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23
     92| 
     93|     // Create test project
     94|     const [project] = await db
       |                       ^
     95|       .insert(projects)
     96|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 312, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d5a2408e-1be4-40be-b0f0-cc9df918ed3f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[278/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Service Lifecycle > should not start if already running
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,ff9a525a-6890-45a3-94c5-637518cc4075,907a8482-adf9-4965-8b5c-a084487d0ff3,ff9a525a-6890-45a3-94c5-637518cc4075,ff9a525a-6890-45a3-94c5-637518cc4075
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23
     92| 
     93|     // Create test project
     94|     const [project] = await db
       |                       ^
     95|       .insert(projects)
     96|       .values({

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:94:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 312, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ff9a525a-6890-45a3-94c5-637518cc4075) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[279/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Service Lifecycle > should handle stop when not running
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,b0f3ea03-3dcb-4426-8037-13f67c54c039,b0f3ea03-3dcb-4426-8037-13f67c54c039,Test Workflow,afdeb547-843f-4d3f-899e-0ee847310dc7,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24
    107| 
    108|     // Create test workflow
    109|     const [workflow] = await db
       |                        ^
    110|       .insert(workflows)
    111|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b0f3ea03-3dcb-4426-8037-13f67c54c039) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[280/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Queue Processing > should process pending jobs when queue is processed
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,db129537-7e78-41d2-ad9a-d91debab196c,db129537-7e78-41d2-ad9a-d91debab196c,Test Workflow,c88258ad-81b2-47f5-b24a-41c31f0bbaed,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24
    107| 
    108|     // Create test workflow
    109|     const [workflow] = await db
       |                        ^
    110|       .insert(workflows)
    111|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 325, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(c88258ad-81b2-47f5-b24a-41c31f0bbaed) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: 'workflows_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[281/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Queue Processing > should process multiple jobs in batch
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,c528b0b9-ef6b-4849-a8ba-f67f49e0199b,c528b0b9-ef6b-4849-a8ba-f67f49e0199b,Test Workflow,99edb3a7-b38d-4aed-8774-d9e946891085,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24
    107| 
    108|     // Create test workflow
    109|     const [workflow] = await db
       |                        ^
    110|       .insert(workflows)
    111|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c528b0b9-ef6b-4849-a8ba-f67f49e0199b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w27_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[282/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Error Handling > should handle missing DOCX output gracefully
TypeError: Cannot read properties of undefined (reading 'error')
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:455:22
    453| 
    454|       // Should have error
    455|       expect(output!.error).toBeDefined();
       |                      ^
    456|     });
    457|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[283/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Transaction Support > should support enqueue within transaction
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,88f1e2f8-db62-4e10-84ed-cc31339e07d3,88f1e2f8-db62-4e10-84ed-cc31339e07d3,Test Workflow,df476c76-49c8-4788-915d-40df22c2747a,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24
    107| 
    108|     // Create test workflow
    109|     const [workflow] = await db
       |                        ^
    110|       .insert(workflows)
    111|       .values({

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:109:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 325, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(df476c76-49c8-4788-915d-40df22c2747a) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: 'workflows_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[284/322]Î“Ã„Â»

 FAIL  tests/unit/services/PdfQueueService.test.ts > PdfQueueService > Transaction Support > should support convertImmediate within transaction
Error: Failed query: insert into "run_outputs" ("id", "run_id", "workflow_version_id", "template_key", "file_type", "storage_path", "status", "error", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default)
params: 2fdf6b33-4cda-4925-89aa-116a72de2cdc,2d1527b8-210c-4522-8334-26494fb319d8,engagement_letter,pdf,,failed,Failed query: insert into "run_outputs" ("id", "run_id", "workflow_version_id", "template_key", "file_type", "storage_path", "status", "error", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, default, default, default)
params: 2fdf6b33-4cda-4925-89aa-116a72de2cdc,2d1527b8-210c-4522-8334-26494fb319d8,engagement_letter,pdf,test.pdf,ready
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» PdfQueueService.convertImmediate server/services/PdfQueueService.ts:363:7
    361| 
    362|       // Store failed output
    363|       await database.insert(runOutputs).values({
       |       ^
    364|         runId,
    365|         workflowVersionId,
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:484:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:483:7

Caused by: error: current transaction is aborted, commands ignored until end of transaction block
 Î“Â¥Â» node_modules/pg/lib/client.js:545:17
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» PdfQueueService.convertImmediate server/services/PdfQueueService.ts:363:7
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:484:24
 Î“Â¥Â» NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:186:22
 Î“Â¥Â» tests/unit/services/PdfQueueService.test.ts:483:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 145, severity: 'ERROR', code: '25P02', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'postgres.c', routine: 'exec_parse_message' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[285/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > should automatically unset other primaries when setting new primary
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 84f65bc6-cffa-4329-8ea3-e89eceb32a04,Test Workflow,Test workflow,557a827d-bebd-4db4-9196-943616ecb6de,557a827d-bebd-4db4-9196-943616ecb6de,test-workflow-e6ff9d6a-0f7b-4fdf-8a40-909d87c748b1,Test Workflow,3066c0c6-ec14-47c3-aa6f-402ee4c9068c,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
    149|     }
    150|   ): Promise<TestWorkflow> {
    151|     const [workflow] = await this.db
       |                        ^
    152|       .insert(schema.workflows)
    153|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(557a827d-bebd-4db4-9196-943616ecb6de) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[286/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > listTemplates > should list all templates for workflow version
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 4bc798ca-791d-4115-9215-f1ab2055fb71,Test Project,Test Project,Test project for integration tests,e0da62b6-fe38-4eb2-b35a-bba83180a6c4,6248c507-ffee-4350-82f6-1d898f3850f6,e0da62b6-fe38-4eb2-b35a-bba83180a6c4,e0da62b6-fe38-4eb2-b35a-bba83180a6c4
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
    120| 
    121|     // Create project with all required ownership fields
    122|     const [project] = await this.db
       |                       ^
    123|       .insert(schema.projects)
    124|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 312, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e0da62b6-fe38-4eb2-b35a-bba83180a6c4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[287/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > listTemplates > should return empty array for version with no templates
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0fe7343e-7d69-4b59-832c-0b9f08726fba,test-1768676065899@example.com,Test User,Test,User,b2d859ee-276f-424d-ac20-63d13492d1ca,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b2d859ee-276f-424d-ac20-63d13492d1ca) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[288/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > getTemplateMapping > should get template mapping by id and version
Error: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: e261fc7d-b644-486e-8542-298822ecd538,90420085-ec92-44ca-8744-5d0aa44b951e,Template 1,First test template,/uploads/template1.docx,docx
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
    232|     overrides?: Partial<typeof schema.templates.$inferInsert>
    233|   ): Promise<TestTemplate> {
    234|     const [template] = await this.db
       |                        ^
    235|       .insert(schema.templates)
    236|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:66:37

Caused by: error: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTemplate tests/helpers/testFactory.ts:234:24
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:66:37

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 325, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(90420085-ec92-44ca-8744-5d0aa44b951e) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[289/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > getTemplateMapping > should throw error if mapping not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 86df5450-7c6e-4ea1-a666-f37bfee2bd26,test-1768676067600@example.com,Test User,Test,User,bb236329-0ce3-406e-8928-23dd522c4b09,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bb236329-0ce3-406e-8928-23dd522c4b09) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[290/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > getTemplateByKey > should get template by key
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 14005d2d-0c33-4b78-8d2a-1e24149ccad7,test-1768676068286@example.com,Test User,Test,User,12df800c-cb45-4117-9fff-4458016a93e6,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(12df800c-cb45-4117-9fff-4458016a93e6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[291/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > getPrimaryTemplate > should get primary template for workflow version
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 05141c5a-6e5f-484e-a5d1-25eac1b23d52,test-1768676069691@example.com,Test User,Test,User,70b5611d-4d63-4a8f-a98f-c8cc9883f5e9,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(70b5611d-4d63-4a8f-a98f-c8cc9883f5e9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[292/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > getPrimaryTemplate > should return null when no primary template exists
Error: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: c8493879-87e0-4609-8216-fc7a4f303508,Test Project,Test Project,Test project for integration tests,913adcbb-e472-4432-8ca5-f1ef1561cd9a,4393e9ac-92e5-4736-908a-a73887144646,913adcbb-e472-4432-8ca5-f1ef1561cd9a,913adcbb-e472-4432-8ca5-f1ef1561cd9a
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
    120| 
    121|     // Create project with all required ownership fields
    122|     const [project] = await this.db
       |                       ^
    123|       .insert(schema.projects)
    124|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:122:23
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(913adcbb-e472-4432-8ca5-f1ef1561cd9a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[293/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > updateTemplateMapping > should update isPrimary flag
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0457e957-43c9-43e9-8b28-2e3f4bafc707,test-1768676071626@example.com,Test User,Test,User,2394c2b9-3c26-4b9e-85a1-0123fff01370,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2394c2b9-3c26-4b9e-85a1-0123fff01370) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[294/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > updateTemplateMapping > should throw error if new key already exists
Error: Failed query: insert into "workflow_templates" ("id", "workflow_version_id", "template_id", "key", "is_primary", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, default) returning "id", "workflow_version_id", "template_id", "key", "is_primary", "created_at", "updated_at"
params: eb3055c9-04cd-4206-9268-802e1e774587,7a99f53c-c3e8-42c3-a8f4-0d1671779bb9,first,false
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowTemplateRepository.create server/repositories/BaseRepository.ts:90:22
     88|     const database = this.getDb(tx);
     89| 
     90|     const [record] = await database
       |                      ^
     91|       .insert(this.table as any)
     92|       .values(data as any)
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:328:23

Caused by: error: insert or update on table "workflow_templates" violates foreign key constraint "workflow_templates_workflow_version_id_workflow_versions_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» WorkflowTemplateRepository.create server/repositories/BaseRepository.ts:90:22
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:328:23

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 427, severity: 'ERROR', code: '23503', detail: 'Key (workflow_version_id)=(eb3055c9-04cd-4206-9268-802e1e774587) is not present in table "workflow_versions".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'workflow_templates', dataType: undefined, constraint: 'workflow_templates_workflow_version_id_workflow_versions_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[295/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > updateTemplateMapping > should throw error if mapping not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3bb37733-6d32-4c26-9a94-baade3acc1fd,test-1768676073320@example.com,Test User,Test,User,2862eb72-748f-4b25-a423-fb96031b9237,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2862eb72-748f-4b25-a423-fb96031b9237) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[296/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > updateTemplateMapping > should unset other primaries when setting isPrimary to true
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9991ea21-3e53-4c43-b716-65b35d8c4d6d,test-1768676074007@example.com,Test User,Test,User,b025bde1-c59d-49cb-a314-0961a1994349,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b025bde1-c59d-49cb-a314-0961a1994349) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[297/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > detachTemplate > should detach template from workflow version
Error: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, default, default, $3, default, default, default, default, $4, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 7c930952-cd3e-4091-b918-05edabf53e4d,21881ec0-7320-4cc3-8d19-d774add7b6f2,{},787117ea-8253-4be7-94dc-43e86f77246e
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:166:23
    164|       .returning();
    165| 
    166|     const [version] = await this.db
       |                       ^
    167|       .insert(schema.workflowVersions)
    168|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Caused by: error: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:166:23
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(21881ec0-7320-4cc3-8d19-d774add7b6f2) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[298/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > detachTemplate > should throw error if mapping not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 56f2e71d-3e88-4d64-a82e-6b5aae32c46f,test-1768676075828@example.com,Test User,Test,User,91a4b5ad-533e-4141-95cd-ca9f1efcda32,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(91a4b5ad-533e-4141-95cd-ca9f1efcda32) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[299/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > setPrimaryTemplate > should set template as primary
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fb3cbb1a-ec5b-425e-bb88-3e0e08be282a,test-1768676076377@example.com,Test User,Test,User,70e20ea5-f76e-4a91-ab1d-07bc34c843c4,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(70e20ea5-f76e-4a91-ab1d-07bc34c843c4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[300/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > setPrimaryTemplate > should throw error if mapping not found
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8ab6ac0b-f4c6-4677-b812-4bf6423bcf5c,test-1768676076885@example.com,Test User,Test,User,bc36a541-77cd-4d8e-ba57-1d78037fb96b,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bc36a541-77cd-4d8e-ba57-1d78037fb96b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[301/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > transaction support > should support operations within a transaction
Error: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 56ab13e7-e0a3-4cc4-a221-ddb9f607480a,Test Workflow,Test workflow,1d00f9d7-fcd3-43e5-89d0-37ee5cf8d9b9,1d00f9d7-fcd3-43e5-89d0-37ee5cf8d9b9,test-workflow-91e400b3-392f-4c87-8cc3-283024f68bbe,Test Workflow,df5a50a0-b165-4ae7-90df-7779268b7831,draft
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
    149|     }
    150|   ): Promise<TestWorkflow> {
    151|     const [workflow] = await this.db
       |                        ^
    152|       .insert(schema.workflows)
    153|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Caused by: error: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createWorkflow tests/helpers/testFactory.ts:151:24
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:53:35

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(1d00f9d7-fcd3-43e5-89d0-37ee5cf8d9b9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[302/322]Î“Ã„Â»

 FAIL  tests/unit/services/WorkflowTemplateService.test.ts > WorkflowTemplateService > attachTemplate > transaction support > should rollback on transaction error
Error: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: c8908190-5c97-4070-b6a0-2bb1c0991e72,test-1768676078172@example.com,Test User,Test,User,450d6450-6a37-49d8-a02f-07aaf422a73b,admin,owner,local,easy
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
    102| 
    103|     // Create user with admin/owner role for test permissions
    104|     const [user] = await this.db
       |                    ^
    105|       .insert(schema.users)
    106|       .values({
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» TestFactory.createTenant tests/helpers/testFactory.ts:104:20
 Î“Â¥Â» tests/unit/services/WorkflowTemplateService.test.ts:47:39

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(450d6450-6a37-49d8-a02f-07aaf422a73b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[303/322]Î“Ã„Â»


[2m Test Files [22m [1m[31m55 failed[39m[22m[2m | [22m[1m[32m101 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m282 failed[39m[22m[2m | [22m[1m[32m1938 passed[39m[22m[2m | [22m[33m422 skipped[39m[90m (2642)[39m
[2m   Start at [22m 12:53:47
[2m   Duration [22m 973.89s[2m (transform 50.63s, setup 19.54s, import 297.27s, tests 12544.97s, environment 19.52s)[22m

