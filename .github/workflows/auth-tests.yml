name: Auth Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'server/services/AuthService.ts'
      - 'server/services/MfaService.ts'
      - 'server/services/AccountLockoutService.ts'
      - 'server/routes/auth.routes.ts'
      - 'server/middleware/auth.ts'
      - 'tests/**/*auth*.test.ts'
      - 'tests/**/*mfa*.test.ts'
      - 'tests/**/*session*.test.ts'
      - 'tests/**/*trusted*.test.ts'
      - 'shared/schema.ts'
      - 'vitest.config.*.ts'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'server/services/AuthService.ts'
      - 'server/services/MfaService.ts'
      - 'server/services/AccountLockoutService.ts'
      - 'server/routes/auth.routes.ts'
      - 'server/middleware/auth.ts'
      - 'tests/**/*auth*.test.ts'
      - 'tests/**/*mfa*.test.ts'
      - 'tests/**/*session*.test.ts'
      - 'tests/**/*trusted*.test.ts'
      - 'shared/schema.ts'
      - 'vitest.config.*.ts'
  workflow_dispatch: # Allow manual trigger

jobs:
  auth-unit-tests:
    name: Auth Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgrespw
          POSTGRES_DB: auth_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: npm run db:push
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"

      - name: Run Auth Service Unit Tests
        run: npm run test:auth -- --reporter=verbose --reporter=json --outputFile=auth-unit-results.json
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"
          JWT_SECRET: "test-jwt-secret-minimum-32-characters-long-for-ci"
          VL_MASTER_KEY: ${{ secrets.VL_MASTER_KEY_TEST || 'dGVzdC1tYXN0ZXIta2V5LTMyLWJ5dGVzLWxvbmctZm9yLXRlc3Rpbmc=' }}

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-unit-test-results
          path: auth-unit-results.json
          retention-days: 7

  auth-integration-tests:
    name: Auth Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgrespw
          POSTGRES_DB: auth_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: npm run db:push
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"

      - name: Run Auth Integration Tests
        run: npm run test:auth:integration -- --reporter=verbose --reporter=json --outputFile=auth-integration-results.json
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"
          JWT_SECRET: "test-jwt-secret-minimum-32-characters-long-for-ci"
          VL_MASTER_KEY: ${{ secrets.VL_MASTER_KEY_TEST || 'dGVzdC1tYXN0ZXIta2V5LTMyLWJ5dGVzLWxvbmctZm9yLXRlc3Rpbmc=' }}
          SESSION_SECRET: "test-session-secret-minimum-32-characters-long"

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-integration-test-results
          path: auth-integration-results.json
          retention-days: 7

  auth-coverage:
    name: Auth Test Coverage
    runs-on: ubuntu-latest
    needs: [auth-unit-tests, auth-integration-tests]
    if: always()

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgrespw
          POSTGRES_DB: auth_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: npm run db:push
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"

      - name: Run Auth Tests with Coverage
        run: npm run test:auth:integration:coverage -- --reporter=verbose
        env:
          NODE_ENV: test
          DATABASE_URL: "postgresql://postgres:postgrespw@localhost:5432/auth_test_db"
          JWT_SECRET: "test-jwt-secret-minimum-32-characters-long-for-ci"
          VL_MASTER_KEY: ${{ secrets.VL_MASTER_KEY_TEST || 'dGVzdC1tYXN0ZXIta2V5LTMyLWJ5dGVzLWxvbmctZm9yLXRlc3Rpbmc=' }}
          SESSION_SECRET: "test-session-secret-minimum-32-characters-long"

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-coverage-report
          path: coverage/
          retention-days: 30

      - name: Generate coverage summary
        if: always()
        run: |
          echo "# Auth Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json | jq -r '
              .total |
              "## Overall Coverage\n\n" +
              "| Metric | Coverage |\n" +
              "|--------|----------|\n" +
              "| Lines | \(.lines.pct)% |\n" +
              "| Statements | \(.statements.pct)% |\n" +
              "| Functions | \(.functions.pct)% |\n" +
              "| Branches | \(.branches.pct)% |"
            ' >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check coverage thresholds
        if: always()
        run: |
          echo "Checking auth test coverage thresholds..."
          # This will fail if coverage is below thresholds defined in vitest.config.integration.ts
          # Lines: 85%, Functions: 85%, Branches: 80%, Statements: 85%

  auth-test-summary:
    name: Auth Test Summary
    runs-on: ubuntu-latest
    needs: [auth-unit-tests, auth-integration-tests, auth-coverage]
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: auth-*-test-results
          merge-multiple: true

      - name: Generate test summary
        run: |
          echo "# ðŸ” Auth Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Unit Tests Status
          if [ -f auth-unit-results.json ]; then
            echo "âœ… **Unit Tests:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Unit Tests:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi

          # Integration Tests Status
          if [ -f auth-integration-results.json ]; then
            echo "âœ… **Integration Tests:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Integration Tests:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Auth tests run independently and don't block main CI pipeline." >> $GITHUB_STEP_SUMMARY

      - name: Set job status
        if: needs.auth-unit-tests.result != 'success' || needs.auth-integration-tests.result != 'success'
        run: |
          echo "::warning::Some auth tests failed. Check the logs above."
          exit 1
